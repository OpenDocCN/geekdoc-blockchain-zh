© 作者，独家许可给 APress Media, LLC，Springer Nature 的一部分 2022J. T. George 介绍区块链应用[`doi.org/10.1007/978-1-4842-7480-4_5`](https://doi.org/10.1007/978-1-4842-7480-4_5)

# 5. *权益证明*：未来的共识

Joseph Thachil George^(1  )(1)意大利，罗马

*权益证明*算法将挖矿者替换为验证者，并将挖矿过程虚拟化。以太坊开发者一直希望转向权益证明，但它目前存在一些开发者仍在努力解决的问题。

*权益证明*算法基于不同的区块挖掘哲学。

一般而言，该算法基于以下事实：

+   想要成为验证者的任何用户必须通过抵押一定数量的硬币在网络上注册为验证者。然后，这个抵押价值将会被冻结。

+   这个硬币抵押永远不能小于一个特定的数量。事实上，抵押必须大于他们可以通过验证新区块获得的收益。

+   为了正常运作，该算法必须通过削减他们的抵押来惩罚不诚实的验证者。这样一来，验证者遵守诚实的收益要比攻击区块链高。

每个时间间隔，从验证者池中选择一个验证者用于验证并添加另一个区块到区块链中。每次间隔选择验证者依据多种标准进行选择。

每个验证者的抵押赌注都会影响被选择的概率。赌注越大，被选中的可能性就越大。

每种权益证明的实现按其认为合适的方式定义了这一选择。因此，它可以从工作量证明（PoW）变化为权益证明（PoS）。

一般来说，有两种方法可以做出这种选择：

+   **随机选择的区块** **：** 通过最小的哈希值和最大的抵押价值之间的配对来选择验证者。然而，由于每个验证者的抵押是公开的，这种选择可以被预见。

+   **硬币时代选择** **：** 根据代币持有的时间长短选择验证者。年龄根据代币在权益份额中持有的天数计算。但是，每当验证者添加一个块时，硬币的年龄就会重置为 0。因此，它必须等待一段时间间隔才能验证一个新块。

    +   这样可以实现去中心化。

    +   这样可以防止大股权节点主导验证，从而主导区块链。

这显然不会阻止新的选择方法。相反，通过项目的选择，每个人都可以实现其选择。

实际上，每个使用 PoS 的区块链都会根据其认为最合适的方式实现自己的方法和技术。所选节点将验证新块，对其进行签名，并将其添加到区块链中。

作为奖励，节点会收取交易费用。

如果一个节点想要停止验证块，因此撤回其股权，它可以这样做。但是，它将不得不等待一段时间，以便网络验证其是否表现得诚实。该算法允许您达到：

+   **安全性** **：** 股权作为金融激励，只验证块和有效交易。然后拒绝无效的。它还激励验证者在规范链上工作。如果行为不端，惩罚是截断该事件。

+   **能源效率** **：** 不需要昂贵和专门的硬件来进行复杂的计算，例如 PoW 所需的计算。

+   **激励** **：** 越来越多的用户将被激励进入管理验证。

+   **去中心化** **：** 由于验证者被随机选择的伪随机性，它避免了将验证集中到一小部分组织的圈子中，就像 PoW 所发生的那样。

+   **硬币价格稳定性****：** 由于不再需要释放新硬币作为对矿工的奖励。

因此，只要权益高于奖励，验证者在不诚实行为的情况下将损失的硬币超过可以赚取的硬币。

为了有效地控制网络并验证欺诈交易，验证者应持有网络中总权益数的 51%。然而，数学上虽然不是不可能的，但实际上是不太可能的。实际上，要发生这种情况，验证者必须控制网络，持有至少 51%的当前提议。有两种股东权益证明算法：

+   **链上权益证明：**该算法在每个时间段（每十秒可以代表一个时间段）伪随机选择一个验证者，并赋予该验证者生成单个区块的能力。此区块必须参考一些先前的区块（通常是大多数情况下的前一条最长链的结尾处的区块）。因此，随着时间的推移，大多数区块会汇聚成一条持续增长的单一链。

+   **以 BFT（拜占庭容错）风格的权益证明：**验证者随机获得提出区块的权限，但是通过多轮方法确定哪个区块是正规的。基于此，每个验证者在每一轮都会为某个特定区块投票，最终所有验证者（诚实并且在线的）在过程结束时将会一致同意给定的区块是否与链相连接。需要注意的是，这些区块仍然可以连接到链上；不同的是，对区块的认可可以发生在区块内，而不是取决于链的长度或大小。

## 5.1 基于链的权益证明

本节讨论了与工作量证明相结合的权益证明算法。

开发比特币的开发者首次提出的 PoS 技术作为 PoW 的替代区块生成方法是基于链的 PoS。实际上，它是 PoS 和 PoW 之间的一种结合机制。它是在纳卡莫托协议的背景下，其中维持以下原则：

+   一种类似八卦的通信方式

+   区块验证规则

+   最广泛的链规则

+   逻辑目标

第一个完整链式区块链 POS 系统已经被 Nxt 和 Peercoin 实施和采纳。链式 PoS 的过程可以通过以下算法来说明。与 PoW 不同，PoS 不依赖于无用的哈希来创建区块。矿工只能在时钟的一个滴答中找到解决方案一次。

由于哈希难题的复杂性随着矿工押注金额的增加而降低，矿工解决难题所需的哈希尝试次数可以大大减少，即使他们的押注水平更高。

因此，PoS 组件避免了使用强制哈希并发，如果使用 PoW 将会发生，从而实现了大量的能源节约。

我们首先提出 BlockGen()方法，然后是共识算法。（见图 5-1。）![../images/520777_1_En_5_Chapter/520777_1_En_5_Fig1_HTML.jpg](img/520777_1_En_5_Fig1_HTML.jpg)

图 5-1

BlockGen()和基于链的股权证明一般程序

### 5.1.1 基于委员会的 PoS

基于链的 PoS 仍然依赖于哈希难题来创建区块。作为一种替代技术，基于委员会的 PoS 遵循更有序的程序：

+   基于押注邮件成立利益相关者委员会。

+   允许委员会轮流创建区块。

安全的多方计算（MPC）技术经常用于在全球网络中推导这样一个委员会。MPC 是一种分布式计算，其中从不同输入开始的不同部分产生相同的结果。

基于委员会的 PoS 中的 MPC 过程有效地实现了功能，该功能从所有股东目标区块链的当前状态中取值，并生成一系列伪随机的股东（领导者序列），然后这些股东将占据提议委员会。 (见图 5-2.)

这个领导者序列对所有参与方都是相同的，那些具有更高级别的权威可以在序列中占据多个位置。![../images/520777_1_En_5_Chapter/520777_1_En_5_Fig2_HTML.jpg](img/520777_1_En_5_Fig2_HTML.jpg)

图 5-2

CommitteeElect() 和基于委员会的股权证明一般程序

### 5.1.2 无所谓的权益理论

在许多早期基于链的股权证明系统中没有处罚或激励。（见图 5-3.)

这样做的不良后果是，如果多条链竞争，验证者的动机是努力在每条链上制作区块。有两个基本原因：

+   与 PoW 不同，验证者可以免费跨多个分支验证交易。因为不需要 PoW 来构建区块，因此在每个分叉上生产区块的计算成本较低。

+   验证者在所有分叉上工作是因为这对他们有利可图。如果验证者主要在两个（或更多）链上验证区块，他们将在任何获胜的分支上收取交易费。这增加了收集的概率。

因此问题在于，如果验证者指向每个分叉，区块链将更容易受到双重支付攻击的影响。![../images/520777_1_En_5_Chapter/520777_1_En_5_Fig3_HTML.jpg](img/520777_1_En_5_Fig3_HTML.jpg)

图 5-3

基于链的股权证明系统

在 PoW 中，没有动力同时在多条链上进行挖矿。如果将他们的哈希功率（计算能力）分配到两条链上，也不会增加矿工提取区块的机会。

这个问题可以通过两种策略来解决 —— Slasher 和 Dunkle。

#### 5.1.2.1 Slasher

这包括对同时在多个链上创建区块的验证者进行惩罚，以及对恶意行为的证据。此时，恶意验证者的存款被削减。由于这个原因，激励结构发生了改变。 (见图 5-4.)![../images/520777_1_En_5_Chapter/520777_1_En_5_Fig4_HTML.jpg](img/520777_1_En_5_Fig4_HTML.jpg)

图 5-4

Slasher

但是，对于解决该问题，两个分支上每个区块的验证者选择都是相同的，这要求在分叉之前进行验证者选择。这种解决方案存在一些缺点：

+   节点必须经常在线才能安全地查看区块链。

+   对于中程验证者（例如，30 个验证者中的 25 个事先商定发动对前 19 个区块的 51% 攻击的情况等），对串通风险持开放态度。

#### 5.1.2.2 Dunkle

第二种方法是简单地惩罚在错误链上创建区块的验证者。假设有两个对立的链，A 和 B。在 A 上构建区块的验证者会在 A 上获得 +R 的奖励，但该区块的头部可能被包含在 B 中，并且验证者会在 B 上受到 -F 的惩罚。换句话说，即使试图“错误地”伪造链（次要链）的验证者也可能会受到惩罚。 (见图 5-5.)![../images/520777_1_En_5_Chapter/520777_1_En_5_Fig5_HTML.jpg](img/520777_1_En_5_Fig5_HTML.jpg)

图 5-5

Dunkle

这里的见解是，你可以在 PoS 内部复制 PoW 经济。

在 PoW 中，制作链上区块时犯错会有一定的代价，但这个成本被隐藏在环境中。矿工必须消耗更多的电力并购买或租赁额外的硬件。或者，他们必须划分他们的计算资源，这是不方便的。

在这里，制裁仅仅是陈述。这种技术的缺点是使验证者面临更大的风险。

出于这些原因，以太坊 2.0 正在计划自己的权益证明，采用了类似 BFT（拜占庭容错）的 Casper 名称。

### 5.1.3 基于 BFT 的权益证明

因为最长链规则仍然被采用以确保区块的概率性确定性，基于链的 PoS 和基于佣金的 PoS 实质上遵循 Nakamoto 共识结构。相比之下，基于 BFT 的 PoS 包括一个额外的同意层，提供了对区块的确定性快速确定。

提案阻塞可以通过任何机制 PoS（轮换、基于委员会等）进行，只要它向 BFT 共识层注入稳定的新区块流即可。

除了标准方法外，还可以采用检查点机制来确保区块链的目标得以实现。（见图 5-6。）

因此，最长链规则可以以安全方式被当前和安全的检查点规则替代，以确定规范主链。

其中 BlockGen():

+   通过与权益值成比例的成功率选举提议的区块。

+   因此提出区块 BlockFi BTC()。

+   参与确定获胜区块的共识 BFT。

获胜的区块返回。![../images/520777_1_En_5_Chapter/520777_1_En_5_Fig6_HTML.jpg](img/520777_1_En_5_Fig6_HTML.jpg)

图 5-6

基于拜占庭容错的 PoS 一般流程

## 5.2 以太坊 Casper

FT 方法（部分同步）允许验证者使用权益证明技术对区块进行投票，该技术提供一种或多种形式的签名消息。目标是达成共识，并识别和惩罚任何不诚实的验证者。

像 BFT 共识算法一样，假设如果 3 分之 2 的验证者正确地遵循协议，那么无论网络延迟如何，算法都无法解决冲突的区块。

Vitalik Buterin 表示，Casper 的目标之一是实现经济目的。我们可以定义如下：

如果客户能够证明 (i) B1 将永远成为规范链的一部分，或者 (ii) 导致 B1 恢复的参与者被保证至少受到价值至少 X 美元的经济处罚，那么 B1 区块在经济上被最终确定，带有 X 美元的加密安全保证。

显然，经济加密安全边际必须足够高。实际上，如果我们将 X 设定为 7000 万美元，我们会明白那个区块是链的一部分，并且更改它的成本非常昂贵。PoW 没有这些保证。这是 PoS 的一个特定特征。

目的是使 51% 攻击变得非常昂贵，以便大多数验证者共同努力而未能在不遭受极大经济损失的情况下恢复已经最终确定的锁。经济目的是通过要求希望参与验证过程的人提交赌注来实现的。

如果协议确定一个验证者行为不诚实，违反了协议的规则，那么他们将受到惩罚，并且他们的赌注会被削减。

协议的一组规则被称为*惩罚条件*。惩罚条件使我们能够毫无疑问地确定一个验证者何时行为不当（例如，同时为多个不同的区块投票）。

另一方面，遵守协议规则的验证者不会违反任何规则，也不会受到任何处罚的保证。

还有*最终性条件*，描述了何时可以考虑某个特定已确认的哈希。当至少有当前活跃验证者集合存入的总余额的 2/3 承诺了哈希时，哈希被视为已确认。切割条件必须满足两个属性：

+   **可追责安全：** 如果两个冲突的哈希被确认，则必须能够证明至少有 1/3 的验证者违反了某些切割条件。

+   **可信活性：** 必须存在一组消息，以便 2/3 的验证者可以传输以完成一些新的哈希，而不违反切割条件，除非至少有 1/3 的验证者违反了某些切割条件。

可追责安全是经济目标的基础：如果两个冲突的哈希被确认（即出现分叉），那么你就有数学证据表明一大批验证者必定违反了某些切割条件，你可以向区块链提供证据并对其进行惩罚。

可信活性基本上意味着“不应该发生”。可能出现算法仍然被阻塞且无法确认任何内容的情况。

## 5.3 Casper 实现

区块树是一种与 Casper 中刚生成和接收的块相关的树数据结构。共识的实际对象是*检查点树*，它是区块树的子树。

特别是，在每个共识时期（区块树的高度每 100 或检查点树的高度每 1），每个验证者向其对等体传输一次用于块的检查点的投票。

检查点是创世块以及在区块树中高度为 100 或 100 的倍数的每个块。但是，高度为 100 k 的块的“检查点高度”简单地为 k。在区块树中，块的高度必须可被 100 整除。

为了更好地理解，请参见图 5-7 中的检查点树。![../images/520777_1_En_5_Chapter/520777_1_En_5_Fig7_HTML.jpg](img/520777_1_En_5_Fig7_HTML.jpg)

图 5-7

检查点树：虚线表示检查点之间有 100 个区块

高度函数显示在图 5-8 中。![../images/520777_1_En_5_Chapter/520777_1_En_5_Fig8_HTML.jpg](img/520777_1_En_5_Fig8_HTML.jpg)

图 5-8

具有高度函数的检查点树

成绩由合理的源检查点（CPs）及其高度 h（s）组成。一个目标门 CPT 及其高度 h（t）和验证者 S 的签名。必须满足 h（t）> h（s）。

因此<s; CPs; CPt; h (s); h (t)>是验证者的投票。

每个投票都会发送到网络，并根据签名者（从他们的利益出发）的参与价值进行加权。

如果来自押注总额超过总押注额的 2/3 的验证者的源-目标控制点对<CP[s]; CP[t]>被投票，则 CP[t]被证明是合理的，CP[s]被完成。CP[s]和 CP[t]之间的所有区块也被完成。

Casper FFG 依赖于两个所谓的 Casper 诫命来确保同意的安全性：

1.  1.

    不能有两个来自验证者的相同检查点高度的投票。

1.  2.

    验证者不需要投出新的投票，因为其现有投票的范围包括源-目标。

违规者将面临严厉的处罚，包括没收赌注和暂时的禁止投注。Casper FFG 可以轻松检测和应用削减规则，因为每个投票都是用验证者的私钥签名的，这些私钥由验证者接收。

此外，还适用以下条件：

+   超过半数的链接被定义为一个有序对的检查点（a; b），也写作 a -> b，使得至少有 2/3 的验证者（即，存款总额为 2/3 的验证者集合）发布了一个以 a 为 sorgete 和 b 为目标的投票。超过半数的链接可以跳过检查点。所以如果 h (b) > h (a) + 1，那么没问题。

+   如果两个检查点（a 和 b）在不同的分支中，即一个不是另一个的祖先或后代，则被定义为冲突。

+   如果检查点被证明是合理的，则称之为合理：

    +   这是来源

    +   链接 c0 - <c 具有超过半数的支持率

如果存在一个超过半数的链接 c-> c0，且 c0 是 c 的重要子代，则检查点 c 被认为是最终的。同样，只有在 c 被证明合理时，c 才能被最终化。还必须有一个超过半数的链接 c - > c0，其中检查点 c 和 c0 不冲突，且 h (c0) = h (c) + 1。 (见图 5-9。)![../images/520777_1_En_5_Chapter/520777_1_En_5_Fig9_HTML.jpg](img/520777_1_En_5_Fig9_HTML.jpg)

图 5-9

合理的 r -> b1 -> b2 -> b3 链

EIP 1011 包含有关 Casper FFG 当前智能合约的信息。股东通过注册提交的智能合约成为合格参与者，该智能合约编码了 Casper FFG e，并可以通过以太坊交易访问。

在这里我们报告 CheckpointTimes() 函数（见图 5-10），然后是 Casper FFG（Casper the Friendly Finality Gadget）算法。![../images/520777_1_En_5_Chapter/520777_1_En_5_Fig10_HTML.jpg](img/520777_1_En_5_Fig10_HTML.jpg)

图 5-10

CheckPointVote()

接着我们报告卡斯珀 FFG，如图 5-11 所示。![../images/520777_1_En_5_Chapter/520777_1_En_5_Fig11_HTML.jpg](img/520777_1_En_5_Fig11_HTML.jpg)

图 5-11

CheckPointVote()

## 5.4 摘要

本章介绍了未来股权证明的范围，它将矿工替换为验证者，并使挖矿过程虚拟化。该章还讨论了基于链的股权证明，它使用了一个区块系统。

公共区块链如比特币和以太坊的流行引发了人们对区块链技术及其在最尖端商业应用中的使用的兴趣。要在分布式系统中使用区块链，您需要了解*超级账本* *的概念，它作为应用程序开发或模块化架构解决方案的基础。下一章将更详细地介绍超级账本。
