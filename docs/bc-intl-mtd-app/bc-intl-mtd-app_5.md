©作者（们），在独家授权下 Springer Nature 新加坡私人有限公司. 2021 郑子豪等人（编辑）区块链智能[`doi.org/10.1007/978-981-16-0127-9_5`](https://doi.org/10.1007/978-981-16-0127-9_5)

# 5. 区块链数据的不良行为检测

陈伟利^(1  )，崔佳慧^(1  )，郭雄风^(2  )，陈志光^(3  )和陆宇通^(3  )（1）中山大学数据科学与计算机学院，广州，中国（2）中山大学数字生活国家工程研究中心，广州，中国（3）中山大学广州国家超级计算中心，广州，中国陈伟利电子邮件：chenwli28@mail.sysu.edu.cn 崔佳慧电子邮件：cuijh6@mail2.sysu.edu.cn 郭雄风电子邮件：guoxf6@mail2.sysu.edu.cn 陈志光（通讯作者）电子邮件：zhiguang.chen@nscc-gz.cn 陆宇通电子邮件：yutong.lu@nscc-gz.cn

## 摘要

不良行为的普遍性导致了巨大的经济损失，从而破坏了加密货币的公众声誉，阻碍了区块链技术的发展。为了解决这个问题，本章讨论了几种在区块链上的不良行为类型和数据挖掘作为一种识别区块链上不良行为的手段。提出了两个针对以太坊上庞氏骗局和网络钓鱼诈骗的实用数据挖掘模型，并进行了详细的评估。

## 5.1 概述

金融安全一直是现实世界中货币系统的热点。随着区块链技术带来越来越多市值不断攀升的加密货币，其金融属性也吸引了各种骗局。由于生态系统中骗局的泛滥，识别这些不良行为已成为一个重要问题。

最近的研究（Vasek 和 Moore 2015）在比特币中确定了四种骗局类型，并发现有价值 1100 万美元的比特币被用于骗局，最多只有 400 万美元退还给受害者。然而，比特币生态系统中的骗局可能只是冰山一角，因为还有许多其他加密货币和包括洗钱（Moser 等人 2013）、赌博（Tasca 等人 2018）和黑市交易（Christin 2013）在内的广泛的其他非法活动。这些生态系统中的不良行为可能会阻碍用户接受和使用区块链技术，进而阻碍该技术的发展。

在区块链行为检测领域，已经提出了各种方法用于洗钱、钓鱼检测等。行为检测的主要问题是：区块链生态系统中存在哪些不良行为？这些不良行为如何在区块链上运作？根据*Chainalysis*的报告，区块链上的不良行为主要分为六类：^(1)

+   **洗钱：** 基于比特币的匿名性的洗钱，旨在隐藏非法收益的原始地址。然而，比特币并不提供真正的匿名性，因为交易被设计成涉及允许研究人员将来自特定用户的全部交易链接在一起的真名地址。随着主要比特币交易所鼓励更好的客户识别，比特币的混合服务（Bonneau 等人.2014）已经成为洗钱的必要技术。

+   **诈骗：** 随着加密货币的匿名性，诈骗行为也日益猖獗。来自*Chainalysis*的报告已经确定了加密货币生态系统中的六种诈骗类型：假币销售、庞氏骗局、钓鱼诈骗、报告的投资诈骗、敲诈和假混合器，其中庞氏骗局诈骗收入占绝大部分。

+   **勒索软件：** 随着勒索软件即服务（RaaS）的普及，技术不那么先进的黑客也能够利用其他黑客开发的勒索软件技术进行勒索软件攻击。然而，通过区块链分析很难估计勒索金额，因为许多公司出于对股价的考虑，更愿意支付赎金而不上报。

+   **黑客攻击：** 近年来发生了越来越多的加密货币黑客攻击。然而，Coincheck 的 5.34 亿美元攻击和 Mt.Gox 的 4.73 亿美元攻击仍然占据了总经济损失的大部分。随着混合服务的增加和复杂的诈骗策略，区块链上的黑客技术正在变得更为复杂。

+   **暗网市场：** 加密货币的金融性质不可避免地吸引了暗网市场。虽然毒品商店占据了主要部分，但基于区块链的暗网市场上也存在其他非法类别，包括被盗的信用卡信息和儿童性虐待材料。

+   **恐怖主义融资：** 基于区块链技术的去中心化和半匿名性质，恐怖主义融资给当局带来了新的挑战。代理商无法禁止此类交易，因为区块链上没有集中当局。此外，由于洗钱服务，追踪起源也面临困难。

对于国家当局来说，区块链技术非常新颖，其去中心化、半匿名的性质使得法律体系难以覆盖加密货币生态系统。因此，识别这些不良行为面临很大困难。

为了解决这一关键挑战，已经提出了各种不同的方法来应对不同的问题。在这些方法中，我们最感兴趣的是利用数据挖掘方法来识别诈骗行为，在本章中，我们提出了两种针对区块链生态系统中庞氏骗局和网络钓鱼骗局检测的方法。

本章的其余部分组织如下：第 5.2 节介绍了作为一种区块链中不当行为检测方法的数据分析。第 5.3 节展示了我们在以太坊上识别庞氏骗局方面的成果。第 5.4 节展示了一种基于以太坊的网络钓鱼骗局检测方法，第 5.5 节对本章进行了总结。

## 5.2 区块链上的数据分析

尽管如此，加密货币的去中心化和匿名特性使得整个生态系统充斥着犯罪行为，给受害者带来了相当大的经济损失。但另一方面，其透明性也让它与传统货币形式区分开来，这使得我们可以利用数据挖掘方法对区块链进行分析。

区块链中的数据大致可以分为两类：链上数据和链下数据。前者指的是记录在区块链账本中的、可以向公众公开的交易数据。链下数据通常指的是包括主要交易所的交易价格和交易记录在内的市场参数。根据不同的分析工具，数据分析方法可以分为三组：复杂网络分析、数据挖掘方法和统计方法。

### 5.2.1 基于复杂网络的分析

由于记录在区块链上的大部分数据都是交易数据，因此链上分析方法主要关注交易。在这些研究中，将交易模型化为图形数据库，并使用复杂网络技术研究网络是主要方法（Chan 和 Olmsted 2017；Lischke 和 Fabian 2016）。基于比特币的研究有很多，例如比特币地址研究（Fleder 等人 2015）和利用社区检测跟踪比特币用户活动（Remy 等人 2018）。由于智能合约的引入，以太坊的情况更为复杂：交易可能涉及用户和智能合约（Chen 等人 2018a）。

### 5.2.2 基于数据挖掘方法的分析

区块链用户的迅速增加和公开可访问的特点为数据分析提供了一个前所未有的平台。已经提出了一个同时考虑离链信息和链上信息的聚类模型，用于比特币地址关联（Ermilov 等人 2017）。在（Harrigan 和 Fretter2016）中评估了各种地址聚类方法的有效性，并提出了一个模块化框架，用于可视化从比特币网络中提取的复杂信息（Spagnuolo 等人 2014）。区块链上的交易分析对投资者具有吸引力。已经使用从链上信息和离链信息中提取的常见特征构建了几种比特币价格预测模型，这些模型基于递归神经网络（RNN）和长短期记忆（LSTM）（Jang 和 Lee2017；McNally 等人 2018）。

### 5.2.3 基于统计工具的分析

离链信息下的加密货币交易价格具有重要意义。由于价格直接以时间序列呈现，时间序列分析在此领域中被广泛使用。与交易价格相关的方面，检测其决定因素引起了广泛关注。因此，已经引入了多种模型来研究主要驱动因素，包括 VSM 模型（Georgoula 等人 2015）、VECM 模型（Ciaian 等人 2016）、ARDL 方法（Bouoiyour 和 Selmi2015）、小波相干分析（Kristoufek2014）、Copula 方法（Osterrieder 等人 2017）等。

由于去中心化和匿名服务的存在，基于数据分析方法的区块链监管不可避免地遇到障碍。与集中式系统不同，我们无法控制交易的验证，也无法轻易追踪非法行为的源头。但是，至少通过适当的工具，公开可访问的区块链账本可以为我们提供有关区块链上犯罪模式的独特见解。

## 5.3 案例研究：庞氏骗局检测

### 5.3.1 以太坊上的庞氏骗局

在众多利用区块链技术开发的项目中，以太坊是最具活力的平台之一。以太坊是一个开源的去中心化平台，通过以太坊矿工生成的加密货币——以太币。以太坊提供了一个图灵完备的虚拟机——以太坊虚拟机（EVM），用于执行智能合约。智能合约是以太坊用户发布的脚本，当某些预设条件满足时，由 EVM 自动执行（Buterin2014; Szabo1996），即，接收一个消息调用。智能合约的执行不依赖于可信的权威，也无法被修改。智能合约可以应用于各种领域，包括物联网、去中心化组织的合作，甚至可以在犯罪场景中使用（Christidis 和 Devetsikiotis2016; Juels 等 2016; Norta2015）。支持智能合约的区块链平台被称为第二代区块链（CoinDesk2017）。

任何新生技术都不可避免地存在可以被对手诈骗利用的漏洞。例如，电子邮件的发展导致了垃圾邮件的泛滥。作为一种新兴技术，区块链也因其去中心化、匿名特性以及监管的缺失而吸引了相当数量的诈骗类型。在这些诈骗中，一种经典的欺诈形式——庞氏骗局，也在区块链上有了实施（Bartoletti 等 2020; Vasek 和 Moore2015）。庞氏骗局以一个臭名昭著的欺诈犯的名字命名，最早在 1920 年代实施，它是一种欺诈性的投资操作，通过最近投资者的资金来吸引投资者并给早期投资者带来利润，而不是通过合法的商业活动或金融交易的利润（Wikipedia2017）。

事实上，大多数人会在庞氏骗局中失去他们的投资，这导致了许多国家禁止庞氏骗局。当涉及到区块链技术时，庞氏骗局正在从那些想要参与区块链技术、在区块链市场中投机的冲动投资者那里获得相当的利润，而这些投资者对区块链如何运作的了解却很少（Stan Higgins2015; Keirns2017; MORRIS2017）。最近的研究发现，从 2013 年 9 月 2 日至 2014 年 9 月 9 日，各种比特币诈骗在一段时间内筹集了超过 700 万美元（Vasek 和 Moore2015）。

在以太坊领域，许多庞氏骗局都隐藏在*智能合约*之下（Bartoletti 等人 2020)。换句话说，它们是以太坊上部署的智能合约实现的。这些庞氏骗局被称为*智能*庞氏骗局，相应的智能合约被称为*庞氏骗局合约*。在庞氏骗局的各种实现中，庞氏骗局的一个关键属性是需要受害者持续和长期的投资。从这个意义上说，智能合约是实现庞氏骗局的一种理想方法。一旦智能合约在以太坊上发布，当局无法终止它，它将永久运行在以太坊上。最重要的是，由于区块链技术的半匿名性，庞氏骗局的推广者保持某种匿名性。图 5.1 展示了典型智能庞氏骗局的海报。海报上的文字如下：

> 你好！我的名字是 Rubixi！我是新审核过的以太坊区块链上的金字塔智能合约。当你给我 1 个以太坊时，当余额充足时，我会将金额翻倍并发送到你的地址。我的乘数因子是动态的（**最小 x1.2，最大 x3**），因此我的支付速度加快，**保证**在未来几个月内支付！../images/506524_1_En_5_Chapter/506524_1_En_5_Fig1_HTML.png
> 
> 图 5.1
> 
> 智能庞氏骗局（Rubixi）的宣传图片。（来源：[`​bitcoindtalk.​org/​index.​php?​topic=​1400536.​0`](https://bitcoindtalk.org/index.php?topic=1400536.0))

根据口号，这个智能合约看起来相当有利可图，回报期似乎是有保证的。然而，实际情况远非如此描述。通过手动检查，我们发现有 112 个参与者加入了该合约，而只有 22 个参与者获得了收益。其中，盈利最高的两个参与者获得了超过 40%的收益，其中一个是合约的创建者。不幸的是，大多数参与者没有收到承诺的利润。

上述示例展示了一个成功的庞氏骗局的实例，并说明了检测智能庞氏骗局的重要性。尽管一些用户明确知道参与庞氏骗局可能会损失（Moore 等人 2012; Neisius 和 Clayton2014)，但自动检测庞氏骗局仍然具有重要意义，原因如下。（1）有些人难以理解区块链是如何工作的，这使得他们难以区分区块链上的欺诈行为。（2）对于国家当局来说，区块链技术非常新颖，这使得区块链处于某种法律体系的灰色区域（Elwell 等人 2013)，在一定程度上，纵容了诈骗的发展。因此，开发自动智能庞氏骗局检测技术是一项关键任务。

由于区块链的半匿名性质，检测以太坊上的庞氏骗局合约并非易事。庞氏骗局合约由相应的源代码组成，因此可以手动检查合约代码以确定它是否是庞氏骗局合约。然而，这种方法也带来了困难。那就是，以太坊不需要智能合约的创建者披露源代码。换句话说，智能合约在以太坊上发布只需要字节码。实际上，在以太坊上运行的超过一百万个合约中，只有不到四千个拥有验证过的源代码。^(2) 这使得从源代码检测庞氏骗局合约变得不切实际。因此，提出了各种各样的问题：以太坊上有多少庞氏骗局合约？它们的特点是什么？它们造成了多少损失？为了回答这些问题，首要的步骤是回答以下问题：如何在没有源代码的情况下检测庞氏骗局合约？

在这本书中，我们将智能庞氏骗局检测问题定义为一个分类问题。为了建立一个有效的分类模型，需要有足够的带有*标签*的有效特征的智能合约，这些特征不包括源代码特征。图 5.2 展示了本书提出的方法的总体框架。如图所示，首先下载了 3071 个经过验证的智能合约，包括正常交易、触发交易和源代码。然后将源代码编译成字节码，这些字节码在以太坊上是公开可访问的。此外，字节码被反汇编成操作码（详细信息见 Sect. 5.3.2）。接下来，我们从记录的交易中提取账户特征，从操作码中提取代码特征。最后，基于这些特征提出了一个 XGBoost 分类模型。![../images/506524_1_En_5_Chapter/506524_1_En_5_Fig2_HTML.png](img/506524_1_En_5_Fig2_HTML.png)

图 5.2

智能庞氏骗局检测框架

本节的一个关键贡献是对在合约创建时刻检测智能庞氏骗局的可行性进行了实验验证。因为我们从公开可访问的操作码中提取了代码特征。这一结果具有重要意义，因为通过使用该模型，我们可以：(1)即使源代码被故意隐藏也能检测出智能庞氏骗局；(2)在它造成任何损害之前检测出智能庞氏骗局；(3)基于它建立一个风险预警平台。

### 5.3.2 以太坊和智能合约

由于已经在第二章中介绍了以太坊平台及其状态交易机制，因此本节简要介绍了 Ponzi 计划合约的源代码片段。此外，操作码，字节码的助记形式和我们模型中的主要功能来源也得到了介绍。

#### 5.3.2.1 一个智能 Ponzi 计划的源代码片段

通常，以太坊上的智能合约是用高级语言编写的。在各种高级语言中，*Solidity*是一种面向合约的广泛使用的语言，在以太坊平台上起着重要的作用。

清单 5.1 简化的 Rubixi![../images/506524_1_En_5_Chapter/506524_1_En_5_Figc_HTML.png](img/506524_1_En_5_Figc_HTML.png)

为了更好地理解如何区分 Ponzi 计划和稳固的源代码，我们提取了 Rubixi 合约代码的主要部分（清单 5.1），它确定了这个合约正在实现 Ponzi 计划的函数。一般来说，智能合约包含两个组件：函数和数据结构。函数可以通过其他账户或合约的交易或消息调用。数据结构是存储智能合约数据的部分，在合约执行期间可能随时更新。

考虑 RUBIXI 合约的源代码；第 2-11 行是数据定义，用于描述合约的当前状态。例如，变量*balance*描述合约当前的余额，数据结构*Participant*描述参与 Ponzi 计划的投资者的地址和余额。第 14 行的函数在合约创建时只运行一次。

第 17 行无名的函数，只包含对*addPayout*的函数调用，被称为*fallback 函数*。*fallback 函数*仅在账户向合约地址传输一些以太币而不带数据时调用。第 19 行定义的*addPayout*是实现 Ponzi 计划主要逻辑的核心部分：（1）记录投资者的地址和投资（第 21-22 行）；（2）计算费用（第 28 行）；（3）当合约余额满足某些条件时向之前的投资者支付（第 29-34 行）。

第 12 行定义的数组*participants*记录了所有投资者的顺序，包括地址(*msg.sender*)和支付(*payout=msg.value *pyramidMultiplier)/100*)。请注意，传播的高利润（见图 5.1）由变量*pyramidMultiplier*控制，最初在第 6 行设置为 300，但从第 10 个参与者减少到 200（第 23 行），从第 25 个参与者减少到 150（第 25 行）。显然，为了吸引早期参与者，合约所有者承诺给他们更高的利润。值得注意的是，*pyramidMultiplier*应该设置为超过 100，以保证参与者的利润。

从代码片段中可以清楚地看出，Rubixi 对每个投资收取 10%的费用，收费是通过在第 37 行调用函数*collectAllFees*来实现的。从第 29 行到第 34 行的 while 循环试图按照投资顺序支付所有前一个参与者，直到余额不足。这段代码清楚地显示了合约支付的逻辑，这显然可以被识别为庞氏骗局。

正如代码片段所示，智能合约可能发生两种交易：普通交易和已触发交易。这些交易是公开的，可以通过提供的 API 从 ethereum.io^(3)下载。

#### 5.3.2.2 部署合约

如上所述，以太坊合约是一系列“以太坊虚拟机代码”或“EVM 代码”的集合，这些代码存储在以太坊区块链上。我们称这个合约的*bytecode*。为了方便编写智能合约，使用了一种高级语言（例如*Solidity*语言）。因此，要部署合约，首先要将源代码编译成 EVM bytecode。EVM bytecode 由一系列字节组成。每个字节都是一个操作。为了人类可读性，每个操作都与一个助记词相对应。例如，EVM bytecode 0x10 的助记词形式是 LT，这意味着小于比较。我们称 LT 以及这样的 EVM bytecode 为*opcode*。以太坊黄皮书附录（Wood 2014）包含 EVM bytecode 及其助记词形式的完整列表，即 opcode。可以使用反汇编器^(4)从 bytecode 获取合约的操作码。操作码由一系列*opcode*和*操作数*组成。例如，Rubixi 的操作码的前五行是：*PUSH1 0x60; PUSH1 0x40; MSTORE; CALLDATASIZE; ISZERO*。*PUSH1*是一个操作码，*0x40*是一个操作数。

为了使合约能够从其他账户调用，智能合约的 bytecode 应该部署在以太坊主网络上。针对零账户（地址为 0 的账户）的特殊交易创建一个新的合约。合约的 bytecode 作为该交易的负载，并将被执行；执行结果将存储在新合约账户的代码字段中，并永久记录在区块链上，直到合约被创建者杀死。新合约的地址将返回给创建者，然后可以与其他人分享。

### 5.3.3 数据、特征提取和分类模型

为了建立一个有效的智能庞氏骗局检测模型，从网站 [`etherscan.io`](http://etherscan.io) 收集了 1382 个经过验证的智能合同。根据之前的研究（Bartoletti 等人 2020），这些智能合同经过手工检查，以确定其是否为智能庞氏骗局。我们重新检查了结果并将它们整理为我们模型中的真实数据。具体来说，收集了 131 个庞氏骗局合同和 1251 个非庞氏骗局合同。为了建立模型，我们下载了相应数据并从数据中提取了两个类别的特征。本节提供了数据和特征的概述。还介绍了特征提取方法。

#### 5.3.3.1 数据

图 5.2 说明了存储在以太坊平台上的两种数据的收集过程，包括交易和源代码。交易数据包含正常交易和以 JSON 文件形式触发的交易。所有这些数据都是通过 etherscan.io 提供的 API 收集的。^(5) 请访问我们的网站^(6) 以获取更详细的信息。值得注意的是，由于 ethescan.io 的限制，只能下载最后 10000 笔交易。然而，这个限制对我们研究的影响很小，被忽略了。

分析智能合同的源代码能够对检测合同实施的功能做出相当大的贡献。然而，在以太坊上，开源代码不是强制性的，尽管建议进行公共审查。为了建立一个实用的庞氏骗局检测模型，我们只依赖存储在以太坊区块链上的公开可访问的字节码。对于标记的智能合同，我们首先通过以太坊本地客户端将源代码编译成字节码。然后利用反汇编工具获取操作代码。最后，我们从操作代码中提取操作码并计算它们的出现次数。

#### 5.3.3.2 账户特征

由于庞氏骗局合同的欺诈性质，一些特征可以用来识别这些合同。至少有三个特征可以将庞氏骗局合同与常见的智能合同区分开来：(1) 庞氏骗局合同总是向已经投资的账户发送以太币。 (2) 在参与者中，一些账户会收到比投资更多的付款，例如合同的创建者。 (3) 合同的余额可能总是处于较低的范围，因为庞氏骗局试图维持快速和高回报的印象以吸引新投资者。

庞氏骗局的内在特性决定了其行为，这可以帮助我们检测庞氏骗局合约。这些行为的一种表现形式是以太坊流动。我们从交易记录中提取*以太坊流动图*来分析这些行为特征。与常用的现金流动图不同，以太坊流动图用来表示合约与参与者之间的交易。这些交易有两个方向：从参与者到合约和从合约到参与者。我们称第一个方向为投资交易，第二个方向为参与者的支付交易。在图中，投资交易用红色圆圈表示，支付交易用绿色三角形表示。*x*轴代表时间线，而*y*轴代表个体参与者。图展示了每个参与者在时间线上的交易。交易的以太坊金额通过圆圈或三角形的大小反映出来。合约与参与者之间的交易按照交易时间戳的顺序排列在水平线上。参与者按照与合约的第一次交易的时间戳顺序排列。因此，第 0 个参与者通常是合约的创建者。通常，在正常经济活动中，投资交易应该伴随着支付交易，但在智能庞氏骗局中并非如此。

图 5.3 和 5.4 展示了两个合约的以太坊流动图：Rubixi 和 LooneyLottery。Rubixi 是一个典型的智能庞氏骗局，而 LooneyLottery^(7)是一个正常的彩票游戏合约。Rubixi 合约的以太坊流动图（图 5.3）显示，合约的创建者和其早期参与者是游戏的赢家。合约中有大约 120 个参与者，但大部分支付都与前 25 个幸运的参与者有关。值得注意的是，第 54 个参与者（在图中以灰色虚线表示）的行为异常，因为他们只发送了两次，但收到了许多支付。这种异常行为是因为源代码中有一个漏洞，可以用来更改合约的拥有者并收取费用（Atzei 等人 2017）。![../images/506524_1_En_5_Chapter/506524_1_En_5_Fig3_HTML.png](img/506524_1_En_5_Fig3_HTML.png)

Fig. 5.3

典型的庞氏骗局合约 Rubixi 的以太坊流动图

![../images/506524_1_En_5_Chapter/506524_1_En_5_Fig4_HTML.png](img/506524_1_En_5_Fig4_HTML.png)

Fig. 5.4

典型的非庞氏骗局合约 LooneyLottery 的以太坊流动图

两个数字之间存在显著差异。一方面，图 5.3 中有更多的参与者。然而，这些参与者和合约之间的互动很少。相比之下，图 5.4 显示合约涉及的参与者较少，但投资显著增多。另一方面，图 5.3 中的大部分支付都与前序参与者有关，但图 5.4 中的支付表现出更多随机性。这些差异可以通过合约的函数轻易得出。因此，反过来，账户行为可以用来分类智能合约。

通过检查 Rubixi 的以太坊流动图，我们可以发现：(1) 支付交易通常在投资交易之后发生，这表明合约通常向已知的账户支付；(2) 但许多投资交易没有跟随的支付交易；(3) 一些参与者的支付交易多于投资交易。基于这些观察和特点，我们从合约中提取了以下七个关键特征：

+   *Known rate (Kr):* 支付前已经投资的接收者的比例。*Kr*高意味着合约与已知的账户交互更多。我们期待智能庞氏合约的*Kr*非常高。

+   *Balance (Bal):* 智能合约的余额。

+   *N_investment (N_Inv):* 投资次数。

+   *N_payment (N_pay):* 支付次数。

+   *Difference index (D_ind):* 这个指数用于衡量合约中所有参与者支付次数与投资次数的差异。假设合约有关联*p*个参与者，*v*是一个长度为*p*的向量，*m*[*i*] 和 *n*[*i*] 分别表示第*i*个参与者的投资次数和支付次数。计算差异指数时，向量*v*的每个元素首先通过 *v*[*i*] = *n*[*i*] − *m*[*i*] 来计算，然后![    $$\displaystyle \begin{aligned}D\_ind=\left\{\begin{array}{ll} 0 &amp; if\ v=0\ or\ p \leq 2;\\ s &amp; otherwise \end{array} \right. \end{aligned}$$    ](img/506524_1_En_5_Chapter_TeX_Equa.png)其中*s*是向量*v*的偏度。对于一个智能庞氏合约，D_ind 通常是负的，因为许多参与者投资多而获得少。

+   *Paid rate (Pr):* 收到至少一次支付的投资者比例。

+   *N_maxpay (N_max):* 参与者支付次数的最大值。

表 5.1 展示了提取特征的三种统计数据：平均值、中位数和标准差（SD）。表格分为两部分：上半部分是所有庞氏合约的结果，下半部分是非庞氏合约的结果。表 5.1

提取的账户特征统计数据

|   | Kr | Bal | N_inv | N_pay | D_ind | Pr | N_max |
| --- | --- | --- | --- | --- | --- | --- | --- |
| *庞氏合约* |
| Mean | 0.89 | 4.65 | 56.84 | 92.49 | − 1.04 | 0.62 | 36.12 |
| 中位数 | 1.00 | 0.26 | 17.00 | 21.00 | − 0.65 | 0.66 | 11.00 |
| Sd | 0.29 | 15.51 | 119.41 | 204.71 | 1.95 | 0.30 | 94.36 |
| *非庞氏合约* |
| 平均值 | 0.49 | 22319.60 | 653.44 | 540.74 | − 0.51 | 0.43 | 237.95 |
| 中位数 | 0.50 | 0.10 | 6.50 | 4.00 | 0.00 | 0.40 | 2.00 |
| Sd | 0.43 | 187549.23 | 3986.45 | 2195.42 | 6.05 | 0.41 | 1095.08 |

从表中可以看出，庞氏合约与非庞氏合约在这些特征的统计上存在显著差异。例如，已知愤怒（Kr）的平均值在庞氏合约中为 0.89，在非庞氏合约中仅为 0.49。庞氏合约的高 Kr 值意味着这些合约总是向它们的投资者支付，这是典型庞氏合约的特征。至于余额（Bal），两个合约的中位数非常接近，但标准差的差异非常显著。庞氏合约的低 Bal 标准差表明，大多数庞氏合约的余额非常低。另一方面，非庞氏合约的高标准差表明，尽管非庞氏合约的平均余额较低，但一些合约的余额相对较高。同时，非庞氏合约余额的中位数仅为 0.1，这意味着非庞氏合约中有一半的合约余额低于 0.1。实际上，许多非庞氏合约的余额为零。

#### 5.3.3.3 代码特征

操作码在分析智能合约的潜在问题时具有重要意义，因为它在一定程度上反映了从 EVM 代码的角度来看智能合约的逻辑（Atzei 等人 2017; Chen 等人 2017）。因此，我们期望从操作码中提取的一些特征有助于检测潜在的庞氏合约。在这本书中，我们从字节码中提取了操作码，这是在以太坊上公开可用的，并统计了它们的出现次数。结果，在 1382 个合约的操作码中发现了 64 个不同的操作码。

图 5.5 展示了前述两个智能合约的操作码云。最常出现的三个操作码，PUSH，DUP 和 SWAP，被移除以使图形更易见。这是因为 EVM 是基于堆栈的，这些操作码在每一个合约中频繁出现。![../images/506524_1_En_5_Chapter/506524_1_En_5_Fig5_HTML.png](img/506524_1_En_5_Fig5_HTML.png)

图 5.5

瑞比希（左）和洛尼彩票（右）的操作码云

尽管通过观察操作码的词云图来判断智能合约的类型几乎是不可能的，但两个合约的词云图仍然明显不同。直观上，至少有两个显著的区别：Rubixi 的操作码集中包含更多的判断，而 LooneyLottery 的操作码集中包含更多的随机性。实际上，第一个区别是明显的，因为 Rubixi 合约包含更多的 JUMPI（7.8%），而 LooneyLottery 合约包含更多的 JUMP（2.6%）。这些指令之间的区别是前者是后者的条件版本。发现第二个区别需要更多的观察。LooneyLottery 合约包含 4 个 TIMESTAMPs，而 Rubixi 一个也没有。这个差异的原因是操作码 TIMESTAMP 用于获取区块的时间戳，这是在系统中获取随机值的常用指令。上述分析表明，操作码特征可能有助于检测庞氏合约。

#### 5.3.3.4 分类模型

为了利用上述提取的特征，以高准确度、低误报率区分庞氏合约与非庞氏合约，我们使用了广泛应用于机器学习领域的算法 XGBoost，该算法已在许多问题中表现出良好的性能（Chen 和 Guestrin 2016a）。本节提供了 XGBoost 的简单介绍及其参数。

XGBoost 是“Extreme Gradient Boosting”的缩写，是梯度提升树（Friedman 2001）的改进版本。与 GBM 不同，XGBoost 引入了两项重要的改进：正则化和树剪枝。基本来说，XGBoost 在目标函数中提供了正则化，用于避免基于树的模型过拟合。同时，它将树剪枝方法从遇到负损失时停止更改为后剪枝。

具体来说，假设数据集中有*N*个智能合约 {(*x* [*i*], *y* [*i*]) | *i* = 1, 2, …, *N*}，其中*x* [*i*] ∈ *R* ^(*d*)是与第*i*个智能合约相关的提取特征，*y* [*i*] ∈{0, 1}是分类标签，当且仅当智能合约是一个经过验证的庞氏合约时，*y* [*i*] = 1。我们使用 XGBoost 旨在最小化以下目标函数：![$$\displaystyle \begin{aligned} Obj(\theta) = L(\theta) + \Omega(\theta), \end{aligned} $$](img/506524_1_En_5_Chapter_TeX_Equ1.png)(5.1)

其中*L*是训练损失函数，Ω是正则化项。训练损失函数衡量模型在训练数据上的预测能力，正则化项惩罚模型的复杂度，有助于避免过拟合。

$$\displaystyle \begin{aligned} \hat{y}_i^{(0)} &amp;= 0 \\ \hat{y}_i^{(1)} &amp;= f_1(x_i) = \hat{y}_i^{(0)}+f_1(x_i) \\ \hat{y}_i^{(2)} &amp;= f_1(x_i) + f_2(x_i) = \hat{y}_i^{(1)} + f_2(x_i)\\ &amp; \cdots \\ \hat{y}_i^{(t)} &amp;= \sum_{k=1}^t f_k(x_i) = \hat{y}_i^{(t-1)} + f_t(x_i). \end{aligned} $$

$$\displaystyle \begin{aligned} L(\theta) = \sum_i[y_i \ln(1+e^{-\hat{y}_i})+ (1-y_i)\ln(1+e^{\hat{y}_i})]. \end{aligned} $$

](../images/506524_1_En_5_Chapter/506524_1_En_5_Chapter_TeX_Equ2.png)(5.2)

For the learning process, XGBoost introduces *additive training*, which starts from constant prediction and adds new function each time as follows:![

and XGBoost aims to find the best *f* [*t*] to minimize this function at each step. To grow the tree, it tries to add the best split of a feature that maximizes *gain* on each leaf nodes. XGBoost adopts the post-pruning method

$$\displaystyle \begin{aligned} \Omega(f) = \gamma T + \frac{1}{2} \lambda\sum_{j=1}^T \omega_j², \end{aligned} $$

$$\displaystyle \begin{aligned} f(x) = \omega_{q(x)},\ \ \omega \in R^T,\ q\ : R^d\rightarrow \ \{1,2,\ldots,T\}, \end{aligned} $$

对于正则项，首先要重新定义一棵树，使其便于测量复杂度。在 XGBoost 中，一棵树是一个将实例映射到叶权重的一个函数。具体地，![To ensemble trees, the objective function is rewritten as follows:![$$\displaystyle \begin{aligned} Obj= \sum_{i=1}^n l(y_i,\hat{y}_i) + \sum_{k=1}^K\Omega(f_k), \end{aligned} $$](img/506524_1_En_5_Chapter_TeX_Equ5.png)(5.5)

where ![](img/506524_1_En_5_Chapter_TeX_Equ7.png)(5.7)

](../images/506524_1_En_5_Chapter/506524_1_En_5_Chapter_TeX_Equ6.png)(5.6)

$$\hat {y}_i = \sum _{k=1}^K f_k(x_i)$$

通过应用上述方程，目标函数可以写成![](img/506524_1_En_5_Chapter_TeX_Equ4.png)(5.4)

$$\displaystyle \begin{aligned} Obj^{(t)} = \sum_{i=1}^n l(y_i,\hat{y}_i^{(t-1)} + f_t(x_i)) + \Omega(f_t) + constant, \end{aligned} $$

where *γ* and *λ* 是模型的参数。

](../images/506524_1_En_5_Chapter/506524_1_En_5_Chapter_TeX_IEq1.png), *K* 是树的数目。

### 5.3.4 实验结果与特征分析

在本节中，我们展示了我们的实验结果。首先，我们描述了实验设置和评估指标。然后，总结了基于两种提取特征类别比较的实验。最后，我们分析了特征的重要性。

#### 5.3.4.1 实验设置

数据集为了比较这两种特征的区分能力，我们使用了以下三种特征进行相应实验：账户、操作码以及两者的组合。对于这三种实验，我们使用了五折交叉验证来为模型找到最佳参数。然后我们将相应数据分为 80%作为训练集和 20%作为测试集，并使用找到的最佳参数进行十次实验。实验的平均结果在表 5.2 中展示。表 5.2

特性表现比较

| 特征 | 精确度 | 召回率 | F 分数 |
| --- | --- | --- | --- |
| 账户 | 0.74 | 0.32 | 0.44 |
| 操作码 | 0.90 | 0.80 | 0.84 |
| 账户 + 操作码 | 0.94 | 0.81 | 0.86 |

评估指标

与分类问题中常用的错误率指标不同，我们使用三个指标，精确度、召回率和 F 分数，来评估模型的表现。

#### 5.3.4.2 结果总结

表 5.2 总结了三种特征在检测智能庞氏骗局中的表现。从表中可以得出几个结论。首先，令人惊讶的是，本次实验中的账户特征并不有效。我们本期望账户特征会有良好的表现，因为在上述分析中我们发现两类合约在这方面有显著差异。然而，低召回率表明，仅使用账户特征训练的模型无法将庞氏合约与非庞氏合约区分开来。相反，操作码特征在分类中非常有效。导致这一结果的原因可能是许多智能合约仍然处于实验阶段，这使得从其行为中检测其类型变得困难。实际上，许多智能合约没有交易记录。另一个可能的原因是，与操作码特征相比，账户特征的数量太少。此外，相应的指标显示，仅使用操作码特征训练的模型在庞氏合约检测中是有用的。最后，通过将操作码特征与账户特征结合，可以提高这种模型的性能。

#### 5.3.4.3 特征分析

为了进一步了解提取特征的区分能力，我们在图 5.6 中展示了十个最重要的特征。图中的操作码描述总结在表 5.3 中。![../images/506524_1_En_5_Chapter/506524_1_En_5_Fig6_HTML.png](img/506524_1_En_5_Fig6_HTML.png)

图 5.6

十个最重要特征的重要性

表 5.3

Opcode 及其描述

| Opcode | 描述 |
| --- | --- |
| GASLIMIT | 获取区块的 gas 限制 |
| EXP | 指数操作。 |
| CALLDATALOAD | 获取当前环境的开头数据 |
| SLOAD | 从存储中加载单词 |
| CALLER | 获取调用者地址 |
| LT | 小于比较 |
| GAS | 获取可用 gas 的数量 |
| MOD | 取模余数操作 |
| MSTORE | 将单词保存到内存中 |

可以看出，最重要的特性是 GASLIMIT，这是一个用于获取区块 gas 限制的指令。为了更好地理解为什么 GASLIMIT 是最重要的特性，我们首先计算了使用此指令的智能合约的数量。我们发现，57%的庞氏骗局合约正在使用这个指令，而只有 4%的非庞氏骗局合约在使用它。因此，与非庞氏骗局合约相比，庞氏骗局合约更倾向于参考区块的 gas 限制。然而，这个结论某种程度上与常识相悖，因为庞氏骗局的逻辑不需要获取区块的 gas 限制。为了找到真正的原因，我们选择了使用 GASLIMIT 指令的一些庞氏骗局合约的源代码，以找出什么样的源代码会导致这个指令。结果是，这些合约通常使用 Oracle 的 API，这导致了 GASLIMIT opcode。

另一个值得注意的 opcode 是 CALLER，这是一个用于获取调用者地址的指令。请注意，庞氏骗局合约需要记录投资者的地址，以便将来向他们支付资金。其余的 opcode 主要与算术操作相关。

总的来说，这些指令似乎反映了一种特殊的合约类型：这些合约有更多的支付交易，需要记住调用者的地址，并且主要由算术计算组成。如预期一样，庞氏骗局合约属于这种类型的合约。

对于账户特性，只在最重要的十个特性中发现了一个特征（D_ind）。这并不是一个令人惊讶的结果，因为如第 5.3.3.2 节分析，庞氏骗局合约与非庞氏骗局合约在这个特征上的差异非常显著。

#### 5.3.4.4 应用

为了估计以太坊上庞氏骗局合同的总数，先前的研究已经比较了它们的字节码以检测隐藏的庞氏骗局合同（没有公开可访问源代码的庞氏骗局合同）(Bartoletti 等人 2020)。研究发现了 54 个隐藏的庞氏骗局合同。为了通过与先前研究的比较验证我们方法的可靠性，我们只用代码特征来预测这 54 个隐藏的庞氏骗局合同。结果显示，54 个合同中有 45 个（83%）被我们的模型分类为庞氏骗局合同。为了了解为什么剩下的 9 个合同没有被我们的模型识别，我们手动检查了它们的交易记录。以下是发现：

+   实际上有两个合同有源代码。^(9)它们指的是 github 上的同一个项目。^(10)通过阅读简介页面并检查源代码，可以发现它不是一个智能庞氏骗局，而是一种游戏。我们的模型成功地排除了它。

+   一个合同^(11)只与创建者互动。虽然我们不能说它不是一个智能庞氏骗局，但从交易记录来看，它更像是一个测试交易合同。另一个合同，^(12)成功进行了五次交易，但只向一个不熟悉的地址支付了一次，可能是智能庞氏骗局，因为余额相对较大，交易模式不符合 Bartoletti 等人总结的任何智能庞氏骗局(2020)。

+   一个合同，^(13)只有一个大于 0 的交易（包括正常和已触发交易），并且所有已触发的交易都是来自未知账户的函数调用，不能是一个智能庞氏骗局。在另一个合同中也可以找到类似的情况。^(14)

+   两个合同的支付顺序^(15)很奇怪。参与人数很少，但前一部分参与者比后一部分参与者晚收到支付，这表明它们可能不是智能庞氏骗局。

+   最后一个合同，^(16)其行为与智能庞氏骗局相似，但支付金额超过投资金额，很难得出结论。

这些发现表明，我们的模型可以比比较字节码的相似性更准确地检测到庞氏骗局合同。

为了估计在以太坊上运行的庞氏骗局合同的数量，我们首先下载了所有在 2017 年 5 月 7 日之前创建的合同（与（Bartoletti 等人 2020）相同的时间范围）。我们总共获得了 280704 个合同。根据我们提出的模型，我们从这些合同的字节码中提取了相应的操作码特征，然后使用这些特征进行预测。我们的模型发现了 386 个庞氏骗局合同（包括验证过的合同）。因此，估计可能有 434（386×*精确度*÷*召回率*）个庞氏骗局在以太坊上运行，占 2017 年 5 月 7 日之前总合同数的 0.15%。图 5.7 说明了模型预测的每个分数（概率）下庞氏骗局合同的数量。可以看出，大多数合同得分很高，这表明问题可能比预期的更严重。实际上，最近的研究中只发现了 191 个庞氏骗局合同（Bartoletti 等人 2020），这个数字远低于我们的估计。![../images/506524_1_En_5_Chapter/506524_1_En_5_Fig7_HTML.png](img/506524_1_En_5_Fig7_HTML.png)

图 5.7

检测到的智能庞氏骗局数量及分数（概率）

### 5.3.5 相关工作

自比特币诞生以来，区块链技术成为了研究的热点。文献中可以找到三种类型的研究。第一种类型关注于底层机制。提出了许多共识机制，例如权益证明（PoS）（King 和 Nadal 2012），实用拜占庭容错（PBFT）（Hyperledger 2015；Mazieres 2015），以及 Ripple（Schwartz 等人 2014）。此外，一些研究专注于改进现有机制（Decker 等人 2016）。第二种类型讨论区块链技术的应用。由于区块链技术有许多有利特性，在金融服务（Kondor 等人 2016；Peters 和 Panayi 2016）、物联网（IoT）（Christidis 和 Devetsikiotis 2016；Conoscenti 等人 2016）和社会服务（Namecoin 2014）等领域都可以找到许多应用。最后但最相关的一种类型的工作是在区块链上进行数据挖掘。得益于公开可访问的特性，区块链为数据分析提供了前所未有的机会来回答各种问题，例如使用特性（Meiklejohn 等人 2016；Ron 和 Shamir 2013；Yelowitz 和 Wilson 2015），匿名性（Androulaki 等人 2013；Reid 和 Harrigan 2013），以及经济行为分析（Kondor 等人 2014a，b）。更多信息可以在调查报告（Zheng 等人 2017）中找到。

随着互联网的发展，在线“高收益”投资计划（HYIP）已成为庞氏骗局的典型形式。通过对 HYIP 网站收集的数据进行分析（Moore 等人 2012），提供了初步的经济分析。在（Neisius 和 Clayton2014）中进行了更详细的研究，其中提出了一个模型来估算 HYIP 的营业额和利润。这两篇文章都关注使用集中虚拟货币的 HYIP。区块链技术的创建使得加密货币成为骗子理想的货币。在区块链中，账本记录每一笔交易，并且这些交易可以公开访问。研究人员可以因此获得宝贵数据，以调查区块链上的骗局。在不同的骗局中，比特币是最值得注意的是（Christin2013；Moore 和 Christin2013；Moser 等人 2013）。Marie Vasek 和 Tyler Moore 对基于比特币的骗局进行了实证分析（Vasek 和 Moore2015）。他们发现了 32 个 HYIP，并估计有超过 400 万美元涉及其中。最近的研究关注智能庞氏骗局的经济学方面（Bartoletti 等人 2020）；他们使用*归一化 Levenshtein 距离*（Yujian 和 Bo2017）作为字节码之间相似度的度量，以检测隐藏的智能庞氏骗局。与他们的研究不同，这项工作专注于寻找一种可验证的方法，以检测字节码中的智能庞氏骗局。

### 5.3.6 未来工作

基于区块链和加密货币的金融骗局已成为一个重要的研究问题。随着区块链技术的发展，庞氏骗局现在隐藏在智能合约之下。未来，我们将从三个方面进一步研究。首先，扩展真实数据并改进分类模型。随着每天拥有源代码的智能合约数量不断增加，可以通过手动检查源代码来扩展真实数据。拥有更多的真实数据，可以开发出更准确、更可信的模型。其次，建立一个统一的平台，对每一个可能的骗局对每一个智能合约进行评估和打分。我们注意到有一个在 Github 上的开源项目，用于追踪所有当前的以太坊骗局。17 然而，该网站通过用户手动报告收集数据并加以整合。我们正在尝试建立一个类似的网站，专注于通过数据挖掘方法检测智能合约。第三，研究其他类型的骗局。除了智能庞氏骗局，许多其他骗局都在利用区块链技术。有必要研究这个问题，以促进区块链技术的发展。

## 5.4 案例研究：钓鱼骗局检测

### 5.4.1 以太坊上的钓鱼骗局

至于基于区块链技术的加密货币，金融安全扮演着关键性的基础角色。然而，加密货币系统中欺诈的快速增长无疑阻碍了用户接受度以及区块链技术的进一步应用，从而阻碍了区块链技术的发展。因此，识别此类骗局变得重要且迫切，这已经吸引了研究者的广泛关注（Bartoletti 等人 2020；Chen 等人 2018b）。在众多骗局中，钓鱼骗局是一种新的在线欺诈形式。它随着在线业务的普及（Liu 和 Ye2001）而诞生，现已发现在区块链系统中。根据*Chainalysis*的数据，自 2017 年以来，超过 50%的网络犯罪利润来自于钓鱼骗局。^(18)Bee Token ICO 上的钓鱼骗局^(19)在区块链骗局中发挥了众所周知的作用。骗子仅在 25 小时内就骗走了约 100 万美元。从这个角度来看，基于区块链的钓鱼骗局的检测是一个重要且迫切的挑战。

传统的钓鱼欺诈通常会创建一个假冒的官方网站，然后诱使用户登录以获取用户的私人信息，比如密码。因此，应对传统钓鱼欺诈的主要方法是识别假冒网站并在用户登录前警告他们。另一方面，基于区块链的钓鱼骗局展现出各种新的特征。首先，用户所拥有的加密货币成为新型钓鱼骗局的攻击目标，而非私人信息。在正常情况下，钓鱼骗子会使用各种方法诱使用户将资金转到一个特定地址，正如 Bee Token ICO 事件所发生的那样。此外，从欺诈中获得的加密货币需要通过交易所兑换成法定货币。最后，公共区块链上的所有交易记录都是透明且公开可查的，从而为检测钓鱼欺诈提供了新的数据基础。

基于区块链上钓鱼诈骗的新特点，我们提出了一种基于交易记录和机器学习技术的区块链钓鱼诈骗识别方法。这种方法可以集成到区块链钱包中（即用于管理区块链上账户和交易的工具）作为一个警告功能，以检测潜在的钓鱼诈骗并警告用户在与其他不熟悉账户进行交易之前。该方法的整体框架如图 5.8 所示，以太坊平台用于展示我们方法的有效性。总的来说，我们首先从以太坊客户端 Parity 下载了以太坊的交易记录，然后从 Etherscan.io 抓取了所有的钓鱼账户信息。接着，我们基于常识和一些机器学习方法缓解了机器学习领域中的类不平衡问题。在此基础上，我们根据交易记录建立了交易图，并提出了一种基于图的级联特征提取方法。然后，我们提出了一个双重采样集成框架来检测可疑账户。最后，我们将提出的方法与其他方法进行了比较，以证明我们方法的有效性。在不同的参数下评估了该模型的性能，并讨论了特征的有效性。![../images/506524_1_En_5_Chapter/506524_1_En_5_Fig8_HTML.png](img/506524_1_En_5_Fig8_HTML.png)

Fig. 5.8

框架

总结起来，我们在本节做出了以下主要贡献。

+   我们提出了一种系统的方法来检测区块链生态系统中的钓鱼诈骗，并以以太坊为例验证了该方法的有效性。该方法表现良好，这表明我们的方法可以嵌入到用户的加密货币钱包中，为用户提供金融风险警告功能。为了加速这一领域的研究并促进区块链技术的健康发展，本书出版后所有相关数据和代码都将公开发布。

+   我们提出了一种基于图的级联特征提取方法，该方法可以方便地提取丰富的交易结构信息，并形成一个具有良好分类效果的特征集。此外，根据“六度分割”定理，该方法非常可扩展且难以规避。

+   我们提出了一种新的模型集成算法，即双重采样集成算法，该算法可用于处理类不平衡的高层次分类问题。评估结果表明了该算法的有效性。

### 5.4.2 背景和相关工作

区块链技术是比特币等加密货币的关键支持技术。^(20)区块链可以被看作是由不需要相互信任的对等方维护的一个公共账本（Zheng et al. 2017）。用户持有的加密货币数量和区块链上的交易记录都保存在这个账本中。在这个系统中，用户由一对公钥和私钥对表示。公钥，像在银行系统中一样，扮演着账户的角色，是用户在区块链上的表示，通常被称为地址。（在本章中，我们交替使用术语地址和账户。）在区块链系统中，交易是从一个账户（发起方的地址）发送到另一个账户（接收方的地址）的消息（Chen et al. 2018b）。通常，发起方会将一定数量的加密货币转给接收方。在一段时间内发生的交易会被对等方打包成区块，并通过密码学与前一个区块链接起来。每个区块都有一个对应的高度（在本章中表示为*blockNumber*），从 0 开始递增 1。区块的高度可以被看作是交易发生的时间。从这个角度看，区块的高度可以被视为交易发生的时间，区块高度较大的交易发生在区块高度较小的交易之后。

总的来说，比特币系统每 10 分钟生成一个新块，而以太坊的时间大约是 15 秒。由于其支持智能合约（Wood 2014），以太坊被称为第二代区块链技术，以太币是其维护的加密货币。智能合约是存储在区块链上的可执行脚本。以太坊提供了一个图灵完备的虚拟机（以太坊虚拟机）来支持这些脚本的执行。智能合约以字节码的形式存储在区块链上。当智能合约接收到指向合约地址的消息调用时开始运行，并在给定条件满足时终止。实际上，以太坊已经成为了最大的支持智能合约的区块链平台，也是各种针对区块链的网络攻击的主要目标之一。

近年来，随着区块链技术的发展，区块链生态系统中的金融安全受到了广泛关注，各种欺诈行为的识别已成为研究热点。在比特币生态系统中，（Vasek 和 Moore2015）展示了基于比特币的诈骗行为的首次实证分析。作者确定了 192 起诈骗行为，并指出至少有 13,000 名不同的受害者损失了超过 1100 万美元。（Vasek 和 Moore2018）分析了基于比特币的庞氏骗局的供需情况，而（Bartoletti 等人 2018）为比特币生态系统中的庞氏骗局建立了一个地址识别模型。此外，（Chen 等人 2019a）显示了在比特币交易所 Mt. Gox 中存在市场操纵行为。在以太坊生态系统中，一方面，人们关注各种诈骗行为的识别，例如，智能庞氏骗局（Bartoletti 等人 2020；Chen 等人 2018b）。另一方面，由于大多数智能合约控制着某些数字资产，确保智能合约中没有漏洞是以太坊金融安全的重要部分（Kalra 等人 2018）。

诈骗检测在过去几十年中得到了广泛研究，并提出了许多方法（Abdelhamid 等人 2014；Khonji 等人 2013；Zouina 和 Outtaj2017）。然而，很少有研究关注考虑区块链特点的诈骗欺诈识别。Andryukhin(2019)对针对区块链项目的诈骗攻击的主要类型和方案进行了分类，并从区块链项目侧的角度提出了防范诈骗攻击的方法。与它们不同，我们关注整个区块链生态系统，并向用户提供关于诈骗诈骗的预警。

### 5.4.3 提出的方法

在区块链系统中识别诈骗账户面临两大挑战：（1）我们仅有的交易记录，对账户功能和持有者信息知之甚少；（2）诈骗地址的数量非常少，其他地址则众多，在庞大的账户集合中识别这样一个小型账户群体，就像是海底捞针。（数据细节在章节 5.4.4 中有描述。）为了应对这些挑战，提出的方法包括两部分，即级联特征提取方法和基于 LightGBM 的双采样集成算法。

#### 5.4.3.1 级联特征提取方法

由于交易记录是我们可以使用的唯一信息，而且它们给账户一个自然的图形结构，为了提取有效的特征，我们首先根据这些交易记录构建一个交易图（TG）。具体来说，*TG*=（*V*, *E*），其中*V*是一组节点（数据集中的所有地址）和*E*={(*v* [*i*], *v* [*j*])|*v* [*i*], *v* [*j*]∈*V*}是一组有序边。每条边表示一个地址*V* [*i*]向另一个地址*V* [*j*]转移了一定数量的以太币。每条边有两个属性：*blockNumber*和*amount*，分别表示这条边出现的时间和交易的金额。请注意，在 TG 中，两个节点之间可能有多条边，这取决于两个相关账户之间的交易次数。（在以下内容中，我们交替使用账户、地址和节点。）接下来，我们介绍所提出的特征提取方法。

基于图的特征在许多识别问题中已被证明非常有效（Chatzakou 等人 2017；Ramalingam 和 Chinnaiah2018）。因此，我们提出了一种基于 TG 的*级联特征提取*方法用于识别诈骗账户。这个想法如下。将账户之间的交易视为一种*朋友*关系，要判断一个账户的类别，我们可以使用不仅仅是该账户的信息，还可以使用其朋友的信息，甚至是其朋友的朋友的信息，等等。为了更清楚地解释，我们首先定义与节点相关的几个关键词。

+   节点数据：节点数据是该节点的交易历史。每笔交易包含关于交易时间、方向和金额的信息。交易时间用*blockNumber*表示，这是一个递增的整数。交易有两个方向：*出*和*入*。账户的出交易将以太币从账户转移到其他账户，账户的入交易从其他账户接收以太币。

+   节点特征：节点特征是从节点数据中提取的各种信息。在本章中，我们通过各种统计方法提取信息。

+   *N 阶朋友*：节点的 1 阶朋友是与节点直接相连的节点（即它们之间有交易）。节点的 N 阶朋友是通过至少 N-1 个节点与节点相连的节点。

+   *N 阶特征*：节点的 0 阶特征是该节点的特征。N 阶特征是从 N 阶朋友那里级联提取的。

为了说明如何实现级联特征提取，我们在图 5.9 中展示了二阶特征提取的过程 5.9。假设我们需要计算节点*A*的二阶特征，它有 1 阶朋友*B, C*和 2 阶朋友*D, E, F, G, H*。在图中，每一条无向边代表两个节点之间的一项或多项交易（无论方向如何），2 阶朋友的交易对手方未显示。该过程分为三个阶段。在第一阶段，我们通过使用其节点数据（即交易历史）为每个 2 阶朋友计算一个统计量（即灰色矩形）。第二阶段需要通过使用第一阶段计算的统计量（而不是 1 阶朋友的节点数据）为每个 1 阶朋友计算一个统计量。同样，在最后阶段，我们仍然计算一个输入来自第二阶段的统计量。这种方法非常可扩展。事实上，通过增加阶数并在不同阶段使用不同的统计方法，我们可以提取关于节点如何与整个网络交互的丰富信息。需要注意的是，这里描述的方法没有考虑交易的*方向*。但是，对于钓鱼账户，入交易和出交易的意义有显著不同。因此，在本章中，我们分别提取两个不同方向的特征。![../images/506524_1_En_5_Chapter/506524_1_En_5_Fig9_HTML.png](img/506524_1_En_5_Fig9_HTML.png)

Fig. 5.9

二阶特征提取过程示例

节点特征是节点数据的统计量。数据有两种*类型*：交易金额和交易次数（即*区块*编号）。为了区分交易性质，统计在不同*方向*进行（即*出*交易或*入*交易）。为了方便，我们将这些特征命名为*方向 _ 类型 _ 方法*。例如，一个节点的特征*in_block_std*表示所有入交易（即交易方向*入*）的交易时间（即数据*区块*）的标准差（即方法*sd*）。对于交易时间，我们计算的只是交易时间差（表示为*ptp*）及其标准差（表示为*sd*）。对于交易金额，我们计算了总和、最大值、最小值、平均值和标准差（即*sd*）。此外，还有与交易金额无关的统计量：*计数*、*唯一*和*唯一比率*。它们分别表示交易次数（即*计数*）、交易对手方数（即*唯一*）和两者的比率（即*唯一*∕*计数*）。通过这样做，我们得到了 19 个特征（即 2×1×（2+5+2）+1）。

为了简化，在本研究中，我们只提取了一阶网络特征。如前所述，交易方向在识别钓鱼骗局中很重要。因此，考虑到交易方向，节点的 一阶朋友可以分为*from*朋友和*to*朋友。简单地说，当节点*A*向节点*B*发生转账交易时，我们称节点*B*为节点*A*的*from*朋友，节点*A*为节点*B*的*to*朋友。具体来说，一阶网络特征被命名为*friend_direction_statistic2_statistic1*。例如，*from_in_mean_max*特征的计算如下：首先，我们计算每个*from*朋友的*in*交易额的最大值（即*max*）。然后，我们计算前阶段所有统计量的平均值。同样，为了计算*to_out_std_sum*，我们首先计算每个*to*朋友的*out*交易额的总和。然后，我们计算前阶段所有统计量的标准差（即*sd*）。这样做，我们可以得到 200 个特征（即 2×2×2×5×5）。请注意，我们在一阶网络特征提取中没有考虑时间。

#### 5.4.3.2 双重采样集成方法

识别钓鱼骗局本质上是建立一个地址分类模型。但钓鱼账户识别面临一个类别不平衡问题。为了建立一个有用的嫌疑人识别模型，我们提出了一种双重采样集成方法，一个集成了许多通过采样示例和特征训练的基础模型的识别框架。

基础模型在识别框架中扮演着中心角色。许多成熟的多类分类算法可以用作基础模型，如逻辑回归（LR）、支持向量机（SVM）和决策树（DT）。在这些模型中，梯度提升决策树（GBDT）在许多问题中取得了良好的结果。GBDT 有几种不同的变体，包括 XGBoost（Chen 和 Guestrin2016b）和 LightGBM（Ke 等人 2017），这些方法被广泛使用并普遍认可。在钓鱼检测问题中，我们发现 LightGBM 更有效，因此我们将其选为我们的基础模型。

给定监督训练集*X*= {(*x* [*i*], *y* [*i*]), *i* = 1, 2, ⋯, *n*}，LightGBM 整合了许多 K 回归树！

公式：$$f(x)=\frac {1}{K}\sum _{i=1}^Th_i(x) $$

 以最小化特定损失函数*L*(*y*, *f*(*x*)的期望值来逼近某个函数*f* ^∗(*x*)。在 GBDT 的每次迭代中，假设前一次迭代获得的强学习者是*h* *t*−1，损失函数是*L*(*f*(*x*), *h* *t*−1），那么当前迭代的目标是找到一个使用 CART 回归树模型的弱学习者，表示为*h* *t*，以最小化公式*L*(*f*(*x*), *h* *t*−1 + *h* *t*)。假设在迭代*t*中，样本*i*的负梯度可以表示为![$$r_{ti}=\frac {\partial L(y_i,h_{t-1}(x_i))}{\partial h_{t-1}(x_i)}.$$](img/506524_1_En_5_Chapter_TeX_IEq3.png) 使用对数似然损失作为损失函数*L*(*y*, *h*(*x*))=*log*(1+*exp*(−*yh*(*x*)))，其中*y*∈[−1, 1]，我们可以简化样本的负梯度如下：![$$\displaystyle \begin{aligned}r_{ti}=-\frac{\partial L(y_i,h_{t-1}(x_i))}{\partial h_{t-1}(x_i)}=\frac{y_i}{1+exp(y_ih(x_i))},\end{aligned}$$](img/506524_1_En_5_Chapter_TeX_Equb.png)

其中*i*=1,2,⋯,*m*.

通过使用该公式，LightGBM 选择将这些小的梯度样本从训练集中移除，以使模型更加关注那些造成巨大损失的样本。这项技术被称为基于梯度的单侧采样（GOSS）（Ke 等人 2017）。在构建 CART 回归树时，LightGBM 绑定互斥特征，从而大大减少特征（叶子）的数量。

受到*EasyEnsemble*（Liu 等人 2008）的启发，我们提出了一种双采样集成算法来解决钓鱼诈骗识别中的类别不平衡问题。伪代码显示在算法 5.1 中。

算法 5.1 双采样集成算法![../images/506524_1_En_5_Chapter/506524_1_En_5_Figd_HTML.png](img/506524_1_En_5_Figd_HTML.png)

双采样集成的背后想法很简单。与*EasyEnsemble*（Liu 等人 2008）类似，我们通过采样多数样本来减少类别不平衡（即负样例）。不同的是，由于我们使用级联特征提取方法可以获得大量的特征，所以我们还采样训练集中的样本特征。这种双采样方法使得基础模型具有更好的异质性。

### 5.4.4 数据收集与准备

#### 5.4.4.1 数据收集

我们在服务器上启动以太坊客户端 Parity，^(21)以下载以太坊的账本。使用 Parity，我们获得了 2019 年 1 月 3 日之前的所有以太坊区块（确切地说，从区块高度 0 到区块高度 7,000,000）。通过分析获得的交易，我们得到 43,783,194 个账户，其中 1,564,580 个账户由智能合约控制。

建立钓鱼诈骗识别模型最重要的任务之一是找到足够的钓鱼账户示例。幸运的是，ethereumscan.io 为以太坊地址提供了几个标签，通过爬取该网站，我们获得了所有被标记为 Phishing 的地址。（^(22)这些地址被用于一些已验证的钓鱼诈骗中。这样，我们获得了 1683 个钓鱼地址。我们将这些钓鱼地址称为*正*例，其余的称为*负*例。

#### 5.4.4.2 数据清洗

获取所有数据后，我们发现类非常不平衡。类不平衡率，即多数类（负例）的大小与少数类（正例）的比例，超过了 26000。考虑到一些地址不是钓鱼地址，我们建议在模型训练之前删除一些明显的负例（即非钓鱼地址），以建立更有效的模型。为此，我们（1）过滤涉及智能合约地址的交易记录，（2）删除交易记录少于 10 条或多于 1000 条的地址，（3）忽略所有在区块高度 200 万之前的交易。

上述选择方法基于以下事实。首先，智能合约通常由复杂的逻辑结构组成，因此它们并不非常适合钓鱼欺诈。根据收集的数据，智能合约只占钓鱼地址的一小部分（即 2.6%），这些地址通常与代币有关。因此，在这个初步研究中，我们为了简化问题移除了智能合约。其次，我们期望在这个研究中学习钓鱼地址的交易行为特征。在这种考虑下，交易记录太少的地址不利于我们的研究。另一方面，交易记录过多的地址通常意味着该账户是加密货币钱包或其他类型的账户。实际上，超过 70%的账户有超过 1000 条交易记录，但只有一个账户被标记为钓鱼地址。最后，我们发现所有钓鱼地址在 2016 年 8 月 2 日之后都变得活跃。根据初始活动时间的分析，这种现象的可能原因是，在以太坊的早期阶段，钓鱼诈骗相对较少，甚至在那段时间内记录的钓鱼诈骗也较少。因此，我们建议基于 200 万区块高度（即 2016 年 8 月 2 日）之后的记录建立模型。这些过滤规则使模型能够专注于学习钓鱼诈骗的特征。

### 5.4.5 实验结果与分析

#### 5.4.5.1 实验设置

我们从以太坊创立之初到 2019 年 1 月 3 日下载了所有的交易数据（即从区块高度 0 到区块高度 7,000,000）。通过使用第 5.4.4.2 节中的筛选规则，我们最终得到了 7,795,044 条交易记录。共有 534,820 个地址，其中 323 个是钓鱼地址。以下实验基于此数据集进行。为了更准确地反映模型的有效性，避免训练集和测试集划分引起的变化，实验采用了 k 折交叉验证的评估方法。具体来说，我们设置参数 k=5。为了准确评估模型，我们选择了四个指标：精确度、召回率、F1 分数和 AUC 值，这些指标在分类问题中常用。

#### 5.4.5.2 方法比较

为了验证我们提出的模型更适合这个问题，我们将单模型 LightGBM、支持向量机（SVM）、决策树（DT）及其双重采样集成（DE+）模型进行了比较。SVM 和 DT 在许多分类不平衡问题中被认为是有效的（Chen 等人 2019b）。因此，我们将其作为我们模型的基线。为了比较这些方法的表现，我们将特征采样率设置为 70%，基础模型数量设置为 1600（即平衡集成）。表 5.4 显示了结果。可以看出，在这些单模型中，SVM 表现较差，LightGBM 和 DT 有一定的表现，但显然没有实际价值。相反，采用集成策略后，每个模型的性能都显著提高，尤其是 LightGBM 和 DT（即 DElightGBM 和 DEDT）。这表明在面对不平衡分类问题时，集成方法是一个很好的选择。值得注意的是，提出的模型（即 DElightGBM）在所有指标上表现都很好（即所有指标都大于 0.8）。这意味着提出的模型可以部署在真实钱包中进行实时预警。表 5.4

性能比较

![../images/506524_1_En_5_Chapter/506524_1_En_5_Figa_HTML.png](img/506524_1_En_5_Figa_HTML.png)

粗体值给出了每个指标的最佳性能

#### 5.4.5.3 示例采样效应分析

评估示例抽样对模型影响本质上是在选择基本模型的数量。表 5.5 展示了不同基本模型数量下 DElightGBM 框架的四个评估指标。（我们将特征抽样率设为 70%，每个模型的参数围绕最优参数随机选择。）可以看出，随着基本模型数量的增加，所有指标都不同程度地得到了提升。当基本模型数量达到 800（即半平衡集成）时，三个指标（即*精确度*、*F1 分数*和*ROC AUC*)达到最大。然而，*召回率*持续上升，当基本模型数量为 1600（即平衡集成）时达到最大值。这一结果表明，类不平衡程度是影响基本模型性能的一个非常重要的因素。从实验结果来看，半平衡集成似乎是一个不错的选择。然而，为了使模型更具实用性，我们更愿意以精确度为代价找到所有潜在的钓鱼骗局（即更高的*召回率*）。因此，我们提出使用平衡集成进行钓鱼骗局检测。表 5.5

示例抽样效果（使用 LightGBM）

| #模型 | 精确度 | 召回率 | F1 分数 | ROC AUC |
| --- | --- | --- | --- | --- |
| 1 | 0.0789 | 0.0991 | 0.0879 | 0.549 |
| 100 | 0.7583 | 0.3993 | 0.5232 | 0.6947 |
| 800 | **0.**9288** | 0.7368 | **0.**8217** | **0.**8274** |
| 1000 | 0.826 | 0.7585 | 0.7908 | 0.8206 |
| 1600 | 0.8196 | **0.**805** | 0.805 | 0.8097 |

粗体值给出了每个指标的最佳性能

#### 5.4.5.4 特征抽样评估

接下来，我们通过设置不同的抽样比例来分析特征抽样的效果。为了消除基本模型数量的影响，统一设置为 1600\。表 5.6 展示了评估结果。总的来说，特征抽样方法对最终结果有一定的影响；然而，与示例抽样相比，其影响要小得多。从最偏爱的指标，即*召回率*的角度来看，0.8 是最佳的特征抽样比例。与使用所有特征（即比例=1）相比，*召回率*提高了 4.24%。表 5.6

特征抽样效果

![../images/506524_1_En_5_Chapter/506524_1_En_5_Figb_HTML.png](img/506524_1_En_5_Figb_HTML.png)

粗体值给出了每个指标的最佳性能

这些结果揭示了一个值得注意的现象。模型的性能并不一定随着特征数量的增加而更好。相反，在我们可以获得大量特征的情况下，一定程度的特征抽样有助于获得更好的模型。这可能是因为特征抽样可以使不同的基本模型从不同的角度看待对象，从而获得更好的识别。

#### 5.4.5.5 特征分析

自从我们采用了级联特征提取法，获得了大量特征。图 5.10 展示了模型中最重要的 15 个特征。接下来，我们分析这些特征为何重要。![../images/506524_1_En_5_Chapter/506524_1_En_5_Fig10_HTML.png](img/506524_1_En_5_Fig10_HTML.png)

Fig. 5.10

最重要的 15 个特征

+   `in_block_std` 是节点所有 `in` 交易 `blockNumber` 的标准差。这一特征反映了特定地址入交易的活动强度。如果在短时间内有大量入交易，这些交易的 `blockNumber` 将非常接近，从而构建的 `to_block_std` 会非常小。这个特征比其他特征重要得多，其意义也容易理解。对于钓鱼地址，一个自然现象是在钓鱼开始后的一段时间内，入交易数量突然增加。然而，随着钓鱼诈骗的揭露，入交易变得稀少，甚至不存在。这导致钓鱼地址的入交易集中在一段较短的时间内，这个特征能很好地抓住这一特点。

+   `to_out_sum_median` 是一个典型的 1 阶网络特征。它反映了所有 `to` 朋友出交易的整体情况（即 *sum*）。这个特征不如前面那个特征直观，需要一些解释来理解它的价值。首先，我们可以将一个地址的出交易中位数视为其财务实力的一个指标。这并不难理解，因为较大的中位数意味着至少有半数的地址出交易金额较大，表明其财务实力较强。其次，对于钓鱼地址，`to` 朋友是钓鱼诈骗的受害者。因此，对于钓鱼诈骗，这个特征可以被视为所有受害者整体财务实力的一个指标。

+   `from_in_sum_min` 也是一个 1 阶网络特征。与之前的特征不同，这个特征反映了节点的 `from` 朋友的 `in` 交易。理解这个特征为什么重要相对容易。对于钓鱼诈骗，洗钱是提现前的一个重要环节。因此，钓鱼地址的 `from` 朋友，通常用于洗钱的代理地址，必须表现出与正常地址不同的行为特征。而这种特征有效地捕捉到了这种差异。

对前三项重要特征的分析表明，我们的特征工程取得了良好的效果，充分挖掘了节点本身及其不同邻居的特征。

### 5.4.6 结论与未来工作

在区块链生态系统中，各种骗局泛滥成灾，严重威胁到了参与用户的金融安全。未来，我们打算将这一研究拓展到其他网络犯罪，并建立一个区块链骗局检测网站，以 API 的形式提供钓鱼骗局鉴定服务。此外，为了加速这一领域的研究，书籍出版后所有相关数据和代码都将公开发布。

## 5.5 总结

在本章中，我们重点关注区块链上的不良行为检测。

具体来说，在 5.3 节中，我们提出了一种检测智能庞氏骗局的方法。利用人工检查的样本和 XGBoost，基于提取的账户特征和代码特征构建了一个回归树模型。实验结果表明，所提出的模型具有高准确性，可以用于在实践中检测潜在的智能庞氏骗局。最重要的结果是，利用我们提取的代码特征，在任何一个运行中的合约中都是公开可用的，足以在合约创建时刻构建一个实用的庞氏骗局检测模型。此外，我们估计在以太坊上有超过 400 个智能庞氏骗局，这远远超过了之前的估计。

在 5.4 节中，我们提出了一种系统的方法来检测以太坊生态系统中的钓鱼骗局。首先，通过使用 Parity 客户端和爬取 etherscan.io，我们收集了以太坊区块链上所有的交易和已标记的钓鱼地址。然后，利用这些数据，我们构建了一个交易图，并提出了基于图的级联特征提取方法，这帮助我们提取了许多有用的特征。接下来，基于提取的特征和 LightGBM，我们提出了一种双重采样集成模型来检测钓鱼嫌疑人。最后，我们从多个角度评估了该模型，结果表明我们的模型是有效的。

总之，本章讨论了几种不良行为及其相关研究。此外，我们还提出了两个数据挖掘模型来处理以太坊上的庞氏骗局检测和钓鱼骗局检测，并进行了相应的实验。此外，对这两个模型进行了多角度评估，发现理论结果与实验结果之间具有一致性。
