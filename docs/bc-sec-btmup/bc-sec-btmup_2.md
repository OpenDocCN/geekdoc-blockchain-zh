# CHAPTER 3

协议

区块链是协议，而不是具体的实现。就像 HTTP，它定义了 Web 服务器和浏览器应该如何通信，区块链协议定义了节点应该如何协同工作以维护去中心化的数字账本。

区块链协议旨在激励区块链网络中的节点为其最佳利益工作，同时假设一定比例的节点是贪婪的，可能是恶意的。区块链协议旨在让遵守规则比作弊更有利可图。

区块链账本定期通过添加新块进行更新。使新区块定义网络应如何选择下一个区块的创建者（共识）以及被选中的区块创建者应如何进行操作的两个主要协议。  ## 共识

分布式账本被设计成作为分布式、去中心化系统运行。网络中的每个节点都存储分布式账本的一份副本，并负责将该副本与网络中的其他部分同步。

在基于区块链的系统中，这是通过共识算法实现的。这些算法通过定义确定区块链中下一个区块创建者的过程来形式化这一过程。在下面的章节中，我将讨论一些主要共识算法的工作原理、它们的安全假设以及针对它们的常见攻击。

### 区块链共识的关键概念

区块链共识算法旨在实现去中心化决策。网络中的每个节点都需要能够独立地确定下一个区块的创建者，并得出与其他所有人相同的答案。

在做出这些决定时，区块链节点需要考虑几个潜在的问题。网络中的恶意节点可能会试图为了自己的利益误导其他节点。简单的多数投票不是做出决策的可行方法。网络可能无法达成共识，导致区块链存在多个版本。

中本聪在比特币白皮书中的一个主要贡献是提出了适用于区块链网络的这些问题的解决方案。这些方法支持去中心化决策，并可扩展到与比特币一样大的网络。

#### 拜占庭将军问题

拜占庭将军问题（BGP）是由莱斯利·拉蒙特设计的计算机科学问题。¹ 它描述了在某些决策者和通信路径不能被信任的环境中分布式决策的问题。

在 BGP 中，多个军队正在围困一个城市，并需要决定接下来做什么。大多数将军要么需要达成一致，同时发起攻击，要么同时撤退。如果群体没有达成共识，他们将被城市的守卫者击败。由于军队分布在城市周围，将军们不能离开他们的军队，他们需要通过信使进行沟通。

情况因一些将军可能是叛徒而变得复杂，他们会发送虚假信息或根本不发送信息。为了达成共识，国王给每一位将军发送一条包含他命令的信息，每位将军都将这条信息转发给其他每一位将军。结果，每位将军都收到了多条表达国王愿望的信息。由于一些将军可能是恶意的，这些信息可能相互矛盾。然而，只要三分之二以上的将军是忠诚的，就有可能达成共识。

拜占庭将军问题的解决方案已经存在一段时间了，但它们对于大规模应用来说效率太低。为了运行，区块链需要解决拜占庭将军问题，因为它们也是一个分布式系统，在处理潜在的叛徒（恶意节点）的同时，试图就下一个区块的内容达成一致。区块链共识算法旨在提供一个可扩展的拜占庭将军问题解决方案，如果它们能够做到这一点，就被称为拜占庭容错（BFT）。#### *通过稀缺性实现安全*

去中心化决策的最简单方法是多数投票。然而，由于 Sybil 攻击的可能性，简单的多数投票对区块链来说并不适用。

区块链系统被设计成匿名的，任何人都可以创建一个区块链账户。在 Sybil 攻击中，恶意用户创建了许多虚假账户，这只需要在区块链上为新地址生成一个私钥。如果一个区块链通过多数票实现共识，Sybil 攻击者会拥有不成比例的投票权，理论上可能控制大多数账户。

名字*Sybil 攻击*来源于一本名为《Sybil》的书，书中讲述了一个患有解离性身份障碍的女子。然而，书中的主人公后来承认，那些多重身份都是假的，就像区块链上的攻击者的多个账户一样。

区块链的共识算法并不是给每个账户提供对账本状态的平等控制权，而是用一种稀缺资源来表示对区块链的控制。尽管不同的共识算法使用不同的稀缺资源并以不同的方式应用它们，但用户对区块创建过程的控制力与他们控制的稀缺资源的百分比成正比。由于区块创建者决定哪些内容会被记录在账本中，这种对稀缺资源的控制等同于对区块链账本及其历史的控制。

资源供应、需求和价格之间的关系是经济学的一个核心原则。如果某项物品的需求相对于供应增加，价格也会随之增加。试图积累足够有限资源以控制区块链账本的攻击者增加了对固定供应资源的 demand. As the demand increases and the available supply shrinks (as the attacker accumulates all that is for sale), the price continues to rise.

在一个去中心化系统中，没有权威可以惩罚不良行为，因此用户必须想要遵守规则，系统才能运行。区块链试图通过支付节点创建区块来激励参与区块创建过程，并刺激对稀缺资源的需求。同时，它试图防止任何单一用户积累过多权力，使得这种攻击要么成本过高不可行，要么无利可图。#### 最长链规则

区块链的一个有效版本是指其区块只包含有效交易，并遵循区块链共识算法的规则。对于许多共识算法来说，这意味着可能存在同一个区块的多个有效版本和多个分叉的区块链。

区块链系统缺乏一个可以决定区块链分布式账本两个版本中哪一个是“正确”的中心化权威。区块链需要一种去中心化的方式来达成这一决定，因此它们采用了最长链规则。

在最长链规则下，“更长”的两个冲突区块链中的哪一个是一个节点应该接受的。在这个上下文中，“更长”意味着需要更多工作来创建的版本。对于一些共识算法，这实际上是指具有更多区块的那一个，但在其他算法中，一个由难以创建的区块组成的短链可能会胜过一个由更容易的区块组成的较长链。

最长链规则通过前面提到的稀缺资源实现了多数投票的原则。无论哪种版本的区块链更长，都应该得到稀缺资源大多数的支持。节点或群体控制的稀缺资源的百分比与被选中创建区块的概率成比例。如果支持一条链的节点比支持另一条链的创造者创建了更多的区块，那么逻辑上那条链应该控制更多的稀缺资源。

在最长链规则下，一个节点可能被迫用一个新的区块链替换它之前接受的区块链。这就是为什么说区块链交易只提供概率性的最终确定。尽管任何区块理论上都可以被不同的版本替换，但当更多的区块建立在其之上时，这会变得更加困难。区块的链和区块链共识算法旨在使区块链的重大重组变得如此困难以至于不可能。### 工作量证明

工作量证明（Proof of Work）是最古老的区块链共识算法。中本聪在 2008 年的比特币白皮书中描述了它，从而向世界介绍了区块链的概念。

工作量证明使用计算能力作为其稀缺资源。矿工能执行的计算越多，找到网络其他部分将接受的有效区块的概率就越高。

**工作量证明简介**

区块链工作量证明中的区块分为两部分：头部和体部。体部包含了存储在区块中的交易数据，而头部包含了四个重要字段：

+   **时间戳：**区块创建的时间

+   **交易哈希：**包含区块中交易的默克尔树根哈希

+   **前一个区块哈希：**前一个区块的哈希，将它们链接在一起

+   **Nonce：**由区块创建者生成的随机值

工作量证明共识算法旨在使创建有效区块变得困难，但验证却变得容易。在工作量证明中，有效的区块是指其头部哈希值小于某个阈值的区块。通常，这个阈值指的是头部哈希具有特定数量的前导零的哈希值。

哈希函数的特性既使得工作量证明算法成为可能，又保证了其安全性。哈希函数的非局部性意味着相似的输入会产生非常不相似的输出。通过修改区块头中的 nonce 值，工作量证明矿工可以创建具有非常不同哈希的头部，这些哈希可能满足这个值小于阈值的要求。

哈希函数反向映射抵抗意味着给定区块头的哈希是不可预测的。因此，找到有效区块的唯一方法是尝试不同的 nonce 值，直到矿工找到一个可用的 nonce。这里计算能力的稀缺资源就发挥作用了。矿工控制的计算能力越大，他们可以执行的哈希计算就越多，他们找到当前区块有效版本的概率也就越高。

##### 工作量证明中的难度目标

用于判断区块是否有效的阈值基于当前的难度目标。这个难度目标会随着区块链网络总哈希率的增减而随时间变化。目标是设置难度目标，使网络能够以设定的速率创建新的有效区块。

例如，比特币的目标区块生成率是 10 分钟。这意味着，平均而言，每 10 分钟创建一个区块。由于挖矿过程的不可预测性，有些区块生成得更快，有些则更慢。然而，难度目标是设置为在区块链当前的哈希率下，可以在 10 分钟内测试到一个有效区块所需的潜在 nonce 数的。

工作量证明中的难度目标以去中心化的方式定期调整。区块链网络中的所有用户都能看到每个区块的创建时间，并确定实际的区块生成速率。在预定义的间隔，他们会将当前难度目标与实际和目标区块时间的比率相乘，以创建一个反映当前区块链网络资源的新目标。#### *工作量证明的安全性*

尽管针对工作量证明（Proof of Work）区块链可以实施多种不同类型的攻击，但其中有三种是专门针对工作量证明共识算法的。51%攻击是一种“暴力破解”方法，旨在控制网络，而自私挖矿和简单支付验证（SPV）挖矿则旨在让攻击者在不投入与 51%攻击相同数量资源的情况下控制网络。

攻击者还可以利用工作量证明的机制来破坏区块链的运行。一种方法是通过强制工作量证明共识的人工难度更新。

##### 51% 攻击

51%攻击可能是针对区块链最著名的攻击方式，并在比特币的白皮书中进行了描述。工作量证明旨在基于多数票来强制达成共识，这里的“票”是指矿工在区块创建过程中执行的哈希计算。

如果攻击者拥有网络哈希算力的多数（即 51%），他们很可能会赢得创建每一个新区块的竞赛，并控制区块链。尽管其他网络节点可能能够在创建一个或多个区块的速度上超过攻击者，但从统计学上讲，他们维持这种领先的可能性很小。如果攻击者能够创建并维持区块链的最长版本，那么遵循区块链协议的用户有义务接受它，而不是更短的选项。

###### *对策*

如果攻击者拥有执行 51%攻击的资源，那么防止 51%攻击将极其困难。实际上，有人认为，没有漏洞可被 51%攻击利用的系统是无法真正实现去中心化的。已经尝试过的两种方法是设置检查点以及罚款尝试执行 51%攻击的矿工。

***检查点机制***    在采用检查点机制的区块链中，矿工偶尔会在链上设置检查点，并拒绝接受具有不同版本块的区块链，即使其他区块链版本更长。这种方法的问题在于，它可能导致网络分裂或中心化。

如果每个用户单独设置检查点，用户可能会对同一个块设置不同的版本。因此，这些节点将拒绝接受彼此的账本版本，使得网络无法重新合并。

如果一个用户生成检查点并分发它们（以避免网络碎片），那么区块链系统已经变得中心化。这两个选项对区块链安全都不好，因此检查点很少使用。  ***惩罚***     防止 51%的另一方法是对执行 51%攻击的矿工进行罚款。一般来说，51%攻击旨在促成双重支付，攻击者发布交易的其中一个版本，等待它被接受，然后发布一个包含与原交易矛盾的区块链更长版本。因为更长的版本会被接受，且只能接受一个交易版本，所以原交易被忽略。

为了成功执行双重支付攻击，攻击者必须在秘密中构建区块链的矛盾版本，并在原交易被接受后才揭露它，通常是在包含交易的区块上构建了三个区块之后。这意味着这个分叉链的早期区块在创建后很久才能被网络看到。在比特币上，分叉链的最早区块在其创建时间半小时后发布，这比可以归因于网络延迟的时间长得多。

一种方法是对创建的第一个被网络看到的区块进行罚款。这通过让矿工因创建恶意区块而损失资金，而不是获得奖励，从而消除了 51%攻击的激励。

这种方法的问题在于，区块产生的延迟也可能有合法的原因。稍后，我们将讨论拒绝服务攻击，攻击者可以减缓区块产生的速度。如果区块在惩罚截止时间前无法产生，区块链可能无法运行，因为合法矿工害怕被惩罚而不创建区块。  ###### *案例研究*

执行 51%攻击的成本取决于用于在区块链上执行工作量证明计算的计算能力。算力越高，执行 51%攻击的成本越高，且越不可能发生 51%攻击。

有超过十几个小型区块链经历过 51%攻击，包括知名如以太坊经典（ETC）和比特币萨诸塞愿景（BSV）。²这些加密货币的算力相对较低，使得利用租借的基于云的算力基础设施进行 51%攻击成为可能。

边缘币（The Verge）成为 51%攻击的受害者，攻击者利用协议的设计执行了大约 10%的区块链算力的攻击。³这次攻击利用了区块链协议的设计，降低了一个五挖掘算法之一的难度阈值。

因此，使用 Scrypt 算法的矿工比使用其他四种算法的矿工更容易找到区块。假设 hash power 在五种算法中均匀分布，这意味着 20%的 hash power 保证能找到每个区块。这使得攻击者仅仅通过控制整体 hash rate 的 10%，就能比其他人更快地创建区块，只需打败其他 Scrypt 矿工即可。  ##### SPV 挖矿

SPV 挖矿利用了简化支付验证（SPV）节点软件的存在。当一个新的区块被创建时，一个 SPV 节点只会下载该区块的头部用于验证。它忽略了包含交易数据的 Merkle 树，除非它需要验证区块中的特定交易。这些节点并非用于挖矿，而只是利用区块链系统提供的服务。

SPV 矿工利用区块链协议的规则给自己在挖矿中提供一个先发优势。当传统矿工收到一个新区块时，他们会采取以下步骤：

1.  下载并验证区块头部。

1.  下载并验证交易数据。

1.  更新待处理交易池。

1.  使用有效交易构建新区块。

1.  开始挖矿新区块。

下载和验证交易的过程可能很耗时，但却是必要的。有可能恶意用户创建了两个相互矛盾的交易并将它们传输到网络中。如果其中一个已经添加到账本中，另一个也无法包含在内。在构建区块之前，矿工需要确保前一个区块和当前区块只包含合法交易。如果不是，他们挖矿区块就是在浪费时间和资源，因为没有合法用户会接受这样的区块。

SPV 矿工跳过挖矿过程中的第 2 步和第 3 步，以给自己提供一个先发优势。他们通过挖掘只包含一个交易的区块来实现：即为创建区块支付给他们设定的奖励。这个区块完全有效，不可能包含无效交易，使他们能够在获取到前一个区块的哈希值后立即开始挖矿。

###### *对策*

SPV 挖矿依赖于这样一个事实：验证前一个区块和当前区块中的交易需要一些时间。比特币网络通过提高这些操作对客户端的效率，在一定程度上成功减少了 SPV 挖矿攻击。

一个 SPV 矿工在挖矿更多区块以获得更多区块奖励（由于他们的先发优势）和由于挖掘空区块而损失的交易费之间做出权衡。验证代码效率的提高以及大多数加密货币区块链中区块奖励随时间减少的事实，将很快使 SPV 挖矿成为一种无利可图的攻击方式。  ###### *案例研究*

在 2018 年，以太坊挖矿池 Etherdig 进行了广泛的 SPV 挖矿。⁴在三个月内，该池创建了 1,250 个区块，而这些区块没有验证过任何交易。这次攻击使该池获得了价值 86.25 万美元的 3,750 个 ETH。##### 自私挖矿

51%攻击需要攻击者投入大量资源，这可能是不切实际的。自私挖矿允许攻击者用不到网络总哈希率的一半来执行 51%攻击。它还可以被恶意矿工用来增加创建新块的概率。

在工作量证明区块链中，区块率只是一个目标。难度设置为平均需要那么长时间来找到一个工作量证明谜题的解决方案；然而，也有可能在第一次尝试时就找到解决方案，或者所需时间远超过目标。

自私矿工利用这个知识在区块创建中获得优势。如果他们为当前轮次找到了一个有效区块，那么在不久的将来找到另一个的可能性很小。在区块链中创建新块需要知道前一个块，因为其哈希包含在新块的头部。在区块创建的时刻，只有区块的创建者拥有这个知识并能够开始挖下一个块。

自私矿工会故意隐藏他们关于当前区块有效版本的知识，以便在创建链中下一个区块时获得先发优势。这个先发优势让他们可以在其他节点开始挖该区块之前尝试一些潜在的非 ce 值。

有了这个先发优势，一个只有网络 49%哈希率的攻击者可能有能力发起 51%攻击。对于没有这么多哈希率的矿工来说，自私挖矿仍能提高他们找到下一个区块的概率，从而增加他们获得区块奖励的机会。

###### 应对措施

不幸的是，自私挖矿很难防范。这些攻击者利用最长链规则和工作量证明挖矿的难度来操控系统，获得增加的奖励。###### 案例研究

在 2018 年，以太坊挖矿池 F2Pool 可能进行了自私挖矿攻击。⁵这个池控制了区块链的 12.5%的哈希率，并结合了自私挖矿和 SPV 挖矿技术。F2Pool 创建了一个比网络其他部分更快的区块链替代版本，利用了空块可以比有效块大约快 15%创建的空块事实。

当该池的区块链长度超过合法的区块链时，它就发布该区块链，导致其他节点根据最长链规则接受它。虽然这次攻击没有用来执行双重花费，但它确实使该池获得了额外的区块奖励。##### 服务拒绝：人工难度增加

工作量证明区块链试图调整找到有效区块的难度以适应网络的哈希率。随着哈希率的上升和下降，难度目标也会随之变化，以保持区块率接近目标。

这为攻击者提供了一个机会，执行拒绝服务（DoS）攻击，以降低区块链创建新区块的能力。通过向区块链网络添加更多的哈希能力，攻击者在下一次更新时可以推高难度目标，因为网络认为它创建区块的速度太快。

如果攻击者随后从区块链中移除了这种额外的计算能力，那么剩余节点的难度目标就会设置得过高。结果，区块将被创建得更慢，直到网络下次更新其难度阈值。在比特币网络上，每 2,016 个区块进行一次更新，即在 10 分钟一个区块间隔的情况下，这是两周一次。区块率变慢，这次更新将需要更长的时间来完成，从而延长 DoS 攻击的影响。

这种攻击的另一种变体涉及通过恶意软件、分布式拒绝服务（DDoS）等方式对合法矿工进行 DoS 攻击。这会降低哈希率，减缓区块生产。

###### *对策*

工作量证明区块链的难度目标设计为随着哈希率的变化而上升和下降。此外，很难区分人为的难度增加和良性矿工离开网络所引起的变化。### 权益证明

在工作量证明（Proof of Work，PoW）之后，权益证明可能是最著名的区块链共识算法。它比 PoW 消耗的能量少得多，且不需要专用硬件，使其更加“绿色”，并且对新手的进入更为容易。

#### *权益证明简介*

在权益证明中，区块链自身的加密货币是限制用户对区块链控制的稀缺资源。用户拥有的加密货币越多，他们就能在区块创建过程中施加越多的控制。

权益证明的运作方式与购买公司的股票类似。如果你拥有一家公司的股票，你就有潜力根据你拥有的股票数量获得股息。

在权益证明（Proof of Stake，PoS）中，用户可以抵押他们的一些加密货币，这意味着他们承诺不会花费并将其发送到一个特殊地址。只要这些加密货币仍然被抵押，用户就有机会被选中创建区块。用户可以随时提取他们的抵押品，但将失去被选为区块创建者的能力。

用于选择 Proof of Stake 区块创建者的算法分为两组：随机区块选择和币龄基础选择。主要的区别是一个用户被选中创建区块的概率。在随机区块选择中，这个概率与用户拥有的总质押加密货币的百分比成比例。在币龄基础选择中，考虑了用户的股份大小和自上次创建区块以来经过的时间。

所有 Proof of Stake 的实现都必须能够以去中心化和安全的方式执行区块创建者选择过程。中心化消解了区块链的目的，不安全的区块创建者选择过程可能会让用户操纵系统。为了实现这一点，下一个区块创建者的计算需要几个输入（前一个块的哈希、股份大小、币龄等）并将它们通过涉及哈希计算的函数。由于所有输入对所有用户都是已知的，任何人都可以执行计算。然而，使用前一个块的哈希和哈希函数使得某人操纵系统变得困难，因为他们无法预测股份在多个账户中的分配会让他们在时间上做出必要的调整。#### *Proof of Stake 的变体*

存在多种不同的 Proof of Stake 变体。基于链的 Proof of Stake 使用股份直接选择区块创建者，并利用最长链规则确定两个竞争的区块链版本中哪个是正确的。在本章中，我们将关注这个版本。

另一种 Proof of Stake 称为 BFT 风格的 Proof of Stake。这种变体使用多阶段共识协议，其中随机选择的区块生产者提出一个区块，其余的质押验证者投票是否接受它。这可以使他们实现与使用最长链规则的共识算法提供的概率性最终化不同的交易最终化。

Delegated Proof of Stake (DPoS) 使用质押资产实现代表民主。股东为代表投票，票数最多的 certain number of 候选人被选中。在这个方案中，代表执行区块生产的工作，并将奖励传递给质押者。#### *Proof of Stake 的安全性*

Proof of Stake 的安全性依赖于区块创建者选择过程和数字签名的安全性。为了使区块创建者选择过程安全，必须不能让任何人提前预测区块创建者并修改他们的股份以提高被选中的概率。Proof of Stake 使用哈希函数来确保这一点，因此 Proof of Stake 的安全性依赖于哈希函数的安全性。具体来说，哈希函数必须是伪随机的（以防止预测未来状态）且是单向的（以防止某人反向工程一个获胜的解决方案）。

数字签名安全对权益证明区块链的安全性也至关重要。与工作量证明（Proof of Work）不同，在权益证明中创建有效区块非常容易。权益证明依赖于这样的事实：用户只接受由选定区块创建者创建的区块。区块的真实性由数字签名保护，因此数字签名必须安全且不可伪造，才能使权益证明区块链安全。

与工作量证明（Proof of Work）类似，许多针对权益证明（Proof of Stake）的攻击目标是使区块链上的双重支付攻击成为可能。在以下各节中，我们将讨论攻击者可以控制的区块链的五种方法，激励攻击者允许双重支付攻击，或对区块链节点执行拒绝服务攻击。

##### XX% 攻击

XX% 攻击是权益证明中的 51% 攻击的对应物。在这种攻击中，恶意用户积累足够的稀缺资源（在本例中为加密货币），以高概率被选为每个新区块的创建者。

与工作量证明（Proof of Work）不同，拥有 51%的抵押加密货币并不能保证分布式账本的控制权，但它提供了 51%的机会被选为每个区块的创建者。为了发起有效的双重支付攻击，攻击者需要控制足够的抵押加密货币，以高概率被选为所需连续区块（通常是至少三个）的区块创建者。

执行此攻击所需的抵押加密货币的确切百分比取决于攻击成功的期望概率。这可以使用以下方程进行建模：

![正常上标 S 等于正常上标 P 除以正常上标 N](img/c03-disp-0001.png)

其中 S 是攻击者需要控制的股份池的百分比，以实现成功创建 N 个连续区块的概率 P。作为参考，控制三个区块以 90%的成功率需要控制超过 96%的股份。攻击者必须决定一个可接受的失败概率，因为它们不太可能控制所有抵押的货币。

###### 应对措施

在原始的权益证明算法中，“抵押”仅仅是指拥有加密货币，这意味着不存在不当行为惩罚。逻辑是攻击者会贬值加密货币，这也会伤害攻击者自己。

现代权益证明（Proof of Stake）算法要求抵押者将他们的加密货币存入特殊地址，以参与共识。这使得这些算法能够惩罚行为不当的节点，例如创建区块链的分支版本。##### 权益证明“定时炸弹”

权益证明“定时炸弹”指的是这样一个事实：持有区块链上最高股份比例的用户最终将能够不采取任何恶意行为进行 XX%的攻击。这是由于该用户可以利用“复利”通过投注通过区块奖励获得的全部加密货币。

在权益证明中，用户获得的区块奖励百分比与他们拥有总投注硬币百分比成比例。拥有最大股份比例的用户将获得最大的区块奖励，使他们的股份增长最快。

因此，他们的总股份比例将随时间增长，使他们能够获得越来越大的区块奖励。最终，加密货币将会消亡（因为所有硬币都绑定在用户的股份中）或者控制玩家将拥有所有股份（因为其他用户放弃他们的股份以便在交易中使用硬币）。

###### *对策*

这更多的是一个理论上的攻击，而不是一个实践中的攻击。通过区块奖励在权益证明区块链中积累控制性股份需要花费很长时间。此外，如果攻击者控制了区块链加密货币的足够份额从而使这种攻击成为可能，大多数或全部区块链用户可能已经放弃了它，导致货币贬值，使攻击变得毫无意义。##### 长期攻击

长期攻击旨在允许一个在权益证明区块链中不拥有最大股份的用户仍能利用“定时炸弹”效应。在此攻击中，攻击者选择区块链历史中的一个点（通常是创世区块），他们在那里控制一些股份，并创建一个分叉区块链。

在主区块链上，他们拒绝了自己创造区块的每一个机会。结果是，主区块链增长得更慢，因为任何他们未能创造的区块都被跳过了。这降低了区块链的吞吐量，这是攻击的关键。尽管如此，攻击者对主区块链的影响能力会随时间降低，因为他们没有获得新的区块奖励，而且他们总股份的比例很可能因此缩小。

在攻击者的区块链版本上，他们尽可能地创建区块。结果是，他们是唯一获得区块奖励的人，他们将奖励重新投注为股份。从长远来看，他们实现了与“定时炸弹”相同的区块链控制。

这种攻击的挑战在于使攻击者的区块链版本被接受为官方版本。为此，他们需要确保其版本包含比官方版本更多的区块。除非他们在开始时拥有超过一半的权益，否则他们的链条会一开始增长得更慢。随着时间的推移，他们在侧链上创建区块的能力将增加，并最终超过主链，因为主链将错过他们被选中创建的任何区块，以及由于自然错误（选定的区块创建者未能在他们的窗口内创建区块）偶尔错过的区块。结果，他们最终会缩小差距，成为最长的链，完成攻击。

##### *对策*

长期攻击利用了最长链规则，该规则规定了节点应如何处理区块链的冲突版本。从理论上讲，网络中的所有节点都应该接受恶意的区块链版本，从而使攻击者完全控制网络及其账本。

实际上，区块链中的节点更有可能简单地拒绝明显恶意的替代区块链，即使它应该根据最长链规则被接受。虽然这打破了区块链的规则，但它将使区块链能够继续运行。##### 资源耗尽攻击

权益证明（Proof of Stake）区块链比工作量证明（Proof of Work）区块链需要更多的验证工作。在工作量证明区块链中，可以通过验证区块头链来进行潜在区块链的高级验证。有效的区块难以计算但易于验证。因此，节点可以在验证每个交易之前，先检查链条作为初步验证步骤，以确认分叉的区块链是完全合法的。

在权益证明中，区块链的有效性取决于权益的分配以及每个区块是否由合适的区块生产者创建。因此，创建分叉的区块链相对容易，但验证起来却很困难，因为这需要访问区块体以识别和跟踪加密货币的抵押和解除抵押。

因此，可以使用伪造的区块链对基于链的权益证明区块链执行资源耗尽攻击。根据最长链规则，节点有义务确定潜在更长链的有效性，并在确认后在其基础上构建。攻击者向节点发送无效的分叉区块链，可以浪费其资源，并可能由于资源被用于检查无效链而减缓新块的创建。

##### *对策*

这些资源耗尽攻击利用了基于链的权益证明区块链的设计和规则来攻击节点。在深入检查之前，有一些启发式方法可以确定区块链是否可能有效；然而，许多这些方法都容易受到攻击。⁶  ##### 无利害关系问题

在权益证明中的**无利害关系问题**指的是在许多区块链系统中，区块创建者没有动机不去行为不端。如果区块链发生分叉，无论是意外还是因为攻击者的双重支付攻击，都没有机制阻止区块创建者将区块添加到两个版本中。

事实上，这样做对他们来说是最好的选择。通过将他们的区块添加到区块链的两个版本中，区块创建者保证无论最终哪个版本被选为官方版本，他们都能收到区块奖励。选择其中一个或另一个版本的风险是猜错，导致他们的合法区块从账本中被删除。

###### **对策**

**无利害关系问题**假设验证者没有理由不去在区块链的多个版本上构建。一些权益证明区块链，比如以太坊 2.0，要求节点向特定地址发送一笔安全押金，以被视为潜在的区块创建者。

这笔安全押金为这些区块链提供了一种惩罚违反规则的节点的机制。如果权益证明验证者在冲突链上创建区块，他们可能会失去部分股份或完全被排除在验证者之外。  ###### **案例研究**

自以太坊 2.0 启动以来，多个节点因签署多个冲突版本的区块而被惩罚。通常，这是由于配置错误和重新启动节点，但有些尝试可能是恶意的。

一个例子是 Staked，一个权益基础设施提供商，运营的 75 个 Eth2 验证者被“削减”。⁷ 这些节点由于配置更改和错误地签署了一个先前签署块的替代版本而意外重新启动。结果，这些节点遭受了 18 ETH，即当时价值 29,000 美元的惩罚。  ### 共识的安全建模

大多数区块链共识攻击都是为了帮助攻击者实现 51%攻击或以其他方式增加他们对数字账本的控制。以下是一些这些攻击对 STRIDE 威胁模型的影响：

+   **篡改**：51%攻击可以让数字账本被重写，打破区块链的不变性。

+   **否认**：51%攻击允许进行双重支付攻击，允许攻击者覆盖并否认过去的交易。

+   **服务拒绝攻击**：攻击者可以人为提高工作量证明区块链的难度阈值，减缓区块创建。一个 51%的攻击者可以拒绝将交易添加到区块链中，阻止它们被添加到数字账本。

+   **权限提升**：51%攻击、长程攻击、自私挖矿和 SPV 挖矿攻击旨在为攻击者提供对数字账本状态的完全或提升控制。  ## 区块创建

区块链被设计成一个分布式、去中心化的账本。区块链网络中的每个节点都有能力存储区块链的完整副本。这使得有必要 formalized 一种更新账本的方法，以便网络能够保持同步。

区块链通过将单独的交易收集到区块中，一次更新账本来实现这一点。区块链协议被设计成在（接近）规律的时间间隔内执行这些更新，这使得能够预测信息被添加到分布式账本的速度。

### 区块创建阶段

向分布式账本添加新区块是一个多阶段的进程。账本更新的五个主要阶段如下：

+   交易传输

+   区块创建者选择（共识）

+   区块构建

+   区块传输

+   区块验证

这些阶段对于区块链分布式账本的有效性和安全性都是非常重要的。

#### *交易传输*

区块创建过程的第一个阶段是持续发生的。在这个阶段，使用区块链系统的人们生成交易并将其传输到区块链网络中的同伴。

例如，比特币用户可能会在将交易发送到直接相连的网络节点之前生成并数字签名一个交易。收到这笔交易后，这些节点将其转发给他们的同伴，使得交易能够传播遍整个网络。

在传输时，这笔交易不被认为是分布式账本的一部分。节点维护着一个包含尚未包含在区块中的待处理交易的数据池。当创建区块的时候，区块创建者会从这个池中提取信息来构建分布式账本接下来的部分。  #### *区块创建者选择（共识）*

这个区块创建过程的这一阶段使用前面描述的共识算法来选择下一个区块的创建者。区块链网络没有中央权威来决定每个区块的内容；然而，它需要某个人来创建网络其余部分将接受的区块的官方版本。区块链共识算法确保以去中心化的方式完成这一过程，以确保没有人能控制账本。

这一步骤可能根据区块链使用的共识算法在区块创建过程的早期或晚期发生。在工作量证明中，由于成为区块创建者的标准是生成有效区块的能力，因此需要在共识完成之前创建区块。在权益证明中，选择区块创建者的依据不是区块的内容，因此在新区块构建之前完成。  #### 区块构建

选定的区块创建者有几个责任。第一个是为区块链（最大尺寸等）的要求组装区块。第二个是确保区块是有效的。

生成新区块时，区块创建者对其内容拥有完全控制权。许多区块链包含了交易费用的概念，用户可以为他们的交易支付费用以在新块创建时获得优先权。一个贪婪的区块创建者应该创建包含最高可能交易费用的区块，因为他们将收到他们区块中的费用；然而，并没有义务这样做。正因为如此，区块创建者在区块链网络中拥有很大的权力，这也是为什么系统保持去中心化如此重要的原因。

区块创建者的另一个重要责任是确保他们创建的区块的有效性。区块链中的主要威胁之一是双重支付攻击，用户创建相互冲突的交易（即向两个不同的收款人发送相同的加密货币）。区块创建者有义务确保他们的区块在账本中不创建任何双重支付。不这样做的话，未来区块创建者可能选择不在其区块上构建，使区块孤立并使区块创建者失去他们创建区块所获得的奖励。  #### 区块传输

一旦一个区块完成，它的创建者会数字签名并将其传输到区块链网络的其余部分。这模仿了交易传输的过程，其中网络中的每个节点在收到它后将其传输给他们的同伴。  #### 区块验证

最后，网络中的每个节点在将区块添加到他们分布式账本官方副本之前需要验证一个区块。共识算法试图确保网络中只有一个节点创建区块，但它不能保证节点不是恶意的。网络中的每个节点执行与区块创建者应该做的相同的双重支付搜索，并且仅当它满足区块链的所有要求时才接受区块。#### 攻击区块创建

区块创建过程对于更新分布式账本和使区块链运行至关重要。然而，这一过程的设计使它容易受到针对区块链可用性和它所包含数据完整性的攻击。

#### 服务拒绝

服务拒绝攻击是针对任何系统的常见攻击类型。通过使系统某个组件处理输入的能力过载，它降低了或破坏了系统整体的有效性。尽管区块链的去中心化使其对某些服务拒绝攻击免疫，但其他攻击仍然可能发生。

一种针对区块创建过程的服务拒绝攻击涉及交易洪水。通过创建大量垃圾交易并将其发布到区块链，攻击者可以对区块链的功能产生短期和长期影响。

在短期内，交易洪水影响合法交易添加到分布式账本的能力。区块链通常具有固定的区块大小和区块率，这意味着它们有一个固定的最大容量。如果攻击者的垃圾交易占据了这部分容量，它就会降低区块链处理合法交易的能力。

区块链对抗垃圾交易的一种方式是通过包含交易费用，使攻击者支付攻击区块链的成本。然而，如果攻击者不因成本而却步，这可能会对区块链产生另一种短期影响。为了在攻击期间将交易添加到账本，合法用户将不得不支付更高的费用以获得优先权。增加系统使用的成本会降低其可用性。

这种攻击的潜在长期影响是区块链的膨胀。区块链技术的一个关键特性是其不可变性，意味着一旦交易记录在账本上，就必须永远保存（并在验证时进行检查）。分布式账本上的每一个垃圾交易都会使系统变得不那么可用。

这只是可能影响区块创建过程的一种服务拒绝攻击。区块创建也可能因任何抑制区块创建、传输或验证的攻击而受到干扰，例如针对区块创建者的分布式拒绝服务（DDoS）攻击或试图干扰点对点网络上的通信。

##### 应对措施

保护免受这类服务拒绝攻击需要受影响节点的单独行动。例如，区块创建者可以拒绝在他们的区块中包含垃圾交易，以防止它们影响数字账本，并部署 DDoS 缓解解决方案。

然而，这些方法有其挑战，例如区分合法交易和垃圾交易。此外，这需要依赖特定的节点来保护区块链，这违反了区块链的去中心化目标和对其他节点的信任要求。  ##### 案例研究

索拉纳区块链曾多次遭遇可能为交易洪水 DDoS 攻击或合法流量压垮网络的事件。⁸ 这些事件利用了索拉纳区块链交易费用极低（每笔交易 0.00025 美元）的事实，使得用垃圾交易淹没区块链网络变得负担得起。

其他区块链经历过旨在为攻击者获利的 DDoS 攻击。2020 年 3 月的一次攻击导致以太坊网络出现重大拥堵，同时以太币的价值大幅下跌。这种价格下跌导致 MakerDAO 借贷平台上的抵押品被拍卖。攻击者能够以零出价交易赢得拍卖，因为竞争性出价无法通过，从而获得 830 万美元。⁹  #### *抢跑交易*

在区块链上，交易公开传输与分布式账本中纳入之间的时间延迟创造了“抢跑”攻击的潜在可能。一个区块链系统可能存在这样的情况：第一个提交解决方案具有实际利益。例如，可以在区块链上运行拍卖，如果两个出价者愿意出的最高价相同，那么先提交出价的人获胜。

在区块链上，提交出价需要创建并广播一个交易给网络。在广播时，这个交易不被信任或被视为分布式账本的一部分。相反，它被存储在与类似的不信任交易池中，直到下一个区块准备好被创建。在这个时刻，区块创建者将构建一个可能包含此交易的区块并将其添加到区块链上。

如果这个区块创建者是由自我利益驱动的（这是区块链所鼓励的），他们将会根据相关交易费用来排序区块中的交易。这意味着后来创建但费用更高的交易将会被优先考虑。因此，在拍卖中观察到出价交易并做出相同出价但费用更高的参与者很可能会首先被拍卖师看到并选择。在区块链上，第一个创建的交易不一定是最先处理的。

##### 应对措施

抢跑攻击利用了交易在包含在区块之前先公布于区块链网络的事实。这为攻击者提供了一个窗口，在窗口期内创建一个可能首先被添加和处理的有竞争关系的交易。

解决这个问题的一种方法是独家采矿，即交易创建者只与一个潜在的区块创建者分享交易。当这个节点下一次被选中创建区块时，他们可以在其中包含该交易。这防止了前置运行，因为只有在交易已经添加到账本后，它才会被公开。除非攻击者进行 51%攻击，否则前置运行交易无法出现在之前。

这种方法在过去曾被用来在黑客之前利用漏洞保护交易。2020 年，一个针对 Lien Finance 智能合约的白色黑客利用了独家采矿，保护了超过 960 万美元的代币免遭攻击者盗窃。¹⁰这次利用涉及 SparkPool 矿池的独家采矿，以保护免受前置运行攻击。##### 案例研究

前置运行攻击在去中心化金融（DeFi）领域很常见。自动化机器人扫描待处理的交易池，寻找可以利用的交易，通过前置运行交易以低价买入和高价卖出。

尽管这些机器人旨在利用其他区块链用户，但它们偶尔会带来更多的好处而非坏处。例如，在针对 DODO 去中心化交易所（DEX）的攻击中，一个机器人通过“前置运行”攻击者试图利用脆弱的 DEX 的交易。¹¹从协议中提取的 380 万美元代币中，189 万美元由机器人取出，后来由机器人的所有者归还给协议。#### SPV 采矿

前面提到了 SPV 采矿，因为它是对工作量证明（Proof of Work）共识的攻击。然而，它也适用于区块创建过程。SPV 矿工故意跳过区块创建过程中的步骤，以获得优势。

一个合法的矿工必须下载区块链中每个块的完整副本，然后验证他们的新块是否在与自己的块奖励相同的区块中创造了双重花费。SPV 矿工跳过这两步，因为只包含矿工的块奖励的区块不可能包含双重花费。### 区块创建的威胁建模

将针对区块创建的攻击映射到 STRIDE 威胁模型中，突出了以下威胁：

+   **篡改：**前置运行攻击旨在允许后来者先处理较早的交易，从而改变这些交易的影响。

+   **服务拒绝：**攻击者可以以多种方式执行服务拒绝攻击，减缓或阻止区块创建以及数字账本中交易的添加。

+   **权限提升：**SPV 采矿为攻击者提供了创建区块的概率增加和更大程度地控制数字账本内容的机会。## 结论

区块链协议定义了区块链的理论。共识算法描述了如何让相互不信任的区块链节点共同选择区块生产者，而区块创建协议概述了网络将如何组织和验证交易以更新区块链账本。

在下一章中，我们将从理论转向实践。区块链系统作为运行在计算机上的软件，并通过现代网络进行通信。这种底层基础设施带来了新的安全考虑和潜在的攻击向量。## 注释

1.  1. `[`lamport.azurewebsites.net/pubs/byz.pdf`](https://lamport.azurewebsites.net/pubs/byz.pdf)`

1.  2. `[`hacked.slowmist.io/en/?c=Blockchain`](https://hacked.slowmist.io/en/?c=Blockchain)`

1.  3. `[`blog.theabacus.io/the-verge-hack-explained-7942f63a3017`](https://blog.theabacus.io/the-verge-hack-explained-7942f63a3017)`

1.  4. `[`decrypt.co/3506/spy-mining-hits-ethereum`](https://decrypt.co/3506/spy-mining-hits-ethereum)`

1.  5. `[`decrypt.co/3506/spy-mining-hits-ethereum`](https://decrypt.co/3506/spy-mining-hits-ethereum)`

1.  6. `[`medium.com/@dsl_uiuc/fake-stake-attacks-on-chain-based-proof-of-stake-cryptocurrencies-b8b05723f806`](https://medium.com/@dsl_uiuc/fake-stake-attacks-on-chain-based-proof-of-stake-cryptocurrencies-b8b05723f806)`

1.  7. ``cointelegraph.com/

1.  [8`. `[`cryptonews.com/news/solana-reportedly-went-down-again-after-ddos-attack.htm`](https://cryptonews.com/news/solana-reportedly-went-down-again-after-ddos-attack.htm)`

1.  9. `[www.coindesk.com/tech/2020/07/22/mempool-manipulation-enabled-theft-of-8m-in-makerdao-collateral-on-black-thursday-report](https://www.coindesk.com/tech/2020/07/22/mempool-manipulation-enabled-theft-of-8m-in-makerdao-collateral-on-black-thursday-report)`

1.  10. `[`samczsun.com/escaping-the-dark-forest`](https://samczsun.com/escaping-the-dark-forest)`

1.  11. `[`dodoexhelp.zendesk.com/hc/en-us/articles/900004851126-Important-update-regarding-recent-events-on-DODO`](https://dodoexhelp.zendesk.com/hc/en-us/articles/900004851126-Important-update-regarding-recent-events-on-DODO)`
