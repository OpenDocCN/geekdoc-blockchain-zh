# 第三章。超级账本 Fabric 架构和组件

在上一章中，我们调查了四代区块链技术，接着是超级账本架构及其组件。我们还通过审查其项目、工具和库介绍了超级账本生态系统。本章将深入了解超级账本家族，重点介绍超级账本 Fabric 项目。在此过程中，我们将向您介绍所有超级账本 Fabric 组件，包括对构建区块链应用程序和理解其他章节中涵盖的概念都很重要的对等体、通道和链码。

本章将帮助您理解以下内容：

+   Fabric 与其他区块链开发平台的主要亮点

+   成员服务提供者、CA 和身份在 Fabric 权限网络中的角色

+   Fabric 中账本的角色

+   Fabric 网络的主要组成部分

+   对等体在 Fabric 网络中扮演的角色

+   对等体处理交易的机制

+   Fabric 权限网络中私有数据和数据收集的角色

# 超级账本 Fabric 概述

*超级账本 Fabric* 作为一个代码库项目开始，结合了数字资产控股（现称为数字资产）、Blockstream 的 Libconsensus 库以及 IBM 的开放区块链平台之前的工作。Fabric 提供了一种独特的弹性和可扩展的架构，其性能优于其他替代区块链平台。Fabric 与其他超级账本项目、库和工具非常配合，使其成为一个全功能的区块链平台。Fabric 网络可扩展，以满足企业应用程序的需求。

Fabric 是构建分布式账本解决方案的平台。它带有几个方便的功能，例如模块化架构，提供高度的保密性、灵活性和可扩展性。这种模块化架构使得像共识和成员服务这样的组件能够作为即插即用的附件。此外，Fabric 设计成能够适应技术变化，通过满足经济生态系统的复杂性。最后，Fabric 革命性之处在于它允许实体进行保密交易，而不必通过中央机构传递信息。

在本章的剩余部分，我们将回顾各种 Fabric 组件，以提供对其强大功能的全面认识。到本章结束时，你将对为什么 Fabric 正成为企业区块链实施的显著选择有着坚实的理解。

# Hyperledger Fabric 模型

在区块链应用开发中，开发者可以通过多种方式构建分布式账本技术。然而，Hyperledger Fabric 是一种独特的 DLT 实现，主要针对的是企业而不是个人。

Fabric 的架构将交易流程分为三个主要步骤，遵循执行-排序-验证范式。通过这样做，它让 Fabric 在不受信任的环境中执行不受信任的代码。执行-排序-验证范式单独将 Hyperledger 与其他广泛采用的无许可区块链（如比特币或以太坊）区分开来，后者只有执行-排序模型。以下是范式中步骤在 Fabric 系统中的执行方式：

1.  对于 Fabric 执行事务，它首先检查事务的正确性。然后 Fabric 为事务生成状态更新。执行事务的节点称为背书者。他们被召唤来验证并添加作为计算结果产生的一组状态更新。在此阶段，可以同时执行多个事务。因此，状态更新可能包含冲突。

1.  Fabric 排序服务遵循 Fabric 网络中定义的共识协议，无论事务语义如何。运行共识算法的节点称为排序者（稍后在本章中介绍）。

1.  Fabric 验证事务以确保满足两个条件：

    1.  事务按照给定的事务逻辑执行。

    1.  在提交的事务之间不存在状态冲突，即两个事务想要更新相同的状态。

        验证事务后，使用 *提交者* 节点将其添加到账本上。请注意，背书者也是提交者。

执行-排序-验证设计具有几个主要优点。首先，在顺序执行模型中，排序事务的节点也在执行它们。因此，将会针对两个假设进行验证：

+   排序是正确的。

+   计算被正确执行。

相反，Fabric 中的信任假设在共识和事务执行方面可能被不同对待。这使得 Fabric 具有极大的灵活性，特别是在保密性方面，因为只有网络的特定子集被调用来执行某些事务，而不是其他事务。

其次，执行-排序-验证设计使得网络的不同部分能够同时并行执行多个交易。这对系统的整体吞吐量非常有益，并解决了潜在的非确定性问题（即相同输入在不同环境中的行为不同）。灵活的认可策略指定了哪些对等方，或者其中多少个，应参与给定业务逻辑的正确执行。

Fabric 具有以下六个基本功能：

身份管理

*成员服务提供商*(*MSP*)处理身份管理。Fabric 提供了一个成员身份服务，管理用户 ID 并对网络上的所有参与者进行身份验证。对企业应用程序来说，这是一个巨大的优势，因为它们拥有大量的凭据。

隐私和保密性

在 Fabric 中实现隐私和保密性的一种方法是通过私有通道。简而言之，*私有通道*是受限制的消息路由，可用于特定子集网络成员之间的交易。这些私有通道在企业联盟成员之间尤其实用，因为子集成员可能希望共享私有数据而不影响网络其他部分的运行。

只要有序服务是可信的，通道就能够实现其承诺，因为所有交易都必须经过排序，因此它们的内容对该服务是可见的。当无法信任排序服务保密性时，Fabric 提供*私有数据集*(*PDCs*)。私有数据集可以被视为只对网络子集可见的分类账的一部分。我们稍后在本章中将更详细地讨论排序服务和私有数据集。

高效处理

Fabric 通过节点类型分配网络角色以提供并发性和并行性。这样的特性单独就会通过在 Fabric 网络中允许交易进行线程化以实现更快的处理而提高网络操作的性能。此外，只有网络的子集正在执行某些交易时需要了解业务逻辑；因此，它释放了其他网络的资源。这使得只在严格需要的地方加载业务逻辑成为可能，并且不将其提供给整个网络。

业务逻辑

智能合约，或链码，定义了构成交易执行的业务逻辑。业务逻辑可以用任何通用编程语言编写，而不需要系统依赖于本地加密货币。我们将在本章和后续章节中更详细地讨论这一点。

治理

治理模型提供了另一个重要的能力。在 Fabric 中，这些模型可以通过*policies*来表示。策略需要识别可以部署链码或向通道添加 MSP 的各方。它们是灵活的，并且可以通过发出适当的配置交易来根据需要进行更新。我们将在本章后面更详细地讨论政策的作用。

模块化架构

如前所述，Fabric 具有模块化架构，使其更具有适应性，同时允许其公共部分与其他网络共享。换句话说，一旦拥有模块化设计，Fabric 将产生一种通用的区块链架构，任何行业或公共领域都可以采用。

## 区块链网络

与其他区块链平台不同，Fabric 提供了一个网络，能够灵活满足各种项目规模，从基本的两个成员布局到由多个联盟组成的多层联盟，每个联盟都有多个成员。总体而言，网络在企业区块链平台的可扩展性和适应性中起着至关重要的作用。

Fabric 网络可能会因正在实施的项目而有所不同。Fabric 网络中的所有组织都将无限制地访问某些组件，而某些组件仅通过一个称为*orderer 服务*的独立节点分配给特定组织。因此，考虑到 Fabric 网络的逻辑特性，您可以开始理解 Fabric 内部运作所涉及的多个组件。

网络中的每个组织都可以部署任意数量的节点。作为私有和权限网络的超级账本所授予的信任是全面的，因为其网络中所有节点参与者的身份是已知的。

## 身份

在超级账本 Fabric 中，*身份* 的概念与我们稍后将看到的 MSP 的概念密切相关。网络中的每个组件——如节点、计算机、管理员和客户端——都有由一个或多个权威机构生成的认证凭证。这些凭证是将它们认定为网络操作者的身份。

一旦身份被颁发，它将根据其分配的策略在网络上运作。这意味着策略（本章后面将讨论）的工作是设置多个认证参数，例如谁有权访问什么，以及身份持有者在网络中可以执行什么操作。例如，只有具有特定管理权限的身份才能在给定的对等方上安装链码，或者只有具有写权限的身份才能请求向给定分类帐追加新交易。

Fabric 不会强加任何特定的身份基础设施/技术。这提供了很大的灵活性，使管理员能够在各种环境中部署 Fabric 网络。然而，默认情况下，Fabric 可以配置为支持任何*公钥基础设施*(*PKI*)。 PKI 是一种常用的基础设施，用于组织数字身份的管理（从发行到吊销）。数字身份通常绑定到一个加密密钥对（公钥/私钥）。在这种方案中，数字签名是使用数字身份所有者拥有的秘密密钥生成的，而任何人都可以使用的公钥用于验证这些签名。

最后但并非最不重要的，身份可以被吊销。当发生这种情况时，身份失去了在网络中操作的能力。用于吊销身份的机制取决于所使用的成员服务提供者，因此，用于组织数字身份的基础系统也有所不同。

通过利用我们在下一节中探讨的 MSP，可以支持其他组织数字身份的方式。

## 成员服务提供者

*成员服务提供者*(*MSP*)为 Fabric 提供了一个方便的抽象，隐藏了身份和认证的定义和验证背后的所有加密机制和协议。实际上，MSP 提供了一个通用的身份概念和断言其有效性的规则。此外，它基于数字签名的明确定义概念提供了身份验证的 API。

Fabric 使用一个或多个 MSP 来管理其网络中的身份及其生命周期。由于 MSP 抽象，不同成员标准和架构之间的互操作性成为现实。事实上，当创建新通道时，管理该通道的 MSP 列表必须包含在创世区块中。然后可以通过发出适当的通道配置交易来随后更新此列表。

另一方面，MSP 不规定身份应该如何发放，只规定了应该如何验证身份。事实上，一旦身份被发放并分配给一个 Fabric 实体，这个实体就可以开始与网络交互。例如，客户端使用这些凭据来验证他们的交易，而对等体使用这些凭据来验证交易处理结果（认可）。

更具体地说，让我们考虑基于 X.509 标准的 Fabric 默认 MSP 实现。*X.509* 标准通常用于互联网，规定了公钥证书的格式和使用方式。这些证书携带了公钥以及这些密钥的所有者的信息。每个证书都由一个证书颁发机构签名，其公钥存储在另一个称为*根证书*的证书中。中间证书也是允许的，形成一条认证链。

在这个背景下，基于 X.509 的 MSP 是由一组根和中间证书来定义的，这些证书用于标识身份认证的信任源，以及一个证书吊销列表（CRL）。一个身份简单地就是一个 X.509 证书。如果相应的证书由 MSP 中列出的权威机构之一颁发，并且不在吊销证书列表中，我们说这个身份在给定的基于 X.509 的 MSP 下是有效的。请记住，证书颁发机构通常会维护 CRL。当一个权威机构更新其 CRL 时，MSP 的定义必须相应地更新。在 Fabric 中，可以通过发布有效的配置事务来更新 MSP 定义。我们将在接下来的章节中详细讨论这个问题。

总结一下，基于 X.509 的 MSP 使 Fabric 能够支持几乎任何 PKI，其证书由市场上主要的证书颁发机构（与浏览器中通常使用的相同）颁发。如果需要，可以通过使用 Hyperledger Fabric CA 来实现 PKI，这是一个 Fabric 的伴随项目，实现了证书颁发机构。

值得一提的是，X.509 不是 Fabric 支持的唯一技术。为了额外的隐私，Fabric 配备了一种称为 *Identity Mixer* (*Idemix*) 的技术。这种加密协议提供了强大的身份验证同时保持隐私。这使得交易者可以获取与网络交互的有效成员状态，同时保护自己的身份。同样，交易者可以在不透露任何签名痕迹的情况下签署多个交易。虽然交易者的匿名操作是可能的，但交易内容仍然可以用于将多个交易链接在一起，并需要通过其他方式保护，例如使用私有数据集合或像 ZKPs 这样的高级加密技术。

在这一点上，应该清楚 Fabric 的许可性质在很大程度上取决于给定网络中可用的 MSPs。在一个极端情况下，只要给定网络配备了一个像比特币那样接受任何公钥的 MSP，Fabric 就变得无需许可。在这种情况下，签名方案的公共参数被设置在创世块中。（一个例外仍然可以由订单者代表，其身份可能在创世块中被固定。）

正如我们所见，MSP 为 Fabric 提供了一个明确定义的身份概念，复杂的访问控制策略可以在此基础上定义。

## 策略

在前一节中，您看到 MSP 赋予了 Fabric 识别有效身份的能力。然后，*策略*是 Fabric 提供的用于思考这些身份的工具。策略配置了网络内如何做出决策的结构。换句话说，这些策略配置了谁可以在网络的哪个元素上做什么。

策略在 Fabric 中是首要的，并且它们是设置网络治理的黄金工具。策略规定了谁被允许访问给定账本，谁可以部署链代码，以及谁可以升级通道配置。

Fabric 中我们遇到策略的第一个地方是 *系统通道*。每个 Fabric 网络必须定义一个系统通道，其中包含了识别形成排序服务的各方（也称为 *排序组织*）的 MSP，以及识别可以在网络中进行交易的身份的 MSP（也称为 *联合组织*）。然后，使用这些 MSP，系统通道通过包含在系统通道创世块中的策略来确定谁可以创建应用通道（或简称 *通道*）。

通道的 *创世块* 是我们遇到策略的第二个地方。事实上，创建一个新通道意味着设置策略来添加和删除成员，并在定义和提交到通道之前批准链码等。如果未设置策略，则从系统通道继承。

管理员可以通过发出适当的配置更新事务来更新通道的配置。此事务必须由足够多的实体背书，这些实体一起可以满足目标更新的特定策略。事务提交后，更改将被视为操作性。

在 Fabric 中最常用的策略形式称为 *签名策略*。这只是一个单调布尔表达式。支持的布尔运算符有 `AND`、`OR` 和 `NOutOf`，它们可以灵活组合。以下是一个示例：`OR('Org1.peer', 'Org2.peer')`。此策略要求至少一个对等身份，在名为 `Org1` 或名为 `Org2` 的 MSP 下有效，提供签名。

这个例子还展示了 Fabric 提供的另一个有用工具，称为 *MSP 主体*。主体表示具有某些共同特征的一组身份。例如，`peer` MSP 主体标识在 Fabric 网络中作为对等体的所有身份。Fabric 提供了一系列方便的原则来识别客户端、对等体、排序器、管理员等。

总之，策略是管理员可以使用的工具，用于管理 Fabric 网络。可以设置策略以通过允许任何人执行任何操作（再次说明，订购服务可能是一个例外）来配置网络为无权限，也可以设置策略以限制对特定过程的访问。

## 节点

*节点* 是区块链的通信实体。节点在某种程度上只是逻辑功能，这意味着不同类型的多个节点可以在同一物理服务器上运行。重要的是将节点分组 *成可信域* 并与控制它们的逻辑实体相关联。

节点具有身份，此身份允许节点执行某些操作。我们可以在 Fabric 网络中识别以下节点：

客户端

初始化 Fabric 中交易的生命周期。

背书者

负责执行封装在称为 *链代码* 的程序中的业务逻辑。

订购者

参与共识算法以决定交易的顺序。

提交者

从订购者处获取分类帐，并应用验证逻辑以建立每个已排序交易的有效性。认可者也是提交者。

有时我们会用 *对等方* 这个词来指代背书者或提交者之一。

## 链代码

在 Hyperledger Fabric 中，广泛使用的术语 *智能合约* 被称为 *链代码*。链代码是实现应用逻辑并在执行阶段运行的代码片段。除了公开预定义接口外，链代码开发人员可以自由编码计算方式，以最好地实现他们的目标。例如，Fabric 不要求链代码是确定性的。

Chaincode 被安装并在通道的对等节点上实例化，以便由合适授权的成员执行，并通过 *Fabric 链代码生命周期*。通过类似的过程也可以更新链代码。

每个链码必须定义一个*背书策略*，由验证阶段的提交者进行评估。典型的背书策略允许链码以一组对于交易必要的背书者的形式指定背书者。它代表了对编码在链码中的特定业务逻辑的正确执行的信任假设。

一个链码必须公开两个函数：`Init`和`Invoke`。`Init`用于初始化链码可能需要的任何数据结构，仅在初始化时调用一次。`Invoke`是链码提供的业务逻辑的入口点。链码接收参数，并根据这些参数决定要执行的操作。

一个链码可以被看作是账本中的一个命名空间，它组织了由该链码管理的一组键值对。这些键值对可以通过完成 Fabric 交易生命周期来进行更改。让我们回顾一下这个生命周期。要成功提交交易，需要以下步骤：

1.  提出交易。客户端准备并发送交易提案到目标链码的背书者。交易提案指定了链码和链码调用的参数。

1.  执行交易提案。接收提案的背书者执行或模拟使用提案中提供的参数在链码中运行（调用`Invoke`函数）。模拟的结果包括一个返回值和一个读/写集。

    *读/写集* 是一个数据结构，用于记录对世界状态的更新以及对其依赖关系（更多内容请参阅“账本”）。*读集* 包含一组唯一键和它们当前的版本号（值不需要添加，因为网络已知）。另一方面，*写集* 包含更新后的唯一键列表。在这种情况下，必须包含分配给键的新值。最后，可以使用一个标记来表示一个键已被删除，并且在世界状态中不应再可用。

    我们将链码的执行称为*模拟*，因为在此阶段世界状态不会改变。这些仅是对世界状态的建议性更改，需要稍后进行验证。执行链码的所有对等方都会签署执行的输出并将其发送回应用程序。此签名称为*背书*。

1.  组装事务。客户端将所有背书人的响应（背书）捆绑到一个事务中（一个背书者事务），并将其发送到排序服务。

1.  对事务排序。排序服务收集传入的事务，并根据共识算法将它们组装成块。一旦一个块完成，排序服务就会将其发送给提交对等方。

1.  验证事务。当提交对等方接收到一个新块时，它们将其附加到账本上，并验证该块中的每个事务。验证包括确保满足两个要求：事务的背书满足该链码的背书策略，并且读/写集不与已提交的并发更新冲突。只有当事务有效时，世界状态才会通过应用读/写集中的更改而更新。

1.  决定事务的最终性。作为非强制步骤，客户端可以联系网络中选定数量的对等方，询问事务的最终性。

一个链码也可以被调用来检索状态信息，作为计算的结果或者仅仅是在世界状态中查找（例如，某个键的值）。这个操作有时被称为 *查询*。在这种情况下，步骤 3 到 6 可以被避免。客户端只是检索信息，而不是更新。假设客户端决定组装一个包含接收到的背书的交易并提交该交易进行排序。在这种情况下，客户端是在进行 *强查询*，因为结果在账本上有时间戳，可以被任何人验证。

长话短说，背书人不区分调用还是查询。入口点始终是 `Invoke` 函数。

## 账本

*账本* 是整个区块链以及 Hyperledger Fabric 中的一个基本组成部分。账本以相同的副本存储在构成网络的每个节点中。因此，每个 Fabric 通道都与一个账本绑定。注意，一个 Fabric 网络可以包含多个通道，在这个意义上，通道可以被看作是在多个分片中分割数据的一种方式。

当我们谈论账本时，我们指的是两个关键概念：世界状态和区块链。*世界状态* 是区块链的一部分，它指的是其中包含的最新数据的键值对。这是访问存储数据的一种更简单的方式。而 *区块链* 则更大。它是区块链中存储的所有记录，以交易形式存储。这些交易存储在块中以供以后查询。

由于 Fabric 使用的执行-排序-验证模型，账本可以区分为 *原始账本* 或 *验证账本*。前者表示由订单服务排序的交易序列；后者表示有效交易的序列。世界状态是从验证账本构建的。

## 订单服务

排序者运行*排序服务*——一种提供交付保证的通信。排序服务可以以各种方式实现：从集中式服务（例如，在开发和测试中使用）到针对不同网络和不同类型节点的分布式协议。

排序服务为 Fabric 网络的节点提供了共享通信通道，为包含交易的消息提供了广播服务。客户端连接到排序服务，并且可以在给定通道上广播消息，只要客户端有权限这样做，这些消息就会被传递到所有对等方。通道将相同的消息广播到所有连接的对等方，并按照相同的逻辑顺序发送给所有对等方。通信的消息是区块链状态中包含的候选交易。

简而言之，一组定义好的节点对交易进行排序并将其广播到所有连接的对等方。一些对等方可以直接与排序服务交互，以在网络中广播区块以加快区块传递速度。这样的传播过程通过一种八卦协议进行，通过阻止每个对等方连接到排序服务特别有用。

## 私有数据集合

在 Hyperledger Fabric 技术的演变中，其中一个最大的是创建*私有数据集合*（*PDCs*）。PDC 的两个主要用例如下：

+   当无法信任排序服务的保密性时

+   当一个单一分类账或 Fabric 通道中的数据需要被划分并且只对特定方参与方可见时

每个 PDC 都附属于一系列组织和属性，这些组织和属性定义了私有数据应如何传播和认可。在 Fabric v2+ 中，PDC 定义是链代码定义的一部分。链代码开发人员可以使用特定的 API 来操作这些集合。

然后，PDC 可以被视为在链码命名空间中定义的子命名空间。PDC 包括一个私有部分和一个公共部分。私有部分包含通过对属于 PDC 的组织的对等节点进行点对点协议传播的数据。公共部分包含私有数据的哈希，这些哈希经过认可并提交到账本。默认情况下，这些哈希值未经盐处理；因此，它们可能容易受到字典攻击。链码开发人员应使用适当的策略来避免这种情况。

# 摘要

在本章中，您了解了 Hyperledger Fabric 的特性和组件。我们首先回顾了其关键特性，如资产、隐私和共识。然后我们讨论了区块链网络的以下重要元素：身份、成员服务提供商、策略、对等节点、智能合约和链码、账本、排序服务和私有数据集。了解 Fabric 网络及其组件如何相互作用对于在 Hyperledger Fabric 中构建区块链应用程序至关重要。

我们希望您现在已经为在 Fabric 中构建您的第一个区块链应用程序打下了良好的基础。确实，本章为您提供了企业 Fabric 区块链应用程序中通常与彼此配合使用的所有部分的高级概述。

简而言之，在所有之前的章节中，我们通过逐步介绍区块链、Hyperledger 家族和 Hyperledger Fabric 的概念，从高级层次结构逐渐转向低级别。现在我们已经涵盖了所有的实际概念，我们将继续进行编码。在下一章中，我们将通过构建第一个链码或 Fabric 智能合约来开始进行实际编码。
