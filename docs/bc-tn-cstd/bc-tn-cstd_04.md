©作者（们），受 APress Media, LLC 独家授权，Springer Nature 的一部分 2023 吴布赖恩，吴布里吉特《区块链青少年》[`doi.org/10.1007/978-1-4842-8808-5_4`](https://doi.org/10.1007/978-1-4842-8808-5_4)

# 4. 以太坊：通往加密货币的门户

布莱恩·吴（Brian Wu）和布里吉特·吴（Bridget Wu）(1)新泽西州，美国，Livingston

艾伦·图灵是一位数学家、逻辑学家和计算机科学家，被广泛认为是计算机科学之父。在 20 世纪 30 年代，他发明了通用图灵机。假设有足够的内存可用，图灵机只需使用两个符号（0 或 1）组成的潜在无限一维序列，就可以计算任何东西。这是第一台计算机的基础。图灵完备性因此指的是任何可以在图灵完备环境中解决和实现的问题，无论多么复杂。

Ethereum，继比特币之后的第二大加密货币，被认为是一个分布式图灵机。它引入了一个内置的图灵完备编程语言——智能合约，可用于创建各种去中心化应用程序（也称为 Dapps）。

上一章介绍了比特币作为区块链技术的第一个体现和世界上最受欢迎的加密货币。

在本章中，我们将继续探索作为图灵完备区块链构建的以太坊区块链。本章从以太坊的历史开始。从那里，我们涵盖了以太坊许多基本概念和基本操作，包括以太币、燃料和以太坊账户。然后，为了更深入、更全面地了解以太坊，我们探讨了以太坊虚拟机（EVM）的大图景概述。我们还将看到重要的以太坊客户端和节点实现。最后，我们讨论了以太坊的工作原理以及探索以太坊的内部架构。

本章的一个目标是帮助您掌握理解以太坊机制所需的必要技术背景，并让您为在下一章开发您的第一个去中心化应用程序做好准备。

本章围绕几个主要主题组织：

+   Ethereum 的历史

+   了解以太坊

+   以太坊是如何工作的

## Ethereum 的历史

维塔利克·布特林是一位俄罗斯-加拿大作家和程序员，自 2011 年以来一直参与比特币和加密货币，就在比特币创建后的两年。维塔利克成为了一名作家，为比特币杂志网站的每篇文章赚取 5 个比特币。很快，他成为了《比特币杂志》的联合创始人。布特林加深了对比特币的理解，成为了一名比特币专家，并意识到了比特币功能的局限性。2013 年，维塔利克环游世界六个月，学习、会见并与其他比特币开发者交流。他意识到，通过在比特币的基础上进行迭代，他可以构建一个全新的、潜在更好的区块链版本。

### 白皮书发布（2013 年 11 月）

2013 年 11 月，19 岁的 Vitalik 发表了题为《以太坊：下一代智能合约和去中心化应用平台》的白皮书，探讨了以太坊的一般概念。

解释以太坊概念的白皮书包括以下内容：

+   它提供了一个内置的图灵完备编程语言，可以用来创建“智能合约”——只是一个在区块链上运行的自我执行程序。

+   它建立了区块链上的点对点交易。该平台可以创建和构建智能合约和去中心化应用程序，允许任何人定义、创建和交换各种价值类型：加密货币、股票以及许多其他资产。

### 黄皮书发布（2014 年 4 月）

2014 年 4 月，Gavin Wood 博士发表了以太坊黄皮书，给出了以太坊协议的技术定义——以太坊：一个安全的去中心化通用交易账本，描述了以太坊协议的技术定义。

### 以太坊的诞生（2014 年 7 月）

2014 年 1 月，在迈阿密的北美比特币会议上，以太坊被公开宣布。作为一个非营利组织，以太坊基金会于 2014 年 7 月 6 日在瑞士楚格成立。以太坊的创始成员包括 Vitalik Buterin、Gavin Wood、Charles Hoskinson、Anthony Di Iorio、Mihai Alise 和 Joe Lubin。

### 启动以太币众售（2014 年 7 月至 9 月）

2014 年 7 月 20 日，以太坊基金会启动了一个为期 42 天的众筹活动。2014 年 9 月 2 日，公共众售结束。以太坊基金会筹集了 31,591 个比特币，这在售罄时大约是 1800 万美元。

### 以太坊发布（2015 年 6 月）

2014 年至 2015 年间，许多原型概念被开发出来。“奥林匹克”是第九个也是最后一个原型。2015 年 6 月 30 日，以太坊上线，第一个“创世区块”被创建。

### DAO 攻击（2016 年 7 月）

2016 年 5 月，开发者在以太坊区块链上创建了一个去中心化匿名组织（DAO）。该 DAO 使用智能合约进行自我治理和自动化决策，没有典型的集中式管理结构。任何人都无论其位置如何都有权参与和投票。首个 DAO 众售非常成功。它筹集了创纪录的 1270 万以太币（在当时价值约 1.5 亿美元）来资助项目。

然而，2016 年 6 月 17 日，一名黑客利用了 DAO 智能合约中的某些漏洞。黑客能够多次调用 DAO 智能合约以在智能合约更新其余额之前退还以太币。黑客成功窃取了超过 360 万个 ETH（在当时价值约 5000 万美元）。

由于 DAO 投资者损失了大量资金，以太坊社区决定回滚攻击以退款损失的资金，导致以太坊分叉成两个区块链。一个是当前的以太坊区块链。代币所有者按 1 ETH 兑换 100 DAO 代币的汇率获得，与首次发行相同。恢复了 DAO 投资者的损失资金。2016 年 9 月，数字货币交易所将 DAO 代币除名。与此同时，以太坊社区的一部分不同意硬分叉，决定继续维护旧区块链，现称为以太坊经典。

### 以太坊 2.0（合并）

近年来，以太坊社区开始从以太坊 1.0 迁移到以太坊 2.0，也称为 Eth2、合并或宁静。以太坊 1.0 是基于工作量证明区块链创建的。与以太坊 1.0 相比，2.0 有几个主要优势。表 4-1 显示了这些差异。表 4-1

对比以太坊 1.0 和 2.0

|   | 以太坊 1.0 | 以太坊 2.0 |
| --- | --- | --- |
| 共识 | 使用工作量证明（PoW）共识。 | 使用权益证明（PoS）共识。 |
| 速度 | 网络每秒可以处理大约 15 笔交易（15 TPS）；它经常导致网络拥堵和延迟。 | 与维萨相比，以太坊 2.0 网络的潜在 TPS 可扩展到 100,000，而维萨为 30,000。 |
| 能源 | 工作量证明（PoW）要求矿工消耗大量计算能力来解决一个复杂的数学难题。 | 以太坊 2.0 通过质押其代币作为抵押资产来检查和验证交易以及添加区块。它需要的硬件功率最小，可以比工作量证明（PoW）共识减少 99%的资源。 |
| 安全性 | 一些强大的矿工群体可能控制网络 50%以上的活动，可能导致 51%攻击等漏洞。 | 在以太坊 2.0 中，它更加去中心化。网络需要大约 16,384 个验证者。用户只需质押 32 个以太币就可以参与验证以太坊网络。即使以太币较少，用户也可以加入一个矿池，使大家能够一起质押并分享奖励。在区块链上没有矿工控制。 |

| 燃气费（交易费）| 由于网络每秒只能处理有限数量的交易，导致所谓的“燃气费”高昂，交易缓慢。通常，每笔交易的平均燃气费约为 12 美元。随着需求的急剧上升，燃气费可能会很高，例如 100 美元。 | 以太坊 2.0 使用权益证明（PoS）共识来处理几乎零燃气费的交易。因此，它只收取一些基本费用以避免网络上恶意活动。 | 启动以太坊 2.0 有三个阶段，如图 4-1 所示，完全推出以太坊 2.0 需要几年时间。![](img/535492_1_En_4_Fig1_HTML.jpg)

一张描绘以太坊 2.0 三个阶段的插图展示了从 beacon 链的阶段 0 到合并阶段的阶段 1，最后到分片链阶段的 2。

图 4-1

以太坊 2.0 的三个阶段

#### 阶段 0 – Beacon Chain

阶段 0 始于 2020 年 12 月正式推出的 Beacon Chain。Beacon Chain 在以太坊网络上建立基于权益证明（PoS）并管理验证者注册表。

#### 第一阶段 – 合并

在这个阶段，以太坊主网络与 Beacon Chain 合并。它正式结束了网络上的工作量证明（POW）共识并开始使用权益证明（PoS）。2022 年 9 月 15 日，以太坊从原有的工作量证明机制切换到权益证明，这一过程被称为“合并”。合并减少了以太坊约 99.95%的能源消耗。

在 Beacon Chain 上质押以太坊的用户可以成为验证者。

交易和 Dapp 将继续以与之前相同的行为运行。

#### 第二阶段 – 分片链

在这个阶段，分片链将被引入网络。同时，以太坊主网络将被分成 64 个分片。每个分片都可以运行一个功能完备的智能合约。网络允许每个分片彼此之间进行通信。

## 了解以太坊

在比特币网络中，比特币被视为数字黄金，被设计为一种交换媒介和价值储存手段。比特币为人们提供了一种使用去中心化方式（没有中央银行）从一个人转移到另一个人价值的支付方式。另一方面，以太坊网络是一个图灵完备的区块链。这个网络是用一种叫做 Solidity 的图灵完备编程语言构建的，它可以在以太坊虚拟机（EVM）上运行。用户可以在 EVM 中创建和运行去中心化应用程序（Dapps）。EVM 是所有以太坊账户和智能合约的所在地。作为以太坊区块链的原生货币，以太币（Ether）被 Dapp 在以太坊网络内部使用以处理交易。例如，当智能合约执行一个交易时，Dapp 必须为矿工执行挖矿工作支付一个燃气费（以太币）。

### 以太币（单位）

每个区块链都有自己的原生货币。与比特币相似，以太坊区块链的原生货币被称为以太币（ETH）。

以太币作为“燃料”，用于支付在 EVM 上执行智能合约的费用。当矿工解决计算谜题时，他们将获得以太币作为货币奖励。以太币也可以用于支付，用户可以将以太币发送给其他用户作为支付。

就像美元一样，有七种面额：$1、$2、$5、$10、$20、$50 和$100，以太坊也被划分成不同的面额。以太坊最小的货币单位被称为 Wei，这个名字来源于数字货币和加密技术的先驱 Wei Dai。Wei 创造了 Crypto++ 加密库，并发明了 B-money。其他单位包括 Gwei、Mwei、Kwei、微以太坊和毫以太坊。它们也有其他的名称。例如，毫以太坊也被称为 Finney，这个名字来源于另一位数字货币先驱，哈罗德·托马斯·芬尼二世（Harold Thomas Finney II），他在 2004 年实施了世界上第一个可重用的工作量证明系统（RPOW），在比特币之前。2009 年 1 月，芬尼收到了比特币网络的第一笔交易。表 4-2 列出了以太坊的命名面额和其他单位：表 4-2

以太坊的货币单位和名称

| 单位名称 | 以 Wei 的值 | 以太坊 |
| --- | --- | --- |
| Wei | 1 wei | 10^(-18) ETH |
| 千 Wei（Babbage） | 1,000 wei | 10^(-15) ETH |
| Mwei (Lovelace) | 10⁶ wei | 10^(-12) ETH |
| Gwei (Shannon) | 10⁹ wei | 10^(-9) ETH |
| 微以太坊（Szabo） | 10¹² wei | 10^(-6) ETH |
| 毫以太坊（Finny） | 10¹⁵ wei | 0.001 ETH |
| 以太坊 | 10¹⁸ wei | 1 ETH |

### 气体、气体价格和气体限制

像比特币一样，以太坊目前使用工作量证明（PoW）共识机制。它要求矿工计算和解决复杂的数学难题，验证交易，并创建一个交易区块以添加到区块链中。矿工将获得以太币（ETH）奖励。当用户提交交易时，他们需要支付以太币以供矿工执行此类工作。

根据 coinwarz.com 的数据，假设你使用一台 hash 率为 750.00 MH/s（每秒兆哈希）和 1350 瓦的电力消耗的机器。你需要大约 $20,000。假设电费是每千瓦时 $0.10（根据你的位置，美国的平均电费是 $0.14/kWh）。挖掘一个以太坊可能需要大约 103 天。当前以太坊的价格约为 $1100，需要一段时间才能盈利。图 4-2 显示了以太坊挖掘计算器的结果。![](img/535492_1_En_4_Fig2_HTML.jpg)

3 径向挖掘收入、挖掘费用和电力成本，以及以太坊挖掘哈希率、电力消耗、电力成本、池费用和每小时及每天的挖掘 E T H。

图 4-2

以太坊挖掘计算器

燃气是指成功在以太坊上执行交易所需的费用，即需要支付给矿工处理交易的费用。

常用的以太坊单位之一是 Gwei。它用于指定以太坊燃气价格和支付交易费用。例如，一个 Gwei 等于 0.000000001 ETH。如果交易成本为 0.000000050 ETH，我们可以称成本为 50 Gwei。

在当前的以太坊区块链中，标准交易费用为 21,000 Gwei。燃气费可以使用以下公式计算：

总费用 = 气体单位（限制）*（基本费用+小费）

**燃气单位（限制）** – 指的是你想用来执行交易的最大的燃气量。

**基本费用** – 它指的是用户交易被包含在一个区块中所需要的最低的燃气费。基本费用数额是自动动态计算的，由以太坊根据任何时候的市场需求来决定。

**小费** – 也被称为优先费，矿工小费。这是一个可选费用，由用户确定并直接支付给矿工。优先费帮助你的交易被矿工更快地挑选和处理。

让我们以一个真实的以太坊区块链交易为例（见图 4-3，数据来自 etherscan.io）来计算今天的以太坊交易成本。![](img/535492_1_En_4_Fig3_HTML.png)

一张图片代表了以太坊交易成本，包括状态、区块、时间戳、价值、交易费、燃气价格、燃气限制和燃气费。

图 4-3

以太坊交易成本（etherscan.io）

从前面的例子中，一个交易的燃气限制是 201,027 单位，基本费用是 33.529 Gwei，优先费是 1.101 Gwei；执行该交易的总交易费用将是 0.006961 ETH（201,027* (33.529 + 1.101) = 2,310,000 Gwei）。在当前市场上，一以太币大约是 1100 美元，所以这个交易费用大约是 0.006961* 1100 = 7.65 美元。

需要注意的是，如果你支付的燃气费少于所需的交易费，交易将会被撤销，你不会收回你的燃气费，因为矿工已经完成了处理你交易的工作量。即使交易失败，他们也会为他们的劳动收取费用。另一方面，如果你支付了更多的燃气费，交易完成后，多余的燃气费将会退还给你。在前面的例子中，“Txn 的用途”字段表明只有 40.21%的燃气费被使用，剩余的费用将会退还给用户（500,000 - 201,027 = 298,973）。

### 以太坊账户

每个以太坊账户都有一个以太坊地址。以太坊有二种类型的账户：外部所有账户（EOA）和合约账户。

#### 外部所有账户（EOA）

外部所有账户（EOA）是由用户拥有的公钥/私钥对控制的。在第二章中，我们学习了如何通过使用 Keccak-256 散列从公钥派生出以太坊地址。每个以太坊地址都是 42 个十六进制字符的串，以 0x 开头，代表十六进制格式。创建以太坊账户没有成本。外部所有账户可以用于资金（以太币）转移或向智能合约发送交易。你需要私钥来访问你的资金或向其他人发送资金。

#### 合约账户（CA）

合约账户由以太坊虚拟机执行的代码控制。这些代码通常被称为智能合约代码。创建合约账户是昂贵的，因为它将使用网络存储。合约账户可以进行以太币转账和创建智能合约账户。

图 4-4 突出了 USDT 代币智能合约创建者地址，这是一个合约账户：![](img/535492_1_En_4_Fig4_HTML.png)

一个 USDT 合约账户带有许多字段的屏幕截图。在左边，合约概要列出余额、以太币价值和代币。在右边，更多信息列出我的名字标签、合约创建者和代币追踪器的状态。在右上角是 4 个弹出按钮。

图 4-4

USDT 合约账户（etherscan.io）

所有账户都有四个公共字段：

+   **nonce**——每个地址都有一个 nonce，代表一个账户的交易计数。不同的账户地址可以有相同的 nonce。nonce 中使用的数字是唯一的，以防止双重花费的情况。

+   **余额**——该账户拥有的以太币。

+   **存储哈希**——有时它被称为存储根。每个以太坊合约账户都有自己的存储树（有序树数据结构），其中包含合约数据。存储根是当前合约状态的 Merkle Patricia 树，它是一个 32 字节整数之间的映射。基于这些合约数据计算出一个 256 位的哈希值。当其状态发生变化时，哈希值会随时改变。它可以用来验证过去的状态。存储哈希只适用于合约账户。图 4-5 表示以太坊账户的存储根。

![](img/535492_1_En_4_Fig5_HTML.png)

账户存储树有一个带有根节点分为 2 个区块的循环图，这 2 个区块再分为 2 个区块。根节点指向存储根（storageRoot）。

图 4-5

以太坊账户存储根

+   **代码哈希**——它指的是在 EVM 上此账户下的合约代码。它是不可变的。

![](img/535492_1_En_4_Fig6_HTML.png)

以太坊账户的矩形块有账户地址 1 到 n 的区块。账户地址 1 指向具有 nonce、余额、存储哈希和代码哈希的 4 个文本圆圈的账户状态。存储和代码哈希分别指向 EVM 账户和代码。

图 4-6

以太坊账户结构

### 智能合约

合同是两个或更多方之间达成的书面和口头协议，以执行某些事情。

以下是我们日常生活中的一些例子：

+   **房屋租赁合同**——房东将物业出租给租户，以换取月付款的租赁协议。

+   **景观合约**——景观设计师与客户之间的义务。

+   **软件许可协议**——软件公司与客户之间为了合法使用软件而达成的协议。

+   **个人贷款** - 贷款人向借款人提供资金，并以退款加利息的形式进行交换的书面协议。

一个有效的合约将详细描述正式要求，各方必须遵守的责任，合同项目应何时何地执行，以及当这些规则不被遵守时会发生什么。因此，合约成为各方计划相遇的可靠文档。

智能合约非常相似，但是这些详细的协议是通过使用计算机代码来实施的。一旦在去中心化的区块链网络上创建，它们就无法更改。当条件满足时，智能合约会自动执行，而不是由第三方执行。由于区块链是去中心化、不可篡改且透明的，网络中的每个人都可以公开验证智能合约的交易结果。

尼克·萨博（Nick Szabo）是第一个描述智能合约的人。他在 1997 年发表了一篇论文《智能合约的理念》。他设想将合同转换为代码，以实现自我执行的合同，从而消除了各方之间的信任需求。为了说明他的概念，尼克使用自动售货机来解释智能合约是如何工作的。当你向机器投入正确的金额时，你会得到想要的产品。自动售货机内部的软件指令保证合同将按预期履行。如今，这个想法已经遍布全球。

以太坊是最受欢迎的智能合约平台。任何人都可以在区块链上创建智能合约。代码是透明的，可以公开验证。每个人都可以看到智能合约的实现逻辑是怎样的。以下是来自 etherscan.io 的 SHIBA INU 示例！[](../images/535492_1_En_4_Chapter/535492_1_En_4_Fig7_HTML.png)

以太坊 S H I B A I N U 合约的屏幕截图展示了一个概览字段选择合约和资料概要的代币应用。右上角有 4 个下拉图标。

图 4-7

以太坊 SHIBA INU 合约示例

在以太坊中，智能合约是用多种编程语言编写的，包括 Solidity 和 Vyper。Solidity 是以太坊中最受欢迎的智能合约语言，我们将在后面的章节中进一步探索。

每个网络计算机节点都存储了所有现有智能合约代码及其当前状态的副本，以及交易数据。用户通常需要支付燃料费以执行智能合约的功能并将交易包含在新的区块中。

### Ethereum 虚拟机（EVM）

“虚拟机”或“VM”是一个你可以在物理计算机上运行软件的模拟计算机系统。虚拟机本质上是在模拟计算机系统和运行操作系统如 Windows、macOS 或 Linux 之间建立一个隔离层。例如，使用“Parallels Desktop for Mac，”你可以在你的苹果 Mac 电脑上运行 Windows，如图 4-8 所示。![](img/535492_1_En_4_Fig8_HTML.jpg)

一张显示运行在 Mac 笔记本上的 Windows 操作系统的笔记本电脑图片。菜单栏在左上角，状态栏在右上角。底部有 15 个图标。

图 4-8

虚拟机示例 - Windows 在 Mac 上运行

以太坊虚拟机（EVM）是一个图灵完备的虚拟机，它允许 EVM 字节码在一个隔离的沙盒化运行环境中运行。字节码是由 Solidity 等高级智能合约编程语言编译而成的低级二进制机器码。

在以太坊上，智能合约通常是用名为 Solidity 的高级编程语言编写的。Solidity 编译器将智能合约编译成低级的二进制机器码（字节码）。用户只需发送一个包含这些字节码的以太坊交易，而这个交易不需要指定任何接收者。一旦合约交易被提交到区块链，就会创建一个新的以太坊账户。合约账户存储合约余额、合约 nonce、代码和数据。合约账户存储哈希实际上是智能合约数据的哈希。合约地址的创建是基于发送者的 EOA 地址和非 ce。RLP 编码的非 ce 和 EOA 地址数据与 keccak-256 算法进行哈希。RLP（递归长度前缀）是编码任意嵌套的二进制数据数组的方式。当你调用智能合约函数时，你与这个合约地址进行交互，合约存储操作码将指导 EVM 执行操作。合约部署过程如图 4-9 所示。![](img/535492_1_En_4_Fig9_HTML.png)

一个人形图从 E O A 流向智能合约、字节码和 O P C O D E、合约地址以及 E VM 的流程图。

图 4-9

智能合约部署

一旦合约被编译，编译器将生成 Abi、字节码和操作码。ABI（应用程序二进制接口）是一个描述部署的合约及其功能的 JSON（JavaScript 对象表示法）文件。它允许我们外部调用合约函数。字节码和操作码（操作码）是紧凑的二进制表示。它们存储在区块链上，并与合约地址相关联。

当用户调用智能合同时，EVM 运行环境将解释字节码以对应一系列操作码作为一组指令，并执行操作码。图 4-10 展示了编译的合约字节码和操作码示例。![](img/535492_1_En_4_Fig10_HTML.png)

字节码和操作码。它们分别以对象和操作码开头。代码由数字和字母组成。

图 4-10

Solidity 编译的字节码和操作码示例

您可以从以太坊官方网站找到每个字节码的操作码参考（[`ethereum.org/en/developers/docs/evm/opcodes/`](https://ethereum.org/en/developers/docs/evm/opcodes/)）。大约有 148 个独特的操作码，这使得 EVM 能够计算几乎任何任务，使其成为图灵完备机器。

操作码可以分为以下几类：

+   算术运算、比较和位逻辑运算（ADD, SUB, GT, LT, AND, OR 等）

+   执行上下文查询（CALL, DELEGATECALL, CALLCODE 等）

+   栈、内存和存储访问（POP, PUSH, UP, SWAP, LOAD, STORE, MSSTORE 8, M SIZE 等）

+   控制流运算（STOP, RETURN, REVERT 等）

+   日志记录、调用和其他操作符（LOG0, LOG1, LOG2 等）

让我们使用前面的字节码示例来模拟 EVM 解释器。我们将关注合约字节码的前 16 个字节：6080604052348015。根据操作码参考，我们可以将字节码翻译为操作码，如表 4-3 所示。表 4-3

字节码到操作码转换（6080604052348015）

| 字节码 | 操作码 | 参考（操作码，名称） | 描述 | 燃料 |
| --- | --- | --- | --- | --- |
| 60 80 | PUSH1 0x80 | 0x60 = PUSH1, | 复制栈顶元素 | 3 |
| 60 40 | PUSH1 0x40 | 0x60 = PUSH1 | 复制栈顶元素 | 3 |
| 52 | MSTORE | 0x52 = MSTORE | 将单词保存到内存中 | 3* |
| 34 | CALLVALUE | 0x34 = CALLVALUE | 通过指令获取存款值 | 2 |
| 80 | DUP1 | 0x80 = DUP1 | 复制栈顶元素 | 3 |
| 15 | ISZERO | 0x15 = ISZERO | 简单的不操作符 | 3 |

以太坊虚拟机（EVM）是一个简单的基于栈的执行机器，将执行操作码指令。栈（有时被称为“压栈”）是一种线性集合，新元素插入到最后位置（称为“顶部”），现有元素的移除总是在顶部位置进行。它也被称为后进先出（LIFO）。在前面的解释操作码示例中，我们期望 EVM 将按顺序执行标准栈操作：

![](img/535492_1_En_4_Figa_HTML.jpg)

一个以文本形式展示字节码到操作码转换的流程图，带有逐步过程。

EVM 堆栈深度为*1024*项，每项包含一个 256 位（32 字节）单词或 32 个块，每个块大小为 8 位（1 字节）。256 位的主要原因主要是为了对任意数量的数据应用 Keccak-256 加密哈希函数，并将其转换为唯一的 256 位哈希。在 EVM 中，合约可以在上述项中存储和读取数据。EVM 有三个可以存储项的地方——存储、内存和堆栈。

内存是用于短期保存临时值的位置。它将在智能合约函数调用之间被清除。

当从内存中读取数据时，EVM 将使用 MLOAD。要写入 32 字节（256 位）的数据，将使用 MSTORE Opcode。当写入 1 字节（8 位）的数据时，EVM 将使用 MSTORE8。图 4-11 表示 EVM 如何使用 Opcode 读取和写入合约内存。![](img/535492_1_En_4_Fig11_HTML.png)

块图由堆叠的内存块组成，带有推和拉操作。它有标签 E VM 堆栈。内向和外向箭头分别标记为 M S T O R E 和 M L O A D。

图 4-11

Opcode 读写合约内存

存储是您永久保存数据的地方。当在 EVM 中运行的智能合约使用永久存储时，这些数据将成为以太坊状态的一部分。您可以将存储视为一个数组，其中每个数组项都是 256 位（32 字节）。外部读取存储值没有费用。然而，将数据写入存储非常昂贵，Opcode 是 SSTORE，当前每个 32 字节单词的成本是 20,000 Gas。我们来看看这需要多少钱。

首先，将 gas（Gwei）转换为 ETH - 20,000 * 0.000000001 ETH = 0.00002 ETH，

然后，计算成本：$1100*0.00002 = $0.022。

将数据写入存储的成本比写入内存的成本高出超过 6000 倍。

在前面的表格（表 4-3）中，我们列出了 Opcode 指令的前几个步骤及其 gas 成本，每个 Opcode 都有自己的基础 gas 成本。所有的以太坊合约执行都是公开运行的。攻击者可以创建一个合约来执行大量昂贵的操作（DDoS – 分布式拒绝服务攻击），从而减慢以太坊网络的速度。通过在每次 EVM Opcode 执行中包含 gas 成本，以太坊网络可以防止此类攻击。

### 以太坊节点

在互联网上，任何连接到网络的系统或设备也称为节点。区块链网络也是如此。当一个节点连接到以太坊网络时，它会下载区块链数据的一个副本并参与网络，与其他节点进行通信。根据 etherscan.io 的数据，大约有 4,131,021 个节点连接到以太坊网络。

节点分为三种类型：完整节点、归档节点和轻节点。每种类型的节点消耗数据的方式不同。

#### 完整节点

全节点将存储所有最近的区块链数据，运行自己的 EVM 环境，并可以操作 EVM 指令。它们在参与区块链交易验证和维护区块链当前状态时会有帮助。当新区块中的交易不符合以太坊规范中定义的规则时，它们将被丢弃。例如，如果 Alice 向 Bob 发送 50 ETH，但当全节点验证交易时 Alice 的账户没有足够的以太币或支付了非常少的燃料费，它将把这个交易标记为无效并回滚它。全节点可以直接部署智能合约并与网络上的任何智能合约互动。

全节点存储最近的一小部分区块。默认情况下是 128 个（如果你使用快速同步选项则是 64 个）。每个以太坊区块通常大小约为 80KB，或者在十分钟内约为 4 MB。128 个区块大约是一周的追踪数据。当你查询无法从全节点访问的历史区块数据时，你通常会得到“缺失 trie 节点”错误。这个错误意味着你需要一个归档节点。

当一个全节点第一次连接到网络时，同步全节点数据可能非常耗时，可能需要几周时间来同步！此后，节点需要保持在线以进行区块数据升级和维护。否则，它必须重复全同步过程。创建新区块通常需要 13 秒。当新数据到达时，全节点可以删除旧的区块链数据以节省磁盘空间。

运行具有快速同步的全节点的硬件要求：

配备 4+核心的快速 CPU

16 GB+的 RAM

至少拥有 500 GB 免费空间的快速 SSD

25+ MBit/s 带宽

#### 归档节点

归档节点运行在一种特殊的配置下，称为“归档模式”。归档节点将存储从创世区块以来的所有区块链数据，并构建一个历史状态的归档。

当前的归档以太坊区块链大小约为 12 TB。

通常，在大多数情况下，我们不需要归档节点数据。全节点可以提供大部分数据，比如检查账户余额、转账资金等。但有时，你可能需要查看去年的账户余额、你所拥有的资产或交易。全节点会定期修剪数据，只存储最近 128 个区块的数据（大约 25 分钟）。节点必须重新同步以获取更早的数据，这样提取速度会太慢。归档节点本地拥有所有数据，可以快速获取过去的数据。

归档节点数据通常用于区块链服务，如区块链浏览器、数据分析等。同步全归档节点数据将比全节点同步要长得多。至少需要一个月的时间。

运行全归档节点所需的硬件要求：

配备 4+核心的快速 CPU。

16 GB+的 RAM。

至少 6 TB+空间的快速 SSD 驱动器。

25 MBit/s+带宽。

#### 轻节点

轻节点只下载最小的区块头信息，并使用它通过检查区块头中的状态根来验证数据的有效性。轻节点被设计为与完整节点作为中介交互，并依赖完整节点执行区块链操作，从请求账户余额到智能合约交互。因此，轻节点无需保持在线并本地存储大量 GB 数据。轻节点对于在低内存和计算设备上运行非常有用，例如移动设备、IoT 设备和笔记本电脑。

### 以太坊客户端

正如我们刚刚学到的，轻客户端主要是在移动设备上实现的。尽管设置一个完整节点或归档节点需要很长时间来同步，但运行您自己的节点有多个好处：

1.  1.

    您的节点可以作为一个网络验证者来验证所有的交易和区块。

1.  2.

    您可以自行验证您的应用程序客户端交易数据，无需第三方验证交易——“不要信任。验证。”

1.  3.

    您将拥有当前网络状态的一致视图，并且不需要依赖其他公共节点或服务，这些服务中的数据可能会延迟或不值得信任。

1.  4.

    您将拥有更多的数据隐私。当您使用第三方软件或工具提交交易时，这些服务可能会读取您的 IP 地址以及您的账户信息。IP 地址会暴露您当前的位置。

为了与以太坊网络同步并进行通信，您需要安装以太坊客户端软件。最常用的以太坊客户端是 Geth。etherscan.io 显示，90.3%的以太坊节点安装 Geth 作为以太坊客户端来加入网络并与其他节点建立 p2p 通信通道。图 4-12 显示了总体以太坊客户端使用情况。![](img/535492_1_En_4_Fig12_HTML.jpg)

饼图包括总体 ETM 客户端使用情况。最常用的 ETM 客户端是 Geth，占 90.3%。还有 8 个其他客户端有待估计。

图 4-12

总体以太坊客户端使用情况

Geth（Go Ethereum）是用谷歌的编程语言 Go 编写的开源命令行界面（cli），用于运行以太坊节点。

以太坊社区构建并维护了 Go Ethereum。

使用 Geth 可以让节点执行交易、挖矿、在账户之间转移以太币，以及在以太坊区块链上部署和与智能合约交互。您可以直接从 Geth 的官方网站[`geth.ethereum.org/downloads/`](https://geth.ethereum.org/downloads/)下载 Geth。该网站提供了一个标准的安装指南。

一旦安装了 Geth，您可以以同步模式运行 Geth，以成为完整、轻、归档节点。

Geth 同步完整节点的命令：

geth --syncmode full

当同步模式为完整模式时，Geth 将下载所有区块并从创世区块重新播放所有交易。对于完整节点，将保持最后 128 个区块在内存中。

Geth 同步轻节点的命令：

geth --syncmode light

当同步模式为轻量级模式时，Geth 将下载最近的 2300 个区块并重放相关交易。因此，轻量级模式的同步过程比完整模式快得多。

Geth 同步归档节点的命令：

syncmode full --gcmode archive

Geth 将下载所有区块并从创世区块重新播放所有交易，并将所有中间状态写入归档磁盘。

以太坊社区还有许多其他的以太坊客户端。这些客户端由不同的团队开发，并用不同的编程语言实现。所有这些客户端都在行业中得到积极使用。表 4-4 总结了不同客户端的使用情况。表 4-4

以太坊客户端

| 客户端 | 编程语言 | 磁盘大小（快速同步） | 磁盘大小（完整归档） |
| --- | --- | --- | --- |
| Geth | Go | 400 GB+ | 6 TB+ |
| OpenEthereum | Rust | 280 GB+ | 6 TB+ |
| Besu | Java | 750 GB+ | 5 TB+ |
| Nethermind | C#, .NET | 200 GB+ | 5 TB+ |

Geth 有一个使用 GoJa JS 虚拟机构建的 JavaScript 控制台。

Geth 有一个内置的 JavaScript 控制台，并支持所有标准的 web3 JSON-RPC API，称为 web3.js，与 ECMAScript 5.1 兼容。您可以使用 JSON-RPC API 与您的节点交互。Geth 支持多种让客户端应用程序向节点发送原始 JSON 对象的方式。其中最广泛使用的协议被称为基于 HTTP 的 JSON-RPC。JSON 代表 JavaScript 对象表示法。它是一个开放标准的文件格式，用于在服务器和网络应用程序之间传输数据。数据在 JSON 文件中以逗号分隔的关键字/值对形式存在。以下是一个示例：{ 'name': 'Alice', 'gender': 'Female', 'account': 12345 }RPC 代表“远程过程调用”，用于其他远程系统进程。当客户端应用程序使用基于 HTTP 的 JSON-RPC 将 JSON 数据发送到 Geth 时，Geth 将执行区块链中提供的 Web3 API 的特定任务。Web3 在 RPC 层之上运行，如图 4-13 所示。![](img/535492_1_En_4_Fig13_HTML.jpg)

架构图展示了客户端应用、以太坊客户端、完整节点 EVM 和以太坊区块链之间的相互关系。

Figure 4-13

通过 JSON-RPC 调用以太坊客户端

#### Geth 控制台

要启动 Geth JavaScript 控制台，您可以运行命令——Geth attach with IPC。IPC（进程间通信）为所有 Web3 API 提供无限制的访问。当 Geth 控制台在同一台机器上的 Geth 节点上运行时，您可以使用 IPC 进行连接。

他们从运行中的 Geth 实例打开控制台，结果将看起来像这样：

![](img/535492_1_En_4_Figb_HTML.jpg)

一个 Geth JavaScript 控制台的代码。它包含标签实例、coinbase、at 块、datadir、模块和退出

为了支持包括 eth、personal、admin 和 miner 在内的 web3 API，Geth 控制台提供了 web3 命令。让我们来看看与 eth 相关的 API。在 Geth 控制台中输入 eth。它会显示所有支持的 eth 命令。

![](img/535492_1_En_4_Figc_HTML.jpg)

一系列以 eth 开头的 eth 命令。

要列出网络中您当前的所有账户，只需运行以下命令：eth.accounts.

列出的账户输出应与以下类似：

![](img/535492_1_En_4_Figd_HTML.jpg)

文本表示 eth.账户在控制台中的输出。它由数字和字母组成。

要检查账户余额，将 wei 转换为 ether，运行以下命令：eth.getBalance('0x88437244acbb6276de36175740a8d686a9531ba7') 以获取 wei，或者，我们可以直接转换为 ether：web3.fromWei(eth.getBalance('0x88437244acbb6276de36175740a8d686a9531ba7'),'ether')![](img/535492_1_En_4_Fige_HTML.jpg)

一张包含获取账户余额的代码的图片，该代码从 eth 开始获取余额并直接转换为 web3。

要获取区块链的最新区块号，运行以下命令：

![](img/535492_1_En_4_Figf_HTML.jpg)

一张包含获取区块链区块号的命令的图片，运行命令>eth. block number 并显示 518560。

然后，通过调用以下命令可以显示匹配的区块摘要信息：eth.getBlock (blockNumber)![](img/535492_1_En_4_Figg_HTML.png)

一张展示 eth 控制台打开的 eth.getBlock 新窗口的图片，命令将出现在控制台中。

要退出 Geth 控制台，只需运行 exit 或按 CTRL-C。

#### Geth JSON-RPC 命令

cURL 代表“客户端 URL”，是一个命令行工具，用于使用各种支持协议（HTTP、IMAP、SCP、SFTP、SMTP、LDAP、FILE，以及其他许多协议）传输数据。curl 语法是 curl [选项] [URL...]例如，您可以在 window 或 mac 终端中打开一个窗口，输入下面的 curl 命令，您将看到远程服务器的 HTTP 响应：curl -k www.apress.com/us 要以 http 模式启动 Geth，您可以使用--http 标志如下：geth –http

默认端口是 8545。一旦 Geth 节点启动，我们就可以运行 curl 命令来查询一些有用的区块链信息。

要获取 web3 客户端版本，运行以下 curl 命令：curl -X POST -H 'Content-Type: application/json' \--data '{'jsonrpc':'2.0','method':'web3_clientVersion','params':[],'id':11}' \http://localhost:8545

这里 id - 11 是区块链 Id。响应结果显示 web3_clientVersion 是 Geth/v1.10.17-stable-25c9b49f/linux-amd64/gol.18。

![](img/535492_1_En_4_Figh_HTML.jpg)

一张展示获取运行 curl 命令的 web3 客户端的图片，该命令在控制台中输出 web3_clientVersion。代码包含数字和字母。

要检查账户余额，我们在之前的 Geth 控制台示例中看到，运行以下 curl 命令：curl -X POST \-H 'Content-Type: application/json' \--data '{'jsonrpc':'2.0','method':'eth_getBalance','params':['0x88437244acbb6276de36175740a8d686a9531ba7','latest'],'id':11}' \http://localhost:8545![](img/535492_1_En_4_Figi_HTML.jpg)

一个检查余额的代码图片。它包含数字和字母的文本。

我们得到十六进制结果 - 0x56bbc5d759fba6400

通过将十六进制值转换为十进制值（[www.binaryhexconverter.com/hex-to-decimal-converter](http://www.binaryhexconverter.com/hex-to-decimal-converter)），

![](img/535492_1_En_4_Figj_HTML.png)

一个十六进制值和十进制值框的图片。在左下角有一个转换图标。

然后，我们将 Wei 转换为 Ether，并将十进制数除以 10¹⁸。最终结果是 99.996902986 Eth，这与我们在 Geth 控制台中运行的前一个结果相匹配。

#### Geth 文件夹结构

一旦安装了 Geth，它将根据操作系统存储默认的 Geth 本地数据目录：

+   Mac：~/Library/Ethereum

+   Linux：~/.ethereum

+   Windows：%LOCALAPPDATA%\Ethereum

如图 4-14 所示结构。![](img/535492_1_En_4_Fig14_HTML.jpg)

Geth 文件夹结构包括链数据、古代、ethash、轻量级链数据、节点密钥、节点、Keystore 和 geth.ipc。

图 4-14

Geth 文件夹结构

**chaindata** – 下载的区块数据和 EVM 状态数据的目录。

**ancient** – 当链数据超过大约 100k 块时，过去的块会被移动到古代目录。

**ethash** – Ethash 是 Ethereum 的证明工作散列算法，此位置下的文件是 Ethereum 挖矿计算的一部分。它可以安全地重新生成和删除。

**lightchaindata**– 包含区块链的轻量级版本，仅包含收据（不包含数据）和内容。

**nodekey** – 其他公共对等节点用于连接或向网络添加对等节点的公钥文件。

**nodes** – 包含对等连接数据，用于在启动时建立网络。

**keystore** – 存储账户信息，账户密钥可以在 keystore 文件夹中找到。

**geth.ipc** – Geth 连接用于进程间通信的文件。

默认情况下，Geth 使用 Google LevelDB 作为底层数据库实现来存储区块链数据，例如，在图 4-14 的链数据文件夹中的 000002.ldb 和 000011.ldb。LevelDB 是一个开源的磁盘上键值存储。![](img/535492_1_En_4_Fig15_HTML.jpg)

E VM 流程图，从世界状态 n 流向交易，最后是世界状态 n+1。

图 4-15

通过交易查看以太坊的状态变化

正如我们在第二章“密码学”中所知道的，每个以太坊账户都是由私钥和公钥对定义的。账户的地址是通过取公钥的最后 20 个字节得到的。当我们使用 Geth 生成新账户时，新的账户地址和私钥对被编码为一个 JSON 文本文件中作为密钥文件。因为它包含您的账户私钥，所以文件内容总是加密的。这个密钥文件可以用来访问您的以太坊账户和转移资金。因此，您需要定期备份您的密钥文件，并确保这个文件是安全的，不被他人访问。

让我们使用 Geth 控制台通过运行命令 personal.newAccount()并输入密码短语来生成新账户地址：

![](img/535492_1_En_4_Figk_HTML.jpg)

这张图片由 Geth 控制台生成新账户地址和运行命令组成。new account()和输入密码短语被写入。

生成的账户地址为 0x0b1400031bea2def60a9d8f28fa373ab95d641f6。现在检查密钥库目录，为这个账户生成了一个新的 JSON 文本密钥文件：└── 密钥库    ├── UTC--2022-06-28T04-14-13.945107969Z--0b1400031bea2def60a9d8f28fa373ab95d641f6

这个密钥文件的内容是加密的，如下所示：

![](img/535492_1_En_4_Figl_HTML.png)

在控制台中生成账户地址以及为新账户和地址创建的新 JSON 文本，新版本和操作系统都显示在控制台中。

我们现在已经学习了以太坊客户端—Geth，并澄清了远程客户端（命令行或网络应用）如何通过 web3j API 调用以太坊客户端并与以太坊区块链进行交互。

### 以太坊网络

通常，当人们讨论以太坊网络和 ETH 价格时，他们是在谈论以太坊主网。主网是以太坊的主要公共生产区块链。当我们把智能合约部署到主网时，我们必须支付手续费，这些手续费需要花费真实货币。由于以太坊节点运行一个协议，因此有许多其他类似受控的公共环境运行相同的或类似的协议来模拟主网环境。合约开发者可以在这些类似生产的环境中运行和测试智能合约，以确保结果如预期工作。我们称这些公共网络为以太坊测试网。

在测试网上，您在测试智能合约时不会花费真实货币。以太坊测试网提供了免费的以太币，您可以用来支付手续费。这些以太币只能在测试网上使用，不能在任何其他环境中使用，在现实世界中它们也没有价值。最佳实践是，在将智能合约部署到主网之前，您应该在测试网上测试您的智能合约代码。

许多测试网络使用证明权限的共识机制。选择一些节点作为验证者进行共识工作并创建新区块。测试网络不激励工作量证明挖矿。有几个以太坊测试网络可供使用。你可以选择你最喜欢的测试网络。由于以太坊 2.0 在 2022 年 9 月 15 日合并，一些公共工作量证明和证明权限测试网络变成了权益证明。一些流行的测试网络很快将被弃用，如 Ropsten、Rinkeby 和 Kovan。我们在这里不会讨论这些测试网络。戈尔利测试网络是一个证明权限的测试网络。它已经合并到权益证明，并预计将长期作为一个权益证明测试网络维护。

戈尔利测试网络于 2019 年 3 月建立。它是一个使用 Clique 共识机制的以太坊证明权限测试网络，最初由 Chainsafe 和 Afri Schoedon 提出。你可以使用官方的戈尔利测试网络水龙头（[`goerli-faucet.slock.it/`](https://goerli-faucet.slock.it/)）来获取免费的 ETH。在后面的章节中，我们将使用戈尔利测试网络向我们的钱包中获取一些以太币。

现在，我们已经涵盖了以太坊大部分的基本原理。在下一节中，我们将了解以太坊是如何工作的。

## 以太坊是如何工作的

正如我们之前学到的，有一个分阶段的升级，旨在从当前的工作量证明（PoW）共识机制切换到权益证明（PoS）模型。在 PoW 中，矿工验证交易并将交易添加到新区块。新区块广播给整个网络，验证者将验证并最终提交给以太坊网络。这个过程通常以每秒 10 到 20 秒的恒定速率进行。在 ETH 2.0 PoS 中，网络的吞吐量可以提高到每秒 100,000 笔交易的能力。

在以太坊中，用户通过其 EOA 账户安全地发起并签署交易。例如，Alice 想要向 bob 发送一个以太币。Alice 将为这笔转账发起一笔交易。接下来，以太坊网络将传输这笔交易。一旦转账完成，Bob 的账户将会被扣减一个以太币，而 Alice 的账户必须得到相应的支付。以太坊是一个单例世界状态机。交易是唯一可以触发以太坊状态更改和更新的事物。图 4-15 描述了在交易中以太坊状态的更改。

以太坊有三种类型的交易：

1.  1.

    在两个 EOA 之间转移资金的交易（例如，Alice 向 Bob 发送一个以太币）。

1.  2.

    部署合约的交易。

1.  3.

    与已部署合约函数互动并执行的交易（例如，更新总代币供应量）。

### 交易的结构

区块链要求用户提交交易时矿工挖掘和验证费用。

让我们使用 Geth 控制台提交一笔发送 0.05 以太币的交易，然后，从返回的交易哈希中获取交易收据，如图 4-16 所示。![](img/535492_1_En_4_Fig16_HTML.png)

提交交易并获得收据的代码。代码包含字母数字字母。

图 4-16

提交交易并获得交易收据

从 Geth 的日志中，我们可以看到交易被提交，生成一个交易哈希和非数值：

![](img/535492_1_En_4_Figm_HTML.png)

提交交易的 Geth 交易和交易哈希的图片，带有文本和字母。

图 4-17 显示了来自 etherscan.io 的交易细节示例。![](img/535492_1_En_4_Fig17_HTML.png)

显示交易详细信息的概览标签页，列出交易哈希，状态，区块，自和至，以及值。状态和评论标签页存在。

图 4-17

提交交易并获得交易收据

交易详情包含以下数据：

**自** – 发送者的以太坊地址。

**至** – 接收者的以太坊地址。

**非数值** – 交易序列号。非数值由发起交易的 EOA 发行。这是一个独特的数字，可以防止重复交易。

**燃气价格** – 交易创作者支付的以燃气(Gwei)为单位的交易费用。

**燃气限制** – 该交易将消耗的最大燃气量。

**值** – 发送给接收者的以太币数量。

**数据** – 仅用于发送消息调用和执行合约函数的交易输入二进制有效载荷数据。

**签名** – v, r, s。这是发送者的标识。发送者使用 EOA 通过其私钥签名交易。它使用一种加密的 ECDSA 数字签名。v, r 和 s 是交易签名的值。

慢慢阅读这个长长的列表。你不需要记住每一个字段。我们描述每个字段以帮助你理解它们的含义。当你在以太坊上工作时，这些术语可能经常会出现。

### 交易收据

在图 4-16 中，我们在运行 web3.eth.getTransactionReceipt(transactionHash)后看到交易收据输出。当交易收据可用时，意味着交易已添加到一个区块。当交易是待处理状态时，收据返回 null。

这里交易收据包含的字段有：

**区块哈希** – 包含此交易的区块的哈希。

**区块号码** – 该交易的区块号码。

**交易哈希** – 字符串，32 字节—交易的哈希。

**交易索引** – 交易在区块中的位置。

**自** – 发送者的以太坊地址。

**至** – 接收者的以太坊地址。当它是一个合约创建交易时，此值为空。

**累计燃气使用量** – 在同一区块中，该交易及其所有先前交易使用的总燃气量。

**燃气使用量** – 该特定交易使用的总燃气量。

**合约地址** – 该地址与此次交易关联。如果此次交易是创建合约，否则为空。

**日志** – 该交易的日志信息。

**状态** – “0x0”表示交易失败，“0x1”表示交易成功。

### 区块

正如我们从第一章学到的，每个区块都有头和体。区块体包含交易的列表。这对于比特币和以太坊都是正确的。以太坊区块结构如图 4-18 所示。![](img/535492_1_En_4_Fig18_HTML.jpg)

区块头和区块体的 2 个块。区块体中还包含 2 个块：交易和叔块头。

图 4-18

以太坊区块结构

以太坊区块体还包含“ommer”块，通常称为“叔块”。叔块是在找到多个区块解决方案时为了奖励矿工而创建的。

当有多个矿工解决一个加密谜题并为链提出一个新的区块时，网络只会接受区块中的一个。由于其他矿工也做了同样的工作，网络会奖励他们。那些稳定的区块将被附加到新接受的区块上。我们称之为叔块，如图 4-19 所示。![](img/535492_1_En_4_Fig19_HTML.jpg)

一个三层立方体流程图，从顶部标有 1、2 和 3。立方体 1 导致第二层有两个标有 2 A 和 2 B 的立方体，分别为 Alice 和 Bob 标明。2 A 有勾号，2 B 有叉号。立方体 2 B 通过叔块进入区块 3。

图 4-19

以太坊叔块

例如，在图 4-19 中，有两个由矿工 Alice 和矿工 Bob 提出的区块。Alice 的区块（A）最终被接受并作为新的区块 #2 添加。Bob 的区块（B）最终被拒绝。然后，网络中的一个矿工创建了一个区块 (#3)，使用 Bob 的区块（B）并指定 Alice 的区块是父区块，Bob 的区块是叔块/ommer 块。这样，Alice 将获得全额奖励，但 Bob 仍然获得部分奖励。

如我们稍后提到的，每个区块体包含交易的列表，这里是一个来自 etherscan.io 的区块示例。我们可以看到这个区块中有 374 次交易，如图 4-20 所示。![](img/535492_1_En_4_Fig20_HTML.png)

交易表格的屏幕截图，包含列标题：T x n 散列、方法、区块、年龄、发送方、接收方、价值以及 T x n 费用。这个区块中有 374 次交易。

图 4-20

一个区块：交易列表

区块编号是 15039689。让我们看看其他区块详情，如图 4-21 所示。![](img/535492_1_En_4_Fig21_HTML.png)

详细展示 ETM 区块的图片，包含了概述和注释。概述是交易的详细信息、时间戳、难度、大小、燃料限制和费用。

图 4-21

以太坊区块详情

以太坊区块头包含有关以太坊区块的一些关键信息。每个区块头都有以下重要字段：

+   **区块号码** – 也称为区块高度。区块链祖先区块的长度。第一个区块（创世区块）编号为零。这个数字代表链的高度。

+   **难度** – 表示挖掘一个区块的哈希或质押努力有多难。

+   **总难度** – 通过整数值表示 chain up to a specified block 的难度。

+   **时间戳** – 区块挖掘时的 UNIX 时间戳。

    **Nonce** – 请参阅以太坊账户部分。

+   **父哈希** – 也称为前一个哈希。来自前一个区块（或父区块）的哈希。每个区块都包含一个前一个哈希。顺便说一下，我们可以追溯到链中的第一个区块。

+   **受益人** – 也称为“由谁挖出”。这是接收挖矿奖励的矿工地址。

+   **燃料费** – 请参阅燃料费、燃料价格和燃料限制部分。

+   **Gas 限制** – 请参阅燃料费、燃料价格和燃料限制部分。

+   **大小** – 区块大小（以字节为单位）。

+   **哈希** – 块的唯一 Keccak 哈希值。

+   **额外数据** – 包含来自区块的附加数据的字段。当矿工创建区块时，他们可以在这个字段中添加任何内容。

+   **状态根**：存储整个网络状态的特殊类型 Merkle 树的根节点的哈希，也称为世界状态。它包含所有账户余额、合约存储、合约代码和账户 nonce 的 Keccak 哈希。如果任何数据发生变化，整个状态根值也将发生变化。

+   **交易根**：存储此区块体的所有交易的交易 trie 的根节点的哈希。

+   **收据根**：存储此区块的所有交易收据的交易收据 trie 的根节点的哈希。

在这个阶段，我们已经深入了解了以太坊的工作方式，特别是我们对以太坊区块、交易、账户和状态进行了剖析。这些以太坊区块结构之间的关系。让我们总结我们已经学到的内容，并将它们联系在一起，如图所示（图 4-22）。![](img/535492_1_En_4_Fig22_HTML.png)

ETM 架构的架构图包括单独的块中的头部和正文。世界状态、交易、收据 trie 指向它们各自的层在头部块中。账户状态、交易和交易收据的表格分别指向它们的三元组。账户存储三元组指向账户状态表。正文块指向交易收据表。

图 4-22

以太坊架构：区块、状态、交易

我们已经描述了关于以太坊的大部分重要概念。

## 摘要

本章的主要目的是介绍以太坊的关键概念。我们已经开始了解以太坊的历史以及以太坊背后的关键组成部分和元素，包括账户、合约和燃料（gas）。所以，现在你知道了以太坊账户的基本工作原理。我们讨论了以太坊节点和以太坊客户端，举了一些 geth 技术的例子。我们深入探讨了以太坊的架构，理解以太坊虚拟机（EVM）是如何工作的，智能合约的 Opcode 如何在 EVM 内执行，区块、状态和交易在 EVM 中的结构。在这个阶段，你应该已经准备好进入下一章，开始开发你的第一个智能合约和端到端的去中心化应用。我们将逐步向你展示如何构建。请继续关注。
