# 2 去中心化应用

去中心化应用（DApps）是一种应用范例，它结合了在分布式账本（DL）网络中执行的链上应用逻辑和传统应用工程方法。DL 网络确保链上逻辑（即智能合约）的可靠执行，而 Web、移动、服务器端或嵌入式应用为 DApps 提供用户和机器接口。

DL 网络在应用的技术，以及它们的组织和管理方面各不相同。这些因素共同有助于 DL 网络的信任、性能和可扩展性。智能合约和离线应用采用了一些已知的软件工程方法。与此同时，去中心化环境和不可变账本需要某些适应性。

除了 DL 网络提供的关键服务外，DL 生态系统通常还容纳其他分布式和支持服务。这些服务例如，大规模去中心化和分布式存储、智能合约与离线数据源的组合、对去中心化资源友好命名，或监控运行中的 DL 网络。

去中心化应用架构师和开发者依赖于 DL 技术和支持服务。然而，对于 DApps 的产品化，他们需要企业级的开发和支持生态系统以及第三方服务，以便能够专注于应用开发。去中心化应用的产品化是朝着更广泛采用这些相对新颖的技术和解决方案的重要一步。

## 2.1 去中心化信任 - 分布对比去中心化

两个相关特性是必需的，并且有助于分布式账本系统中的去中心化信任。这些是：

+   账本的分布式特性

+   他们的去中心化控制

让我们考虑一个安装在计算机上的简单数据库系统。它集中在一个单一实例中，因此不是分布式的。系统控制集中在系统所有者手中，所有者管理所有系统用户的访问权限。请注意，所有者可以指定另一用户代表他们管理系统。然而，即便在这种情况下，他们仍保留撤销任何用户行为和完全控制系统的权利。出于性能或其他原因，数据库系统可以在多台计算机上进行扩展。分布式系统拓扑 enable 许多关键优势，包括冗余、消除单点故障、恢复能力或性能可扩展性。现代云和网络虚拟化系统允许高效和可扩展的系统分配。然而，整个系统的控制将仍然集中在所有者手中，访问策略将仍然与集中实现非常相似。

为了分散系统的管理（治理），使得没有单一实体能够控制整个系统，我们需要一种不同的方法，那就是控制去中心化。这样的系统必须作为许多实例来构建。与分布式和中心化数据库的例子不同，去中心化系统中的每个实例都由不同的实体控制。这些可以是，例如，安装和运行区块链节点的用户或同意共同运行 DL 网络的联盟伙伴，因此，他们都设置了自己的节点实例。在 DL 中，去/中心化在本质上更多的是组织性的，而不是技术性的。然而，底层技术必须提供一个分布式系统，这是其去中心化治理的前提。系统中的行动不能基于单一所有者的任意决策，而是基于相互共识。在每一个节点实例中都实施相同的共识机制。这些机制确保了所有行动只能以预先约定的方式进行，即使系统中的一些参与者行为恶意。

DL 系统本质上是分布式的。如果我们以促进去中心化治理的方式来实现它，我们就能得到一个去中心化可信系统。与中心化可信系统不同，在那里我们需要信任系统所有者（例如，一家银行，持有包含客户账户和平衡信息的数据库），在去中心化可信系统中，没有我们必须要信任的中心实体。信任是由 DL 协议保证的，这些协议通常是开源的，因此，任何人都可以进行验证。

表 2.1 显示，一个集中的拓扑结构，其中治理只能集中，只提供集中的信任。在具有集中治理的分布式系统中，也无法保证去中心化的信任。只有那些分布化和去中心化的系统才能提供去中心化的信任。

表 2.1：去中心化信任：通信系统拓扑与治理之间的关系。

|  |  | 治理 |
| --- | --- | --- |
|  |  | 去中心化 | 中心化 |
| --- | --- | --- | --- |
| 拓扑 | 集中 | 不适用 | 集中信任 |
| 分布式 | 去中心化信任 | 中心化信任 |

分布式账本（DLs）中的去中心化信任是系统参与者之间进行可信交易交换的基础。交易被验证并作为新区块的一部分或其他账本架构中的相关数据结构永久且不可反驳地存储在账本中（具体见第一部分）。可信交易交换对于加密货币至关重要，因此分布式账本技术的广泛传播也得益于它。然而，除了可信交易交换之外，现代 DL 平台还允许编程代码——智能合同的可信执行。智能合同是去中心化应用（DApp）的关键要素之一，在第 2.4 节中讨论。

## 2.2 DApp 三元组

“去中心化应用”这个术语并没有被精确定义。尽管分布式账本和区块链技术已经存在了十多年，但它们仍然是在发展中的概念和技术，因此相关术语也在随着研究、实际发展、新的基于 DL 的应用领域和使用案例一起成熟。在这本书中，我们将 DApps[16]称为具有三个组件的去中心化软件系统。我们称这三个组件为 DApp 三元组（见图 2.1）：

+   一个用于可信交易交换的分布式叠加账本网络

+   在叠加网络中以可信方式执行的链上应用逻辑

+   链外应用逻辑是在叠加网络之外实现的，能够利用可信的交易交换和链上应用逻辑的可信执行。

![](img/b_9783110681130-002_fig_001.jpg)

图 2.1：DApp 三元组：DL 网络、智能合同和链外应用。

在非常高的层面上，DApp 架构可以与现代 Web 应用相比较，后者包括后端和前端，并需要一个连接两者的通信网络。在后端，需要例如大数据存储或复杂计算的应用逻辑通常被实现。应用程序的前端部分更侧重于客户端用户界面或物联网中嵌入式系统的逻辑。后端暴露了一个应用程序编程接口（API），例如 REST API，用于在后端和前端之间交换 JSON 格式的内容。通信连接通过互联网协议（IP）网络来确保。

在 DApp 中，后端由智能合同保证，这些合同是在 DL 网络上运行的应用逻辑。因此，它也被称为链上逻辑/应用部分。DApp 的前端应用程序是 Web、移动或嵌入式应用程序。它们不在 DL 网络上运行（因此属于链外应用部分），而是通过 DL 网络节点暴露的 API 访问后端服务。

## 2.3 DL 网络

分布式账本网络是特定分布式账本技术（DLT）的体现。分布式账本技术（DLT）在网络节点上实施，互联的节点构建网络。基于同一 DLT 可以有多个不同的网络。图 2.2 显示，分布式账本操作是一组位于传统 TCP/IP 堆栈上的应用层协议，并构建一个覆盖网络。类似的通信拓扑在例如 P2P 内容分发系统中也可以找到。例如，以太坊中的一些通信原则直接从现有的 P2P 系统中采纳。与客户端-服务器通信拓扑不同，分布式账本网络中没有中心实体。所有节点/客户端在提供通信能力方面具有平等的角色。对等节点使拓扑结构具有弹性且可扩展。因此，节点是一种软件。节点还有其他可能的称呼。分布式账本节点通常被称为客户端。节点运行分布式账本协议，例如：

+   用于节点发现、网络形成、流量控制或加密通信的低级 P2P 网络协议

+   高级 P2P 通信协议，用于节点身份识别、会话管理以及节点间的数据交换

+   用于在节点间同步链路的数据交换协议，例如，区块头信息，以及交易交换

+   构建交易协议，包括哈希和消息序列化

+   挖矿节点的共识协议

+   各种节点、网络管理和服务利用协议及 API

![](img/b_9783110681130-002_fig_002.jpg)

图 2.2：分布式账本网络参考模型。

根据激活能力的范围，分布式账本网络中的节点可以大致分为三类：

+   完整节点：每个节点都保存着整个账本的副本，并持续地进行同步。这些节点对于网络的分布式至关重要。它们确保了账本的有效性以及分布式账本系统（DL）的安全性。保存整个账本的副本（每一个区块、每一笔交易以及账本结构的所有元数据）可能会导致庞大的存储需求。

+   轻量级节点：不保存整个账本的副本。它们可能只拥有账本的一部分，例如，区块头信息，但没有区块内容。轻量级节点对系统资源的要求较低，如果节点的连接是间歇性的，它们还可以实现更快的账本同步。

+   挖矿节点：可以是完整节点或轻量级节点。它们的主要特征是运行账本共识协议（更多细节请参见第一部分和 1.2.1 节）以参与账本的构建过程。并非每个分布式账本（DL）节点都必须具备挖矿功能。然而，它通常被集成到标准节点软件中，并且可以被任意启用。

+   接入节点：可以是完整节点或轻量级节点。它们为离链应用程序提供与 DL 网络交互的 API（更多详情请参见 2.5.2 节）。与挖矿类似，暴露 API 并不是一个强制性的功能。

但我们对 DL 网络的关注超出了技术层面。它还包括网络治理、性能，以及所有设置、调整和新发展，以适应 DLTs 的新、具有挑战性的用例。

### 2.3.1 网络组织与治理

网络治理涵盖了网络节点控制的各个方面，从而控制整个网络及其服务。治理与 DL 技术对 DL 网络的两个基本特性同样重要：

+   性能

+   安全性或信任

在网络运营治理及其服务使用方面，需要区分两个方面：

+   控制网络节点，进而控制共识过程

+   用户访问网络服务，例如创建账户、交易，或向另一个账户转帐资金。

在 DL 网络中，这两方面的治理方法可以不同。例如，网络服务可能免费提供，而不需要特殊的访问控制。相比之下，在同一网络中，现有节点的管理和额外挖矿节点的安装可能严格限制仅限于网络所有者。这可能会让不知情的用户对网络的实际信任和安全级别产生错误的印象。如果网络控制是集中的，我们只能在完全信任网络所有者的情况下信任网络（就像在【2.1 节】中给出的传统数据库示例一样）。没有任何（无）限制的服务访问或关于网络分布的声明可以消除对中心实体的信任需求。在这种情况下，一个有效的问题将是：“*我们真的需要 DL 在这种情况下吗？*”

#### 2.3.1.1 公共、私有和联盟网络

【2.1 节】阐明，在 DL 网络中实体的分布是去中心化信任的前提。一个分布式系统可以是去中心化的或不是。网络的去中心化方法定义了人们对这样一个网络可以拥有的信任程度。比特币和以太坊网络（参见 1.2 节）等知名公共区块链网络是高度分布式的。同时，它们对谁可以向网络添加新节点、创建账户和交易，或参与挖矿过程没有任何限制。因此，它们也是去中心化的。

例如，2021 年公有以太坊主网大约有 7,000 到 8,000 个节点[17, 18]，比特币网络中大约有 10,000 个公开列出的完整节点[19】。估算矿工的数量很困难，因为他们主要组织成矿池。此外，参与挖矿的节点不必是完整节点，大多数矿工也不是。另一项估计指出，2021 年大约有 100,000 个独立的比特币挖矿节点组织在矿池中。以太坊主网也有相似的报道。

公有 DL 网络完全依赖于高度的去中心化和实施的加密算法来确保大多数诚实节点的共识。这为网络提供了安全性，并将恶意节点排除在网络之外。在公有 DL 网络中，网络控制和服务访问都是不受限制的。这样的网络是建立可信的分布式加密货币的前提，这也是许多 DLT（分布式账本技术）的最初动机。有许多著名的公有 DL 网络实例，比如比特币和以太坊。

私有 DL 网络是分布式的，但节点和网络的治理是集中在一个单一的系统所有者手中。因此，它不提供任何去中心化的信任。有限或无限制的用户服务访问无法弥补这种去中心化的缺失。有时，受私人控制的网络倾向于被描绘成是公共的，主要是为了获得它们提供的加密货币的信任。例如，在 IOTA 网络的当前 1.0 版本中，节点只有在其网络协调员节点确认后才真正有效。所有协调员节点都由 IOTA 基金会运营和控制，它过去已经利用这一点来修改交易账本。

在私有分布式账本（DL）网络中，我们可以应用与公有网络相同的技术，甚至可以使用相同的初始设置。例如，我们可以使用相同的网络节点软件（例如，以太坊的 Geth 客户端），选择相同的共识算法，并应用与私有以太坊主网相同的链创世设置。我们的网络可能节点数量要少得多，但两个网络的运作非常相似。链数据当然会有所不同，但这是由于不同的服务使用模式，而非不同的网络运作方式。公有与私有网络之间的关键区别，除了用途之外，在于它们的治理方式。

尽管如此，在私有的 DL 网络中，我们通常不试图模仿现有的公共网络。相反，我们应用不同的链起始设置，甚至是更改 DL 协议，以大幅提高网络性能。私有 DL 网络的关键好处是我们可以对其进行性能优化。

在公共网络中集中治理的挑战，在很大程度上可以被联盟分布式账本网络（DL 网络）所限制。在这里，网络控制仍然不是公开的，但也不局限于单一的中心实体。通常会建立一个合作伙伴联盟，拥有共同的目标——例如，一个连接分布式能源资源生产者（prosumers）的 DApp，他们之间不一定互信但愿意合作。联盟中的每一个合作伙伴都可以建立节点并参与共识决策，所以控制现在在一定程度上是去中心化的。它仍然不如公共网络那样去中心化，但这可能甚至不是必需的。在联盟网络中，我们网络中没有匿名参与者，所以违法者可以通过其他方式受到惩罚，例如，被排除在合作伙伴之外或通过法律措施进行惩罚。基于联盟的 DL 网络治理在金融或物联网业务应用中很普遍。一些著名的公共 DL 网络是基于联盟的网络控制而非公开控制，例如 Hedera 公共网络（具体见 2.7.1.3 节）。

#### 2.3.1.2 许可与非许可网络

分布式账本网络（DL 网络）的公共或私有性质取决于网络访问模式。它可以是：

+   许可

+   非许可

在公共网络中，网络服务的访问是无需许可的。这意味着新的网络用户（通常是个人）不必拥有任何专用权利来创建新账户、构建和提交交易，甚至向网络（包括挖矿节点）添加新节点。参与者因此保持匿名，仅通过其随机创建的 DL 网络地址来识别。真实用户与他们 DL 地址之间的关系不必披露即可参与网络或使用其服务。

在许可系统中，用户被授权访问网络服务或参与网络控制。在 DL 中许可有几个好处。许可网络控制可以实现更好的网络性能，并且更容易管理。许可网络也不需要加密货币来激励挖矿过程，这有助于降低交易成本。所有这些许可网络控制的好处都体现在用户所使用的网络服务上。此外，许可 DL 系统还可以帮助遵守 GPRD 等法规。

公共和无权限这两个术语经常被认为是同义的。公共在这里被理解为没有正式身份（与受权限的，有身份的相比）。对于许多公共 DL 网络来说，这可能是真的，包括比特币和以太坊。尽管如此，私有或联盟控制的网络也可能提供无权限的公共网络服务， too (图 2.3). 网络运行和用户对网络服务的访问是网络治理的两个不同方面，不必适用不同的治理和权限原则。因此，一些 DLT 分类法[20]讨论了公共-受权限系统，其中结合了公共、私有和受权限的最佳特性。此类网络的一个例子是 Corda。¹

![](img/b_9783110681130-002_fig_003.jpg)

图 2.3：DL 网络分类。

让我们考虑一些类比，以说明在控制网络和访问服务中治理和权限的各种组合。请注意，以下所有例子都是集中式系统，我们需要信任例如移动运营商，它不会，例如，拦截我们的通信。这种信任不能假设，因此对移动运营商和服务提供商有严格的规定和法律，以确保中立性、隐私和服务质量。

移动网络：

+   网络控制：私有 – 由移动运营商拥有；受权限控制 – 只有移动网络运营商管理和控制网络。

+   服务访问：公共 – 任何人都可以成为移动网络用户。尽管服务不是免费的，但访问是非歧视性的。

+   服务访问权限：受权限控制 – 如果用户有订阅，即后付费计划。

+   服务访问权限：非受权限控制 – 如果用户没有订阅，即预付费。

开放公共 WLAN：

+   网络控制：私有 – 由 WLAN 提供商拥有；受权限控制 – 提供商通常限制对 WLAN 管理系统访问。

+   服务访问：公共。

+   服务访问权限：非受权限控制 – 无需用户提供凭证。

机场公共 WLAN：

+   网络控制：私有 – 由 WLAN 提供商拥有，受权限控制。

+   服务访问：公共 – 任何人都可以注册然后使用服务。

+   服务访问权限：受权限控制 – 用户需要先注册，例如，通过一个网页。

公司私有 WLAN：

+   网络控制：私有 – 由运营 WLAN 的公司拥有，受权限控制。

+   服务访问：私有 – 只有注册的公司员工可以使用服务。

+   服务访问权限：受权限控制 – 用户需要由 WLAN 管理员提供的 WLAN 账户。

Tab. 2.2：公共、联盟和私有 DL 网络中的授权方法。

|  | 公共 | 联盟 | 私有 |
| --- | --- | --- | --- |
| **网络控制与运行** |
| 添加网络节点 | 无权限 | 受权限或仅限于联盟成员 | 受权限 |
| 挖矿与共识 | 无权限 | 仅限于联盟成员 | 不可能 |
| **DL 服务访问** |
| 账户与交易 | 无权限 | 受权限或无权限 | 受权限或无权限 |
| 节点 API | 无权限 | 受权限或无权限 | 受权限或无权限 |

在网络中可以应用各种权限级别（表 2.2）。一些活动可能需要注册并获得适当的权限级别（例如，添加新的完整节点）。一些活动可能会完全被禁止（例如，挖矿）。其他的可能不需要用户特别权限（例如，创建账户和发出交易）。

#### 2.3.1.3 分布式账本网络中的用户与数据隐私

隐私是当分布式账本（DL）网络和服务受到严格审查时的另一个挑战性概念。许多已知公共 DL 网络的无权限性质可能会导致认为匿名和隐私是（所有）DL 系统的固有特征。我们必须区分如下[21]：

+   用户隐私；

+   数据隐私

在无权限的公共网络中，用户隐私得到保证。任何人都可以在这样的网络中创建新账户，并从其中发送和接收交易。该网络不需要将用户个人身份与 DL 网络账户/地址之间进行任何映射。除非用户自己透露特定账户的所有权，否则该账户保持私密和匿名。当用户在在线加密货币交易所注册以用欧元（EUR）或美元（USD）等法定货币购买和出售加密货币，然后进行 DL 交易到他们的其他 DL 账户时，经常会这样做。

然而，与这些账户相关的所有交易数据都是完全透明的。账本的一个副本及其整个区块和交易内容是公开可用的，因为这是 DL 系统分布式和去中心化的基础。在这样的网络中，数据根本不是私有的。任何人都可以追踪任何账户的所有入账和出账，或计算账户余额。

在私有和基于联盟的网络中，对数据隐私的限制是一样的，只是数据的访问不是完全公开的，而是限制为网络的控制者。在 DL 网络中可以保证数据隐私，但必须采用适当的技术。其中之一是零知识证明。有关在基于 DLT 的物联网解决方案中的 ZK-SNARK 和其他与隐私相关的做法，请参见第 3.1.1 节。即使启用了与交易相关的隐私，也可以进行交易审计以遵守反洗钱或税收法规，其中披露是在用户控制之下的。

### 2.3.2 网络性能

系统性地并以普通方式解决分布式账本性能问题具有挑战性，因为它交织了许多相异的技术、网络实施、性能标准或与使用相关的期望。

交易吞吐量（每秒交易数，tps）和交易确认延迟（延迟）是最直观的两种性能指标。然而，即使是这两种指标，在不同分布式账本技术或网络之间也比较起来也是困难的。当前分布式账本系统的交易吞吐量和延迟无法与集中式或传统分布式数据库服务的数据相提并论[22]。通常，用户体验不佳的很大一部分可以归因于对技术的误解或理解不足，或者选择了不适合分布式账本技术的用例。此外，仅根据（仅）一个网络实施情况来判断分布式账本技术的性能是不可能且不公平的。例如，不能仅根据定量经验（测量）来估算以太坊技术的表现，例如以太坊主网。相同的技术（相同的软件）可以实现在私有或联盟网络中。不同的网络规模或设置在交易吞吐量或延迟方面会带来显著不同的性能。这对所有分布式账本架构都是正确的，其中允许不同的部署。

通常很难获得相关且可比较的性能结果。理论极限可以计算出来。但是，由于交易成本等原因，在公共网络中进行现实性能压力测试是难以执行的。使用相同分布式账本技术的小型私有网络分析不能完全模仿大型分布式网络。此外，一些分布式账本和网络提供商正在系统地研究其系统的性能方面，并得到了研究支持（例如，Hyperledger Fabric [23])和工具（Caliper）(图 2.4)。其他人提供了关于网络的透明且详细统计数据（参见 2.6.4 节）。还有一些人仅仅提出了令人印象深刻但无法复制的数字，并且缺乏透明的方法论。

![](img/b_9783110681130-002_fig_004.jpg)

Fig. 2.4: 分布式账本网络性能评估系统。

除了交易吞吐量与延迟之外，在现实世界的网络部署和 DApps 中，还有其他几个度量标准变得很重要。这些包括分布式账本网络的能量消耗、对节点（例如，链数据存储）和离链客户端（例如，在受限的 IoT 设备中与交易生成相关的加密）施加的资源要求，或者交易成本。

#### 2.3.2.1 交易吞吐量与延迟

吞吐量是指在给定时间间隔内提交的事务数量。然而，并不是工作过程中的每一个单位都算作一个事务，在这种情况下。只有导致状态变化的事务才应该被考虑。例如，在比特币（BTC）中从一个账户向另一个账户转移资金，或者通过以太坊的交易调用智能合约。智能合约的读取请求不会与状态变化的事务一起执行，因此它们应该被排除在这个指标之外。这对于穿透式交易也成立，即同一笔交易在各种智能合约之间传递。因此，它应该被计算为一次。被验证节点拒绝的无效交易，因此，不符合被记录在账本中的资格，也应该被排除。这可能看起来很显然，但是有一些网络性能报告，其中无法确定哪些操作被计算在内，哪些没有。

总体事务延迟取决于以下时间：

1.  事务生成，即编写数据结构，计算哈希值

1.  通过接入节点提交

1.  在 P2P 网络中传播并在矿工处验证交易

1.  区块创建和网络中的共识。

1.  需要额外的时间来达到足够的最终确定性水平。

前两个因素反映了链下因素，例如生成交易的终端设备的资源。剩下的因素反映了网络性能。

交易吞吐量理论上的极限可以通过平均区块时间和每个区块中的平均交易数来计算。区块时间分布取决于共识算法。在 PoW 中，区块时间是当前区块难度和网络总体哈希能力的后果。难度会自动适应哈希能力的变化，但 PoW 中的区块时间波动总是存在。另一方面，Proof of Authority (PoA)可以提供非常一致的区块时间，因为在 PoA 网络创世时设置了目标区块时间。区块链中的区块承载的交易数量有限。在 BTC 网络中，最大区块大小为 1 MB。平均大小为 500 B，每个区块的最大交易数约为 2,000。大约每 10 分钟产生一个新块。这导致 BTC 网络的平均吞吐量约为 3 tps。在以太坊中，区块中所有交易的气体（见第 2.3.2.3 节关于气体和交易成本）之和必须小于最大气体（每块）。在以太坊主网上，最大区块大小为 10,000,000，每笔交易的最小气体为 21,000（或平均气体为 72,000），一个区块中可以有高达 476 笔（对于平均大小为 138 笔）交易。平均而言，每 13 秒产生一个新块。以太坊主网的最大交易吞吐量约为 37 tps（对于平均大小的 10 tps）。

区块时间不能简单地减少以提高性能（包括更高的吞吐量或更低的延迟），因为这可能会危及网络收敛。如果共识算法需要通过网络广播区块创建信息（例如，在 PoW 中），那么传播延迟取决于网络大小。为了实现高分布和去中心化，需要大规模的网络。如果区块时间减少到接近或低于网络传播时间，这将在链的末端导致持续的分叉，可能导致网络分歧。

网络交易延迟是交易引起的状态变化在网络中反映所需的时间——提交新创建的交易和确认记录中包含的交易之间的时间差。在交易生命周期中有两个事件需要区分。当交易包含在一个新挖出的区块中时，矿工首先确认该交易。然而，直到信息被传播并被网络接受，不能保证该区块将成为链的一部分。这时交易被最终确定。在只有一个挖矿节点的网络中，确认和最终化同时发生。网络交易延迟按交易计算，但我们主要提供几笔交易的统计数据，例如平均值、最大值、最小值和标准差。

最终性确保在验证并包含在区块之后，交易不能被任意改变或撤销。在具有概率最终性的分布式账本网络（如 BTC、以太坊）中，我们无法达到 100%的最终性。相反，交易被视为最终完成的等待时间是保证的适当时间。为了获得足够的最终性，我们必须等待附加额外区块（通常是 2-10 个）的确认，这些区块在我们交易的区块之后。在具有绝对（或确定性）最终性的分布式账本架构中，一旦区块得到确认，一个区块中的所有交易立即被视为最终完成。对于不是每个区块都最终化的网络，一个有用的指标是最新最终化区块和当前最新区块之间的延迟时间。这个数字显示验证者落后于多少，同意正确的链[24]。

公共分布式账本网络（DL）依赖于不同的网络拓扑结构，这些结构影响网络性能。通常，这是以去中心化和安全性为代价的。比特币（BTC）和以太坊都是高度分布式网络，拥有成千上万的矿工节点，网络传播对共识和性能是相关的。为了减少网络传播时间的影响，提高挖矿成功率，挖矿池应用更有效的协议来在池内传播信息。在 Hedera Hashgraph 中，只有十个主网络节点执行一种虚拟投票形式来达成对每笔交易的效力和时间戳的共识。投票选择一个矿工来选择下一个区块。运行 Hashgraph 的节点社区作为一个集体，达成一致，决定将哪些交易添加到账本中。在 EOS 区块链网络中，区块生产者的数量也很少。有 21 个，他们轮流以循环方式生产区块。任何人都可以启动他的 EOS 节点，如果得到社区的投票，可以成为区块生产者。用户在一个候选人名单上对这 21 个区块生产者进行投票（委托权益证明（DPoS））。

#### 2.3.2.2 资源消耗

运行和使用分布式账本网络可能需要 significant resource requirements, including computation, storage, and energy.

工作量证明（PoW）共识机制被认为是非常能源低效的（详细情况见第 1.2 节）。矿工节点提供的哈希能力需要高性能的计算能力（CPU、GPU 或专用硬件）。运行比特币网络所需的年度能源消耗与一个中型发达国家相当。因此，能源效率是替代共识机制的关键目标之一，这在对私人和共识治理的网络中尤为如此，在这些网络中，挖矿过程没有货币激励或补偿。

比特币和以太坊的链数据大小数百 GB，并且不断增长。在一个 P2P 文件共享系统中，网络参与者可以保留和分享内容的只有很小的一部分，例如，一个流行 Linux 发行版特定版本的安装文件。参与者无需分享全部内容（所有可用的安装文件）就可以成为分布式网络中有意义的成员。而在 DL 网络中，另一方面，必须保留和分享整个分布式账本，因为这是确保系统去中心化和信任的唯一方式。这需要一个完整节点有大量的专用存储空间。大的存储需求使许多热情的网民望而却步，不愿意建立一个可靠的公共 DL 网络节点，为系统的去中心化做出贡献。大的链大小也增加了新节点同步链所需的引导时间。

非挖矿节点和挖矿节点的通信需求相当矛盾。链同步需要网络节点有可靠但适中的比特率网络连接。以太坊常规同步新块的平均数据大约为 18 kB/s，下载数据大约为 10 kB/s [25]。间歇性连接对于离链应用是至关重要的，因为链未同步可能会由于暂时性的连接问题而导致应用停止或无法正常运行。

对于整体网络性能来说，矿工节点之间块相关信息的快速传播是至关重要的。在真正分布式的、有许多参与挖矿节点的网络中，块传播时间可能成为关键的性能瓶颈。应用于这种传播的分布式通信协议并不是最有效的，并且对任何低级别的通信相关的传播延迟都非常敏感。因此，建议用有能力、低延迟的通信来互联矿工节点。许多挖矿池采用专用的通信方法来加速池内挖矿信息的传播，并通过这种方式为池内矿工获得一些优势。

例如，运行非挖矿全网络节点或网络访问客户端所需的内存和 CPU 功率，如果我们将这些节点设置在普通计算机上，通常并不会非常受限。然而，对于计算和通信资源常常受限的 IoT 设备来说，这很快就会成为一个问题。我们在第三部分回顾了区块链和 IoT 的详细信息。

在此时，我们想解释一下以太坊中用于评估智能合约和交易资源消耗的 gas。gas 反映了交易的规模（以字节为单位）和智能合约执行期间的计算复杂性。然而，gas 只反映了状态更新和智能合约执行的复杂性。它并不反映所有所需的资源，例如，验证交易所需的资源，因此不适用于作为整体网络性能的精确指标 [26].

#### 2.3.2.3 交易成本

分布式账本网络采用广泛不同的方法来补偿资本支出和运营成本（表 2.3）：

+   挖矿成功的奖励。这是大型分布式公共网络中，例如 BTC 和以太坊，关键的补偿原则。由于能源成本巨大，对矿工的财务奖励是必要的。对于成功创建的区块，即附加到账本上，矿工们会创造出约定数量的加密货币并将其注册到他们的账户中。挖矿奖励逐渐减少。这是分布式账本技术（DL）协议的内置功能。

+   通过交易费用进行补偿。在具有公共加密货币的分布式账本网络中，交易费由交易发送者支付。这是成功挖矿的赏金之外的额外收费。长期以来，区块的交易费用高于挖矿奖励。然而，在以太坊，区块的交易费用已经与挖矿奖励持平。存在多种原则来确定实际费用。

+   参与交易验证。在一些分布式账本技术（例如，IOTA）中，交易提交者必须验证其他提交者的一个或多个交易。这种方式直接将交易负载和成本分配给发送者。

+   不通过分布式账本网络进行补偿。这对于节点分布较低的私人或联盟网络来说很方便，因为这种网络的总成本不是很高。网络提供商寻求其他收入来源，例如，基于分布式账本网络或其他服务收费，或来自联盟伙伴的贡献。在这种方法中，交易发送者不支付任何费用。

acceptable transaction costs 没有绝对的价值，因为这取决于不同的用例。在去中心化金融（DeFi）中，几欧元或几美元的应用成本可能是可以接受的。另一方面，在微支付和微交易中，即使是几分之一美分也可能是有争议的，对成功用例有限制。除了绝对值之外，费用的波动性也可能是一个问题。

表 2.3：各种公共分布式账本网络的交易成本。

|  | 成本补偿类型 | 关键特征 |
| --- | --- | --- |
| **比特币** | 基于交易大小的字节数来计算交易费用 | 费用取决于加密货币价值的变化 |
| **以太坊** | 以燃料（Gas）为基础的交易费用 | 费用取决于加密货币价值的变化 |
| **Hedera** | 网络服务 API 调用的费用 | 以法定货币设置的预定义费率 |
| **Corda** | 年度参与费+交易费用 | 以法定货币设置的预定义费率 |
| **IOTA** | 参与验证过程 | 发送者必须为两个之前未确认的交易进行工作量证明（PoW）。 |

比特币的交易费用需要反映交易的大小（以字节为单位）。由于比特币块的大小是有限的，矿工可能更喜欢小交易而不是大交易。因此，他们有动机优先处理小交易。另一方面，交易发送者可以优先处理费用较高的交易。许多加密钱包已经推出了内置的费用计算器。

以太坊的交易费用是通过燃料（Gas）和燃料价格来确定的。燃料反映了资源消耗，因此，处理交易的费用。交易发送者会选择一个燃料价格（以太币的价值）。燃料乘以燃料价格来计算特定交易的费用。矿工在构建下一个区块时更有可能考虑费用较高的交易。

由于 Hedera Hashgraph 网络服务的所有接口都只能通过 API 访问，用户无法直接创建和提交交易。用户更愿意为 API 调用付费，而不是为交易付费。API 定价是透明的，⁴ 费用以法定货币设定。它们根据 API 调用的类型而变化。2021 年，加密传输 API 调用的价格为 0.0001 美元，这使得微交易（<0.01 美元）在经济和技术上变得可行。在 Hedera DL 中调用智能合约或创建文件的成本为 0.05 美元。

一个名为 Corda Network Foundation 的独立实体被设立来管理 Corda 的发展和网络。在 Corda 中，网络是半私有的和受许可的。一个节点必须从网络运营商那里获得证书才能加入一个网络。网络运营商会为提供网络和管理服务收取合理的费用，这笔费用由基金会支付。在 Corda 中，参与者支付年度参与费和交易费用。交易费用是为 Corda Network notary 提供的身份验证服务而收取的，并且分为两种不同的模式：按需付费和预付费包。总费用取决于交易数量，但 Corda 提供了非常透明和可预测的交易定价。

IOTA 用基于哈希权力的交易费用取代了以 MIOTA（或其他数字资产，或法定货币）支付的交易费用。⑤ 交易的发送者必须为两个之前未确认的交易建立 PoW。这样，挖矿就在交易发送者之间而不是在专用挖矿节点之间分布。在 IOTA 中，当其他交易引用它们时，交易得到加强。目前，交易只有在网络协调员（由 IOTA 基金会运营的特殊节点）确认它们时，才真正有效（最终化）。

### 2.3.3 可扩展性

我们需要在两个额外的区块链属性背景下研究可扩展性，这三个属性一起被称为区块链可扩展性三元悖论。这个三元悖论指出了 DL 系统的三个基本属性：去中心化、安全和可扩展性。去中心化（更多详情请参见第 2.1 节）指的是 DL 系统中所有权和控制的多样化。去中心化的程度不是一个二进制属性，实际网络实施提供了一些在完全去中心化和（完全）集中系统之间的去中心化水平。安全性包括使网络对攻击（例如，51%，DoS）具有韧性和弹性的网络操作方面。可扩展性是关于在额外节点方面扩大网络，更重要的是，提高其性能。

去中心化、安全性和可扩展性方面不容易共存，因此需要平衡它们。（图 2.5）例如，在一个庞大的公共网络中，增加分布和去中心化可以提供一个更高水平的信任，但会增加来自匿名且可能具有恶意网络参与者的安全风险。同样，在基于联盟的网络中，更加集中的治理可以有利于扩展网络性能，但会减少（去中心化）信任。

![](img/b_9783110681130-002_fig_005.jpg)

图 2.5：区块链中的可扩展性三元悖论。

随着用户的广泛增加，主要基于 PoW 的公共区块链的性能和可扩展性问题已经出现。这导致了新型 DLT 的研究，并影响了现有技术的发展。可以采取几种方法来促进区块链系统的可扩展性。我们讨论了三个可扩展性原则，这些原则正在以各种形式实施，用于不同的现有区块链技术：

+   链上可扩展性解决方案包括对账本（块大小和结构，块时间）的修改、共识机制（参见第一部分）或网络分片。

+   链下可扩展性解决方案试图促进交易卸载，即在主账本之外的受信交易交换，例如，使用状态通道和预言机。

+   跨链扩展解决方案，其中多个分布式账本网络通过网关/中继器互联，以便在各种系统中交换交易。跨链解决方案是一个非常新颖的研究领域。它们不仅有助于分布式账本网络的可扩展性，而且对于分布式账本网络的互操作性至关重要。

#### 2.3.3.1 分片

分片是一种链上方法，其中分布式账本网络拓扑被划分为几个更小的网络，称为分片。每个分片包含网络节点的一部分。不同的分片处理网络中的交易。这减少了每个节点必须处理的交易数量，并产生了两个积极的结果：

+   状态分片——节点只保留其分片的数据。这降低了节点的系统要求并减少了引导时间。

+   交易分片——交易分布在不同的分片之间；它们可以并行处理和验证。这增加了整个网络的交易吞吐量。分片中节点数量减少也加速了区块传播。

但是，网络拓扑的这种变化有几个困难。我们为了通过分片获得的性能提升而牺牲了去中心化，从而降低了系统信任。分布也减少了，因此常见的分布式账本网络安全风险（51%攻击）变得更加突出。另一个问题是起源于一个分片且目的地为另一个分片的交易。处理这些跨分片交易更加困难，它们需要在分片之间传播，需要更多的通信和专用机制。因此，共享效率强烈依赖于交易的统计特性，因此也取决于特定的用例。

一种修改后的分片方法包括主链（网络）和多个分片链。每个分片定期将其状态提交给主链。这样，分片数据的信任就可以得到验证。跨分片交易通过主链处理。如果跨分片交易数量增加且主网络成为瓶颈，这种方法的效率将大大降低。

分片研究探讨了如何高效地将节点分配到分片以及如何保护去中心化和安全性。大多数分片开发和实施集中在公共分布式账本网络上，通常采用工作量证明（PoW）共识。在私有或联盟网络中，通常通过精简主网络操作来提高性能。

#### 2.3.3.2 离链状态通道

状态通道是一种补充的离线方法，它暂时将两个分布式账本（DL）账户之间的交易从 DL 网络转移到一个专门的通道。如果交易主要是账户之间的价值交换，而不是代币或智能合约调用，状态通道也被称为支付通道。它们减轻了主链的负载，从而提高了整个系统的性能。通过主 DL 网络中的智能合约建立、管理和清结算通道，该智能合约充当调解人。通道可以直接建立在两个账户之间。通道可以通过状态通道网络中的状态通道节点在专门的离线网络中进行多跳，这些节点在 DL 网络之上构建了一层。由于通道中的交易不是构建在区块中，因此没有区块创建的延迟，也不收取交易费用。

两个著名的状态通道例子分别是用于 BTC 的 Lightning Network⁶和用于 Ethereum 的 Raiden Network⁷。Lightning 网络仅限于 BTC 交易。除了常规交易外，Raiden 网络还支持 ERC20 代币。

#### 2.3.3.3 跨链交换

跨链技术，也称为原子交换或跨链原子交换，在分布式网络拓扑和操作中扮演着双重角色：

+   可扩展性——它们将交易交换从单一的共同 DL 网络分离成一组互联的网络。由于交易分布在多个网络上，它们可以并行处理。这增加了整个系统的交易吞吐量。

+   互操作性——与分片不同，跨链交易可以整合基于不同分布式账本技术（DLT）的网络，因此分布式账本应用（DL 应用）不再局限于单一链上。

其互操作性甚至比贡献可扩展性更具颠覆性，因为它正在开启一系列新的分布式账本（DL）用例。通过这种方式，我们能够确保 BTC、以太坊以及其他基于 DLT 的网络之间的协议和语义互操作性。同样，我们可以整合例如私有和公共 DL 网络形成混合拓扑。通过跨链交换，私有和公共网络中的智能合约服务流保持同步，就好像整个平台实现在一个网络中。然而，有了两种（或更多）网络类型，我们现在可以支持整体业务逻辑的不同性能、安全和可扩展性要求。

跨链交易通过称为中继、桥梁和枢纽的元素来保证，通常与专用的分布式账本（DL）一起使用。COSMOS⁸ 是一个由连接的区块链组成的生态系统。它使用基于 Tendermint Core 的 DL 网络和 Cosmos 共识机制。跨链通信协议（IBC）用于连接其他 DL 网络和应用程序。Polkadot,⁹ 也是一个中继区块链。它通过一组验证者确保中继链的安全，该链将各种独立的平行链链接在一起。聚合器是连接到已经运行的 DL 网络的网络元素，包括以太坊。他们将平行链块打包并传递给验证者进行验证。

## 2.4 智能合约

智能合约是 DApp 三位一体的第二个基石（具体见第 2.2 节）。智能合约这个术语是在 1996 年由 Nick Szabo 创造的，这是在第一个区块链网络出现之前很久。他将智能合约视为合同关闭，这种关闭通过硬件和软件的方式使得违反合同的成本过高。他指出自动售货机和传统的支付或银行交易系统是现代 DApps 和智能合约的先驱。有趣的是，他从法律原则、经济理论和实践中常见的合同条件中概述了合同设计的四个基本目标[27]：

+   可观测性 – 证明自己或观察他人履行合同的能力

+   可验证性 – 向仲裁者证明合同已经履行或违约

+   第三方性 – 最小化对第三方的脆弱性，将他们排除在合同内容和执行的知识和控制之外（隐私和保密）

+   可执行性 – 最小化执行努力，包括自我执行协议

Szabo 对许多发现进行了很好的预测，几年后，他在 BTC 协议和网络中实施了这些想法，因此他被认为是真正的 BTC 发明者之一。真正的发明者仍然未知，仍然只以化名中本聪（Satoshi Nakamoto）为人所知。在某种程度上，提到的四个目标在大多数当前的分布式账本技术（DLTs）和网络中得到满足，这些网络超越了简单的价值交易，并支持 DApp 开发（例如以太坊、Hedera Hashgraph 和 Hyperledger）。

智能合约在法律义务的意义上既不智能也不是具有约束力的。然而，在商业合作中，它们通常被用来执行某种类型的协议，这样所有参与者都可以确信结果，而不需要中介的参与 [28]. 这样的协议，编码在智能合约的链上逻辑中，没有失败的中心点，可以执行操作，持有价值，并且只有在满足特定条件时才能解锁 [29, 30].

### 2.4.1 虚拟机

智能合约代码的执行环境可以类比为一种由分布式账本网络提供的虚拟机，实际上，在以太坊中，这个环境被称为以太坊虚拟机（EVM）。

为当前可用的分布式账本技术（DLTs）存在不同的虚拟机。EVM 是其中最受欢迎的之一。一些非以太坊的分布式账本技术也采用了 EVM，尽管它们与以太坊有着完全不同的账本和共识技术。例如，Hedera 为 Hedera Smart Contract Service 提供了一个 EVM 实现的适应版本。Sawtooth，是众多 Hyperledger 项目之一，其内置的 Hyperledger Burrow，可以运行在 EVM 中的 Solidity 智能合约以支持 Hyperledger。这不仅促进了为以太坊开发的智能合约的重复使用；使用相同的智能合约编程语言，并依赖熟悉的智能合约执行环境，对开发者来说也非常有利。他们可以依赖其先前的软件和安全性工程经验，并重复使用他们的现有代码库，使得开发更加快速和安全的。

其他分布式账本的虚拟机采取了不同的方法，并使用了不同的智能合约编程语言。例如，Corda 中的智能合约代码是用 Kotlin 编写的，Kotlin 是由 JetBrains 开发的一种编程语言，针对 Java 虚拟机（JVM）和 JavaScript。合同的执行和验证虚拟机是 JVM 的增强版，并且更加严格，它强制执行安全要求和确定性执行。EOS 中的智能合约运行 WebAssembly，这意味着支持广泛的编程语言。Hyperledger 中的链码可以用任何编程语言编写，并在容器中执行。目前，支持的编程语言包括 Golang、NodeJS 中的 JavaScript 和 Java 链码。借助对 EVM 的支持，Hyperledger 也可以运行 Solidity 智能合约。

分布式账本系统（DL 系统）的分布式并不会提高虚拟机（VM）的性能。分布式账本网络中的每个节点（不仅仅是矿工）都会执行智能合约代码。这确保了共识，从而确保了智能合约执行结果的可靠性。所有分布式账本网络节点都会重复智能合约中编写的相同操作，因此它们都运行着相同的虚拟机副本。因此，整个网络的智能合约处理能力受限于特定节点的处理能力。

### 2.4.2 生命周期

智能合约是一种软件产品。它的生命周期包括设计、开发、编译和部署到分布式账本网络中。最后，作为 DApp 的一部分使用。这与任何其他软件产品类似。然而，在分布式账本网络上执行智能合约对软件工程提出了几个特定的限制，包括开发、性能和安全方面。我们将在接下来的章节中讨论这些内容。智能合约的生命周期概述如图 2.6 所示。图中指出，在生命周期中可以找到管理和几个阶段。然而，如果智能合约非常简单或对软件工程不够重视，这些阶段不一定都存在。省略验证和经过周密计划实施的智能合约管理可能会带来灾难性的安全后果。该图指的是典型的基于以太坊的 DApps 的生命周期。其他分布式账本平台上的智能合约可能具有稍有不同的生命周期。例如，在 Hyperledger Fabric 中，不需要将智能合约源代码编译成 BC 本地可执行字节码，因为智能合约是在容器中安装并运行的。

![](img/b_9783110681130-002_fig_006.jpg)

图 2.6：以太坊中的智能合约生命周期。

设计、开发和源代码验证产生了智能合约的源代码。在以太坊中，源代码通常是用 Solidity 语言编写的（具体工具和语言见 2.4.3 节）。在设计和编程源代码时，可以采用不同的形式和运行时方法来验证智能合约代码的正确性，并在规范和代码实现中尽量减少可能的安全漏洞。

然后，源代码被编译成可以在分布式账本系统（DL 系统）中部署和执行的版本。在以太坊中，这是特定于以太坊的二进制格式，称为 EVM 字节码。

在以太坊中，已部署智能合约的使用由应用程序二进制接口（ABI）规范定义[31]。ABI 是外部程序模块与智能合约字节码之间的接口。然后，字节码和 ABI 文件随合同创建交易发送到区块链。这个特殊的交易发送到一个空接收者区块链地址，以 EVM 字节码作为数据。交易发送者是一个有效的以太坊账户。这个账户成为智能合约的所有者。一旦智能合约部署交易被区块链中的验证节点添加，智能合约获得唯一的智能合约地址。现在，交易可以被定向到新部署智能合约的地址。智能合约有其余额、一些代码和一些持久存储来执行其操作。在部署后可以添加另一层验证。我们现在可以在字节码级别检查可能的编译错误，或确保部署的字节码逻辑与源代码一致。

在以太坊 BC 中，ABI 规定了实际的数据编码/解码机制，即我们如何调用合约中的函数或传递并获取数据回来。在其他分布式账本架构中采取了略有不同的方法，例如，超级账本 Hyperledger[32]。网络中的其他智能合约和外部（离线）应用程序调用智能合约方法以读取智能合约参数或发送 BC 交易以改变其状态。智能合约可以由 DL 网络节点过滤事件并传递给外部应用程序。同一网络中的不同智能合约位于同一虚拟机中。它们的通信简单，仅受智能合约中编码的访问权限限制。离线应用程序需要访问一个有效的 DL 账户和一个 API 与 DL 节点通信。对于以太坊离线应用程序，提供了几个前端 JavaScript API，包括前端编程库。一个例子是 Web3.js – 以太坊 JavaScript API,¹² 一组允许使用 HTTP、IPC 或 WebSocket 与本地或远程以太坊节点交互的库。

传统 Web 应用非常常见地通过各种协议访问互联网上的各种资源，例如 HTTP、HTTPS、WebSockets、WebRTC、RPC 等。另一方面，智能合约执行环境将智能合约执行的范围限制在分布式账本网络中。智能合约只能调用网络中的其他智能合约，但不能访问 DL 之外的资源。

智能合约方法可以通过分布式账本网络参与者两种方式访问。假设一个离线应用程序或另一个智能合约需要，例如，简单读取智能合约参数。在这种情况下，通过智能合约方法的本地调用（仅在本地分布式账本节点中发生）来完成。另一方面，当分布式账本网络参与者需要修改智能合约中的某些状态时，必须通过发送到智能合约地址的交易来初始化调用。此交易可以为智能合约包含加密货币，并为方法调用提供附加输入参数。交易必须经过验证并包含在链中，与非智能合约交易的方式相同。包含后，智能合约执行，并根据需要更新合约及其整个账本的状态。当然，智能合约的字节码保持不变。由于分布式账本的不可变性，部署的字节码的任何代码更改都是不可能的。

图 2.7 展示了一个简单单合约解决方案的类图，该方案提供了两个方法：promoteToAdmin 和 poeCreate。第一个方法期望一个名为 hopefulAdmin 的参数，其值对应于新管理员的以太坊地址。poeCreate 方法接收一个哈希值及其上下文数据。这些方法使用给定参数执行。如果编码条件满足，poeCreate 方法将发出一个名为 poeCreated 的事件，该事件被区块链网络中的所有节点拦截，并通知订阅这些事件的离线应用程序。poeCreated 事件中的哈希值被索引，因此订阅者可以请求只接收具有特定哈希的 poeCreated 事件。智能合约还包括一个名为 eventCount 的变量，该变量是公开可读的。

![](img/b_9783110681130-002_fig_007.jpg)

图 2.7：简单单合约智能合约解决方案的类图。

### 2.4.3 智能合约编程

包括以太坊、Hashgraph 和 BTC 在内的大多数分布式账本智能合约执行环境遵循基于 *order-execute* 原则的状态机复制。这些分布式账本共识机制确保在执行之前，对智能合约调用交易有一个清晰的顺序。然后按顺序在所有对等节点上执行这些有序交易，反映在账本/智能合约状态的公共更改。为了实现这一点，智能合约的执行（智能合约的代码处理所有交易地址）必须是确定性的。

对确定性执行的要求对智能合约能做什么施加了严格的限制。例如，使用日期或时间函数、生成随机值或从链下资源（例如，外部 API 调用）检索数据都会阻止确定性执行。因此，分布式账本技术（DLT）通常使用特殊的智能合约编程语言来强制确定性，甚至是在编程语言层面。假设虚拟机使用的确定性脚本语言是图灵完备的。这意味着开发者可以设计的智能合约类型仅受他们的编程技能和创造力的限制。

然而，并非所有分布式账本（DL）的智能合约执行环境都遵循顺序执行原则。Hyperledger 采用不同的交易生命周期，因此也采用不同的智能合约执行和验证原则，这被称为执行-排序-验证[33]。这个名字表明，首先执行由交易调用智能合约地址的交易发起的智能合约调用。因此，针对智能合约的交易可以以任何顺序执行，甚至可能是并行执行。交易不必在网络中的每个节点执行。交易执行后，背书策略定义哪些节点需要对交易的执行结果达成一致，然后将其添加到账本中。这是交易排序的阶段。交易验证是最后发生的，与执行分离。在验证期间，每个节点都有一个已执行交易的有序列表，可以检查其中是否有任何交易因双重花费而无效。

执行-排序-验证方法有几个相关的优点。其中包括提高性能（不是每个节点都执行每个智能合约）、智能合约代码隐私（只有背书节点需要知道智能合约代码）以及使用通用编程语言进行智能合约开发的可能性。

#### 2.4.3.1 编程语言

各种编程语言被应用于开发智能合约，这取决于所选网络中的虚拟机（VM）。一些虚拟机支持多种编程语言用于智能合约，而其他的则坚持使用一种。

以太坊使用确定性编程语言 Solidity（常用）和 Vyper 来编写智能合约。Solidity 是以太坊上最受欢迎的编程语言¹³，其灵感来源于 C++、Python 和 JavaScript，而 Vyper 则是基于 Python 的。人们可以用 JavaScript、C++或 Python 来构建智能合约。然而，由于与 EVM 相关的顺序执行和上下文约束，使用专门为这一任务设计的语言会更容易。

EOS¹⁴ 区块链网络支持 WebAssembly (WASM) 用于智能合约编程，尽管它也是一个按序执行的分布式账本。WASM 不是确定性的，因此是否使用如一天的时间或随机数生成器等非确定性输入取决于程序员。

Hyperledger Fabric 是第一个能够运行用如 Go、Java、Node.js 等通用编程语言编写的智能合约的区块链系统。智能合约代码在容器中执行。

#### 2.4.3.2 工具和库

在 DApp 时代的开始，只有具备有限功能的 basic 工具集可供开发者使用。大多数工具与以太坊和 Solidity 有关——这是 DApp 先驱的分布式账本技术的基石。开发工具大多是桌面或在线代码编辑器，带有 Solidity 代码高亮和语法检查。一些与 Solidity 编译器相连，而其他的则将编译留给其他工具。调试是手工的，而且没有或只有非常基础的安全性验证可用。

随着 DApp 生态系统的成熟，出现了更多集成度更高、功能范围更广泛的新工具和框架。这些工具支持智能合约的开发、验证、测试和部署。我们现在正在接近与例如长期建立的 Web 应用开发具有相似成熟度的开发环境。

对于以太坊，有专门的框架（Truffle）和集成开发环境（IDE）（例如，Remix）。流行的多功能开发环境（例如，VS Code）也支持 Solidity 代码的编码、编译和安全性验证。这些工具和框架可以与代码验证器（MythX）或模拟器（Ganache）集成，用于在模拟的区块链网络上进行初步测试。同样的工具也可以用于 Hedera Hashgraph 的智能合约开发，因为它实现了以太坊的 EVM 并使用 Solidity 进行智能合约编程。EOS 生态系统也为智能合约维持了一组广泛的开发和测试工具¹⁵。例如，与 EOS 所需的多种工具集成的统一图形应用程序 EOS Studio 提供了强大的且易于使用的 DApp 开发环境。

此外，Solidity 有一些内建库，这些库增强了安全性或以系统化和经过验证的方式实现许多智能合约开发者经常使用的常见功能。这加快了开发过程并增强了安全性。然而，外部库的应用可能会与智能合约代码期望的简洁性相冲突，并引入库中额外代码可能带来新的风险。一些库包括：

+   模块化网络：包括许多模块化库，如 ArrayUtils、Token、CrowdSale、Vesting、StringUtils、LinkedList、Wallet 等。

+   OpenZeppelin:¹⁶ 提供了基于角色的访问控制（库名为 Roles）和安全的数学库（SafeMath），以及为以太坊智能合约编程提供的其他安全相关库（MerkleProof、ECDSA、Address、SafeERC20、Arrays）。

+   DApp-bin: 是由以太坊创建的，并包含了诸如 DoublyLinkedList、StringUtils、IterableMapping 等库。

对智能合约进行不同层次的代码测试对于提高效率和安全性是必不可少的（更多细节请参见第 2.4.4 节）。一些项目旨在对智能合约进行形式化验证，并且有一个全面的列表正在维护[34]。其中一些工具在源代码级别（即 Solidity）操作，而其他工具在编译后的字节码级别操作。MythX¹⁷ 是一个基于云的智能合约安全服务。它远程执行安全分析，通过 API 接收作业并返回结果。它目前检测到了 SWC 注册表中找到的大部分弱点。因此，它涵盖了断言和属性检查、字节码安全、授权控制、控制流、ERC 标准实现的正确性以及 Solidity 的各种编码最佳实践[35]。分析类型包括符号分析、模糊测试（字节码）、Solidity 代码分析、污点分析以及静态分析。MythX API 已经集成到了许多开发框架中，包括 Brownie、Truffle、Remix 和 VC Studio。OYENTE [36] 是基于符号执行的另一种分析以太坊智能合约代码的工具。OYENTE 接受两个输入，以太坊智能合约的字节码和以太坊全局状态。它将合同与几个已知的软件弱点进行对比。尽管大多数测试工具都是针对以太坊和 Solidity 的，但其他分布式账本技术生态系统也解决这个问题。Chaincode scanner [37] 是 Hyperledger Fabric 智能合约的静态安全检查器。它接受用 Go 编写的链码作为输入，并检查九个漏洞模式。

其他工具可以促进已部署智能合约的开发和监控。链和区块浏览器在第 2.6.4 节中介绍。一个有价值的工具是 Hyperledger Caliper,¹⁸ 这是 Hyperledger 项目的一部分。Hyperledger Caliper 是一个基准测试工具，允许用户使用一组预定义用例来衡量区块链实现的性能。Hyperledger Caliper 生成的报告包含几个性能指标，包括资源利用率、交易延迟和每秒交易数（tps）。除了几个 Hyperledger 分布式账本技术（DLT）外，Caliper 还对基于以太坊的网络进行基准测试。

超级账本分布式账本技术（DLT）生态系统（参见第 2.7.1.2 节）开发和推广了多个企业级区块链库。例如，Hyperledger Ursa¹⁹是一个共享的加密库，它使得实现者可以避免复制其他加密工作，并在过程中提高安全性。

### 2.4.4 智能合约安全

智能合约的安全性与相关 DApps 的安全性是更广泛网络安全景观的一部分（参见图 2.8）。因此，它们也共享许多在其他 ICT 系统和应用中常见的已知风险和漏洞。这些常见的攻击载体，例如，攻击应用客户端，通过钓鱼攻击、字典攻击或利用硬件钱包中的漏洞攻击用户钱包凭据。数字签名、哈希函数或地址漏洞的利用也是一样。分布式拒绝服务（DDoS）攻击可以针对 DLT 和 DApp 的基础设施，例如，离线应用部分或辅助服务，如加密货币交易所和挖矿池。

![](img/b_9783110681130-002_fig_008.jpg)

图 2.8：智能合约安全和网络安全。

然而，除了因 DLT 的去中心化和分布式特性影响 DApps 的常见网络风险和漏洞外，未知或特定的漏洞和风险也会出现或加剧。可能的攻击和新攻击载体包括分布式账本网络的治理和运营、挖矿和共识机制、交易篡改以及智能合约攻击等。这些攻击载体经常组合成单一的攻击领域，以控制网络、网络的一部分或个别节点，并利用这种控制来操纵交易。其中一些攻击载体可能执行起来极其困难且成本高昂。在真正去中心化的 DL 网络上，它们可能实际上几乎是不可能的。然而，在更加中心化（私有）的网络中，风险仍然存在。许多攻击载体是协议和实现特定的，并不存在于 DLT 的每个变体中，因此，DL 网络的实际实现可能通过高去中心化、授权节点代替匿名节点、传统 PoW 之外的共识机制等方式减轻或预防一些风险。

虽然一些防御机制和缓解技术在其他 ICT 领域中已经存在，并且在现代软件开发生命周期中易于获得，但其他技术需要重新开发或适应到区块链技术中。这并不令人惊讶。大多数区块链平台、工具和智能合约编程语言仍处于起步阶段，通常它们发展迅速，不断更新特性。因此，区块链平台或智能合约语言中可能存在设计缺陷。随着区块链生态系统的成熟，安全方法也在进步。

先前部署的智能合约代码的不可变性质暴露了在传统软件系统中容易缓解但在去中心化应用中可能带来严重风险的漏洞。与任何源代码一样，即使经过彻底测试和验证的智能合约也可能存在缺陷。区块链平台或智能合约语言中可能存在设计缺陷。常见的软件安全弱点（CWE）[38]可能会在区块链平台和相关智能合约安全[39]上放大。这些弱点包括不适当的行为工作流程、访问控制或初始化、计算错误和随机性不足、包含未经验证的外部功能（例如，外部库、由他人部署的智能合约），以及不正确的异常处理和对加密的理解不足。

关键的智能合约漏洞源于逻辑流程、智能合约代码中的错误以及未优化的代码模式。在合约实施的逻辑流程中，例如智能合约没有退还初始存款、缺乏确保用户输入公平的加密、或激励错位[40]，可能是故意的或由于对分布式账本属性的误解造成的。在公共区块链网络上，其中加密货币和矿工奖励是 DApp 执行的一部分，存在因未优化的智能合约代码模式而导致不必要的气体消耗[41]的风险。他们的研究表明，这主要是由于无用的代码相关和循环相关模式造成的。

在以太坊中，智能合约漏洞源于 Solidity 编程语言、以太坊或 EVM 区块链平台以及对常见实践的误解。在 Hyperledger Fabric 链码中，漏洞源于几乎相同的原因：Go 编程语言、区块链平台和对常见实践的误解。

#### 2.4.4.1 智能合约弱点分类

智能合约弱点分类和测试用例注册表（SWC 注册表）[39]是 Solidity 智能合约代码中关键安全缺陷的全面列表。它为智能合约程序员提供了检查清单，许多智能合约漏洞检测工具也使用该清单。可能的漏洞被标记为 SWC *x*，其中*x*是漏洞的索引号，例如，SWC 107。

一些常见的 Solidity 智能合约漏洞包括交易顺序依赖、时间戳依赖、异常处理不当和重入。交易顺序依赖（SWC114）如果用户无法控制交易执行的顺序，可能会出现问题。顺序取决于矿工。如果有多个交易调用了同一个合约，这些交易的顺序可能会影响区块链的新状态。时间戳依赖（SWC116）与智能合约有关，包括由区块时间戳触发的条件。区块时间戳由矿工根据其本地系统时间设置，可能不可靠或被对手操纵。异常处理不当（SWC104）针对调用另一个合约的合约。如果在被调用合约中发生任何异常，它将终止并返回 false，但它可能不会通知调用者合约。重入漏洞（SWC107）存在于一个合约调用另一个合约的情况下，当前合约执行等待直到被调用合约完成。这为对手利用调用者合约的中间状态并多次调用其方法提供了机会。通过 tx.origin 授权（SWC115）可能会使合约如果一个授权账户调用恶意合约而变得脆弱。可以调用脆弱合约，因为它通过了授权检查，因为 tx.origin 返回事务的原始发送者，即授权账户。

#### 2.4.4.2  securing smart contracts 的步骤

我们可以采取两种类型的安全措施来保护智能合约——被动和主动智能合约安全。这两个子集并非互斥或相互替代，而应被视为智能合约安全的两个独立基石。被动安全措施包括智能合约架构、适用于智能合约环境的软件工程技术或代码审查和验证（有关智能合约编程的工具和库，请参见 2.4.3.2 节）。主动措施发生在智能合约执行期间，指的是智能合约和方法访问控制、对传入智能合约交易的主动监控以及授权其操作。

##### 2.4.4.2.1 更新和升级

正如 2.4.4 节开头所讨论的，先前部署的智能合约的不可变性质阻止了简单地用更新或升级版本替换现有代码。当然，我们总是可以将新版本部署到区块链网络上。然而，原始的智能合约必须变得无法使用，通常是通过禁用对其的所有交易。Consensys 强调了以太坊智能合约的几个最佳实践。为了确保可以有效地对修复和改进进行升级，他们建议暂停、冻结或延迟智能合约操作的机制，以及迁移和将数据和资金转移到智能合约更新版本的动力机制。在部署后发现相关缺陷的情况下，可以应用两种软件工程技术²⁰。断路器（Circuit Breakers）在满足某些条件时暂停或停止智能合约的执行。它们在新错误在部署后被发现时可能很有用。因此，大多数合约功能可能被暂停，现在唯一活跃的操作是提现。我们可以赋予某些可信方触发断路器的能力，或者拥有在满足某些条件时自动触发某些断路器的程序化规则。速度减缓器（Speed bumps）延迟或减缓合约操作，这样如果发生恶意活动，就有时间恢复。

##### 2.4.4.2.2 模块化

在现代软件工程中，源代码通常被分成模块。这些模块比包含在单个文件中的所有代码行更容易处理和导航。模块化使软件管理更容易，包括更新和升级。代码可重用，功能分离。代码库变得越大，采用多合约架构越有意义，服务的安全性好处也越大。

然而，在智能合约开发中，模块化并不是一个常见的做法。基于大量以太坊的 DApps 的智能合约使用模式表明，约 75%基于以太坊的 DApps 采用非常简单的单合约架构，这意味着链上应用逻辑只由一个智能合约组成。其余的 DApps 是多合约的，平均包含三个智能合约。因此，有效复用非常有限，智能合约源代码在不同的实现中大多是简单地重复。单合约解决方案可能满足用户的功能需求，但在更新需求出现时，往往导致无法管理的去中心化应用程序。

钻石方法可升级模块化合同已作为以太坊改进提案（EIP）2535 提出。²¹这份草案文件提出一个支持使用多个逻辑合同的代理合同。这些委派合同被称为面（facet），每个面提供一项或多项功能。一个专用函数可以实现功能的添加、替换或移除。在钻石函数变化时发出事件，用户可以验证调用的是哪个版本的函数。采用这种设计方法，可以随着时间的推移开发并逐步改进 DApp 的智能合同逻辑。然而，智能合同的所有权、认证和授权设计并不包括在此草案中。

模块化合同可以以受控的方式进行升级。可以采取几种方法，也可以使用辅助服务来完成，例如，注册合同、委派调用或以太坊名称服务（见 2.6.3 节关于名称服务）。

##### 2.4.4.2.3 模块化智能合同架构示例

模块化智能合同架构需要一组智能合同协同工作，作为去中心化应用的链上部分。因此，合同方法的安全和访问策略必须仔细设计和规划。拥有一个专门处理去中心化应用中所有智能合同的访问控制和交互权限的智能合同是有意义的。这意味着所有的安全都是集中的，比在多合同架构中的每个智能合同中定义访问和安全策略提供更好的概览。

我们现在可以将服务特定和服务无关的功能分离成不同的模块。服务无关模块提供在多合同解决方案中必需的关键平台功能。一个目录模块可以作为单一访问点，即外部用户的唯一接口。它自动化地将其他智能合同模块的地址分散到其他模块中。如果在部署的系统中其中一个合同被升级和替换，目录反映这种变化，并透明地将剩余合同引导到更新后的地址。一个管理模块为解决方案中的所有智能合同和提供常见访问控制。

服务特定模块依赖于 DApp 目标，并为服务运营提供独特功能，例如，在分布式能源资源管理（见 4.3.3.1 节）或停车场预订（见 4.2.2 节），或者机器人之间的去中心化协作（见 3.6 节）。

辅助模块提供了与服务提供相关的额外功能。然而，它们的功能，如忠诚度代币、资产代币化、托管服务或价值收集，也是其他应用垂直领域所共通和相关的。因此，辅助模块可以系统性地提供并重复用于各种去中心化应用。

具有独立访问管理模块的模块化架构使我们能够定义各种租户。尽管它们都通过接口智能合约与多个模块互动，但只允许调用某些方法，而其他方法则受到限制。通常，去中心化应用中的租户可能是，例如，应用所有者、管理员、服务提供商和服务用户。

##### 2.4.4.2.4 安全的多合约交互

钻石标准（参见第 2.4.4.2.1 节）提出了一个可升级的多智能合约环境，但它不包括任何提供安全可靠智能合约间交互的安全机制。我们可以用安全的智能合约隧道（SCT）[42]扩展这种基本的模块化。智能合约隧道引入了两重访问控制：按模块（只有注册的模块可以互动）和按用户。管理员租户在目录和管理模块中设置隧道。使用目录模块，我们总能确保方法调用是通过一个授权模块传递的，并且它来源于一个授权的智能合约账户。我们使用 tx.origin 值来验证交易是否来自一个授权源，以及 msg.sender 值来验证交易是否来自一个授权源。

图 2.9（参见图 2.9）展示了接口合约与后续目标智能合约之间建立的隧道。只有在我们多合约解决方案中适当注册并在管理模块中授权的智能合约才能访问目标智能合约。此外，接口和目标智能合约中的交易源地址可以检查，以根据特定用户的租户角色限制对特定方法的访问。未注册的智能合约不能向目标合约发送交易。

![](img/b_9783110681130-002_fig_009.jpg)

图 2.9：智能合约隧道用于智能合约模块访问控制。

## 2.5 离链应用

在去中心化应用三明治（参见第 2.2 节）中，分布式账本网络节点确保所有区块链特定的网络操作协议与其他网络节点及链上智能合约执行的功能。Web、移动、服务器端或嵌入式离链应用需要与这些节点接口以利用分布式账本网络提供的区块链特定功能和服务。

因此，一些网络节点暴露区块链 API——通常是 JSON-RPC 或 REST 接口——供软件应用与 DL 网络交互。我们可以在公共无权限网络的节点上，将区块链服务访问 API 作为一个选项启用。或者，我们可以依赖第三方 API，为公共 DL 网络提供服务（参见第 2.7.2.2 节），以更有效地产品化去中心化应用。在受权限的网络中，添加节点可能会更加受限，仅限于授权用户。这些限制是由网络安全和账本数据隐私驱动的，一些 DL 网络甚至不允许添加任何节点。在这些情况下，API 是外部实体参与或与网络交互的唯一机制。例如，为了访问 Hedera 服务（参见第 2.7.1.3 节和第 1.4 节），使用了镜像节点。您不能在 Hedera 中运行镜像节点，但 Hedera 和社区镜像节点可以使用，并提供 Hedera 服务的 API。

公共网络中的 API 端点通常对离链应用不施加访问控制。如果没有访问控制，这可能会让人感到惊讶，但如果我们将其与许多其他基于 Web 的应用的 API 访问进行比较，就会明白，由于账本对所有参与方都是共享和可用的，因此无需保护对其的访问。区块链账户相关的操作，可能会导致严重的安全漏洞，是在离链应用部分执行的。如果我们为节点 API 建立一些访问控制，主要是为了保护节点的计算资源。

### 2.5.1 离链应用示例

离链应用利用现有的 Web、移动、服务器端或嵌入式应用技术，为 DApps 提供用户和机器接口。

除了节点 API，区块链生态系统通常还为不同的编程语言提供离链客户端库。这些便利的库抽象了与区块链节点 API 交互的大部分复杂性。

尽管传统和区块链启用的 Web 用户界面之间有惊人的相似之处，但区块链后端引入了几种可用性问题。它们大多数与 BC 交易延迟有关。因此，用户不能总是依赖传统 Web 应用程序期望的刷新率和响应时间。结果，当由于 DL 网络交互而等待比预期更长的响应时，通知用户是一个好的用户界面设计原则。例如，我们可以在期间暂时将用户重定向到链浏览器（参见第 2.6.4 节），实时跟踪他的交易。

另一种区块链后端对离链 Web、服务器或嵌入式应用程序的影响源于区块链节点 API 的查询。我们无法像在关系型数据库中那样高效地形成节点 API 请求。因此，如果客户端应用程序设计没有考虑到这种可能性，对远程 API 的请求可能会变得很大。这可能会导致节点资源消耗增加和客户端应用程序与 API 之间不必要的通信负载。在通信受限的嵌入式物联网区块链应用程序中，后者可能尤其具有挑战性。

#### 2.5.1.1 客户端 Web 应用程序

客户端 Web 应用程序在浏览器中运行。除了执行客户端应用程序逻辑外，浏览器必须包含一个密钥钱包。钱包使得管理区块链密钥和身份成为可能。它可以是浏览器的一个组成部分（例如，Brave²²）或浏览器扩展。MetaMask²³ 是以太坊网络中流行的钱包扩展。图 2.10[#b_9783110681130-002_fig_010]展示了 MetaMask 菜单，我们可以在这里切换可用的以太坊网络，包括主网和各种公共测试网络。使用 MetaMask，我们还可以将浏览器连接到本地计算机上运行的以太坊节点，或者指定一个 URL 到任意的 JSON-RPC 节点 API。这样，我们可以访问，例如，具有以太坊分布式账本技术的私人或联盟网络。

![](img/b_9783110681130-002_fig_010.jpg)

Fig. 2.10: 在 Web 浏览器中的 MetaMask 钱包扩展。

以太坊 Web 应用程序生态系统中的一个常见约定是，密钥管理软件通过在 Web 页面中的 JavaScript 对象暴露其 API。EIP 1193²⁴ 正式化了一个以太坊提供者 API，以促进钱包互操作性。该 API 被设计为最小化、事件驱动且与连接性和 RPC 协议无关。其功能可以通过定义新的 RPC 方法和消息事件类型来扩展。

在客户端应用程序中，开发者会应用客户端库来处理 BC 节点 API 交互，例如，对于以太坊 Web 应用程序使用 Web3.js²⁵，并创建他们特定的应用程序编程逻辑。Web3.js 是一组库，允许我们使用 HTTP、IPC 或 WebSocket 与本地或远程以太坊节点进行交互。

这样，我们可以利用所有的 Web 界面技术（HTML5、CSS 和 JavaScript）或前端框架来创建丰富、互动且现代化的 Web 用户界面，并利用区块链特性。这些用户界面与实时的区块链网络进行交互。

#### 2.5.1.2 Web 服务器或嵌入式应用程序部分

如果运行在服务器或 IoT 设备上的软件需要与区块链节点 API 交互，我们必须为区块链密钥管理安排不同的方式。没有人会在不同的区块链网络之间切换，或者提供钱包访问授权凭据。尽管如此，在这样一个应用程序中我们可能仍需要一个密钥库。尽管如此，我们通常只在服务器端应用程序的初始配置中设置 DL 网络和账户信息。

另一方面，与 BC 节点 API 的交互与客户端 Web 应用程序中的交互非常相似。例如，如果我们开发一个 Node.js 后端应用程序或 IoT 设备软件，我们包含相同的 Web3.js 库（参见第 2.5.1.1 节）用于以太坊 Web 应用程序。以太坊的离线应用程序开发不仅限于 JavaScript。Web3.py²⁶ 是一个用于与以太坊交互的 Python 库。最初，它是从 Web3.js 派生出来的，但此后已经演变为满足 Python 开发者的需求。

#### 2.5.1.3 移动应用程序

在移动平台上也采取了非常相似的方法。也有移动 Web 浏览器和移动浏览器钱包插件可用。例如，MetaMask 也运行在 Android 和 iOS 上。这使得可以访问基于 Web 的区块链应用程序，就像桌面浏览器一样。

如果我们开发不依赖于浏览器功能的移动应用程序，Web3j.io²⁷ 是一个轻量级、反应式、类型安全的库，适用于 Java、Android、Kotlin 和 Scala。

### 2.5.2 分布式账本节点 API

区块链节点 API 从纯粹的 REST API（例如，Hyperledger Fabric）到 JSON-RPC（例如，Ethereum），常见的连接方法包括 HTTP、WebSocket 和 IPC。并非所有它们都必然存在于所有 DLT 中，甚至存在于同一 DL 网络的不同节点实现中。提供通过 API 的功能集也各不相同。但它们通常提供有关节点客户端、区块链网络、区块和交易的信息，提供账户管理，并允许创建和提交新交易。

#### 2.5.2.1 以太坊 JSON-RPC API

以太坊 JSON-RPC API²⁸ 是用于以太坊节点实现的 API。并非所有实现都保证具有相同的功能集。在表 2.4 中，我们提供了一些主导节点连接方法的基本比较。它们的组合 JSON-RPC 和 HTTP 是共同的。IPC 和 WebSockets 仅在某些情况下得到支持。假设我们设计一个去中心化应用程序，该程序特别依赖于例如 WebSocket 连接，我们必须考虑到不是所有的网络节点都将配置为 DL 网络访问的可能性，或者需要进行适配以从一条区块链网络迁移到另一条。

表 2.4：各种以太坊节点实现中的 JSON-RPC 支持。

|  | Cpp-ETH | Go-ETH | Py-ETH | Parity | HL Besu |
| --- | --- | --- | --- | --- | --- |
| **JSON-RPC 1.0** | + |  |  |  |  |
| **JSON-RPC 2.0** | + | + | + | + | + |
| **HTTP** | + | + | + | + | + |
| **IPC** | + | + |  | + |  |
| **WebSocket** |  | + |  | + | + |

Ethereum JSON-RPC API 具有单个端点，例如，[`localhost:8545`](http://localhost:8545)。API 方法以及相应的参数嵌入到提交到这个端点的 JSON 结构中。Ethereum JSON-RPC API 允许选择特性并详细提供网络状态信息，包括连接对等点的数量和详细信息。账户管理返回客户端拥有的地址列表。这些账户在启动节点时必须启用。API 提供了关于账本同步的详细信息，包括区块和交易详情。我们可以创建、签名并发送新交易到网络。如果我们启用了节点，可以通过 API 设置和管理事件过滤器，跟踪网络中与智能合约的交互，或者管理挖矿。

#### 2.5.2.2 Hyperledger Fabric REST API

Hyperledger Fabric 节点提供 RESTful API 服务。CoreAPI²⁹由几个端点组成，反映了 API 的功能。我们选择适当的 HTTP 方法来选择创建、读取和删除选定资源。

根端点包括/block、/chain、/chaincode、/network、/registrar 和/transactions。我们使用/block API 从区块链获取各种块的内容，使用/chain API 获取网络的当前状态。/chaincode 端点用于部署、调用和查询目标链码，即 Hyperledger Fabric 智能合约。它实现了 JSON RPC 2.0 规范，必须在有效负载中提供所需字段。/network 提供了构成区块链网络的对等节点网络信息。由于 HLF 网络是受权限控制的，/registrar 管理终端用户注册。我们可以使用/transactions/{UUID}端点从区块链检索与 UUID 匹配的单个交易。

#### 2.5.2.3 Hyperledger Sawtooth REST API

Hyperledger Sawtooth API³⁰也依赖于经过验证的 RESTful 服务方法。它系统地使用 HTTP 状态码提供关于特定 API 调用执行的详细反馈。

## 2.6 分布式和支持服务

一些服务扩展了核心分布式账本技术（DLT）及其智能合约中的链上逻辑功能。这些服务对于分布式网络和 DApp 运行不是强制性的，但使操作变得更容易，提供更多控制，并促进架构优化，受到用户的欢迎。

去中心化的区块链存储可以处理大量数据，这些数据不适合或不适合常规区块链的存储限制。名称服务在分布式账本技术（DLT）中增加了额外的寻址或命名层。它们抽象了不可变的 DL 网络地址，并使地址对用户友好。如果智能合约地址发生变化，这些名称可以重新映射到新的 DL 网络地址。为了让智能合约与链下外部数据源互动，需要特殊的可信网关，称为预言机。此外，链浏览器帮助我们检查和分析在活区块链网络中的分布式账本内容。它们以人类可读和用户友好的方式聚合并显示来自网络节点的数据。

### 2.6.1 基于 DL 的存储

区块链技术的核心应用之一，分布式账本，仅仅是分布式、安全、可信赖的数据存储。正如我们讨论的，这在各种应用中有许多不同的用途。然而，许多其他应用需要大量数据存储或文件存储。这些数据不能直接写入区块链，因为这将大大增加账本本身的体积，长期来看会伤害链的性能。

目前有几种基于分布式区块链的存储解决方案可供选择，每个都有其特点[43]。它们之间有一些核心概念是共享的。这些概念包括存储方法、复制和对主机的激励。数据的存储方式非常相似。每个文件都被分割成小的片段，称为碎片。在存储在存储网络（不是实际区块链网络）的一台机器上之前，每个碎片都进行加密。然后，只将这些碎片的存储位置和散列值存储在区块链网络上。数据相对较小且均匀，也有助于提高存储和传输效率。最终，存储这些碎片的机器上有许多大小相同的碎片数据。

另一个共有的概念是数据复制。在网络故障的情况下，需要保护数据。这意味着所有碎片需要在多台机器之间进行复制。复制的确切数量因技术而异，但通常 3 是使用的最小值。由于碎片之间没有容易识别的联系，必须有一种机制确保数据在网络上得到充分复制。

在传统的云存储基础设施中，文件是存储在可以提供服务收费的公司那里。公共分布式系统由许多不同的小型主机组成，没有单一实体来执行发行发票等行动。因此，每个分布式数据存储系统都需要有一种奖励文件主的方法。这因技术而异，但一些示例通过代币或具有价值的加密货币奖励主人，或者给他们更多在系统上投票的权力。

Swarm³¹ 是以太坊对基于区块链的存储的回应，并旨在与 Web3 生态系统一起工作。文件的分片（在 Swarm 中称为块）存储在多个 Swarm 节点上，而清单存储在以太坊主网络区块链上。Swarm 节点只是启用了额外操作模式的以太坊节点。它们保留文件的片段并确保片段安全地存储和可访问。

系统中的文件实际上永远无法被用户更改或删除。相反，用户上传新文件并更改 ENS 引用以指向新文件。Swarm 使用以太坊的加密货币向用户收费并奖励主机。

IPFS³² 或星际文件系统是一个更通用的分布式文件系统。它可以与各种区块链网络一起使用，甚至可以独立使用。要访问 IPFS，用户必须安装一个 IPFS 客户端。安装后，用户和应用程序可以通过发送 HTTP 请求与 IPFS 进行交互。IPFS 背后的组织协议实验室还在开发 Filecoin，旨在成为激励层，为可靠地托管数据提供经济激励。

Storj³³ 设计得看起来和表现起来像传统云提供商的对象存储，但拥有去中心化的后端。应用程序通常通过其与 S3 兼容的 API 进行交互。它使用基于区块链的系统，以 STORJ 代币作为激励方法。

### 2.6.2 预言机

确定性的智能合约代码在区块链虚拟机中执行。执行与外部、现实世界环境隔离，合约状态由区块链系统内部的行为者维护和确定[44]。

尽管区块链系统的去中心化和无需信任的架构，智能合约本身无法访问来自外部世界的数据。如果非确定性的智能合约代码需要外部信息来做出决策，那么就需要预言机将智能合约与现实世界相结合。在这里，现实世界指的是外部软件、硬件或人类行为者及其为链上应用部分提供的输入。软件资源可以是例如天气数据提供商的 Web API 或金融应用的实时或历史价格对。硬件资源可能是一个 IoT 传感器设备，提供感知输入，或者是物理设备标识符，例如，供应链或制造管理 DApp 的 RFID 标签值。人类行为者可以通过回答问题、他们的投票决策等方式提供输入。

预言机收集并给智能合约提供数据馈送和输入。在区块链上，预言机由服务其他智能合约数据请求的智能合约表示。预言机为这些多样的链下来源保证数据证实，并以可信、可验证的方式将外部数据带入区块链系统。

图 2.11 展示了高级预言机架构。去中心化应用程序（参见第 2.2 节）包括一个具有智能合约执行环境的区块链网络、区块链感知用户界面以及 DApp 智能合约。预言机是智能合约环境与外部资源之间的中介。它可以从外部来源请求数据，接收外部数据馈送，或保持历史记录数据值。它保证这些数据的有效性，并在需要时将其提供给 DApp 智能合约。

![](img/b_9783110681130-002_fig_011.jpg)

图 2.11：高级预言机架构。

存在两种关键的信任模型可用于验证和确认外部数据。在集中式预言机信任模型中，预言机解决方案仅通过一个节点将数据输入智能合约。因此，这个节点需要被信任。这种模型适用于外部世界中的数据，这些数据不能被多个分布式方独立验证，例如，数据访问受限或为短暂传感器数据的情况。集中式验证的例子有，软件预言机的真实性证明（TLSNotary）和硬件预言机的可信执行环境（TEE）。另一种是去中心化预言机信任模型。在这里，去中心化声誉、投票或基于共识的决策确保了对外部数据源的共同协议。这两种模型都用于实际预言机实现，以满足各种外部来源的区别特征。

在任何情况下，预言机都是基于区块链系统的链下架构组件，可能是整个系统中的故障点。即使分布式账本网络和链上智能合约应用非常可靠和值得信赖，预言机提供不正确、恶意或腐败数据的风险总是存在。因此，预言机安全是一个新兴的研究领域。已经提出了许多预言机解决方案并得到实施。

Provable³⁴是一个适用于智能合约和区块链应用的区块链中立预言服务。它已经与以太坊、Rootstock、R3 Corda、Hyperledger Fabric 和 EOS 等平台集成。它从包括任意 URL（任何网页或 HTTP API 端点）、来自外部 TEE 兼容硬件的随机结果、Wolfram Alpha 计算引擎的计算结果，或 IPFS 网络上的文件内容等来源为智能合约提供数据。外部数据通过一个经过认证的过程进行交付，其中真实性证明提供了执行的透明度，外部审计验证 Provable 代码是否按预期执行。

要实现 Provable 服务，DApp 开发者和此类应用的用户不必信任 Provable。它作为一个不可信的第三方中介。可选地，向 Provable 发起的请求可以指定真实性证明。数据提供商不必修改其服务以与区块链协议兼容。通过 Provable，智能合约可以访问来自现有网站或 API 的数据。

Town Crier³⁵系统利用可信硬件（Intel SGX）来提供数据来自一个现有、值得信赖来源的强有力保证。Town Crier（TC）从应用合约中指定的目标网站上获取数据，并使用 SGX 来实现其真实性。如果我们信任 SGX，那么从 TC 从一个网站到应用合约传递的数据保证没有遭到篡改。如果我们能信任执行环境，我们就可以信任 TC 从一个网站到应用智能合约传递的数据没有遭到篡改。

Augur³⁶是一个基于区块链的预测市场的 P2P 协议，用户在预测正确结果时会收到支付。这项技术主要应用于赌博应用。然而，Augur 也充当去中心化的预言者³⁷。在赌博事件发生后，事件的结果由 Augur 的预言者确定。结果由 Augur 的预言者确定，该预言者由追求利润的记者组成，他们报告事件的实际、现实世界结果。记者使用一个质押代币（REP 或声誉）来澄清关于预测结果的争议。任何拥有 REP 的人都可以参与对特定创建市场的结果进行报告和争议。用户将 REP 代币锁定在托管中，从而质押它们以断言特定创建市场的结果。Augur 平台内嵌有一个特定的激励结构，奖励正确结果的报告，并对错误结果的报告进行惩罚。这建立了对预言者数据的信任。

Chainlink³⁸ 使任何区块链上的智能合约能够利用广泛的链下资源，例如防篡改的价格数据、可验证的随机性、外部 API 等等。各种去中心化的 Chainlink 预言机网络保证了外部输入数据及其产生的输出事件的真实性。例如，Chainlink 网络提供防篡改且高质量的价格 Feed，进一步促进了 DeFi 的发展。

### 2.6.3 名称服务

鉴于区块链技术的不可变性质，账户、数据和代码无法更改或删除。这意味着每当开发者想要在区块链上更新智能合约或托管在以太坊 Swarm 上的网站时，他们都必须创建一个新的合约，当然，这个合约有一个新的唯一标识符，即以太坊地址。从用户的角度来看，网站或智能合约的最新版本需要始终以相同的名称可用，而且最好是可读的。传统系统使用 DNS 来解决这个问题，将人类可读的名称绑定到 IP 地址上，简化后端迁移、负载均衡和地理优化。

Ethereum Name Service (ENS) 满足了以太坊生态系统中许多等效的需求。它将人类可读的名称绑定到像以太坊地址和 Swarm 文件标识符这样的散列值上。这是使 DApps 对普通用户更加易于访问的关键部分。ENS 是一个智能合约系统，每个合约都负责自己的子域。系统中的几个顶级智能合约（如 .eth 和 .test）进一步作为解析器注册。一个解析器可以用名为 ethereum.eth 的顶级智能合约注册，所以任何对其的查询都会首先发送到 .eth 智能合约，然后被引导到 ethereum.eth 智能合约。这可以任意地链用于像 wallet.ethereum.eth 这样的 ENS 名称。ENS 中所有与顶级域的交互都是严格通过智能合约及其提供的方法完成的。这提供了高度的透明度和信任度。2021 年 .eth 域名的成本为每年 5 美元的 ETH 对于 5 个或更多字符的长域名，4 个字符的域名 160 美元，3 个字符的域名 640 美元。

在 ENS 上注册名称的过程需要五天，并需要多次时间敏感的交易。当我们想要注册一个名称时，并不是简单地购买该名称，而是开启一个公开拍卖。名称本身被散列，所以只有知道名称的人才能参与拍卖。拍卖会持续 72 小时，之后是揭示阶段，竞拍者必须揭示他们的出价。如果他们不这么做，他们的资金就会丢失。获胜者必须支付相当于第二高出价的金额以及自己的出价才能获得该名称。输家可以拿回他们的出价。

注册表和解析器之间的关系如图 2.12 所示。可以通过 Etherscan 链式浏览器查询 ENS³⁹。

![](img/b_9783110681130-002_fig_012.jpg)

图 2.12：以太坊名称系统注册表和解析器。

除了命名智能合约的 ENS，还有几个类似 DNS 的注册商基于去中心化应用程序。这些系统完全独立于传统的 DNS 和 ICANN。注册是由用户直接管理，名称解析通常是通过浏览器扩展完成的。Unstoppable Domains⁴⁰ 管理.crypto 和.zil 域名，基于 Ethereum 技术。Namecoin⁴¹ 是一个专注于安全存储和管理分布式键值对的 BTC 分叉币。键是一个人类可读的名称和一个地址值。它为.bit 域名提供了一种类似 DNS 的服务。

### 2.6.4 链式浏览器

区块链网络中的链式浏览器是用来检查和分析分布式账本的工具。它们从网络节点聚合并展示数据，以一种人类可读和用户友好的方式呈现。

考虑到链式浏览器应用程序的架构，这些通常是具有单独页面来查看账户、交易和智能合约等资产的网页应用程序。它们还显示重要的网络统计信息，以及最新的区块和交易信息。

对于同一网络，通常会有多个类似的工具可供选择，主要是由值得信赖的第一方提供，比如网络运营商，或者不相关的第三方，比如一个开源项目组。这是公共基于区块链的分布式账本网络开放性的一个很好的例子。

不管怎样，它们都是了解链状态的第二意见。DApp 通常会提供这些工具的链接，使用户能够独立验证交易是否如应用程序显示的那样发生，提供了一层额外的信任。由于这些 DApp 使用基于区块链的后端，链式浏览器在识别和修复问题上是关键的。

Etherscan⁴² 是 Ethereum 最受欢迎的链式浏览器。用户界面的快照在图 2.13 中给出。一个名为 Hyperledger Explorer⁴³的类似工具也适用于 Hyperledger Fabric。

![](img/b_9783110681130-002_fig_013.jpg)

图 2.13：Etherscan – Ethereum 的链式浏览器。

## 2.7 DApps 的产品化

当一个企业考虑在数字化中采用去中心化技术，或者旨在向市场提供新的 DLT 产品或服务时，选择底层 DLT 平台是一个战略决策。在采用过程中，可能会发生对信息通信技术（ICT）基础设施和服务的需求投资；需要招聘和培训熟练人员，还需要对去中心化应用（DApp）开发进行大量投资。因此，企业寻求长期和可持续的解决方案和合作伙伴。为了做出适当的战略决策，需要评估和比较特定的 DLT 产品或技术平台以及整个生态系统。恰当的选择可以加快技术解决方案的采用，降低初始开发和长期进步支出，以及减少支持成本。这会导致技术和商业优势以及新收入来源的产生。

当然，技术平台特征至关重要。例如，分布式账本网络（DL 网络）的特征，如性能、治理和可扩展性，取决于 DL 的技术差异和网络实施的细节（参见第 2.3 节）。智能合约环境（参见第 2.4 节）决定 DApp 设计和功能。然而，除了平台之外，许多其他方面也代表了一个 DLT 生态系统。

一套库和工具是期望在开发中使用的，以促进开发和测试、监控网络，并验证解决方案。开发者需要文档和有效的支持，无论是正式的还是非正式的。一些分布式账本技术（DLT）生态系统提供了系统的培训计划和认证。

具备清晰路线图并跟进的能力是确保 DApp 和所选的底层 DLT 平台、工具和库将来会改进、演变并得到支持的一个良好保证。如果一个 DLT 生态系统明确预见了使其运营绿色和节能的步骤，这也可能是有关系的。

一个关键的决策因素应该是生态系统中聚集的社区。一个成功的生态系统吸引并积极支持用户和开发者。一个庞大而活跃的社区表明该生态系统鼓励开放、协作的文化。拥有广泛全球足迹的社区也表明了用户和开发者对平台的接受程度。社区不应仅被视为生态系统的用户或客户，而应被视为外部的创新者。这种态度在许多开源项目中已被证明是成功的。因此，一些 DLT 生态系统有明确定义的与学术界和企业合作的机制。

最后，突出用例的数量和范围也是我们可以期待一个 DLT 生态系统的另一个好指标。

### 2.7.1 分布式账本技术（DLT）与 DApp 生态系统

这里，我们简要概述了某些可用的分布式账本技术生态系统。这绝不是一项全面的研究。还有许多其他生态系统。此外，许多分布式账本平台的分叉并不完全带来新的、独立的技术方法，而是修改现有协议以实现一些改进。其他人可能会在未来带来有趣的平台解决方案，但目前更多地处于概念验证阶段，而不是商业级的分布式账本平台。我们认为所选的是相关的分布式账本技术生态系统，应该始终作为选择分布式账本的相关替代方案。比特币未包含在这些比较中。尽管作为分布式账本技术的先驱和市值最大的公共分布式账本网络的基础，但它不适用于 DApps。

表 2.5 总结了所选分布式账本技术生态系统的一些关键特性。这可以为读者作为匹配预期 DApp 需求与相应 DLT 的起点。

Tab. 2.5:精选的分布式账本技术生态系统比较。

|  | 以太坊 | 超账本 | Hashgraph |  Corda | IOTA |
| --- | --- | --- | --- | --- | --- |
| **管理** | 以太坊基金会 |  Linux 基金会 | Hedera 治理委员会 | R3 | IOTA 基金会 |
| **类型** | 开放社区 | 精选开放社区 | 有限公众参与 | 有限公众参与 | 有限公众参与 |
| **公共网络** |
| **加密货币** | ETH | / | HBAE | / | MIOTA |
| **治理** | 公共 | / | 集中式 | 联盟 | 集中式 |
| **分布** | 非常高 | / | 低 | （不明确） | 未知 |
| **私有网络** |
| **可行** | 是 | 是 | 是 | 是 | 是 |
| **DApp 开发** |
| **DApp 开发** | 非常好 | 非常好 | 良好 | 良好 | v1.0 不适用 |
| **用户和开发者社区** |
| **社区** | 非常大 | 大 | 相对较小 | 金融机构 | 相对较小 |

#### 2.7.1.1 以太坊生态系统

以太坊是一个由以太坊基金会维护的开源链式分布式账本生态系统。2021 年，它继续实施经过深思熟虑的路线图，向以太坊 2.0 迈进。这包括在分布式账本协议中的重要变化，如从 PoW 转移到节能的 PoS 共识，并解决以太坊公共网络的可扩展性问题。

以太坊区块链技术部署在大型、高度去中心化的公共网络上，称为主网。任何人都可以向这个网络添加节点，包括挖矿节点。2021 年，主网约有 7,000-8,000 个节点。以太坊公共网络中有一种主要加密货币，使其适用于 DeFi 和 IoT 或其他 DApps。使用以太坊技术可以实现私有和联盟网络。它们通常用于与公共网络相比提高性能和隐私。

Ethereum 智能合约通常用 Solidity 编写，但 Vyper 和 Flint 也得到支持。对于以太坊去中心化应用开发，存在一套丰富的库、工具、开发 IDE 和安全验证工具。它拥有最大的开发者社区。Ethereum 是 DApps 最受欢迎的平台，包括 IoT DL 应用，有众多令人信服的用例。

#### 2.7.1.2 Hyperledger 生态系统

Hyperledger 生态系统代表了一组稳定、开源的企业级区块链部署框架、工具和库。它涉及 250 多个团队和公司，并由 Linux Foundation 托管。工作组织成项目，这些项目开发不同的账本技术、全面的工具和支持库。项目的成熟度清晰地表示出来，以及它们之间的相互依赖关系。

Hyperledger 的分布式账本（Burrow、Fabric、Indy、Iroha、Sawtooth）主要面向私有和联盟网络。因此，并不存在公共的 Hyperledger 网络，进而也没有公共的加密货币。只有 Hyperledger Besu，一个基于 Java 的以太坊客户端实现，能够连接到以太坊网络。由于 Hyperledger 网络旨在支持各种组织的运作，所以它们是基于私有或联盟的。尽管多个组织可能访问同一个账本，甚至多个账本中的一部分数据对公众开放，但这些网络仍被视为私有的。在 HL 中，根据选定的账本技术，采取了不同的智能合约开发方法。Hyperledger 支持各种智能合约编程语言和引擎。最突出且广泛使用的编程语言是 Solidity 和 Go。所有项目都有广泛的开放源代码文档可供使用。

每个项目都有其合作组织的团队，这些组织从世界知名的 ICT 公司到致力于 Hyperledger 项目开发的小团队不等。Hyperledger 突出的用例包括物流项目、金融项目、人道主义和慈善项目。

#### 2.7.1.3 Hedera Hashgraph 生态系统

Hashgraph 是一种由 Hedera Governing Council 维护的专利 DLT。Hedera Governing Council 由最多 39 个任期有限且高度多样化的组织和企业组成。他们代表全球多达 11 个独特的行业、学术界和非营利组织。理事会成员致力于管理软件变更，同时为公共网络带来稳定和持续的去中心化。

Hedera 公共网络基于 Hashgraph 分布式共识算法构建。它允许创建或交换价值、证明身份或验证和认证重要数据。公共加密货币 HBAE 可用。加密货币交易的费用可以保持稳定和低廉，使微交易在 Hedera 上从经济和技术上变得可行。有十个主网网络节点。镜像节点用于访问 Hedera 服务。一个人不能在 Hedera 上运行镜像节点，但可以使用 Hedera 和社区镜像节点，并具有 Hedera 服务的 API。Hedera 网络由 Hedera 理事会管理，因此并不是真正去中心化的。Hedera 智能合约与例如以太坊中的智能合约不同，不是不可变的。如果智能合约开发者设计的几方同意，它们可以被更改。

从应用程序开发者的角度来看，Hedera 可以被视为一个基于财团的服务的集合，通过 API 暴露去中心化交易能力，而不是一个真正去中心化的生态系统。

Hedera 的显著用例包括支付、代币化资产和管理凭证。

#### 2.7.1.4 Corba 生态系统

Corda 是由在 2015 年一个银行财团加入该计划时崭露头角的技术公司 R3 开发和维护的开源 DLT。一个名为 Corda Network Foundation 的独立实体被设立，使用在治理活动和商业行为中适用的非营利法律实体类型 Stichting 来管理发展和网络。这种类型适合于治理活动，能够在有限的责任但没有股东、资本或股息的情况下进行商业行为。

Corba 网络是私有的或基于财团模式的。因此，去中心化取决于特定案例。Corba 网络是一个受许可的、公开的 P2P 节点网络。每个节点代表一个法律实体并在运行 Corba 软件。每个节点必须从网络运营商那里获得证书才能加入网络。该证书将众所周知的节点身份映射到现实世界的法律身份及其相应的公钥。在（公开的）Corba 网络中没有公共加密货币。

在 Corda 中，智能合约是可以通过计算机代码与人类输入和控制相结合来执行的协议，其权利和义务，如用法律散文表达，是可以通过法律强制执行的。Corda 中的智能合约代码使用 Kotlin 编写，合约执行和验证的虚拟机是 JVM 的增强和更为严格的版本。为开发者提供了丰富、更新及时、结构良好的文档，包括代码示例。还提供了一组丰富的开发和监控工具。

Corda Enterprise 被证明能满足复杂组织的网络安全、可扩展性和支持要求，并已成为金融服务中的事实标准。

#### 2.7.1.5 IOTA 生态系统

IOTA 是由 IOTA 基金会开发的开源分布式账本技术。基金会宣布了通往 IOTA 2.0 的雄心勃勃的路线路线图。跟上它将是一个挑战。路线图设想了一套新的分布式账本网络协议、新的钱包和新的库套装，与版本 1.0 相比是一个重大转变。版本 2.0 应该消除了对（中心化的）协调员节点的需要，增加了智能合约协议，以及安全的消息传递和一次性自身份识别。IOTA 计划标准化关键的分布式账本协议，并宣布与 IEEE 和 OMG 合作。

在 IOTA 网络的当前版本 1.0 中，当其他交易引用它们时，交易会得到加强。然而，它们只有在网络协调员（由 IOTA 基金会运营的特殊节点）确认后，才真正有效。由于 IOTA 独特的账本风格，它有一些独特的属性。理论上，随着节点和用户数量的增加，交易吞吐量会增加，延迟会降低。IOTA 账本是分布式的，但由于共识机制，网络并不是去中心化的，需要协调员节点。

有一个公共主网络和一个公共测试网络。IOTA 网络使用一种公共加密货币 MIOTA。交易基本上是免费的，但交易发送者必须提交工作量证明。

对智能合约的支持在 v2.0 版本中处于 alpha 阶段，但在当前的 v1.0 版本中不可用，这意味着 IOTA 只能存储和传输数据，但不能处理它。这使得它目前无法用于构建 DApps。因此，IOTA 没有吸引大量的开发者社区。开发者们会欣赏系统化的文档和关于如何参与 IOTA 网络的明确指导。版本 2.0 承诺会有相关的改进，但要最终确定并达到生产级别需要巨大的努力。

### 2.7.2 部署和访问区块链网络

DApps 需要一个底层分布式账本网络（参见 2.2 节和 2.3 节）。这可以是一个新的、专用的私有或联盟网络，我们根据需要进行定制并从头开始构建。然而，它也可以是一个现有的著名公共网络，我们只是想附加几个额外的节点来参与区块链网络操作。

一个可扩展的自行配置的区块链网络搭建起来复杂，管理起来困难。每个节点运营商都需要手动配置硬件、安装软件、创建和管理访问控制的证书以及配置网络组件。这可以通过对节点配置文件的基本编辑完成，例如创世文件。一些手动任务可以通过命令行界面（CLI）向导完成，例如 Puppeth，它有助于创建一个新的以太坊网络。最近，像 Hyperledger Cello⁴⁴ – 一个区块链配置和操作系统 – 帮助更高效地使用和管理区块链。它支持各种基础设施，如裸机、虚拟机平台和容器云（例如 Swarm、Kubernetes）。

一旦区块链网络运行起来，就需要不断监控基础设施并适应变化。除了自托管节点，各种区块链即服务（BaaS）提供商促进了区块链网络节点的高效部署和管理。大多数云服务提供商的关键参与者，例如 Amazon、Microsoft、Alibaba 和 IBM，都提供某种形式的 BaaS。

离链 DApp 部分需要访问 DL 网络节点的 API（2.2 节和 2.4.2）。这些 API 可以在我们监督下的节点暴露或从专用服务提供商那里获得，例如 Infura。后者确保了一个可靠的基础设施，将用户连接到以太坊公共网络。这对于 DApp 中的机器和用户界面的即时运行至关重要。依赖托管 API 使应用程序开发人员完全脱离了 DL 网络配置。

公共账本的内容总是可以通过网络节点获得。然而，对于先进 DL 数据分析所需的查询来说，这可能不是最高效的结构。因此，将各种 DL 网络的历史数据放置在大数据平台上的公共数据集使分析更加高效。

#### 2.7.2.1 区块链即服务（BaaS）

区块链即服务（BaaS）在云或边缘计算环境中提供区块链服务，例如节点和网络部署、系统监控以及智能合约分析和测试。BaaS 实施将部署和访问 BC 网络的技术和运营负担主要外包给云服务提供商。BaaS 提供商提供调整后的定价和优化以适应不同区块链用例的实例类型。⁴⁵基于这些服务，开发者可以专注于业务代码，探索如何更恰当地将区块链技术应用于他们的业务场景，而无需担心维护和监控区块链平台[45]。BaaS 正在提高 DApp 开发的生产力，并促进了区块链技术的广泛采用。⁴⁶

表 2.6 总结了一些主要 BaaS 提供商支持的分布式账本技术。主导的技术有两种——超级账本（Fabric）和 Quorum。这并不令人惊讶，因为两者都是为了私有或基于联盟的区块链网络而设计的。与公共网络不同，这些网络是新建的，因此我们必须建立和管理所有网络节点。超级账本生态系统在第 2.7.1.2 节中有描述。

表 2.6：一些 BaaS 提供商支持的分布式账本技术。

| BaaS 提供者 | 支持的分布式账本技术 |
| --- | --- |
| **亚马逊托管区块链** | 以太坊，超级账本 Fabric |
| **IBM 区块链平台** | 超级账本 Fabric |
| **微软 Azure BaaS** | Quorum⁴⁷ |
| **阿里云 BaaS** | 安特，超级账本 Fabric，Quorum |
| **Oracle 区块链平台** | 超级账本 Fabric |

Quorum 是一个针对受许可的企业区块链网络的以太坊实现。因此，它使用熟悉的以太坊工具来简化 DApp 开发，并从以太坊生态系统中受益（见第 2.7.1.1 节）。Quorum 节点源自公共以太坊客户端（Hyperledger Besu —— 一个与以太坊兼容的客户端，见第 2.7.1.2 节）。它支持一组为网络性能（交易延迟和 TPS）设计的额外共识机制，并增加了企业特性以保障隐私。

##### 2.7.2.1.1 亚马逊托管区块链

亚马逊托管区块链⁴⁷ 是一个完全托管的服务，使用流行的开源框架超级账本 Fabric 和以太坊，让加入公共网络或创建和管理可扩展的私有网络变得容易。

亚马逊托管区块链允许我们加入公共网络（例如，公共以太坊主网）或创建和管理可扩展的、受许可的私有或联盟网络。该服务消除了创建网络或加入公共网络所需的复杂性，并自动扩展以满足运行数百万交易的数千个应用程序的需求。一旦我们的网络运行起来，托管区块链使管理和维护变得容易。它管理授权证书，并让我们能轻松邀请新的授权成员加入网络。这有效地将私有区块链网络转变为基于联盟的网络。托管区块链还监控网络，并自动替换表现不佳的节点。还有预建的模板和 BaaS API 可用于快速创建节点。

##### 2.7.2.1.2 IBM 区块链平台

IBM 是 Linux 基金会 Hyperledger 项目的创始成员，合作开发 Hyperledger Fabric，因此 IBM 区块链平台对 Hyperledger 的关注⁴⁸并不令人意外。IBM 区块链平台是 Hyperledger Fabric 的商业发行版，并带有服务级别协议和全天候支持。

企业可以连接到在任何环境（本地、公共或混合云）中运行的节点，并轻松地将单个对等体连接到多个行业网络。它们可以部署仅需要的区块链组件（Peer、Ordering Service、Certificate Authority），并通过单一控制台管理所有网络组件，无论它们部署在何处。没有供应商锁定，因此公司对我们身份、账本和智能合约保持完全控制。

IBM 区块链平台与 Hedera 共识服务合作，以提高互操作性，后者提供公共共识，而私有区块链网络基于 Hyperledger Fabric。基于 IBM 区块链平台的领先用例包括银行和金融市场、供应链、医疗保健、保险、媒体、广告和政府。

##### 2.7.2.1.3 微软 Azure BaaS

微软 Azure BaaS⁴⁹让我们能够创建和配置联盟区块链基础设施，并快速部署完全托管的区块链网络。它使用伊斯坦布尔拜占庭容错（IBFT）共识机制来简化 Quorum 账本，并最终支持多个区块链平台，如以太坊、Hyperledger Fabric、Corda 和 Chaincode。

该服务由三套产品组成。Azure 区块链工作台是构建、管理和部署大规模完全托管区块链网络和应用程序的基础。Azure 区块链服务是简化开发和原型设计的起点，具有预建网络和基础设施。Azure 区块链开发工具是一个全面的 GitHub 存储库，包含开发者区块链内容，包括代码示例和加速器。模块化控制提供内置治理，方便成员加入、联盟管理和无代码权限设置，简化策略执行。区块链数据管理器可实现灵活、可靠和可扩展的数据流和应用集成。这样，用户可以监控他们的智能合约，对交易和事件做出反应，并将链上数据流式传输到链下数据存储，以构建所需的端到端解决方案。

##### 2.7.2.1.4 阿里云 BaaS

阿里云 BaaS⁵⁰支持 Hyperledger Fabric、蚂蚁区块链技术和 Quorum。它提供开箱即用的服务，包括增强的管理功能，以帮助轻松构建企业级的区块链网络环境，而无需担心复杂的配置问题。它包括管理组织内外的智能合约（链码）和企业业务，包括覆盖安装期、创建实例和更新。该平台允许我们创建联盟，邀请并批准参与业务的参与者加入联盟，并管理业务。

阿里云 BaaS 集成了阿里云物联网（IoT）和防伪技术，为产品追溯提供区块链解决方案。其他显著的用例源于供应链金融、数据资产共享和数字内容所有权。

##### 2.7.2.1.5 Oracle 区块链平台

Oracle 区块链平台⁵¹是一个预集成的 PaaS，包括支持区块链网络所需的所有依赖项：计算、存储、容器、身份服务、事件服务和管理服务。区块链网络控制台支持集成操作。

它基于 Linux 基金会项目的 Hyperledger Fabric，但它以多种方式扩展了开源版本，以满足企业环境的需求。这些包括，例如，预集成的基于模板的配置、操作监控和零停机管理补丁和更新、增强的安全和身份管理功能，以及通过 REST 调用的一套 HL Fabric API，以简化事务集成。⁵²

它们的用例包括大型供应链和贸易网络、食品安全、零售忠诚度奖励以及身份和投票应用程序。

#### 2.7.2.2 API 接口公共分布式账本网络

BaaS (第 2.7.2.1 节)允许节点部署并展示 API，使离线应用程序能够利用区块链服务。然而，BaaS 主要适用于私有区块链网络。另一方面，许多应用完全依赖于公共区块链，那里网络基础架构已经可用。在这种情况下，可靠的远程节点服务对于任何区块链增强的移动应用程序、区块链兼容的浏览器以及 Web 应用程序或区块链开发工具的插件的用户体验至关重要。这些产品的开发者可以完全消除用户访问公共网络时安装、运行和管理他们网络节点的需要。

Infura⁵³专注于即时、可靠的基础设施，连接到以太坊（主网和各种测试网络）、Filecoin 和 IPFS。离线应用程序可以通过 HTTPS 和 WebSocket 上的 JSON-RPC 连接到以太坊和 IPFS，其中请求-响应时间比其他服务和自托管解决方案快 20 倍。Infura 网络节点运行在最新的网络升级上，保证最低 99.9%的在线时间。该服务提供按请求或基于订阅的连接，并拥有全职访问专家支持团队。

仪表板直接提供了应用程序性能和 API 使用的洞察。这可以用来深入具体请求方法或最活跃使用时间，以优化应用程序，更好地了解用户。

许多领先的区块链赋能产品依赖 Infura 的服务，例如，移动应用（Coinbase Wallet）、与区块链兼容的浏览器和插件（Brave、Metamask、Opera）以及区块链工具（OpenZeppelin、Truffle）。

Infura 占据主导地位，但在这个服务领域还有一些替代提供商。ZMOK⁵⁴通过 JSON-RPC API 提供快速以太坊节点。为以太坊网络和 IPFS 提供类似服务的还有 Cloudflare 分布式网络网关。⁵⁵ QuikNode⁵⁶提供弹性 API 和专用节点。除了以太坊，他们的 API 端点还包括 BSC、Optimism、比特币、xDAI 和 Polygon。Pocket Network⁵⁷是一个包容性的 relay 网络，用于向主要区块链的 API 请求，具有加密经济模型。请求被伪随机地路由到可用节点，使它们非常冗余。与单一服务提供商相比，Pocket Network 组织为去中心化自治组织（DAO）。其使命是确保区块链基础设施的持续去中心化。

#### 2.7.2.3 高级区块链数据分析的公共数据集

直接从网络节点获取的账本数据可能不适用于高级区块链（BC）数据分析所需的查询，大数据利用，机器学习或商业智能机制。为此，例如 Google BigQuery 提供了公共数据集，以访问来自各种 BC 网络的历史数据，包括对链上交易数据和整个区块历史的访问。因此，数据可以立即在 BigQuery 的所有分析方法和可视化工具中使用。2021 年，Google Cloud Platform 市场上有近 50 个公共数据集⁵⁸。它们包括大多数关键的公共区块链网络，例如 BTC、以太坊、以太坊经典、莱特币、达世币、门罗币、卡尔达诺、NEO 等。这些数据可以立即应用于 Google Cloud 的 AI 服务及数据分析，或者简单地用 SQL 进行结构化和查询。

例如，分析可以揭示最受欢迎的收藏品（ERC721 合约）或代币（ERC20 合约），找到零费用交易，计算区块链地址的余额等等。
