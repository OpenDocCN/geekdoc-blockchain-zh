© 作者，独家许可给 APress Media, LLC，隶属于 Springer Nature 2022J. T. George 介绍区块链应用[`doi.org/10.1007/978-1-4842-7480-4_14`](https://doi.org/10.1007/978-1-4842-7480-4_14)

# 14. 使用 MATLAB 智能农场项目

Joseph Thachil George^(1  )(1)意大利，罗马

该项目说明了如何有效地控制对共享资源的互斥访问。为了以这种方式实现排他性，该项目使用 MATLAB 和 Simulink 框架创建。项目的名称是*智能农场*。在这个项目中，一支由自主机器人组成的队伍执行一系列的农业任务，包括准备土壤、浇水和收获植物。

## 14.1 智能农场项目描述

该项目涉及到一个分布式、互斥访问共享资源的案例研究。情境是一个*智能农场*，其中一支由自主机器人组成的队伍负责准备土壤、浇水、收获植物等工作。

每个机器人循环移动在田地和主要农场建筑和仓库之间。农场的地理位置是这样的，有两个主要的生产区域（称为北部和南部），可以通过一条乡村道路从主要农场设施到达，该道路横跨一条小河上的一座小桥（见图 14-1）。一次只能有一个机器人使用桥梁，这意味着机器人需要通过 V2V 通信协商独占式访问桥梁，而没有中央控制中心。![../images/520777_1_En_14_Chapter/520777_1_En_14_Fig1_HTML.jpg](img/520777_1_En_14_Fig1_HTML.jpg)

图 14-1

河上的桥梁

每个机器人可以被视为在不同操作模式之间循环，如图 14-2 所示。当机器人需要移动到田地或农场建筑时，它会进入询问桥梁模式，向其他处于询问桥梁或桥梁模式的机器人发出访问桥梁的请求。

项目的主要目标是定义分布式通信协议，以实现对桥梁的独占访问，以避免在桥梁上发生碰撞。![../images/520777_1_En_14_Chapter/520777_1_En_14_Fig2_HTML.jpg](img/520777_1_En_14_Fig2_HTML.jpg)

图 14-2

操作模式

### 14.1.1 项目需求

系统必须满足以下要求：

+   *需求 1*：系统由一组不确定数量的相同机器人组成，它们通过无线连接进行通信。

+   *需求 2*：每个机器人遵循图 14-2 中描述的循环操作行为。

+   *需求 3*：任何两个机器人不能同时访问桥梁（互斥，安全性）。

+   *需求* 4：未被授予桥梁访问权限的机器人将等待桥梁清空，然后才会发出新的访问请求。

+   *需求* 5：如果机器人发出桥梁访问请求，迟早会被授予访问权限（*活性*）。

+   *需求 6*：如果桥梁的访问权限被授予来自北部田地的机器人，并且至少还有其他两个机器人 R1 和 R2 要过来—R1 也来自北部，R2 来自农场或南部—那么下一个访问权限不能再次授予给 R1，再次来自北部。对于机器人从南部或从农场穿过桥梁的对称情况也适用（*公平性*）。

+   *需求 7*：该系统基于完全分布式算法，没有任何集中化元素。

+   *需求 8*：机器人不使用统一的时钟，而是每个时钟都是自主的，不进行同步。

### 14.1.2 解决方案提示

机器人可以看作是分布式系统的节点，将使用给定的规范形式对其进行建模。通常，每个节点将被建模为某种形式的*扩展有限状态机*，并且节点将使用规范提供的机制来交换数据，以使不同的状态机进行通信。

节点（机器人）用一个数字进行标识，它们的标识符可以在必要时用于发送点对点通信。

作为建议，您可以基于 2PC（两阶段提交协议）算法（标准或线性）组织解决方案，在该算法中需要定义一个协调器，向其他节点发送其提案。

申请访问桥梁的机器人 R1 在每次运行时都充当协调器。因此，它向其他机器人广播访问请求。一个机器人从 R1 接收到这个请求时，当处于 Ask4Bridge 或 Bridge 以外的任何模式时，简单地回复同意。一个处于桥接模式的机器人将回复中止，因为它当前正在占用桥梁。一个机器人 R2 在 Ask4Bridge 模式下收到来自 R1 的请求时，如果它的标识符低于 R1 的标识符，它将回复中止；否则，它将回复同意。但在这种情况下，R2 还必须中止它进入 Ask4Bridge 模式时启动的算法运行。

离开桥接模式的机器人会向其他节点广播桥接空闲的信息，以便处于 Ask4Bridge 模式的节点可以重试它们的请求。

注意，一个节点应该能够启动自己的 2PC 运行*并且*同时监听来自其他参与其他 2PC（两阶段提交协议）运行的机器人的消息。这需要使用一些并发线程，或者*状态图*区域。

在第一阶段，你应该专注于 2PC 方案，考虑一个固定的三或四个机器人集合，并准确研究它们的相互作用，忽略活性和公平性要求，只考虑三种操作模式（*Ask4Bridge*、*Field Action*和*Bridge*)。

在第二阶段，你需要将模型扩展以考虑其他操作模式，可能涉及更多的机器人和/或活性/公平性要求。

请注意，通常情况下，为了能够模拟或正式验证模型，需要实例化一定数量的对象（节点），通过物理复制和粘贴。

## 14.2 实施项目

该项目设计有三台机器人，它们在田地和主要农业建筑物及仓库之间循环移动。农场的地理位置使得有两个主要的生产田地（命名为北和南）。机器人的移动满足分布式系统中使用互斥的并发控制的三个基本要求，如前文所述。

此外，该系统基于完全分布式算法，没有任何集中化的元素。机器人不参考一个共同的时钟，而是每个时钟都是自主的且不同步的。

该项目是用 MATLAB 实现的，机器人是借助 Simulink 工具设计的。以下 MATLAB 依赖项需要用于实现：

+   Simulink

+   Stateflow

+   机器人系统工具箱

+   导航工具箱

接下来的部分涵盖了 Simulink 中可用并在此项目中使用的内置功能。

### 14.2.1 环境模型

MATLAB 内置的机器人可视化器使您能够在 2D 移动机器人环境中模拟和原型化算法。多机器人生态系统还能够在 2D 多机器人移动机器人环境中开发和原型化算法。这些功能可通过 MATLAB 和 Simulink 界面访问。

### 14.2.2 传感器模型

在这个项目中，激光雷达传感器模拟了 2D 视线传感器，用于可视化和算法原型设计。这个特性在 MATLAB 和 Simulink 界面中可用（见图 14-3）。![../images/520777_1_En_14_Chapter/520777_1_En_14_Fig3_HTML.jpg](img/520777_1_En_14_Fig3_HTML.jpg)

图 14-3

传感器

### 14.2.3 多机器人激光雷达传感器

除了前面列出的特性外，多机器人激光雷达传感器还被用来模拟多机器人环境中的二维视线探测器。该传感器将测试环境中使用有限半径的占用图的视线以及其他机器人的视线。这个特性在 MATLAB 和 Simulink 界面中可用。

## 14.3 系统架构

该项目实现了两阶段提交协议技术来移动机器人。

在系统架构下，关键部分（CS）一次只能运行一个进程。在分布式网络中，不能使用共享变量或本地内核实现互斥。创建分布式互斥的唯一方法是使用消息转发。通过分布式系统算法处理未预见的通信延迟和系统状态的部分信息（见图 14-4）。![../images/520777_1_En_14_Chapter/520777_1_En_14_Fig4_HTML.jpg](img/520777_1_En_14_Fig4_HTML.jpg)

图 14-4

多传感器

为了避免穿越桥梁的机器人之间的碰撞，该架构被设计为，当一个机器人需要移动到一个场地或农场建筑时，它进入请求桥梁模式。在那里，它向处于请求桥梁模式的机器人通信请求桥梁的访问。分布式通信协议（两阶段提交协议）允许独占访问，以避免在桥上发生碰撞。

在上述架构中，事务被定义为一组操作。根据应用标准，每个事务都被赋予一个截止日期。这些操作被认为是坚实且真实的，并且具有相同的严重程度。过期的事务将立即被取消。

当一个事务准备“提交”时，两阶段提交协议就会启动。一个孤立的协调机器启动它（在本例中是机器人 1）。机器人 2 和 3 是其他参与者，它们将等待主管（机器人 1）的指示。

这种技术确保了事务的原子性：整个事务要么反映在系统的最终状态中，要么一点也不反映。如果甚至有一个人无法提交，事务将被终止。换句话说，每个员工对事务都有“否决”权。两阶段提交协议的基本流程如图 14-5 所示。![../images/520777_1_En_14_Chapter/520777_1_En_14_Fig5_HTML.jpg](img/520777_1_En_14_Fig5_HTML.jpg)

图 14-5

智能农场的系统架构

## 14.4 系统建模

所有建模都是通过 MATLAB 完成的。使用 Simulink 工具，我已经为机器人的移动开发了一个状态流模型。程序使用机器人系统工具箱和导航工具箱来移动机器人。（请注意，为了执行此任务，MATLAB 中提供了免费插件。）

### 14.4.1 机器人可视化器和激光雷达传感器

机器人可视化器用于开发机器人架构。此外，利用每个机器人的激光雷达传感器，可以验证机器人的移动。激光雷达传感器还可以模拟二维视线传感器，如图 14-6 所示。![../images/520777_1_En_14_Chapter/520777_1_En_14_Fig6_HTML.jpg](img/520777_1_En_14_Fig6_HTML.jpg)

图 14-6

两阶段提交协议(2PC)

### 14.4.2 避障逻辑和 *2* PC 协议概念

为了防止机器人在从一个状态移动到另一个状态时发生碰撞，该项目使用了 2PC 协议概念进行过渡。为了实现这一概念，该项目包括了机器人的不同运动模式（基于投票）。如果一个机器人想要移动到另一个状态，它会请求 Ask4Bridge 模式。然后，协调员确定是否有其他机器人请求相同的模式。如果没有，它就允许进一步移动。为了防止机器人在移动时发生碰撞，该项目还使用了在 MATLAB 中可用的障碍物避免逻辑。

### 14.4.3 北方和南方农场以及仓库的架构

MATLAB 中有一个称为*多机器人环境*的功能，用于构建不同的场景，如北方和南方农场以及仓库。在这个平台上，您可以构建“n”个机器人并跟踪它们的移动。

这是 MATLAB 中导航工具箱插件中可用的内置功能。MATLAB 中多机器人环境的定义如下：“多机器人环境使您能够在二维多机器人移动机器人情境中模拟和原型化算法。”（见图 14-7。）![../images/520777_1_En_14_Chapter/520777_1_En_14_Fig7_HTML.jpg](img/520777_1_En_14_Fig7_HTML.jpg)

图 14-7

机器人可视化器和激光雷达传感器

## 14.5 实现两阶段提交协议

当交易准备“提交”时，2PC 协议启动。一个单一的监督系统启动它（在初始阶段为机器人 1）。

2PC 协议有两个阶段，如此处所示（假定在初始阶段，机器人 1 是协调员，机器人 2 和 3 是参与者）。

+   **阶段 1：** 监督员，机器人 1，询问每个人是否完成了他们的交易任务并准备好承诺。每个成员都回答是或否。

+   **第二阶段：** 组织者计算所有答案。如果所有工作者都答应，事务将完成。如果没有，则会中止。主管向每个员工发送最终提交选择的消息并获得回应。

此技术确保动作是原子的：要么整个动作反映在系统的最终状态中，要么没有。如果甚至有一个方无法提交，事务将被取消。换句话说，每个方都对事务拥有*否决权*。![../images/520777_1_En_14_Chapter/520777_1_En_14_Fig8_HTML.jpg](img/520777_1_En_14_Fig8_HTML.jpg)

图 14-8

避障逻辑

它还确保了事务的长期可行性。在步骤 1 中回答“是”之前，每个方都会仔细检查事务的所有写入是否已经持久地写入存储。这使得主管可以在对事务做出最终决定时不必担心参与者的故障，如果他们投票“是”（见图 14-8）。

### 14.5.1 要求

当使用互斥时，此项目满足分布式系统中并发控制的三个基本要求：

+   互斥和安全性

+   活性

+   公平性

通过互斥方式使多个进程访问公共资源或数据源：

+   在分布式系统中没有可以用于构建互斥和同步原语的公共变量。

+   唯一的信息共享方式是通过数据传输。

以下是三个基本要求的满足方式：

+   **互斥，安全性：** 在任何给定时间只有一个进程可以运行关键部分。

+   **活性：**（没有死锁或饥饿。）两个或多个方应不必无限期地等待永远不会到达的通信。

+   **公平性：** 每个进程都有平等的机会完成关键部分。原则上，公平性意味着关键部分的执行请求按照它们到达系统的顺序进行。

除了以前的要求之外，我们还实现了以下要求：

+   该系统由一定数量的相同机器人组成，它们通过无线连接相互通信，借助激光雷达传感器和避障逻辑。

+   每个机器人都遵循着循环模式的操作行为，借助机器人可视化工具实现。

+   未被授予桥接访问权限的机器人将等待直到桥梁清空，然后才发出新的访问请求，使用了 2PC 协议的概念。

该系统基于完全分布式算法，没有任何集中化的元素，使用了 2PC 协议的概念。

### 14.5.2 遇到的问题

在实施该项目时，出现了以下问题：

+   由于两阶段提交协议的阻碍特性，存在可扩展性不足的问题。

    两阶段提交协议的最大问题在于它是一个阻碍协议。如果监督员永久失败，某些参与方将无法完成其操作。在玩家提交同意消息给监督员后，将等待收到提交或回滚。

+   一旦参与者承认准备好提交了，即使在中间崩溃，也必须能够提交事务。这需要将检查点写入持久存储。

+   最糟糕的情况发生在监督者也是参与者并对协议的结论进行投票时。然后，如果监督者崩溃，可能会同时消失它和一个成员，从而确保协议会保持阻塞，尽管只发生了一个损失。由于其低通信复杂度，2PC 仍然是一种常见的共识协议。然而，在发生故障时，困难可能会升至 O，如果每个节点都自愿成为恢复节点 O(n2)O(n2)O(n2)。

然而，2PC 可能由于监督者失败而阻塞的事实是一个严重的问题，严重降低了可用性。如果交易可能随时被撤消，那么协议可以随着节点超时而恢复，但如果提交选择必须被视为永久性，则一个故障就可能使整个系统陷入停顿。此外，已经开发出了一种三阶段提交协议，它消除了 2PC 的阻塞问题，但以额外的消息延迟为代价（见图 14-9）。![../images/520777_1_En_14_Chapter/520777_1_En_14_Fig9_HTML.jpg](img/520777_1_En_14_Fig9_HTML.jpg)

图 14-9

北方和南方农场及仓库的模型架构

## 14.6 摘要

在分布式计算系统中，提交协议提供全局原子性。这确保了网络中的交易不会在网络中的所有节点上结束，或者如果所有节点失败，则在所有节点上都不会结束。

分布式计算是使用网络化的独立计算机进行项目协作的一种方法。根据这种范例，中央计算机分割任务并将其传递给客户端计算机完成。由于提交机制，这种方法可以抵御单个客户端的故障。

*两阶段提交协议*的缺点是，如果协调者失败，则所有客户端资源可能会无限期冻结。在提交了的三阶段协议中使用超时转换来弥补这个缺点。超时转换允许在协调计算机失败时在预定时间释放资源。

本章涵盖了一个在设计分布式系统时可能会用到的基本协议。两阶段提交方法确保了原子性，分为两个阶段——提交请求阶段和提交阶段。计算机协调在提交请求阶段向网络上的每台其他客户端计算机发送请求，然后等待每个客户端的响应消息。如果收到所有消息，则执行步骤 2；如果客户端发生错误并且未收到所有消息，则执行步骤 1。所有客户端都会收到中断通知。

这种方式使用 MATLAB 是分布式系统的一个完美例子。机器人的移动是使用 MATLAB 工具设计的。两阶段提交协议用于分布式系统中消息的事务处理。该项目是对共享资源的分布式互斥访问的案例研究。场景是一个智能农场，其中一队自主机器人进行土壤准备、植物浇水、收获植物产品等活动。

下一章介绍了一个具有更多分布式系统特性的高级项目示例。该项目被称为*Platoon*。
