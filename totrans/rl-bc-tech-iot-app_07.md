第六章

# 物联网区块链应用的规模化测试

迈克尔·A·沃克；道格拉斯·C·施密特；阿比希克·杜贝    （范德堡大学软件集成系统研究所，美国田纳西州纳什维尔）

## 摘要

由于区块链技术在私人、公共和商业领域的不断应用，分布式系统的使用和对其可靠性的需求近年来急剧增加，特别是在其与物联网设备的期望集成方面。这导致在分布式系统分析和设计领域开展了大量工作，特别是在区块链智能合约设计和形式验证方面。然而，对形式验证方法的关注意味着对传统测试方法的关注较少，如单元测试和集成测试。其中包括大多数，如果不是所有，主要区块链实现对规模化测试的支持不足，除了完全公开的测试网络。这带来了一些缺点，例如：（1）无法在相同的场景下进行可重复的测试，（2）依赖于区块的公开挖掘，这引入了在私有网络可以减少或消除的测试驱动开发场景下的不合理的延迟，以及（3）无法设计部分网络崩溃的场景。在本章中，我们将讨论设计、测试方法和工具，以允许对物联网区块链应用进行规模化测试。

### 关键词

自动化；区块链；分布式系统；物联网；可扩展性；测试；规模化测试

## 1 引言

区块链部署（特别是以太坊，由于其庞大的安装基数和强大的智能合约语言，本章将重点关注）通常通过具有不同运行模式的程序来管理。它们大致分为命令行界面（CLI）、RPC API 或通过使用 HTML 页面和 JavaScript 代码创建图形界面。这些界面提供了标准手段，可以在客户端内部运行以太坊应用程序，或者将其他应用程序与以太坊客户端进行接口。

实际上，现有的区块链部署界面缺乏内置的容错能力，特别是对于网络通信错误或应用执行故障。此外，由于没有官方管理器存在，以太坊客户端是手动部署的。因此，开发者可能会因为不安全的客户端配置而失去他们所有的以太币（以太坊的数字货币）。解决这个问题需要模式和工具，可以以可重复和系统化的方式部署区块链客户端。当集成物联网区块链应用程序（ITBA）时，这一要求变得更加重要。ITBA 的物联网组件由于与物理环境的交互和增加的隐私问题而在传统区块链应用程序之上添加了其他要求，例如防止个人数据泄漏，比如能源使用量可能会显示用户在家中的活动模式。此外，ITBA 可能不仅仅通过区块链进行通信，还可能出于与其运行相关的原因使用基于 TCP/IP 或其他网络协议的区块链之外的通信。

在本书章节中，我们介绍了利用 PlaTIBART 的结构和功能的区块链系统规模测试的最佳实践。PlaTIBART 是一个用于可重复测试的可交易物联网区块链应用的平台，提供了一套工具和技术，用于增强区块链系统和特别是 ITBA 的开发、部署、执行、管理和测试。本章的部分内容源自一篇名为 PlaTIBART: a platform for transactive IoT blockchain applications with repeatable testing 的文章，可在[`doi.org/10.1145/3152141.3152392`](https://doi.org/10.1145/3152141.3152392)获取。具体而言，我们描述了开发 ITBA 的模式，用于定义私有区块链部署网络的领域特定语言（DSL），可以在其上部署和测试应用的 Actor 组件，使用这些 DSL 模型的工具来管理可重复测试环境中的部署网络，以及通过应用观察者模式提供容错性的接口。书中使用的技术/技术术语在出现时都有解释，或者可以参考 第十一部分，然后提供参考资料。

## 2 分布式账本/区块链测试概念的介绍

对区块链技术的兴趣以及商业应用在近年来有所增加[[1]](S0065245819300348.xhtml#bb0010)。例如，金融业中对区块链的采用已经使比特币的市值超过了 750 亿美元[[2]](S0065245819300348.xhtml#bb0015)，以太坊的市值达到了 360 亿美元[[3]](S0065245819300348.xhtml#bb0020)。区块链的增长至少部分源自它将现有技术结合起来，以实现不需要信任中心权威的去中心化、密码学安全和不可变的生态系统的互操作。区块链作为一种特定类型的分布式账本，根据实现方式以不同的方式提供这些特性。然而，通常情况下，区块链通过创建一个经过密码签名的区块链来运行，因此得名，这些区块链通过诸如工作量证明这样的共识机制来实现去中心化，而这种机制并不受中央权威的控制。虽然分布式账本与区块链有许多相似之处，但并不一定需要分散的权威。然而，在本章中，我们讨论两者，并侧重于区块链版本的分布式账本，因为完全分布的非中央权威更容易实现和管理，因此我们假设对物联网制造商更有可能进行集成。区块链部署（特别是以太坊，因为它具有庞大的已安装基础和强大的智能合约语言）通常通过具有不同运行模式的程序进行管理。它们大致分为命令行界面（CLI）、RPC API 或通过使用 HTML 页面和 JavaScript 代码创建图形界面[[4]](S0065245819300348.xhtml#bb0025)。这些界面提供了标准的方式，要么在客户端内部运行以太坊应用程序，要么将其他应用程序与以太坊客户端进行接口交互。然而，在实践中，现有的区块链部署界面缺乏内置的容错能力，尤其是对于网络通信错误或应用程序执行故障。此外，由于不存在官方管理器，以太坊客户端是手动部署的。因此，开发人员可能会因为不安全的客户端配置而丢失他们所有的以太币（以太坊的数字货币）。这个问题被加剧了以太坊的客户端在其内置的帮助功能中没有警告这个风险，而是依赖在线文档来警告开发人员。解决这个问题需要模式和工具，以便以可重复和系统化的方式部署区块链客户端。

## 区块链和物联网系统的测试分析

区块链系统可以分为两大类：图灵完备和非图灵完备。这意味着系统合约语言的设计要么是图灵完备的，要么不是。这两个类别中最大的分别是作为非图灵完备合约语言的比特币和作为图灵完备合约语言的以太坊。这一点之所以重要，是因为它描述了语言的固有设计目标。图灵完备语言允许理论上完成任何计算，而非图灵完备语言具有更受限的指令集，专门限制了该语言中可用的操作。向语言添加这些限制的原因是为了限制功能，从而限制放置在区块链的公共账本上并分布执行的代码的潜在复杂性。非图灵完备合约语言更容易分析和预测运行时行为、结果和潜在故障。此外，还有诸如 Hyperledger Fabric 之类的区块链/分布式分类帐框架，它们不提供特定的可供使用的公共区块链，而是提供用于模块化开发可定制的区块链/分布式分类帐应用或实现的工具。

在区块链增长的大致同时期，物联网设备的增加使得由于物联网设备从仅仅是智能传感器转变为通过通信、决策和物理作用影响其环境的主动参与者的需求逐渐增加，因此需要交易完整性。这些能力要求交易完整性以对潜在的不受信任的网络第三方物联网设备所做的操作进行审计。对同时利用区块链特性（如去中心化、加密安全性和不可变性）的物联网设备的交易完整性的需求已经促使研究创建交易型物联网区块链应用程序[6,[7]](S0065245819300348.xhtml#bb0040)。

当集成物联网区块链应用程序（ITBA）时，这一要求变得更加重要。由于它们与物理环境的交互和增加的隐私问题，ITBA 的物联网组件在传统区块链应用程序之上增加了其他要求，例如，防止个人数据泄露，如揭示用户在家中的活动模式的能源使用[[8]](S0065245819300348.xhtml#bb0045)。此外，ITBA 不仅可以通过区块链进行通信，还可以通过 TCP/IP 或其他网络协议进行离线通信，原因如下：

+   • 可能需要与传感器和/或执行器进行通信以与物理环境进行交互。例如，用户的智能电表可能通过无线方式与其智能汽车电池通信，以根据当前能源生产/成本考虑激活充电。

+   - 分布式账本（用于在区块链中记录交易的不可变记录）是公开的，因此通常只包括可以安全存储为公开信息的交易内部信息。特别是，如果某个或所有交易数据必须因隐私或其他原因保密，交易可以包含元数据和秘密数据的加密哈希值。因此，私人信息必须通过区块链之外的通信来传达，同时通过在区块链账本上存储元数据和哈希信息来保持完整性。

+   - 管理任务，如：更新、监控、校准、调试或审核可能需要区块链之外的通信（可能包括用于日志记录的区块链组件）。目前，这些管理任务在传统的区块链生态系统中是手动完成的。类似于需要系统化地在区块链网络中部署应用程序的需求，有必要系统化地配置 ITBAs 各个组件之间的网络拓扑结构。

## - 测试物联网区块链系统的期望功能

- 在本节中，我们列出了测试物联网区块链系统的期望功能。具体来说，我们认为最简单的区分物联网区块链系统不断增加的测试水平的方法是什么。这些阶段，从最容易实现的开始，逐渐变得更加困难，包括：单元测试、简单物联网设备集成、多个物联网设备集成、测试驱动开发和完全自动化的测试驱动开发。

软件的单元测试已成为良好开发代码的标准要求。 然而，合同语言并不总是在语言或默认构建环境中包含默认的单元测试能力。 但是，不同类别的区块链解决方案的最大实现：以太坊、比特币和超级账本都提供单元测试功能，因此，任何不提供此功能的解决方案都不应被视为生产级别准备。

除了单元测试之外，ITBA 的期望测试的下一个级别是集成测试。 纯软件为基础的分布式系统的集成测试由于多个实例、网络和运行时配置等的协调而提供了独特的挑战。 ITBA 通过要求不仅要运行多个软件实例进行集成测试，还要求与系统的物联网组件集成以验证运行时特性、硬件和软件兼容性等，使这种挑战更加复杂。 因此，我们决定将带有物联网设备的测试阶段分为两个子阶段：一个只与一个设备进行集成测试的阶段，然后是第二个阶段，将多个设备集成到测试中。 这种划分提供了测试进度分析的更清晰的进展方式。

对于期望进行测试的 ITBA 系统的下一个级别是持续集成。 持续集成，像单元测试和集成测试一样，现在在软件开发中很普遍。 然而，采用这些实践与使用的核心区块链或甚至物联网系统的依赖程度较小，更多地取决于旨在辅助开发该特定系统的支持软件。 因此，像单元测试一样，我们建议考虑任何尚未通过支持库、工具等提供持续集成支持的系统为非生产级别准备。

## 5 测试物联网区块链系统中的现有缺陷

本节回顾了物联网和区块链集成的最新技术，重点放在测试上。之前的工作[[9]](S0065245819300348.xhtml#bb0050)已经表明，物联网和区块链可以集成，允许对等方通过使用区块链以不可信赖、可审计的方式进行交互，区块链作为一个弹性、去中心化和点对点的分类帐。关于物联网和区块链集成的安全性和隐私性也已经做了一些工作[[10]](S0065245819300348.xhtml#bb0055),11。此外，已经对智能合约的形式验证[[12]](S0065245819300348.xhtml#bb0065)以及如何“防御性地”编写智能合约[[13]](S0065245819300348.xhtml#bb0070)以避免多个合同交互时出现异常进行了研究。然而，关于测试的最新技术还不够完善，因为区块链很少以系统化和可重复的方式进行规模化测试，因此我们将重点放在下面。  

### 5.1 功能性与基于模型的声明

目前，据我们所知，PlaTIBART 是唯一一个基于模型的系统，用于部署区块链测试网络，无论是以太坊还是其他区块链。有一些工具，如 Nixos[¹]，可以提供其 Linux 发行版的可重复安装，因此通过使用 NixOps devops 工具，可以声明性地定义私有以太坊网络的部署。然而，这仍然需要对要创建的实例进行功能性声明。基于模型的方法的好处在于它允许输出的变化更加容易，此外，基于模型的声明可以被修改以轻松地创建其他系统的功能性声明输入，从而保持易于适应性，同时增加与其他工具、工具链和工作流的互操作性。

### 5.2 在实时环境中进行测试，不可重复

区块链系统，特别是以太坊，在开始阶段主要集中于在称为测试网络的公共、全球性和不可修改的以太坊网络实例上测试您的智能合约代码。以太坊至少增加了对智能合约单元测试、在模拟器中测试智能合约以及称之为集成测试的功能支持。然而，这些方法缺乏稳健性和可重复性。

对于开发者来说，使用公共的非区块链，即使是测试环境，也会带来几个潜在问题。首先，在测试环境中发布旨在保密的内容的可能性是一个很大的问题。其次，依赖公共区块链进行测试剥夺了对测试环境的频率、延迟和可预测性（或缺乏可预测性）的控制能力。这很重要，因为测试通常需要比实时执行速度更快。

仅对系统的智能合约组件进行集成测试使用模拟器缺乏稳健性，原因有几点。首先，它不使用与生产代码相同的客户端。其次，它忽略了将客户端本身纳入集成测试过程的必要性。第三，它专注于官方客户端的 HTML/JavaScript 接口，而忽略了 geth 提供的其他接口，比如 JSON RPC API。

因此，我们认为以太坊在其测试机制的设计理念上存在问题。此外，我们此前已经注意到【14】以太坊的文档不完整，并且同一 API 的文档分散在多个页面上，截至本出版日期，这个问题仍然存在。

### 5.3 缺乏定义的集成/测试方法论

不幸的是，目前对于测试区块链系统和软件的支持严重不足，并且没有使用区块链系统创建者构想的精确场景。例如，以太坊没有任何工具，无论是测试还是其他用途，能够帮助将以太坊的官方命令行客户端 geth 集成到应用程序中。官方的 IDE 是 Remix Solidity IDE，它可以进行单元测试，但目前完全不支持集成测试。他们的重点在于对智能合约进行单元测试，以及在一个独立的模拟器中“集成测试”他们的合约，而不是 geth 客户端和私有测试网络。其他区块链或分布式分类账技术，如超级账本 Fabric，至少有单元测试支持和集成测试支持，但在撰写本文时，它们还没有相关文件。

## 6 平台用于可重复测试的可交互物联网区块链应用 (PlaTIBART)

以下章节将描述 PlaTIBART 架构、组件和组件。

### 6.1 系统设计/原理

PlaTIBART 架构用于创建可重复测试网络部署的物联网/区块链应用，结合了特定领域语言 (DSL) 来定义网络拓扑和设置，一个利用 Fabric API 管理测试网络的 Python 程序，以及 RIAPS 中间件 [[15]](S0065245819300348.xhtml#bb0080) 来促进网络节点之间的通信。下面将分别描述这些组件。

### 6.2 应用平台

Resilient Information Architecture Platform for Smart Grid (RIAPS) [[15]](S0065245819300348.xhtml#bb0080) 是 PlaTIBART 用来实现我们案例研究示例的应用平台。

RIAPS 提供了基于演员和组件的抽象，以及对通过网络部署算法的支持^(b)，并通过提供微秒级时间同步 [[15]](S0065245819300348.xhtml#bb0080)，基于故障的重新配置 [[7]](S0065245819300348.xhtml#bb0040)，以及组创建和协调服务（仍在积极开发中），解决了协作解决问题，除了 [[18]](S0065245819300348.xhtml#bb0095) 中描述的服务外。它能够处理不同的通信并实时运行已实现的算法。

### 6.3 演员模式

网络中的每个应用客户端都实现为一个演员，具有两个主要组件：（1）特定于演员所给定角色的包装器类和（2）geth 客户端，以太坊的参考客户端。^(c) 图 1 显示了五个演员的小网络（通过包装器和 geth 客户端对的椭圆表示），以及每个演员组件之间的网络连接。Geth 客户端专门通过区块链方式进行通信，即每个演员的 geth 客户端直接与其关联的包装器通信，并且包装器通过脱离区块链通道（例如 TCP P2P 通信）直接与其他包装器通信。

![图 1](img/f06-01-9780128171899.jpg)

图 1 演员组件网络示例，其中一个演员是 geth 客户端和一个包装器。

### 6.4 容错

将区块链客户端和包装器解耦为 actor 的两个组件的关键好处是，与紧密耦合的解决方案相比，在交易丢失方面提高了容错性。具体来说，它允许包装器不仅监视区块链客户端，还可以根据需要关闭并重新启动客户端。这种设计使得包装器组件能够确保，如果区块链软件中出现任何已知或发现的缺陷引起的故障，包装器至少可以尝试恢复。

例如，在我们描述的以太坊测试网络中第八部分，我们遇到了交易从未被挖掘的故障[[5]](S0065245819300348.xhtml#bb0030)在客户端重新启动时。这些丢失的交易是有问题的，因为它们阻止了客户端能够与区块链网络进行交互。其他类型的故障，如与网络的其他组件通信相关的故障，由其他中间件解决方案处理，如 RIAPS。

PlaTIBART 应用了观察者模式来通知包装器发生的事件，如故障和其他与区块链相关的条件。这个通知是通过包装器内部的一个独立线程完成的，该线程监视其配对的 geth 客户端以获取新事件，如完成的交易或潜在故障。然后，当目标事件发生时，该线程通知已注册的回调函数。例如，如果 geth 客户端变得无响应或交易似乎已经停滞不前，则调用注册的回调方法来通知包装器。

### 6.5 领域特定语言

PlaTIBART 的 DSL 定义了我们网络中不同客户的角色，基于 Actor 模式。 这个 DSL 模型实现了一个正确构建的设计，因此允许在部署之前对模型进行验证阶段，以检查内部一致性。 这种验证可以防止不一致，例如两个客户在同一主机上请求相同的端口。

图 1 展示了我们 DSL 的一个示例，该示例指定了一个测试网络的完整网络配置文件。 配置文件的前两行包含了该测试网络及其当前版本的两个唯一标识符，“configurationName” 和 “configurationVersion”。 接下来，它包含了特定于创建以太坊私有网络创世区块的值。

以太坊中的创世区块是区块链中的第一个区块，具有特殊属性，例如没有前任和能够在任何挖掘或交易开始之前声明已经有余额的帐户。 "chainID" 是一个唯一的正整数，用于标识测试网络正在使用的区块链； 1 到 4 是不同生产/测试阶段的公共以太坊区块链，不应该用于创建私有网络。

接下来，“difficulty” 表示挖掘一个区块的计算难度有多大，“gasLimit” 是基于数据的长度（以字节为单位）和其他以太坊运行时值的交易的最大难度。 “balance” 是我们在创建网络时分配给每个客户起始帐户的起始余额，^(d) 这消除了在任何挖掘开始之前客户无法开始交易以请求资产的情况。 最后，“clients” 代表我们网络中的实际节点。

图 2 显示了如何定义客户端。DSL 中的客户端代表我们网络中的个体参与者，包括使用包装接口的 geth 客户端和 RIAPs 实例的客户端。geth 客户端有两个接口/TCP 端口对与其关联：一个用于传入的区块链连接，另一个用于与 RIAPs 的管理和通信。

![图 2](img/f06-02-9780128171899.jpg)

图 2 样本 DSL 模型。

### 6.6 网络管理器

基于我们开发区块链生态系统的去中心化应用程序（DApps）的经验[14,[19]](S0065245819300348.xhtml#bb0100)，DApps 在 ITBA 生态系统中有效运行所需的三个关键能力是必不可少的：应支持传统的 IoT 计算和交互，信息应该在分布式数据库中得到健壮的排序，并提供系统范围内被接受的事件顺序日志。每个要求可以委托给三层架构中的一个单独层。第一层是 IoT 中间件层，便于网络设备之间的通信，可以通过现有的 IoT 中间件来解决，如 RIAPS [[15]](S0065245819300348.xhtml#bb0080)。第二层是分布式数据库层。第三层是事件顺序日志层，可以通过区块链集成来解决。PlaTIBART 提供了一种以容错的方式协调所有这些层的架构，同时提供了大规模重复测试的工具。它利用 Actor 模型 [[20]](S0065245819300348.xhtml#bb0105) 来集成这三个层。

每一层都由完成其指定层任务的组件组成。然后将这些组件组合成一个单一的演员，该演员可以与网络中的每一层和其他演员进行交互，如第八部分案例研究：交易能源系统所述。交易能源系统（TES）是对电力行业从集中式、单一的大规模发电和单向供电模式向去中心化模式转变的响应而出现的，该模式特点是终端用户在生产和消费方面发挥更积极的作用[21,[22]](S0065245819300348.xhtml#bb0115)。GridWise 架构委员会将 TES 定义为“一种经济和控制机制系统，允许使用价值作为关键运行参数来动态平衡整个电气基础设施的供需”[[22]](S0065245819300348.xhtml#bb0115)。在本文中，我们考虑一类以接网模式运行的 TES，这意味着当需求大于本地网络能够生成的电量时，本地电网与配电系统运营商（DSO）相连，由其提供电力。主要演员是消费者，其中主要包括住宅负载，以及操作分布式能源资源的自给自足者，例如屋顶太阳能电池或具有需求/响应能力的灵活负载。此外，DSO 管理网络的电网连接。这些安装配备有一个由 TES 启用的智能电表组成的先进计量基础设施。这些安装示例包括布鲁克林微网项目[[23]](S0065245819300348.xhtml#bb0120)和 Sterling Ranch 学习社区[[24]](S0065245819300348.xhtml#bb0125)。TES 的一个关键组成部分是交易管理平台（TMP），它以平衡本地市场的供需方式处理市场结算功能。

## 7 PlaTIBART 网络管理器的深入引导式演示

PlaTIBART 的目标是使用模型设计和部署可重复测试的物联网区块链应用网络。因此，我们提供了 PlaTIBART 的网络管理器如何允许通过简单的命令行创建区块链网络的引导式演示，目前仅支持以太坊，但在软件的未来版本中会支持更多。

网络管理器，文件名为 network-manager.py，旨在成为命令行工具，最终将集成到其他系统中，例如自动化构建系统等。因此，它遵循命令行工具的最佳实践，并具有内置的帮助菜单，以帮助用户学习系统。此外，它不会对系统进行任何无法通过一系列重复且潜在复杂的命令行指令完成的操作。这意味着网络管理器的目的是简化以可重复和基于模型的方式创建区块链测试网络的过程。使用模型允许命令行指令对几乎所有支持的网络设计变体保持相同。目前，网络管理器仅支持每个区块链节点连接到每个引导节点或到每个第一类客户端的网络设计。网络连接中更高级别的定制是未来的研究和开发领域。使用相同的一系列指令对网络管理器使得可以编写一系列简单的命令，从而完全自动化测试网络的创建和测试。为了证明这一点，我们将检查一个完整的周期，包括创建、运行、停止和删除一个测试网络。

### 7.1 创建新测试网络的引导式演示

创建测试网络的第一步是删除可以使用的临时文件。以下命令删除了区块链被创建和保存到的 /new-blockchain/ 目录。其余文件是可能的文件，可能会根据系统设计创建或不创建。static-nodes.json 文件是静态节点列表，是一种可能的以太坊发现机制，可能已经事先创建。新的矿工和客户端 json 文件是新创建的矿工客户端和标准非矿工客户端的列表。由于矿工相对较大的内存需求，至少需要 4 GB 的内存才能开始挖矿，并随着区块链的长度增加而增加，而非矿工客户端使用的内存约为 250 MB，这些需求是针对以太坊网络和以太坊的客户端 geth 的。genesis-data.json 文件是 geth 用于创建新区块链网络的传统输入文件，网络管理器在网络创建过程中创建这个中间产物（参见图 3 和 图 4）。

![图 3](img/f06-03-9780128171899.jpg)

图 3 删除网络管理器临时文件的命令。

![图 4](img/f06-04-9780128171899.jpg)

图 4 如何使用网络管理器创建 Bootnodes。

创建新的以太坊测试网络的第一步是如果你的网络要使用 Bootnodes 则创建 Bootnodes。我们将假设一个有效的 PlaTIBART 模型文件作为参数传递给 $1 在以下命令行说明中，既节省空间又强调网络管理器的命令不会根据输入模型而改变。

创建新的以太坊测试网络的下一步是创建输入模型文件中定义的客户端和矿工。这些命令的顺序不依赖于彼此（参见图 5）。

![图 5](img/f06-05-9780128171899.jpg)

图 5 创建矿工和客户端。

接下来，在创建新的以太坊测试网络时，需要制作 genesis-data.json 输入文件，该文件允许以太坊的 geth 客户端创建新的区块链网络。此文件包含有关要创建的网络的所有元数据，例如已知客户端的起始 Ether，初始挖矿计算的复杂度以及 ChainID，它防止不相关的链相互通信。然后将其提供给主机机器上的 geth 的本地副本，并创建创世块（区块链中的第一个区块）（参见 图 6）。

![图 6](img/f06-06-9780128171899.jpg)

图 6 为新的测试网络制作创世文件。

这里是在主机机器的本地 geth 客户端上创建创世块，参见 (图 7) 和 (图 8)。

![图 7](img/f06-07-9780128171899.jpg)

图 7 创建新的区块链创世块。

![图 8](img/f06-08-9780128171899.jpg)

图 8 将创世块分发给客户端和矿工。

这个新创建的区块包含了模型的所有元数据，并允许将预先挖矿的结果分发给每个矿工和客户端。这种预先挖矿的分发有助于防止潜在的竞争条件，即客户端始终试图“赶上”最新创建的区块，但始终无法赶上。如果与主机系统托管的矿工相比，挖矿难度设置过低，这种情况可能会发生。

此时，局部逻辑和数据文件也可以通过网络管理器分发到为模型生成的每个主机的主机。这些文件的具体内容将取决于正在测试的 ITBA（S）。本示例分发了我们用于 Use-Case 1 的代码。此时，新的区块链，在本示例中为以太坊，测试网络现在已完全创建并准备就绪。一些用例，例如我们的 Use-Case 2，将对此网络进行归档以备将来使用，而其他用例将按原样使用它。

### 7.2 启动和停止测试网络的指导漫游

为了进行挖矿并开始数据和请求的处理，首先启动矿工和客户端。如果矿工和客户端可以连接到引导节点网络中的单个引导节点，那么如果网络相当可靠，它们最终会同步。否则，如果不使用引导节点，矿工将需要手动连接到客户端（图 9–11）。

![图 9](img/f06-09-9780128171899.jpg)

图 9 分发逻辑代码和数据到每个客户端。

![图 10](img/f06-10-9780128171899.jpg)

图 10 连接矿工到每个客户端以连接网络。

![图 11](img/f06-11-9780128171899.jpg)

图 11 启动矿工和客户端。

通过使用上述命令逐步停止整个网络。或者，您可以使用网络管理器的网络选项一次性停止整个网络。启动整个网络也行，但出于清晰起见，上面已对此进行了详细解释（图 12）。

![图 12](img/f06-12-9780128171899.jpg)

图 12 网络管理器停止整个网络。

删除网络将删除网络中所有客户端、矿工和引导节点在设置过程中创建的所有文件，但不会删除主机机器生成的文件，如果这些文件要单独保留的话（图 13）。

![图 13](img/f06-13-9780128171899.jpg)

图 13 网络管理员删除整个网络。

## 8 示例用例 1：可交易能源

可交易能源系统（Transactive Energy Systems，TES）是对电力行业向去中心化模式转变的响应，这种模式不再以大规模发电和单向输送为特征，而是朝着一个更为去中心化的模式，其中最终用户在生产和消费中发挥更积极的作用[21，[22]](S0065245819300348.xhtml#bb0115)。GridWise Architecture Council 将 TES 定义为“一种经济和控制机制系统，允许在整个电气基础设施中动态平衡供需，以价值作为关键的操作参数”[[22]](S0065245819300348.xhtml#bb0115)。

### 8.1 示例问题

在本节中，我们考虑一类在并网模式下运行的 TES，这意味着当本地电网需求超过本地网络所能生成的电量时，本地电网与配电系统运营商（DSO）相连，后者提供电力。主要参与者是消费者，主要包括居民负载，以及运营分布式能源资源的生产者，例如屋顶太阳能电池或可进行需求/响应的灵活负载。此外，DSO 管理网络的电网连接。此类安装配备了由 TES 启用的智能电表的先进计量基础设施。此类安装示例包括布鲁克林微电网项目[[23]](S0065245819300348.xhtml#bb0120)和 Sterling Ranch 学习社区[[24]](S0065245819300348.xhtml#bb0125)。TES 的一个关键组成部分是交易管理平台（TMP），它以平衡本地市场的供需方式处理市场清算功能。

### 8.2 深入的指导性漫游

为了测试 PlaTIBART，我们实现了一个解决方案来处理可交易能源案例研究，并将其部署到图 2 中定义的测试网络中。该网络安装在范德堡大学托管的私有云实例上。我们在 6 个虚拟主机上运行了我们的测试，每个主机都有：4GB RAM、40GB 硬盘空间、运行 Ubuntu 16.04.02，并具有千兆网络。为了进行这些测试，我们在 Python 中实现了自定义的智能合约以及智能电网配电系统运营商（DSO）和用户客户端的包装器。每个包装器都与一个 geth 客户端相关联。我们使用了 PlaTIBART 中的网络管理工具，该工具在第 6.6 节中概述，并在第 7.1 节和 7.2 节中详细说明了命令，以创建、启动、关闭和删除测试网络。我们手动将每个包装器与其 geth 客户端的 IP 地址和端口配对（在未来的工作中，这将被集成和自动化到网络管理器的功能中）。使用我们自己编写的包装器、智能合约和管理的测试网络，我们模拟了参与者之间一天的可交易能源交易。通过 Linux 中的“time”命令，我们测量了创建测试网络的整个过程中每个步骤所需的时间，包括客户端创建、矿工创建、区块链制作、区块链创建、分发到客户端和分发到矿工。我们还测量了为每个“客户端”（“用户”和“DSO”）启动和连接 geth 实例所需的步骤。目前，这种星型网络是 PlaTIBART 唯一支持的网络拓扑，但我们将来会扩展支持的拓扑结构。

### 8.3 系统输出与分析

运行上述测试后，我们发现每个测试阶段的标准偏差很小（最大值为时间的 0.09%）。同样，平均时间要么保持相对静态，要么与客户数量线性增长（2、5、10、15、20 个 prosumer + 1 个 DSO + 1 个矿工）。

保持相对静态的测试阶段包括：矿工创建、区块链生成、区块链创建、分发给矿工、矿工启动和网络删除。随着 prosumer 数量的增加而扩展的测试阶段包括：客户创建、分发给客户、完整网络创建、客户启动、网络连接和网络停止。在将平均时间增加除以客户数量的差异后，扩展增长是线性的（标准偏差 < 0.065）。

我们实验的结果表明，管理 PlaTIBART 管理的区块链测试网络存在很高的一致性和可预测性。这些结果有助于增强对 PlaTIBART 为物联网区块链应用创建可重复测试网络的方法的信心，这对于鼓励物联网系统开发人员采用是很重要的。

## 9 用例示例 2：区块链/分布式系统教育

正如我们在《用于 MOOCs 的大规模软件作业评估的弹性平台》（EPLASAM）中所讨论的，尝试扩展软件作业以供 MOOCs 使用时存在重大挑战。尝试扩展分布式系统，特别是 ITBA，软件作业会带来比传统软件作业更多的挑战。即使忽略在上面测试代码所需的物理物联网硬件的需求，对于个人评估来说，私有可重复的区块链网络、易于调整的网络设计以及教师、工作人员甚至学习者都能轻松设置网络的需求变得至关重要。

### 9.1 示例问题

PlaTIBART 的使用并未提供完整的解决方案，如 EPLASM 中所述，用于 MOOC 可扩展评估或仅用于 ITBA 的测试。但是，它提供了设计哲学、工具和方法，可实现可重复的个体 ITBA 和/或 ITBA 组件评估。在我们的课程中，无论是在范德堡大学还是在杨斯敦州立大学，我们都利用 PlaTIBART 协助创建了评估 ITBA 区块链组件的作业。此外，我们能够利用 PlaTIBART 为一系列与杨斯敦州立大学、杨斯敦商业孵化器合作举办的物联网讲座和研讨会配置了 25 × IoT 集群（思科路由器、4 × 树莓派 3B +、以太网电缆和物联网电子套件），并得到了思科的支持。^(e) 这些集群包括自定义 PDF 指南，通过 Python 操作电子套件所需的所有软件，以及在每个集群上操作以太坊网络所需的所有软件，包括在每个集群的第一个树莓派设备上安装的 PlaTIBART。

### 9.2 深度引导式演练

PlaTIBART 的设计好处在于，创建包含所有必需代码的 Docker 化容器，以便学生可以轻松开始学习区块链和配置物联网研讨会集群的唯一区别是轻微修改输入模型文件并更改分发给每个客户端的文件。图 14 展示了我们用于创建具有单个客户端和单个矿工的 Docker 镜像的模型输入，两者都在同一主机上使用本地主机 127.0.0.1，但网络管理器负责为它们提供不同范围的端口。

![图 14](img/f06-14-9780128171899.jpg)

图 14 区块链分配示例模型 json 文件。

现在，为了支持部署到实际的个体 ITBA 集群，唯一的要求是每个系统都已经有主机机器的公共 SSH 密钥，已安装了 geth，并接受 SSH 连接。

图 15 显示唯一需要更改的是调整 json 的“客户端”部分。增加客户端数量并更改客户端将安装在哪些 IP 上。这两种情况均通过与 7.1 和 7.2 讨论的完全相同的命令行指令完成，唯一的区别在于将哪些文件分发给了每个客户端。

![图 15](img/f06-15-9780128171899.jpg)

图 15 IoT/区块链集群配置示例模型 json 文件。

### 9.3 系统输出和分析

本节讨论的两个示例都被证明是可行的，并成功创建了 ITBA 组件教育评估。区块链课程的两个 Docker 镜像以及 IoT 和区块链研讨会的准备和指导都取得了成功。然而，这两者都没有进行深入的正式验证研究，而是被用作在教育场景中快速创建可重复的区块链测试网络的手段。因此，这些示例更多地展示了在设计未来 ITBA 任务时 PlaTIBART 设计的适应性。未来的工作将需要验证这种方法的有效性。

## 10 测试 IoT 和分布式系统规模的研究方向

分布式系统的规模化测试是一个持续的研究重点，将同时有许多不同的方法。区块链相关合同语言、系统和工具的正式验证，包括 PlaTIBART，是一个将继续关注的领域。此外，需要证明在教授 ITBAs 方面使用 PlaTIBART 的有效性验证；这是我们目前正在追求的研究领域。扩展 PlaTIBART 支持的网络拓扑结构是未来需要解决的工作，可能需要与网络模拟或管理软件集成。需要在单元测试和集成测试框架中包含私有测试区块链网络的工作已经进行了，目前至少对以太坊来说，在 Solidity IDE 之外进行集成测试似乎没有工具。 

## 11 个关键术语和定义

+   物联网区块链应用（ITBAs）：在物联网系统上运行的区块链应用，其中区块链被利用于从分布式日志记录到整合到物联网设备的指挥和控制决策过程等各种潜在用途。当区块链和物联网一起在系统中使用时，区块链和物联网用例场景都可能发生巨大变化。因此，我们使用这个术语来描述与物联网设备通过物理世界进行交互的区块链应用的增加复杂性。

+   在规模测试中：测试分布式系统比测试传统系统要花费更多的成本，无论是在复杂性还是所需资源方面，尝试测试一个完全集成的分布式系统与传统系统相比。这是因为完全测试一个分布式系统需要大量潜在异构的设备运行在潜在的多个平台和/或架构上。这不仅需要一种可以轻松运行每个新的整体系统变体的测试系统和方法，无论是硬件还是软件，而且还允许对性能、可靠性和其他指标进行一致的基准测试、分析和性能分析。 

## 参考文献

[1] HBR。*关于区块链的真相，HBR*。（访问日期：2017 年 01 月 08 日），2017 年 1 月 [`hbr.org/2017/01/the-truth-about-blockchain`](https://hbr.org/2017/01/the-truth-about-blockchain)。

[2] CoinMarketCap。*比特币 (BTC) 价格、图表、市值和其他指标，CoinMarketCap*。（访问日期：2017 年 08 月 30 日），2017 年 8 月 [`coinmarketcap.com/currencies/bitcoin/`](https://coinmarketcap.com/currencies/bitcoin/)。

[3] CoinMarketCap。*以太坊 (ETH) 381.84 美元 (上涨 3.83%)，CoinMarketCap*。（访问日期：2017 年 08 月 30 日），2017 年 8 月 [`coinmarketcap.com/currencies/ethereum/`](https://coinmarketcap.com/currencies/ethereum/)。

[4] 以太坊 Git 图书。*接口 | 以太坊前沿指南*。（访问日期：2017 年 08 月 30 日）[`ethereum.gitbooks.io/frontier-guide/content/interfaces.html`](https://ethereum.gitbooks.io/frontier-guide/content/interfaces.html)。2017 年。

[5] Github。*使用 RPC API Personal_SendTransaction 丢失硬币问题 #14901 · Ethereum/Goethereum，Github*。（访问日期：2017 年 08 月 30 日），2017 年 8 月 [`github.com/ethereum/go-ethereum/issues/14901`](https://github.com/ethereum/go-ethereum/issues/14901)。

[6] Bogner A., Chanson M., Meeuw A.在以太坊区块链上运行智能合约的分散共享应用程序。在：《第 6 届国际物联网大会，177–178。IoT’16》。德国斯图加特：ACM；2016：doi:10.1145/2991561.2998465 ISBN：978-1-4503-48140。

[7] Buccafurri F., Lax G., Nicolazzo S., Nocera A.克服物联网应用的区块链限制。在：《第 12 届可用性、可靠性和安全性国际会议，26：1–26：6。ARES ‘17》。意大利雷焦卡拉布里亚：ACM；2017：doi:10.1145/3098954.3098983 ISBN：978-1-45035257-4。

[8] Gubbi J., Buyya R., Marusic S., Palaniswami M.物联网（IoT）：愿景、架构要素和未来方向。《未来。计算机系统》2013 年；29（7）：1645–1660。

[9] Christidis K., Devetsikiotis M.区块链和智能合约用于物联网。《IEEE Access》。2016；4：2292–2303。

[10] Dorri A., Kanhere S.S., Jurdak R., Gauravaram P.物联网安全和隐私的区块链：智能家居的案例研究。在：IEEE 国际普适计算与通信研讨会（PerCom Workshops）2017 年；IEEE；2017：618–623。

[11] Ouaddah A., Abou Elkalam A., Ouahman A.A.致力于基于区块链技术的物联网隐私保护访问控制模型的创新。在：《欧洲和中东北非合作信息和通信技术进展》。Springer；2017：523–533。

[12] Kumaresan R., Bentov I.如何使用比特币激励正确计算。在：2014 年 ACM SIGSAC 计算机和通信安全会议论文集；ACM；2014：30–41。

[13] Delmolino K., Arnett M., Kosba A., Miller A., Shi E.逐步创建安全智能合约的经验和见解：来自加密货币实验室的教训。在：《金融密码学和数据安全国际会议》。Springer；2016：79–94。

[14] Walker M.A., Dubey A., Laszka A., Schmidt D.C. Platibart：一个可重复测试的传感器物联网区块链应用平台。在：*物联网中间件和应用程序第四届研讨会论文集.* ACM; 2017:17–22.

[15] Eisele S., Mardari I., Dubey A., Karsai G. *RIAPS：去中心化智能系统的弹性信息架构平台.* 在：[2017 IEEE] 第 20 届实时分布式计算国际研讨会（ISORC）; 2017:125–132\. May [`doi.org/10.1109/ISORC.2017.22`](https://doi.org/10.1109/ISORC.2017.22).

[16] ZeroMQ, Hintjens P. *ZeroMQ：指南，ZeroMQ.* URL [`zeromq.org`](http://zeromq.org). 2010.

[17] Cap'n Proto, Varda K. *Cap'n Proto.* 2015\. [`capnproto.org/`](https://capnproto.org/).

[18] Lee H., Niddodi S., Srivastava A., Bakken D. 在智能电网中使用分布式计算架构进行去中心化电压稳定性监控和控制。 在：*2016 IEEE 工业应用学会年会.* 2016:1–9\. October [`doi.org/10.1109/IAS.2016.7731871`](https://doi.org/10.1109/IAS.2016.7731871).

[19] GitHub. *JSON RPC—以太坊/Wiki.* 访问于 08/28/2017 [`github.com/ethereum/wiki/wiki/JSON-RPC`](https://github.com/ethereum/wiki/wiki/JSON-RPC). 2017.

[20] Lee E.A., Neuendorffer S., Wirthlin M.J. 嵌入式硬件和软件系统的面向演员的设计。 *J. Circuit. Syst. Comp.* 2003;12(03):231–260.

[21] Cazalet E., De Marini P., Price J., Woychik E., Caldwell J. *Transactive Energy Models.* 国家标准技术研究所技术报告; 2016.

[22] Melton R.B. *Gridwise Transactive Energy Framework.* 太平洋西北国家实验室技术报告; 2013.

[23] Brooklyn Microgrid, Brooklyn Microgrid - 主页。 [`brooklynmicrogrid.com/`](http://brooklynmicrogrid.com/). 2017.

[24] Sterling Ranch 开发公司。 *Sterling Ranch 的本质，Sterling Ranch 开发公司.* [`sterlingranchcolorado.com/about/`](http://sterlingranchcolorado.com/about/)。 2017.

[25] Walker M., Schmidt D.C., White J. 用于大规模软件作业评估的弹性平台（EPLASAM）。在：*大规模开放在线课程（MOOCs）的用户中心设计策略.* IGI Global; 2016:187–206.

## 进一步阅读

[26] Agrawal H., Horgan J.R., Krauser E.W., London S.A. *增量回归测试.* 在：会议论文集，1993 年软件维护会议; IEEE; 1993:348–357.

[27] Banafa A. *物联网与区块链的融合：好处与挑战—IEEE 物联网, IEEE.* 访问日期 08/31/2017 [`iot.ieee.org/newsletter/january2017/iot-and-blockchain-convergence-benefits-and-challenges.html`](https://iot.ieee.org/newsletter/january2017/iot-and-blockchain-convergence-benefits-and-challenges.html)。 2017.

[28] Beck R., Stenum Czepluch J., Lollike N., Malone S. *区块链——无需信任的加密交易门户.* ECIS; 2016 ResearchPaper153.

[29] Dubey A., Karsai G., Pradhan S. *物联网系统中边缘的韧性.* 在：2017 年第二届雾计算与移动边缘计算国际会议（FMEC）; IEEE; 2017:139–146.

[30] Leung H.K.N., White L. *关于集成测试和软件回归的集成级别研究.* 在：会议论文集，1990 年软件维护会议; IEEE; 1990:290–301.

[31] Mirkovic J., Benzel T. 使用 DeterLab 进行网络安全教学。*IEEE 安全与隐私.* 2012;10(1):73–76.

[32] Rothermel G., Untch R.H., Chu C., Harrold M.J. 将测试用例按照回归测试的优先级排序。*IEEE 软件工程交易.* 2001;27(10):929–948.

[33] Siaterlis C., Garcia A.P., Genge B. 关于使用 Emulab 实验平台进行科学严谨实验的研究。*IEEE 通信调查与教程.* 2013;15(2):929–942.

[34] Simić M., Sladić G., Milosavljević B. *物联网和区块链驱动的医疗保健案例研究.* 2017 年 6 月，收录于：第八届 PSU-UNS 国际工程与技术会议（ICET-2017）。

[35] Github. *有时，交易会从 Txpool 中消失，而不是被挖掘进入下一个区块—问题 #14893—以太坊/Go-Ethereum.* 2017 年。[`github.com/ethereum/go-ethereum/issues/14893`](https://github.com/ethereum/go-ethereum/issues/14893).

[36] Zhang F., Cecchetti E., Croman K., Juels A., Shi E. *城镇信使：智能合约的认证数据源.* 收录于：2016 年 ACM SIGSAC 计算机与通信安全会议论文集；维也纳，奥地利：ACM；2016 年：270–282。isbn: 978-1-45034139-4。CCS ’16 [`doi.org/10.1145/2976749.2978326`](https://doi.org/10.1145/2976749.2978326)。

**Michael A. Walker 先生**是一位攻读计算机科学博士学位的研究生助理，就读于美国田纳西州纳什维尔的范德堡大学。目前，他是杨斯顿州立大学计算机科学与信息系统系的讲师。他曾于[2011 − 2013 年]在范德堡大学获得计算机科学硕士学位，并于 2006 年至 2011 年在杨斯顿州立大学获得计算机科学学士学位。

Mr. Walker 的研究兴趣包括分布式系统、大规模学习、隐私、安全和软件设计模式。他在各种会议、研讨会和国际著名期刊上发表了超过 11 篇研究论文，包括 IEEE 和 ACM。他参与了 10 门大规模开放在线课程，担任三门课程的教学人员和四门课程的讲师。他是几个非营利组织的现任和前任董事会成员，致力于推广科学、技术、工程和数学教育，重点关注计算机素养和科学理解，特别是惠及来自贫困背景的年轻女孩。此外，他还就弥合非传统学生之间的学术和产业分歧问题进行了多次会议演讲。

**Douglas C. Schmidt 博士**是范德堡大学的康奈利斯·范德比尔特计算机科学教授、研究发展和技术副教务长、数据科学研究所联合主席以及软件集成系统研究所的高级研究员。他的研究涵盖了一系列与软件相关的主题，包括模式、优化技术以及用于分布式实时嵌入式系统和移动云计算应用的中间件框架的经验分析。

施密特博士已发表了 12 本书和超过 600 篇技术论文，涵盖了一系列与软件相关的主题，包括模式、优化技术以及框架和模型驱动工程工具的实证分析，这些工具有助于开发在无线/有线网络和嵌入式系统互连上运行的任务关键型中间件和移动云计算应用。在过去的三十年里，施密特博士一直领导着 ACE 和 TAO 的开发，这是一些最成功的软件研发范例之一，已经从研究转向产业。

施密特博士分别于 1984 年、1986 年、1990 年和 1994 年从弗吉尼亚州威廉斯堡的威廉玛丽学院获得社会学学士和硕士学位，以及从加利福尼亚大学尔湾分校获得计算机科学硕士和博士学位。

**阿比舍克·杜贝**是范德堡大学电气工程和计算机科学的助理教授，也是软件集成系统研究所的高级研究科学家，范德堡智慧城市运营和研究计划的联合负责人。他的研究兴趣包括用于动态和有弹性的人类网络物理系统的模型驱动和数据驱动技术。他在大学指导着智能计算实验室（[scope.isis.vanderbilt.edu](https://na01.safelinks.protection.outlook.com/?url=http%3A%2F%2Fscope.isis.vanderbilt.edu&data=02%7C01%7Cabhishek.dubey%40Vanderbilt.Edu%7Cc1bc5ff6ca16470115b908d5c176ef8d%7Cba5a7f39e3be4ab3b45067fa80faecad%7C0%7C0%7C636627638934148505&sdata=7jGNtuWHa9XybgoJEZO0EC8G25k6eMbbeyRLG1fDzoI%3D&reserved=0)）。该实验室在分布式系统、大数据和网络物理系统的交叉领域开展研究，尤其是在交通和电力网络领域。阿比舍克于 2009 年从范德堡大学取得电气工程博士学位。他于 2005 年 8 月从范德堡大学获得电气工程硕士学位，并于 2001 年 5 月从印度理工学院班拉斯大学取得电气工程学士学位。他是 IEEE 的高级成员。

* * *

^(a) [`nixos.org/`](https://nixos.org/).

^(b) RIAPS 使用 ZeroMQ [[16]](S0065245819300348.xhtml#bb0085)和 Cap'n Proto [[17]](S0065245819300348.xhtml#bb0090)来管理通信层。

^(c) [`github.com/ethereum/go-ethereum/wiki/geth`](https://github.com/ethereum/go-ethereum/wiki/geth).

^(d) “balance” 仅适用于在创建新区块链之前创建的帐户。在区块链创建之后创建的帐户，无论是公共的还是私有的，都不会收到任何初始余额。

^(e) [`oh-iot.com/`](https://oh-iot.com/).
