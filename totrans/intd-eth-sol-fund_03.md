© Chris Dannen 2017Chris DannenIntroducing Ethereum and Solidity10.1007/978-1-4842-2535-6_3

# 3. 以太坊虚拟机（EVM）

以太坊虚拟机（EVM）是一个全球性的计算机，任何人都可以使用，只需支付一小笔以太币 Chris Dannen^(1 )(1)美国纽约布鲁克林 EVM 是一个单一的全球性 256 位“计算机”，在网络的每个节点上，所有交易都是本地化的，并以相对同步的方式执行。这是一个全球可访问的虚拟机，由许多较小的计算机组成。这台巨型计算机，任何拥有节点或钱包应用的人都可以访问，使得几乎可以即时地移动任意数量的价值（货币）。虽然任何人都可以使用这个全球虚拟机，但没有人可以在其中创建假币，或未经许可移动资金。如果整个 EVM，所有那些节点，复制相同的交易并在成千上万个个人计算机之间奴性地维护相同的状态，这似乎是浪费的，那么对比一下当今金融服务 IT 工作的适当基础是很重要的。与金融服务 IT 相比，EVM 是简洁高效的典范！更重要的是，所有这些工作并不是白费力气。事实上，正如您将在本章中看到的那样，正是这项工作的证据实际上保护了网络。

## 昨天的中央银行网络

如今，各大企业、保险公司、大学和其他大型机构都花费了大量资金来构建和维护软件服务以及为自己的员工和业务线提供的 IT 支持。它们的各种收入和支出由大型商业银行进行对账，这些银行有自己的架构、政策、代码库、数据库和基础设施层。当然，这还不算 Fedwire 系统，这是美联储的实时毛额结算系统，简称 RTGS。美联储是美国的中央银行。Fedwire 系统由所有美联储成员银行用于以电子美元进行最终支付结算。任何合格的州立特许银行都可以通过购买股份成为该系统的成员。Fedwire 系统由 12 家美联储银行自己拥有和运营，尽管它收取费用，但它并非盈利性运营。这个系统每天处理着无法想象的美元金额——以万亿计。它还有一些很棒的特性：所有现有和批准的账户都有透支系统，而且该系统以其在海外汇款方面的可靠性而闻名。它或多或少以某种形式运行了大约 100 年。正如你所想象的那样，维护 Fedwire 软件的安全性和可靠性是极其昂贵的。然而，构建和维护在 RTGS 之上的各个层次的成本更高，这归因于其安全要求。最终，这些成本通过费用转嫁给了使用商业银行的企业。这些公司有自己的 IT 基础设施成本。总的来说，这些成本最终会推高消费者的价格和费用。

## 什么是虚拟机？

如果你在阅读本书之初对虚拟机不太熟悉，那么到现在你可能已经明白，在以太坊的语境中，虚拟机（VM）是一个由构成节点组成的一个巨大的全球计算机，这些节点本身也是计算机。一般来说，虚拟机是一个计算机系统通过另一个计算机系统进行仿真。这些仿真是基于与其仿真目标相同的计算机体系结构，但通常在与其可能设计用于的不同硬件上再现该体系结构。虚拟机可以使用硬件、软件或两者创建。在以太坊的情况下，两者都有。与 Fedwire 一样，以太坊没有安全地连接成千上万台离散的机器，而是采取了一种安全地运行一个非常庞大的机器的方法，该机器可以覆盖整个地球。从以太坊客户端的长列表中可以看出，EVM 是在成千上万台机器上运行的集体仿真，在个别级别上，这些机器可能正在运行 Windows、Linux、ethOS 和 macOS 等几十种不同版本中的任何一种（有关 ethOS 的更多信息，请参见第六章）。

### 以太坊协议在银行业中的角色

这本书的范围不足以断言基于区块链的系统是否适合被主权中央银行使用，或者是否确实可以取代它们。更有可能的是，中央银行自身将采用这项技术。商业银行当然也感兴趣；您可以在第十一章找到更多关于参与以太坊开发的银行和企业的信息。Fedwire 系统是一个结算系统，其用户体验专为州特许银行及其运营商量身定制。例如，对于零售银行的最终用户，它几乎没有任何关注或关心；这是零售银行的职责。软件开发人员将 Fedwire 视为“银行平台”。银行选择在 Fedwire 之上构建的内容（客户体验、在线银行工具、实体分支机构、金融产品、跨销售）是使其与 Fedwire 系统上的其他银行区别开来的因素。

### 任何人都可以制作银行平台

以太坊（Ethereum）更加通用。它允许任何人创建一个具有与 Fedwire 相同或更好的安全性和可靠性的网络，并且具有几乎即时进行安全价值转移的能力。但这只是以太坊的起点。开发者可以在这个安全账本上构建任何类型的金融产品或业务逻辑，使用自动化和不可变的脚本，而无需支付传统中心化托管和银行基础设施所带来的额外负担。但是它是否能够扩展到像 Fedwire 这样的系统的速度和规模？答案是，是可以的，但这需要数年的时间。交易大小或区块大小都没有直接或固定的限制。在比特币中，区块的大小限制为 1MB，大约相当于每秒 7 笔交易。在以太坊中，这些限制会根据需求和网络容量的变化而增加和减少。然而，这并不意味着区块可以无限大小。请记住，以太坊网络中的工作单位是以 gas 为价格计价的。因此，更大、更复杂的智能合约需要更多的 gas 来存储和执行。每个区块可以花费的 gas 的最大金额是可变的，但是有一个最大值。理论上，一笔大型交易可以消耗单个区块的整个 gas 限制。但如果对更高 gas 限制有持续需求，系统将以 0.09%的增量增加每个区块的 gas 限制。（有关此操作原理的更多详细信息，请参阅以太坊黄皮书，方程式 40-42。）截至撰写本文时，每个区块的 gas 限制为 4,041,325 gas。这对金融服务行业意味着什么？当然不是末日，但也许会出现一些意想不到的竞争。随着公共以太坊链的扩展，并且能够处理更多的交易，速度越来越快，可能会导致银行服务逐渐分拆为越来越小的品牌。2016 年，主持以区块链为中心的播客《Unchained》的作家兼主持人 Laura Shin 采访了旧金山区块链初创公司 Chain 的 Adam Ludwin，并撰写了这篇文章：

> 谁拥有这个网络，在当前系统中，如果你去 Chase 存入$50 现金，Chase 持有那笔钱，这笔钱是由联邦储备发行的，并在其网络上交易。但 Ludwin 说，你可以想象，与其由银行运行网络，不如将 Fedwire，即当前用于成员银行之间电子结算付款的系统，重建在一个区块链上，银行持有转账的密钥。这可能导致非金融机构成为这种货币的保管人。“对于足够小的金额，你不需要银行，”Ludwin 说。“Google、苹果、Facebook 可以持有少量的数字现金吗？这是否改变了保管人的模式或可能的保管人？答案是肯定的。”这也可能为点对点借贷开辟更多途径，减少消费者对银行贷款的依赖。 ¹

## 以太坊虚拟机的功能

到目前为止，EVM 可能已经成为焦点：一个通用的、安全的、无所有者的虚拟机，提供廉价的 Fedwire 类似功能，以及其他一堆魔法。它究竟是如何做到这一点的呢？EVM 可以运行任意的计算机程序（在第一章提到的智能合约中所提及的），这些程序是用 Solidity 语言编写的。给定特定的输入，这些程序将以相同的方式始终产生相同的输出，带有相同的基础状态更改。这使得 Solidity 程序完全确定性，并且保证执行，前提是你为交易支付了足够的费用；但我们将在本章后面讨论支付 gas 费用的问题。Solidity 程序能够表达计算机可以完成的所有任务，从理论上讲，它们是图灵完备的。这意味着整个分布式网络，每个节点，都执行平台上执行的每个程序。当一个用户通过他们的以太坊节点上传一个智能合约时，它被包含在最新的区块中并在网络中传播，存储在网络中的每个其他节点上。正如我们已经讨论过的那样，作为区块处理协议的一部分，EVM 中的每个节点的工作是运行相同的代码。节点通过它们正在处理的区块并运行其中的任何代码。每个节点都独立进行此操作；它不仅高度并行化，而且高度冗余。尽管所有迹象表明，这是一种以可信赖的方式平衡全球会计帐的高效方法。重要的是要记住，每个银行无论在何处都要花费多少资金、权力和人力来拼凑出自己独特的 IT 系统或每一条业务线的系统混合体。在基于以太坊的银行系统中，所有用户（无论是企业还是客户）都可以免费直接访问相同的 Fedwire 类似系统，并具有编程交易的能力。由于协议是免费的并且是开源的，任何人都可以启动一个节点并连接。不幸的是，尽管在加密货币讨论中，通常会忽略对 Fedwire 系统的前述解释，但理解大型公共区块链的好处是必要的背景。您可以在 Homestead 文档计划中找到最新的社区编写的以太坊项目文档（ [www.ethdocs.org/en/latest](http://www.ethdocs.org/en/latest) ）。这些文档没有得到以太坊基金会的认可，但已经成为一个流行的资源，因为它们对技术概念进行了简明的解释。要进行更复杂的技术讨论并查看以太坊改进提案（EIPs），请转到以太坊 wiki（[`github.com/ethereum/wiki/wiki`](https://github.com/ethereum/wiki/wiki)）。在维基上，您将找到以太坊白皮书。如果您在阅读本书后仍有关于以太坊工作方式的问题，那么您寻找的答案很可能在白皮书或前述的 Yellow Paper 中，您也可以在以太坊维基中找到这些链接。第十一章提供了与以太坊项目相关的学术论文的附加索引。这些论文涉及项目的未来，包括与私有或企业链的可扩展性和互操作性等主题。全局单例机器 EVM 是一个具有共享状态的事务单例机器。在计算中，这意味着它的行为就像一个巨大的数据对象，而不是它是什么：一个由单个机器组成的网络，这些机器本身是单例，并且在不断地通信中。（如果你是非程序员，你可能还记得在第一章中提到的一个对象是一个被格式化的小块信息，它包含属性以及用于读取或更改这些属性的方法。）

## EVM 应用被称为智能合约

从软件开发者的角度来看，EVM 也是一个可以执行网络中的小程序的运行时环境。

### 名称“智能合约”

与其让你听我翻译这个词的词源，让我们澄清一件事：在这个上下文中，合约指的是一种特定类型的合约：金融合约，也更通俗地称为衍生品或期权。金融合约是一种同意在未来某个时间点以指定价格买入或卖出的协议。在以太坊的上下文中，智能合约是账户之间的协议，在满足某些条件时执行以太（即支付）。这些合约之所以“智能”，是因为它们由机器执行，并且资产（以太或其他代币）会自动转移。即使在编写合约数百年后，这些合约也可以执行，假设网络仍在运行中——即使有很多不良行为者试图干扰。EVM 是完全沙箱化的，没有受到干扰，并且与其他网络隔离，使得某一方无法退出智能合约。在实际操作中，这是因为智能合约被赋予了托管资产（以太或其他代币）并在合约条款满足时移动它们的权力。

### EVM 执行字节码

EVM（以太坊虚拟机）有自己的语言，即 EVM 字节码，您的智能合约会编译成该字节码。Solidity 是一种高级语言，会被编译成字节码，并通过客户端应用程序（如 Mist 浏览器或完整节点）上传到以太坊区块链上。

## 理解状态机

正如我们之前多次讨论过的，EVM 是一个状态机。与其简单地定义这个概念然后继续，让我们花一点时间讨论一下计算机究竟是什么，然后再讨论以太坊如何推进这个概念。

### 数字与模拟

构建状态计算机的基础概念是开关的概念，它可以开或关。常说的机器通用语 1 和 0，实际上指的是一系列形象的开关，这些开关按特定配置排列以编码特定的字母、数字或其他键盘符号。键盘上的所有符号（以及更多符号）都可以仅用八个开关来表示，这就是为什么计算内存以八的倍数堆叠的原因。例如，逗号的所谓字符代码是 0010 1100。在计算机编程中，字母和数字可以用来编写俗称为代码的机器指令。美国研究员、美国海军少将格蕾丝·霍普尔在图 3-1 中展示，发明了第一个编译器，它可以自动将人类可读的代码转换成机器代码（如 EVM 的字节码），这种代码较不抽象，因此更接近我们常听说的 1 和 0。²![A433414_1_En_3_Fig1_HTML.jpg](img/A433414_1_En_3_Fig1_HTML.jpg)图 3-1.1944 年，少将格蕾丝·霍普尔是最早为哈佛大学的马克一号计算机编写代码的程序员之一。（图片来源：维基百科。）

### “声明”

单独的代码片段，当单独考虑时，大致可分为两类：表达式和语句。 表达式用于评估特定条件； 语句（注意根词！）用于将信息写入计算机的内存中。 表达式和语句一起使计算机能够在满足特定条件时以可预测的方式修改数据库。 这是自动化的关键，也是我们发现计算机如此有用的原因！ 语句可以评估为真或假，并且根据代码的不同，此二元结果可能导致信息被添加，删除或更改到计算机的众多内存地址之一。（由于 Solidity 语言是强类型的，因此没有类似于 JavaScript 中的“真值”和“假值”语句。）真和假之间的明确区别，是允许计算机安全地做出决策而不是人类的原因。

### 数据在状态中的作用

每当你改变计算机内存中的数据时，你可以将其无数的内部开关（其中大多数是以与本章前面讨论的方式虚拟化的）视为略有不同的配置。状态通常指系统的当前状态：信息的客观变化序列，跨越机器的各种内存地址，导致其内存的当前内容。区分属性和状态非常重要。状态是一种可以轻松而可预测地改变的东西。让我们以汽车为例。重新漆车是一项艰苦的工作，但是可以做到。油漆颜色是属性的一个例子。在伪代码中，你可以这样说一辆车：bodyColor = red。在计算机编程中，这被称为键/值对。键 bodyColor 分配了一个值，即红色。要更改此键的值，您的代码会将新值声明为其他内容：bodyColor = green。现在你的车被重新喷漆了。它有了一个新的颜色值。现在假设你指示计算机，这辆车的颜色会经常改变。换句话说，你将汽车的颜色设置为一个变量。嗯，可以说变量（在本例中是颜色）可以有一个状态，即一个变化的值。但是，像绿色这样的单个值没有状态；绿色只是绿色而已。里程表提供了另一个具有可变状态的变量的例子。里程表的值可能是 1,000，这个数字本身没有状态；它只是一个数字。很快，里程表的状态将更改为新值（1,001），但只有当汽车的驾驶舱表达出导致发动机和变速器从空档到一档等状态改变的命令时才会发生。熟悉状态转换概念将帮助非程序员洞察设计分散系统所面临的真正困难的问题。本章的接下来几节提供了一个快速入门。

## EVM 的内部工作原理

如果这是你第一次接触计算机内部，重要的是要记住，只要计算机通电，它就永远不会真正“休息”。计算机本身正在运行一个状态函数，不断检查其状态是否有变化。这就像一个急切的实习生，每秒数千次地想知道是否有新的工作落在他的桌子上。当触发新的指令时，计算机会运行代码，并可能将新数据写入其内存。重要的是要注意，每个状态变化都必须基于上一个状态变化；计算机不会随意将信息扔进内存地址。如果出现问题——比如说某个指令在数学上是不可能的——机器的状态将变为无效，并且程序将退出或停止。事实上，整个系统可能会崩溃。不断检查特定条件的程序称为编程中的循环，因为它们会持续运行（循环）直到满足指定的条件。EVM 不断运行一个循环，尝试执行当前程序计数器上的任何指令（即“正在处理的”程序）。程序计数器的工作原理类似于熟食店的队列：每个程序都会取一个号码然后等待轮到它。这个循环有几个任务：它计算每条指令的气体成本；如果需要，它会使用内存来执行事务，如果前提计算成功。这个循环重复，直到 VM 完成运行所有的待处理代码，或者抛出异常或错误，并且该事务被回滚。到目前为止，我们已经轻松地走过了一个世纪的计算机科学，只是为了赶上 EVM。现在我们将开始放慢脚步，看看一些部件是如何运作的。  

### EVM 不断检查交易  

状态机（具有内存的机器）可以被认为是永不休息的存在。作为一个状态机，以太虚拟机（EVM）在它们的内存银行中具有所有交易的恒定历史，一直延伸到第一笔交易。与人不同，人们必须应对不完美的记忆，计算机的状态（如今的状态）是自它首次开机以来该机器内发生的每一个状态变化的具体结果。该机器最新版本的状态可以说是这台机器关于现实的权威“真相”，就目前而言。在以太坊中，这个真相涉及账户余额和使您的余额成为今天所处状态的一系列交易。

### 创建一个共同的机器叙事，描述发生了什么

因此，交易代表了一种机器叙事——一个在一个状态和另一个状态之间的计算有效的弧。正如加文·伍德的以太坊黄皮书所言：

> 无效的状态变化远远多于有效的状态变化。无效的状态变化可能是诸如减少账户余额而没有在其他地方进行等量且相反的增加等事情。有效的状态转换是通过交易发生的状态转换。³

随着时间的推移，系统（比特币中的系统）寻求创建一个可信的历史，以确保每个后续的状态变化都是合法的，并且不是由恶意行为者插入的指令。

### 加密哈希

下一节将解释区块：它们包含什么，它们如何工作以及它们如何构成链。为了正确理解该讨论，您首先需要了解加密哈希算法以及它们的作用。

### 什么是哈希函数（或哈希算法）

一般而言，在区块链的背景下，哈希函数的目的是快速比较大型数据集并评估它们的内容是否相似。 一种单向算法将整个区块的交易处理为 32 字节的数据——一个哈希，或者说是一串字母和数字的字符串，不包含有关其中交易的可辨识信息。 哈希为区块创建了一个独特的签名，允许下一个区块在其上构建。 与加密结果的密文不同，后者可以解密，哈希的结果不能被“取消哈希化”。 注意：给定数据集的哈希始终相同。 计算上，两个数据集可能解析为相似的哈希是不可行的。 改变数据集中的任何一个字符将完全打乱哈希。

## 区块链：状态变化的历史

在以太坊网络中，交易和状态变化被分割成区块，然后进行哈希处理。在“顶部”放置下一个规范区块之前，每个区块都会被验证和验证。通过这种方式，网络上的节点不需要单独评估以太坊网络历史上每个单独区块的可信度，仅仅是为了计算网络上账户的当前余额。他们只需验证其“父区块”是否是最近的规范区块。他们通过查看新区块是否包含其父区块的交易和状态的正确哈希来快速完成此操作。所有这些区块被串在一起，包括创世区块，这是网络上线后挖掘的第一个区块的荣誉描述，被称为区块链。在一些圈子中，你会听到人们将区块链称为分布式账本或分布式账本技术（DLT）。账本是一个准确的描述，因为该链包含了网络历史上的每一笔交易，使其实际上成为一个巨大的、平衡的账户簿。然而，大多数所谓的数字账本并不使用工作量证明来保护网络，就像比特币和以太坊那样。

### 理解区块时间

在比特币中，一个区块是 10 分钟。这个所谓的区块时间是从硬编码到比特币发行方案中导出的常量，总共有 2100 万枚硬币将在 2009 年至 2024 年发行，并且每四年减半一次奖励。⁴在以太坊中，区块时间不是以太的发行计划的一个函数。相反，区块时间是一个变量，尽可能保持低，以便进行快速交易确认。截至本文撰写时，平均约为 15 秒。以太坊较短的区块时间是比特币发布后进行的区块链研究的受益者，该研究表明较短的区块时间不仅在技术上可行，而且在许多方面都是可取的。然而，较短的区块时间确实具有一些缺点，在第六章中更详细地探讨了这些缺点。

### **短区块的缺点**

需要注意的是，比特币的长确认时间使得零售商业和其他实际应用变得困难。当区块更短，交易更快时，用户体验更好。然而，更短的区块和更快的交易使得某个节点更有可能将交易顺序弄错，因为它可能没有听说过一些来自遥远地方的交易（或者听说得很晚）。为了补偿这一点，找到有效但最终未成功的区块的矿工会获得一笔较低的费用作为安慰。在以太坊中，这些区块被称为叔叔。什么使一个区块有效与赢家的区别是第六章的主题。要查看完整的以太坊区块协议，请访问 [`github.com/ethereum/wiki/wiki/Block-Protocol-2.0`](https://github.com/ethereum/wiki/wiki/Block-Protocol-2.0)。现在，让我们继续概述以太坊虚拟机。

### “独立节点”区块链

从理论上讲，你可以用一台单独的计算机来调和来自多个节点的更改：一个集中式服务器处理交易顺序。实际上，诸如 Google Docs 等 Web 应用程序拥有复杂的实时引擎，帮助它们处理多个用户所做的冲突更改，其中一些用户可能连接速度更快，还有些用户可能在离线编辑文档。当你在第九章中启动自己的区块链时，你会发现可以使用以太坊协议与一台单独的计算机。只要有一个或多个节点在链上进行挖矿，它就会很好地处理你的交易。但是，如果有人将该计算机断开网络，你的链就无法访问，交易也会停止进行。因此，尽管以太坊是免费和开放的软件，但许多节点创建一个弹性网络的必要性导致开发人员趋同，并且（在很大程度上）作为一个社区，在一小部分公共链上工作。

### 分布式安全

以太坊虚拟机的分布式特性，以及由世界各地的许多节点组成的事实，意味着它必须被专门构建以解决当有许多近乎同时的更改发生在来自世界各地的许多用户对同一数据库的情况下可能出现的差异匹配问题。的确，在一个可验证和可信赖的方式解决这个问题是 EVM 以及比特币虚拟机的目的。EVM 的韧性和安全性来自于在网络上进行挖矿的大量机器，这些机器被激励通过以以太币或比特币计价的费用来赚取收益。在我们深入解释之前，我们将简要介绍一下这个问题，在第六章中进行全面解释。

## 挖矿在状态转换函数中的位置

挖矿是使用计算工作来提名一个区块——即最近交易历史的矿工版本——作为链上最新区块的规范区块的过程。究竟如何实现这一点是第六章的主题，但现在提出这一点的目的是为了显示挖矿激励奖励是作为状态转换函数的一部分而发生的。挖矿实现了达成共识所需的条件，矿工们因为为共识建立做出贡献而得到报酬。这就是以太和比特币是如何“创造”的。回顾一下，每次创建新区块时，它都会被网络上的节点下载、处理和验证。在处理过程中，每个节点执行其中包含的所有交易。这是一个漫长的过程，有许多步骤，但我们会概括。以英文写出来，以太坊状态转换函数可以定义为以下六个步骤。⁶ 对于块中的每个交易，EVM 执行以下操作：

1.  检查交易是否以正确格式存在。它是否具有正确数量的值？签名是否有效？交易上的 nonce——交易计数器——是否与账户上的 nonce 匹配？如果有任何缺失，则返回错误。

1.  计算交易费用，将所需工作量（由 STARTGAS 表示，如表 3-1 所示）乘以燃气价格。然后从用户的账户余额中扣除费用，并增加发送方的 nonce（交易计数器）。如果账户中的以太不足，则返回错误。表 3-1.常见 EVM 操作的成本

    | 操作名称 | 燃气成本 | 描述 |
    | --- | --- | --- |
    | step | 1 | 每个执行周期的默认量 |
    | stop | 0 | 免费 |
    | suicide | 0 | 免费 |
    | sha3 | 20 | SHA-3 哈希函数 |
    | sload | 20 | 从永久存储中获取 |
    | sstore | 100 | 存储到永久存储 |
    | balance | 20 | 查询账户余额 |
    | create | 100 | 合同创建 |
    | call | 20 | 发起只读调用 |
    | memory | 1 | 扩展内存时的每个额外字 |
    | txdata | 5 | 每个交易的数据或代码的每个字节 |
    | transaction | 500 | 基础费用交易 |
    | contract creation | 53,000 | 从 Homestead 中的 21,000 改变 |

1.  3.初始化 gas 支付；从这一点开始，每处理一个交易的字节就会消耗一定数量的 gas。

1.  4.将交易的价值——发送的金额——转移到接收账户。如果接收账户尚不存在，则将创建它。（离线以太坊节点可以生成地址，因此网络可能在交易发生之前不会知道特定地址。）如果接收地址是合约地址，则运行合约的代码。这将继续执行，直到代码执行完毕或 gas 用尽。

1.  5.如果发送账户没有足够的以太完成交易，或者 gas 用尽，那么此交易的所有更改都将被回滚。一个例外是费用，仍然会发送给矿工，而不会退还。

1.  6.如果交易因其他原因出错，将 gas 退还给发送者，并将任何与 gas 使用相关的费用发送给矿工。

注意：智能合约数据在状态转换函数的第 4 步中执行，如上所述。

## 在以太坊虚拟机上购买时间

你可能已经注意到，以太坊虚拟机（EVM）是一台非常谨慎的机器，尽管比起今天我们所拥有的任何网络，它更加值得信赖和可靠。对于每个以太坊虚拟机执行的指令，都必须有一个相关的成本，以确保系统不会被无用的垃圾合约堵塞。每次执行指令时，内部计数器会跟踪产生的费用，并将其收取给用户。每当用户发起交易时，该用户的钱包会预留一小部分（由用户选择）用于支付这些费用。在从给定节点向网络广播了交易之后——比如说，Bob 从他的电脑向 Alice 发送了一些以太币——网络会将该交易传播到各个节点，以便它们都能将其包含在最新的区块中。信不信由你，到目前为止，在本章中所解释的内容几乎只是触及了以太坊虚拟机内部的表面。你将在第五章和第六章中学到更多。现在，拆解费用、它们在交易执行中的作用以及对开发模式的影响将是有用的。

## 你好，Gas

Gas 是一个用来衡量以太坊操作的计算成本的单位。Gas 成本是用少量的以太币支付的。Gas 的目的有两个。首先，它为执行代码和保护网络的矿工们提供了预付的奖励，即使执行由于某种原因失败。其次，它解决了停机问题，并确保执行时间不会超过预付的时间。Gas 是一个工作单位；它不是一种子货币，你不能持有或囤积它。它只是衡量每个交易步骤在计算方面需要付出的努力有多大。为了能够支付 Gas 成本，你只需向你的账户添加以太币即可。你不必单独获取它；没有 Gas 代币。EVM 上的每个操作都有一个相关的 Gas 成本。注意：总 Gas 使用量与支付的 Gas 价格相乘，将得到给定交易所产生的总费用。

### 为什么 Gas 如此重要？

Gas 成本确保了网络上的计算时间得到了适当的定价。这在比特币中的工作方式不同，那里的费用是基于交易大小（以千字节计）的。由于 Solidity 代码可以是任意复杂的，一个简短的指令片段可能会生成大量的计算工作，而一个长的片段可能会生成较少的工作。这就是为什么 EVM 中的费用是基于正在进行的工作量而不是交易大小的原因。

### 为什么 Gas 不以以太币计价？

因为以太币在加密货币交易所上公开交易，所以受到投机性通货膨胀和紧缩周期的影响。使用 Gas 作为计算工作的单位很有帮助，因为它将计算价格与以太币代币的高度波动的价格分开。

### 作为监管的费用

正如你在第七章中所看到的，比特币和以太坊等网络使用经济激励和惩罚来使某些攻击向量无效。费用属于惩罚类别。首先，重要的是要认识到以太坊节点的运行代表了一定的风险。硬件成本、运营者的时间和精力以及网络下载和验证工作证明和区块头的成本都在其中。因此，设立交易费用是有道理的，以防止恶作剧者浪费网络的容量。在以太坊中，消耗过多气体的区块是一个很大的危险。由于它们的体积庞大，它们可能需要很长时间才能传播。系统如何适应用户的需求（用户可能对大型智能合约有合法的用途）将在本章后面以及第六章中变得清楚。协议通过各种方法来截断晚到的区块，我们将在第六章中探讨这些方法，并对操作进行浮动限制，目前每个区块的操作数为 65,536 个。⁷

## 处理气体

在本节中，您将探索与气体的工作细节，然后了解气体与系统扩展的关系。

### 气体特性

让我们回顾一些关于处理气体的细节：

+   不幸的是，术语“gas”造成了一些混淆。每个交易都需要一个 STARTGAS 值。这个值在黄皮书中被称为 gasLimit，在 Geth 和 Web3.js 中通常被简称为 gas。

+   每个交易还需要用户指定一个气价。

+   在执行交易时，由 STARTGAS 规定的数量乘以气价被存入托管。

+   如果你为交易提供的气价太低，节点将不会处理你的交易，它将无法处理在网络上。

+   如果您的 Gas 价格对网络来说是可以接受的，但 Gas 成本超出了您钱包余额中可用的数量，那么交易将失败并被回滚；这笔失败的交易将被记录到区块链中，并且您将获得未在交易中使用的任何 STARTGAS 的退款。

+   使用过多的 STARTGAS 并不能使您的交易更快处理，在某些情况下，可能会使您的交易对矿工不那么有吸引力。⁸

### Gas 与系统扩展的关系

如果您向 EVM 发送了一组计算难度很大的指令，受影响的仅是您自己。这项工作将花费您的以太币，并在您分配给交易的以太币用尽时停止。它不会影响其他人的交易。除非支付大量的交易费用，否则没有办法阻止 EVM，以太币将以交易费用的形式支付。系统的扩展是通过 Gas 费用系统以事实方式处理的。矿工可以自由选择支付最高费率的交易，并且还可以集体选择区块的 Gas 上限。Gas 限制确定每个区块可以发生多少计算（以及可以分配多少存储）。通过这种方式，EVM 上的计算价格保持灵活，并能对系统用户的需求以及处理交易、维护硬件和支付电费等重要工作所产生的成本作出响应。

## 账户、交易和消息

在第二章中我们回顾了以太坊有两种类型的账户：

+   外部拥有账户

+   合约账户

让我们更深入地了解每种账户类型可以做些什么。

### 外部拥有账户

外部拥有账户（EOA）也称为由一对私钥控制的账户，这些私钥可以由个人或外部服务器持有。这些账户不能持有 EVM 代码。EOA 的特征包括以下内容：

+   包含以太币余额

+   能够发送交易

+   受账户私钥控制

+   没有与之关联的代码

+   每个账户中包含的键/值数据库，其中键和值都是 32 字节的字符串

### 合同账户

合同账户不受人类控制。它们存储指令，并由外部账户或其他合同账户激活。合同账户具有以下特征：

+   有以太币余额

+   在内存中保存一些合同代码

+   可以由人类触发（发送交易）或其他合同发送消息来触发

+   执行时可以执行复杂的操作

+   有自己的持久状态，并且可以调用其他合同

+   被释放到 EVM 后不再有所有者

+   每个账户中包含的键/值数据库，其中键和值都是 32 字节的字符串

## 交易和消息

交易来自外部账户，这些账户通常由人类用户控制。这是外部账户向 EVM 提交指令以执行某些操作的一种方式。换句话说，这是外部账户将消息发送到系统的一种方式。在计算术语中，消息是包含指令的数据块。程序员可以将消息视为函数调用。EVM 中的交易是一个包含加密签名的数据包，存储着一个消息（如前文所述），告诉 EVM 转移以太币、创建新合同、触发现有合同或执行某些计算。合同地址可以是交易的接收方，就像具有外部账户的用户一样。回顾一下第二章中关于加密通信的讨论：交易就像是在不安全的网络中两个用户之间的私密通信，尽管如此，他们仍能向彼此“发送”价值。

### 交易的特征

交易包含以下内容：

+   接收者地址；指定没有接收者（并附带智能合约数据）是上传新智能合约的方法。正如您将看到的，合同地址会返回，以便用户知道将来在哪里访问该合同。

+   标识发送者的签名

+   显示发送数量的值字段

    +   一个可选的数据字段，用于消息（如果将其发送到合同地址）

+   一个 STARTGAS 值，指示交易可以预付的最大计算步骤数

+   一个 GASPRICE 值，表示发送者愿意支付的燃气费用

### 消息的特性

消息是合同发送到另一个合同的数据块（从不与人类之间发送或发送）。消息是虚拟对象，永远不会被序列化，仅存在于 EVM 中。当矿工在以太坊网络中获得支付时，通过消息的方式来增加矿工的支付地址；这并不构成一笔交易。当通过 EVM 运行合同时，发送消息并执行 CALL 或 DELEGATECALL 操作码。您将在本章的下一部分学习有关操作码的知识。注意因为以太坊网络与 HTTP Web 未连接，所以不使用 HTTP 方法，而是传统上使用操作码来传递消息，这是“全球唯一计算机”的描述。比特币工作方式类似。消息被发送到其他合同帐户，这些帐户随后运行消息中包含的代码。因此，合同可以彼此之间建立关系。消息包含以下内容：

+   消息的发送者地址

+   消息的接收者地址

+   值字段（指示是否发送了多少以太币）

+   一个可选的数据字段（包含合同的输入数据）

+   一个 STARTGAS 值，限制消息可以使用的燃气量

## 为操作估算燃气费

交易需要提供足够的 STARTGAS 来 cover 所有计算和存储。然而，EVM 中有许多操作，很难记住每个操作的花费。表 3-1 显示了一些常见 EVM 操作的成本。可在 [`gas.eth.guide`](http://gas.eth.guide) 找到包含各种 EVM 操作成本的最新 Google 文档。

## EVM 中的操作码

如您所见，其中一些操作可以作为方法调用。区块链范式最令人困惑的事情之一是它将来自计算机科学和网络几个领域的技术约定相结合。一个例子是以太坊（和比特币）对操作码的使用。表 3-2 显示了在 EVM 上可用的所有操作码及其各自的功能。表 3-2.这是 EVM 操作码的完整列表

| 0s：停止和算术操作 |
| --- |
| 0x00 | STOP | 终止执行。 |
| 0x01 | ADD | 加法操作。 |
| 0x02 | MUL | 乘法操作。 |
| 0x03 | SUB | 减法操作。 |
| 0x04 | DIV | 整数除法操作。 |
| 0x05 | SDIV | 有符号整数。 |
| 0x06 | MOD | 模。 |
| 0x07 | SMOD | 有符号模数。 |
| 0x08 | ADDMOD | 模。 |
| 0x09 | MULMOD | 模。 |
| 0x0a | EXP | 指数运算。 |
| 0x0b | SIGNEXTEND | 扩展 2 的长度（补码有符号整数）。 |
| 10s：比较和位逻辑操作 |
| 0x10 | LT | 小于比较。 |
| 0x11 | GT | 大于比较。 |
| 0x12 | SLT | 有符号小于比较。 |
| 0x13 | SGT | 有符号大于比较。 |
| 0x14 | EQ | 等于比较。 |
| 0x15 | ISZERO | 简单的 NOT 运算符。 |
| 0x16 | AND | 按位与操作。 |
| 0x17 | OR | 按位或操作。 |
| 0x18 | XOR | 按位异或操作。 |
| 0x19 | NOT | 按位 NOT 操作。 |
| 0x1a | BYTE | 从字中检索单个字节。 |
| 20s：SHA3 |
| 0x20 | SHA3 | 计算 Keccak-256 哈希。 |
| 30s：环境信息 |
| 0x30 | ADDRESS | 获取当前执行账户的地址。 |
| 0x31 | BALANCE | 获取给定账户的余额。 |
| 0x32 | ORIGIN | 获取执行起始地址。 |
| 0x33 | CALLER | 获取调用者地址。这是直接负责此执行的账户的地址。 |
| 0x34 | CALLVALUE | 获取执行此操作的指令/事务存入的值。 |
| 0x35 | CALLDATALOAD | 获取当前环境的输入数据。 |
| 0x36 | CALLDATASIZE | 获取当前环境中输入数据的大小。 |
| 0x37 | CALLDATACOPY | 将当前环境中的输入数据复制到内存中。与消息调用指令或事务传递的输入数据有关。 |
| 0x38 | CODESIZE | 获取当前环境中运行的代码的大小。 |
| 0x39 | CODECOPY | 将当前环境中运行的代码复制到内存中。 |
| 0x3a | GASPRICE | 获取当前环境中的气体价格。 |
| 0x3b | EXTCODESIZE | 获取账户代码的大小。 |
| 0x3c | EXTCODECOPY | 将账户的代码复制到内存中。 |
| 40s: 块信息 |
| 0x40 | BLOCKHASH | 获取最近 256 个完整块之一的哈希。 |
| 0x41 | COINBASE | 获取块的受益人地址。 |
| 0x42 | TIMESTAMP | 获取块的时间戳。 |
| 0x43 | NUMBER | 获取块的编号。 |
| 0x44 | DIFFICULTY | 获取块的难度。 |
| 0x45 | GASLIMIT | 获取块的燃气限制。 |
| 50s: 堆栈、内存、存储和流操作 |
| 0x50 | POP | 从堆栈中移除项目。 |
| 0x51 | MLOAD | 从内存中加载字。 |
| 0x52 | MSTORE | 将字保存到内存中。 |
| 0x53 | MSTORE8 | 将字节保存到内存中。 |
| 0x54 | SLOAD | 从存储器中加载字。 |
| 0x55 | SSTORE | 将字保存到存储器中。 |
| 0x56 | JUMP | 更改程序计数器。 |
| 0x57 | JUMPI | 有条件地更改程序计数器。 |
| 0x58 | PC | 获取增量前的程序计数器的值。 |
| 0x59 | MSIZE | 获取活动内存的字节数。 |
| 0x5a | GAS | 获取可用气体量，包括相应的减少量。 |
| 0x5b | JUMPDEST | 标记跳转的有效目的地。 |
| 60s and 70s: 推送操作 |
| 0x60 | PUSH1 | 将 1 字节项目推送到堆栈上。 |
| 0x61 | PUSH2 | 将 2 字节项目推送到堆栈上。 |
| 0x7f | PUSH32 | 将 32 字节（全字）项目推送到堆栈上。 |
| 80s: 复制操作 |
| 0x80 | DUP1 | 复制第 1 个堆栈项。 |
| 0x81 | DUP2 | 复制第二个堆栈项。 |
| 0x8f | DUP16 | 复制第 16 个堆栈项。 |
| 90s: 交换操作 |
| 0x90 | SWAP1 | 交换第 1 个和第 2 个堆栈项。 |
| 0x91 | SWAP2 | 交换第 1 个和第 3 个堆栈项。 |
| 0x9f | SWAP16 | 交换第 1 个和第 17 个堆栈项。 |
| a0s: 日志操作 |
| 0xa0 | LOG0 | 追加没有主题的日志记录。 |
| 0xa1 | LOG1 | 追加具有一个主题的日志记录。 |
| 0xa4 | LOG4 | 追加具有四个主题的日志记录。 |
| f0s: 系统操作 |
| 0xf0 | CREATE | 创建一个带有相关代码的新账户。 |
| 0xf1 | CALL | 向一个账户发送消息调用。 |
| 0xf2 | CALLCODE | 使用另一账户的代码进行消息调用。 |
| 0xf3 | RETURN | 终止执行并返回输出数据。 |
| 0xf4 | DELEGATECALL | 使用另一账户的代码进行消息调用，但保留当前的发送者和价值。终止执行；标记待删除。 |
| 0xff | SUICIDE | 终止执行并注册账户以便以后删除。 |

在传统的网页开发中，操作码的粗略等价物将是 HTTP 动词，也称为 HTTP 方法。这些包括 GET、POST、HEAD、OPTIONS、PUT、DELETE、TRACE 和 CONNECT。这些语义是可靠且众所周知的。在以太坊和比特币中，情况则有所不同。因为网络本质上也是一台全球性的机器，你在网络中进行调用的“方法”只是机器语言代码，就像在单个计算机内部使用的那样。以下是 EVM 操作码的完整列表：

## 概要

这一章提供了关于以太坊虚拟机（EVM）作为数据库的更完整的视角，以及其状态如何更改。虽然设计理念现在应该对您更清晰了，但仍有很多内容需要讨论。如果您想阅读关于 EVM 如何执行程序的更多辅助文档，您可以在[`evm.eth.guide`](http://evm.eth.guide)找到资源列表。下一个需要解决的问题是：在 EVM 上运行程序意味着什么？答案在于编写和部署智能合约，这些合约协同工作形成分布式应用程序。正如我们在本章中讨论的，每个合约都有自己的地址和存储空间，可以容纳任意代码。当一个交易到达这个地址，或者合约被另一个合约调用时，其代码在 EVM 上的每个节点内部生效，导致进一步的消息传递或以太交易。构成智能合约的指令存储在 EVM 字节码中。但在编译成字节码之前，它们是由人类用 Solidity 编程语言编写的。这门语言将成为下一章的主题。脚注 1Forbes，“央行探索区块链：为什么 5 年内数字美元、英镑或人民币可能成为现实”，[www.forbes.com/sites/laurashin/2016/10/12/central-banks-explore-blockchains-why-digital-dollars-pounds-or-yuan-could-be-a-reality-in-5-years/#5ef54e7176d8](http://www.forbes.com/sites/laurashin/2016/10/12/central-banks-explore-blockchains-why-digital-dollars-pounds-or-yuan-could-be-a-reality-in-5-years/#5ef54e7176d8)，2016。2Wikipedia，“格雷斯·霍波”，[`en.wikipedia.org/wiki/Grace_Hopper`](https://en.wikipedia.org/wiki/Grace_Hopper)，2016。3Gavwood.com，“以太坊：安全去中心化的广义交易分类帐”，[`gavwood.com/paper.pdf`](http://gavwood.com/paper.pdf)，2016。4Bitcoin Wiki，“受控供应”，[`en.bitcoin.it/wiki/Controlled_supply`](https://en.bitcoin.it/wiki/Controlled_supply)，2016。5Google Code，“Diff-Match Patch”，[`code.google.com/p/google-diff-match-patch/`](https://code.google.com/p/google-diff-match-patch/)，2016。6 以太坊白皮书，“以太坊状态转换函数”，[`​github.​com/​ethereum/​wiki/​wiki/​White-Paper#ethereum-state-transition-function`](https://github.com/ethereum/wiki/wiki/White-Paper#ethereum-state-transition-function)，2016。7GitHub，“以太坊白皮书”，[`github.com/ethereum/wiki/wiki/White-Paper`](https://github.com/ethereum/wiki/wiki/White-Paper)，2016。8ConsenSys Media，“以太坊、燃气、燃料和费用”，[`media.consensys.net/ethereum-gas-fuel-and-fees-3333e17fe1dc#.ozbhydyz6`](https://media.consensys.net/ethereum-gas-fuel-and-fees-3333e17fe1dc#.ozbhydyz6)，2016。
