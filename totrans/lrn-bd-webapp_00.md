圣地亚哥·帕拉迪诺

# 以太坊 Web 开发者指南

## 学习在以太坊区块链上构建 Web 应用程序

![../images/476252_1_En_BookFrontmatter_Figa_HTML.png](img/476252_1_En_BookFrontmatter_Figa_HTML.png)Santiago Palladino 阿根廷布宜诺斯艾利斯自治市 ISBN 978-1-4842-5277-2e-ISBN 978-1-4842-5278-9[`doi.org/10.1007/978-1-4842-5278-9`](https://doi.org/10.1007/978-1-4842-5278-9)© Santiago Palladino 2019 本作品受版权保护。出版商对整个或部分材料拥有版权，具体包括翻译、再版、插图重复使用、朗诵、广播、微缩胶片或任何其他物理方式的复制，以及信息存储和检索、电子适应、计算机软件或通过现在已知或今后开发的类似或不同的方法传输。商标名称、标识和图像可能出现在本书中。与其在每次商标名称、标识或图像出现时使用商标符号，我们仅在编辑上使用名称、标识和图像，并且只对商标所有者有利，没有侵权意图。本出版物中使用的商业名称、商标、服务标记和类似术语，即使它们没有被标识为这样，也不应被视为对它们是否受专有权利的意见表达。尽管本书中的建议和信息被认为在出版日期时是真实和准确的，但作者、编辑和出版商都不能对可能出现的任何错误或遗漏承担法律责任。出版商对此处所含材料不作任何明示或暗示的保证。由 Springer Science+Business Media New York 在全球范围内向图书贸易分销，地址：纽约市 Spring Street 233 号，6 楼，邮编 10013。电话 1-800-SPRINGER，传真 (201) 348-4505，电子邮件 orders-ny@springer-sbm.com，或访问 www.springeronline.com。Apress Media, LLC 是加利福尼亚有限责任公司，唯一成员（所有者）是 Springer Science + Business Media Finance Inc (SSBM Finance Inc)。SSBM Finance Inc 是特拉华州的一家公司。

*致 Ale，我的即将成为妻子，她在我写这本书的许多日子里一直支持着我。*

*致我那些都是计算机科学家的父母，他们将自己的激情传给了我。*

介绍

写一本关于以太坊的书并不容易。以太坊是我见过的发展最快的技术之一。它建立在一个完全新的计算模型之上，这个模型甚至在五年前都不存在，并且自其构思以来已经经历了无数次变革。写一本像书一样静态的东西几乎是徒劳的尝试去捕捉它。再加上网页开发，另一个以其快速变化环境而闻名的领域，似乎是一个艰巨的任务。

尽管如此，有一些概念已经成为开发基于区块链的应用程序的基本概念。即使这个领域是新的，我们看到了许多新的链在比特币和以太坊之后被启动^(1)，而且它们都共享许多基本构建块。这些就是这本书试图从网页开发人员的角度捕捉到的概念。我相信它们将在未来几年中像今天一样有用，即使我们依赖的工具和实践完全改变。

在整本书中，你可能会读到许多免责声明，形式上是*在撰写本文时*，以强调一些即将发生变化的事情，甚至有些在我写和审阅每一章的时间内都发生了变化。然而，你要牢记的是，免责声明适用于整本书，因为以太坊生态系统正在不断发展。

## 本书适合谁

这本书是为了我几年前进入区块链领域之前而写的。我曾经作为一个全栈开发人员工作了几年，进入以太坊领域后，我的构建和思考应用程序的基础受到了震撼。

当时，想找到全面的资料来理解构建去中心化应用程序所需的以太坊的所有方面非常困难。而且，即使到今天，信息大多是零散的，并且通常是针对特定工具集量身定制的。

所以，这本书是为有经验的 Web 应用程序开发人员而写的，他们想将自己的技能应用到这个新的去中心化平台——以太坊。我们正在经历的情况很像是移动革命，它彻底改变了我们十多年前与网络的互动方式。这需要开发人员重新学习和适应一种新的范式。现在也是一样的。

有了这个前提，本书提供了传统 Web 开发之外，从你可以使用以太坊网络的新概念出发的内容。

## 你应该知道的内容

这本书是为 Web 开发人员编写的，假定你已经知道并精通什么是 Web 应用程序，熟悉 JavaScript 作为一种开发语言，并且理解客户端-服务器架构、关系数据库、HTTP 请求/响应周期和 DNS 等概念。

特别是，我们将使用 React 作为前端库来简化本书中许多示例的开发。考虑到 React 存在的时间比以太坊本身还要长，并且考虑到它今天的流行程度，它似乎是一个合适的选择。我们不会依赖任何框架或状态管理解决方案，因为我们将保持我们的示例简单，并专注于以太坊的方面。

即使我们将与加密货币一起工作，也不需要事先了解加密学或货币学的知识来阅读本书。我们将在第一章中介绍哈希和公钥加密的基础知识，并在最后几章中简要介绍财务激励。当然，如果你对这两个领域中的任何一个感兴趣，区块链是一个非常好的练习场所。

## 工作环境

本书的很大一部分是由代码示例组成的。即使这本书的价值在于它试图向您传达的概念，每一章都包括了几个代码片段或完整的应用程序来帮助说明它们。考虑到这一点，您可能希望准备一个环境来重现列出的实验。

所有的代码示例都是用 Javascript ES6 编写的，在 Ubuntu Linux 系统上开发和测试，并在一个 bash shell 上通过 nodejs ^(2) 10.16 运行。由于 Javascript 是多平台的，这些示例应该可以在 OSX 或 Windows 环境中无缝运行，尽管效果可能有所不同。也就是说，只要 npm ^(3)工作正常，并且能够在本地运行 create-react-app ^(4)，大多数代码示例都应该足够了。某些章节可能还需要您安装并运行以太坊节点，如 Geth ^(5)或 Parity Ethereum。 ^(6)请参考它们的网站以获取特定平台的安装说明。

在整本书中，我们将非常有限地使用特定于以太坊的工具和库。我们将限制自己只使用一个 Javascript 库与以太坊网络交互，^(7)再加上一个简化智能合约编译的工具，^(8)以及一个标准合约库，以避免从头开始重新实现它们。^(9)以太坊的工具和框架领域变化很快，我希望避免将书与其中一个绑定在一起。然而，当您开始您的新的以太坊应用程序时，依赖于现有框架，如 OpenZeppelin，Buidler，Truffle，Embark 或 Etherlime 可能会帮助您加快速度。

## 章节概览

第一章将是唯一没有代码的章节。它将介绍什么是区块链，从比特币到以太坊的历史，以及账户、交易和区块的基本概念，以及本书中需要的基本加密知识点。它还将简要介绍区块链用例，并介绍分布式应用程序的概念。

第二章完全是动手实践。它通过从零开始开发一个完整的分布式应用程序来弥补上一章节缺少代码的不足。许多概念将被快速概述，但是这一章应该能够帮助您以实践的方式理解所有组件是如何相互配合的，以便在后面深入探讨它们的作用时，您对它们的角色有一个清晰的了解。

第三章是唯一与网页开发无关的章节。它提供了智能合约的速成课程，这是以太坊中的一个关键构建。对智能合约有一个良好的理解，并知道它们能做什么，不能做什么，将有助于您设计应用程序的架构。该章的大部分内容都建立在 Solidity 上，这是撰写合约的最流行的高级语言。

第四章和第五章回到网页开发，深入研究非常基础的任务：从区块链读取和写入数据。获取区块链数据不像向您的平均关系数据库发送 SQL 查询，发送交易需要管理燃气和签名等概念。在区块链开发中，长时间的确认时间和重新组织可能会使您从 NoSQL 数据库的最终一致性中了解到的挑战变得微不足道。这两章将介绍这些问题，并介绍处理它们的几种技术。

第六章将挑战去中心化本身。到目前为止，所有示例都是作为静态单页应用程序构建的，使用区块链作为其唯一的后端。本章将在去中心化应用程序的架构中引入中心化组件，例如索引和存储解决方案。

最后，第七章和第八章涉及到以太坊开发中两个当今最紧迫的挑战：用户入门和可扩展性。对于非技术用户来说，在以太坊领域开始可能是具有挑战性的，因为他们会被像私钥或助记词等概念所困扰，在一个不容情的空间中，如果犯错可能会丢失所有资金。此外，拥有全球吞吐量仅为每秒十几笔交易的平台严重限制了它可以运行的应用程序 - 想象一下，一个云提供商只提供每秒不超过十二个数据库写入，分配给所有客户端共享。这两章深入探讨了这些问题，并包括对当前可用解决方案的调查。这也是两个变化最快的场景，但这些章节将为您提供基础，帮助您在这个领域中导航，从而构建出色的以太坊应用程序。

## 强制性免责声明

软件开发中的安全性很难保证。区块链开发中的安全性甚至更难。智能合约应用程序可能管理大量资金，并且在公共可执行环境中容易受到攻击者的攻击。

> *我希望你编写的程序必须在拜占庭环境下运行，并且任何对手都可以使用他们选择的任何参数调用你的程序。你的程序执行的环境（因此任何直接或间接的环境依赖关系）也受对手控制。如果在实现中或者甚至在程序的逻辑设计中出现了一个可以被利用的错误或疏忽，那么你个人或者你的程序的用户可能会损失大量的钱。在你的程序将运行的地方，如果出了问题，就没有法律途径可供追究。哦，一旦你发布了你的程序的第一个版本，你就再也不能改变它。第一次就必须正确。*
> 
> —Adrian Colyer，“Zeus: 分析智能合约的安全性” ^(10)

即使本书中的所有代码示例都经过了审核，但它们并没有经过正式审计。即使进行了审计，仍可能存在未被发现的安全漏洞。本书中的代码目标是教会你，而不是被简单地复制粘贴到你的应用程序中 - 我们已经有了 StackOverflow 来解决这个问题。本书的作者和出版商都不能对你在这里找到的代码的安全性提供任何保证。

底线是，你不应该盲目地信任本书中的任何代码片段 - 或者来自任何其他来源的代码片段。始终确保你对自己在做什么有很好的理解，并在将代码投入以太坊网络生产之前，通过第三方进行代码审查和审计。

> *本软件按“原样”提供，不提供任何明示或暗示的担保，包括但不限于适销性、特定用途的适用性和非侵权性的保证。在任何情况下，作者或版权所有者均不对任何索赔、损害或其他责任负责，无论是在合同、侵权或其他方面产生的，与软件或软件使用或其他交易有关。*

没有更多拖延，让我们开始吧。

致谢

首先，我要特别感谢 OpenZeppelin 团队。OpenZeppelin 是我第一次接触到令人惊叹的以太坊世界的地方，也是我学到了你们在本书中将要读到的一切内容。

我还要感谢所有与我一同度过作为开发者职业生涯的同事，特别是在 manas.tech 工作并学习了近十年的同事。那些年让我成为了今天的开发者。

还要特别感谢整个以太坊社区。许多建设者和维护者们常常被忽视或未被赏识，但正是通过他们的努力，这个生态系统得以蓬勃发展。

我也要永远感谢布宜诺斯艾利斯公共自由大学的老师们，在那里我获得了计算机科学方面的宝贵教育。即使在我作为学生的时代区块链甚至还不存在，但我在那里学到的基础知识今天在接触任何主题时仍然对我有所帮助。

最后但同样重要的是，特别感谢 Apress 团队，他们帮助我编写了这本书，并使它到达了你们的手中。

当然，还要感谢我的猫，它在我写这本书的每一个小时里都坚定不移地陪在我身边睡觉。

### 目录

第一章：区块链 1 加密学复习 1 哈希函数 1 公钥密码学 2 区块链入门 2 交易和区块 3 从比特币到以太坊 7 去中心化应用 9 为什么区块链？ 12 优势和用例 12 局限性 14 非公开区块链 15 摘要 16 第二章：一个示例 DApp 17 关于我们的 DApp 17 我们的需求 17 智能合约 17 架构 19 设置环境 19 构建我们的应用程序 22 编译智能合约 22 通过 Web3 连接到网络 24 合约接口 26 与我们的智能合约交互 28 连接我们的组件 28 查询合约状态 31 发送交易 33 通过事件监视更新 37 部署应用程序 38 摘要 38 第三章：智能合约速成课 39 什么是智能合约？ 39 外部账户 vs. 智能合约 40 代码和状态 42 燃气使用 44 交易 46 调用 49Solidity 50Remix 51 你的第一个 Solidity 合约 52 函数的内容 56 值数据类型 61 引用类型 66 发出事件 73 导入、继承和库 74 知名智能合约 77 应用程序二进制接口 77EIPs 和 ERCs 78ERC20 代币 78ERC721 非同质化代币 81 摘要 87 第四章：查询网络 89 连接到网络 89 全节点和轻节点 89JSON-RPC 接口 90 提供者对象 93 选择正确的连接 96 检索数据 98 网络信息 98 账户余额和代码 100 调用合约 102 检测变化 105 轮询新块

自 2005 年以来一直担任专业软件开发人员，专注于 Web 应用程序开发已有超过 10 年的经验。他于 2017 年进入以太坊领域，加入 OpenZeppelin 团队成为最早的几名员工之一。在那里，他参与了多次审计工作，担任安全研究员，并带领开发了用于构建以太坊应用程序的开源工具和服务。他拥有布宜诺斯艾利斯大学的计算机科学硕士学位，在那里担任了 7 年的算法和数值方法助教。他撰写了几篇关于以太坊开发和区块链的在线文章。你可以在 Twitter 上找到他 @smpalladino，或在 Github 上找到他 @spalladino。

### 关于技术审阅员

Alexander Chinedu Nnakwue![../images/476252_1_En_BookFrontmatter_Figc_HTML.jpg](img/476252_1_En_BookFrontmatter_Figc_HTML.jpg)

拥有尼日利亚伊巴丹大学机械工程背景，并担任前端开发人员已有超过 3 年，在 Web 和移动技术领域都有工作经验。他还有作为技术作者、写手和审阅员的经历。他热爱 Web 编程，偶尔也会踢足球。他出生在贝宁城，目前居住在尼日利亚拉各斯。
