© 维克拉姆·迪隆、大卫·梅特卡夫和马克斯·胡珀 2017 维克拉姆·迪隆、大卫·梅特卡夫和马克斯·胡珀区块链启用的应用程序`doi.org/10.1007/978-1-4842-3081-7_3`

# 3. 区块链的基础

维克拉姆·迪隆^(1 )、大卫·梅特卡夫¹和马克斯·胡珀¹(1)美国佛罗里达州奥兰多

> 你永远无法通过与现有现实斗争来改变事物。要改变某事，就要建立一个使现有模式过时的新模式。——R. 巴克明斯特·富勒

区块链是一种分散式数据结构，其内部一致性通过网络上所有用户就网络当前状态达成共识来维持。它是一种使拜占庭将军问题（不信任方之间的消息通信）得以解决的技术，为无需信任的交易和信息交换开辟了新的可能性。如果互联网使信息的点对点交换民主化，那么区块链则使价值的点对点交换民主化。我们从探索比特币网络上用户之间的交易工作开始本章。这涉及到对区块和交易结构的技术讨论。然后我们深入探讨了钱包和用户地址的作用。在谈论完钱包之后，我们将焦点转移到了比特币网络中实现的简化支付验证（SPV）。SPV 使我们能够理解为什么区块具有奇特的结构，更重要的是，比特币网络如何在网络高速扩展的情况下保持效率。最后，我们通过讨论区块链中的硬分叉和软分叉来结束我们的讨论。我们介绍了分叉对商家和运行比特币核心代码的用户在前向兼容性方面的影响。

## 交易工作流程

比特币协议的核心目的是允许用户在网络上以分散方式进行交易。我们一直在讨论协议的小片段来建立背景知识。现在我们可以将这些概念整合到一个框架中并探索区块链。挖掘的最终结果是随着网络随着时间的推移而增加区块的数量。要了解两个用户（爱丽丝和鲍勃）之间如何发生交易，我们首先需要了解持有交易的区块结构。简而言之，区块链是由两个主要原则约束的区块集合：

+   内部一致性：每个区块的运行中都有一些设计原则，这些原则使区块在内部保持一致。例如，每个区块都链接到链中的上一个区块，并具有创建时间戳。区块链中的这些机制使其成为一个内部一致的数据结构，可以保持一致的交易记录。

+   交易一致性：在第二章中描述的挖掘概念只是验证交易的一种实现方式；存在不涉及蛮力哈希的不同方法。然而，在这些所有实现中，都有一种方案来达成对网络中某个时间间隔内已发生的交易达成共识。我们可以通过使用某种形式的 PoW 或类似的策略来概括这种去中心化系统中的交易验证，然后由网络上的用户检查这些交易。

交易本质上是一个数据结构，存在于一个区块上，但具体是如何的呢？要发现这个过程，让我们看看图 3-1 中一个区块的完整结构。每个区块至少有两个独特的组成部分：区块头，其中包含一个唯一的哈希（称为默克尔根），它唯一地标识一个区块，以及事务列表，其中包含新的交易。请注意，每个区块在列表中包含相同数量的交易，但用户之间的具体交易不同。这是因为每十分钟只有一个区块在区块链上赢得挖矿竞赛，其他候选均被拒绝，竞赛重新开始。在这个简化的模型中，一个区块还包含另外两个组成部分：区块大小，对整个网络保持一致，以及每个区块中的交易数量计数器。在这里，我们更加关注区块头和事务列表。区块头包含一些标准组件，比如之前讨论过的难度目标和 nonce。它还包含了赢得挖矿竞赛的矿工运行的比特币核心代码的版本号。时间戳也是每个区块的一个独特特征，因为它明确地标识了网络中的一个特定区块。头还包含了链中前一个区块的哈希，以及标识此区块的特殊哈希，称为默克尔根。我们稍后在本章中讨论这个特殊哈希是如何产生的。生命的证明最近，有传言称维基解密创始人朱利安·阿桑奇已经去世。阿桑奇最近在 Reddit 上进行了一个问答活动，并通过从区块链中读取最新的区块哈希来证明自己确实还活着来回应这些传言。这个区块是仅十分钟前创建的，所以这不可能是预先录制的，从而无可辩驳地证明了阿桑奇还活着。这是区块哈希第一次在流行文化的意义上发挥作用，阿桑奇称之为生命的证明。

+   用户艾丽斯发起了一笔她想发送给鲍勃的交易。

+   艾丽斯使用她的私钥对交易进行签名。

+   交易被广播到网络上，任何人都可以使用艾丽斯的公钥来验证该交易是由她发起的。

+   在经过网络验证并传播到他那里之后，鲍勃收到了交易。

+   鲍勃使用他的私钥解锁交易。该交易被一个脚本签名，以便只有接收方才能解锁交易并将其分配给自己。

我们提到交易的锁定和解锁机制使用脚本，那么这个脚本是什么呢？比特币协议使用一种最小、最简单、不完全的图灵不完备的编程语言来管理交易。中本聪的意图是尽可能保持编程逻辑非常简单，并且尽可能地不把它们放在区块链上。每个交易都附有一个脚本，其中包含有关接收比特币的用户如何访问它们的说明。基本上，发送方需要提供一个任何网络上的人都可以使用的公钥，以确定该交易确实来自脚本中包含的地址，并且提供一个签名以显示该交易是使用发送方的私钥签名的。如果没有私钥-公钥对的授权，用户之间的交易将不会发生。让我们完成我们在 3-3 中开始创建的图景。![A430562_1_En_3_Fig3_HTML.jpg](img/A430562_1_En_3_Fig3_HTML.jpg)图 3-3.区块链上的交易从概念上来看，将网络上的交易视为 UTXOs 分布在数百个区块中可能有些奇怪，但这个过程确实是交易在网络中传播的方式。在这个例子中，鲍勃首先发起了发送给艾丽斯的交易，其中有一枚比特币被分配给了艾丽斯。他收到了九个比特币作为未花费的输出。艾丽斯进一步向另一个用户发送了 0.5 个比特币，这样做的同时，她从她的交易中收到了 0.5 个比特币的找零。请注意，第一笔交易由发起交易的鲍勃签名，然后艾丽斯签署了第二笔交易。从某种意义上说，第一笔交易的输出成为了第二笔交易的输入，因此鲍勃的签名被保留作为第一笔交易的证明，而艾丽斯的签名现在作为解锁机制。这就是如何在比特币网络中跟踪交易的过程，从起源到最终所有者（最终地址）。通过使用网络地址，网络保留了一定程度的匿名性。现在我们已经谈论了 UTXOs、签名、脚本以及交易是如何记录的，让我们整合这些概念并审查艾丽斯和鲍勃之间交易的工作流程，如 3-4 所示。![A430562_1_En_3_Fig4_HTML.jpg](img/A430562_1_En_3_Fig4_HTML.jpg)图 3-4.网络上交易的概述艾丽斯从她的钱包中发起交易，该钱包包含多个地址。每个地址都有一定数量的比特币余额（与该地址关联的所有 UTXOs 的总和），可以用于创建新的交易。然后使用艾丽斯的私钥对交易进行签名，进入挖矿阶段，其中它将被打包成候选块。随着挖矿的结束，获胜的矿工宣布在网络上发布块，并将块包含到区块链中。其余的交易被抛入待添加的交易池中。交易传播到鲍勃，他现在可以使用他的私钥来解锁交易输出金额并使用它。UTXOs、签名和脚本锁定和解锁的思想提供了对区块链如何作为一个分散的分类账保持内部一致性的更深入的洞察。3-4 介绍了钱包的概念，它可用于发起交易。钱包现在是比特币核心代码的标准部分，它主要为用户提供了三个目的：

+   创建交易：用户可以使用钱包的图形界面轻松创建交易。

+   维护余额：钱包软件跟踪与地址相关联的所有 UTXO，并提供用户的最终余额。

+   维护多个地址：在钱包内，用户可以拥有多个地址，每个地址都可以与特定交易相关联。

从某种意义上说，地址是比特币网络中唯一的所有权手段。未花费交易输出（UTXO）和余额都与特定地址相关联，用户可以创建任意数量的地址。我们在图 3-4 中看到，爱丽丝的钱包中有三个地址，每个地址都可以使用她的私钥。实际上，除了软件钱包之外，还有其他类型的钱包。图 3-4 使用了软件钱包，但其他两种主要类型，移动钱包和冷存储物理钱包的过程类似。移动钱包主要是为了方便起见，作为使用比特币等加密货币进行移动支付的入口。这些钱包通常充当完整钱包的独立但微型化版本，并允许随时访问余额和交易。作为钱包的应用程序通常是在开放源代码环境中设计的，因此它们也有助于将开发人员和高级用户汇集到社区中。冷存储钱包是一种长期存储比特币的更为永久的方法。有时钱包会损坏，或者用户无法记住解锁钱包的密钥，使得他们的余额实际上无法使用。钱包上的密码没有恢复机制。这里的想法是创建一个新钱包，并将交易发送到该钱包上的新地址。现在，这个钱包可以备份并保存到诸如闪存驱动器之类的物理设备中，并安全地存储起来。一旦该交易在区块链上得到验证，您的比特币就可以随时从闪存驱动器中取回。这可以防止发生任何意外事件，并将您的货币与您用于进行交易或挖掘比特币的主要钱包分开。一些开发人员进一步采取了步骤，并创建了纸质钱包，其中地址被编码在一个 QR 码中，而该特定钱包的私钥也以另一个 QR 码的形式打印在纸上。注意您如何在没有自己编写脚本或代码的情况下查看比特币网络上的交易发生情况？在比特币（以及大多数加密货币）中，有一个称为区块链浏览器的功能，通常是一个网站，可以查看来自比特币网络的所有交易。您可以获取关于交易的各种详细信息，例如交易的来源、金额、区块哈希或收到多少次确认。

## 简单支付验证

到目前为止，我们已经讨论了区块的结构、交易列表、用户之间的交易发生方式以及它们如何记录在区块链上。区块基本上是链接在区块链上的数据结构，交易可以被看作是该数据结构的属性。更确切地说，在区块链的情况下，交易被表示为默克尔树的叶子。哈希一直被用于比特币协议中作为维护数据一致性的方法，因为哈希非常容易验证，几乎不可能被逆向工程。建立在这些属性之上，我们可以解决区块链上的一个非常困难的技术挑战：我们如何检查特定交易是否属于一个区块？在列表中检查 N 个项目将非常低效，所以我们不能简单地检查包含数百万个区块的区块链中的每笔交易以进行验证。这就是默克尔树提供速度和效率的地方。要可视化默克尔树，请参考图 3-5。它由一个区块的交易构成，以便快速访问以进行验证。让我们来看一下图 3-5 中显示的例子。在这种情况下，有八笔交易被收集到一个区块中，并在默克尔树上表示出来。最低级别是交易本身，它们通过将两个交易哈希在一起并获得一个输出哈希来抽象到更高的级别。这个哈希与第二个哈希组合并再次哈希以抽象一个更高的级别。这个过程重复进行，直到只剩下两个哈希。请注意，每个级别都包含下面级别的信息，最终最高级别保存有来自整个树的信息的哈希。这个哈希被称为默克尔根。默克尔根如何帮助我们找到一个交易？让我们通过图 3-6 中显示的例子运行一下，尝试从默克尔树中找到交易 6。首先，默克尔根允许我们跳过树的另一半，现在我们的搜索仅限于交易 5 到 8。哈希进一步引导搜索，使我们只需三步就能到达交易 6。将这与搜索整个树、进入每个级别并比较每个交易是否确实是交易 6 相比。这个过程在步骤和时间上更为复杂，如果搜索扩展到数百万笔交易，这将变得过于繁琐。![A430562_1_En_3_Fig5_HTML.jpg](img/A430562_1_En_3_Fig5_HTML.jpg)图 3-5.构建默克尔根最低级别由交易组成，总体思路是将两个元素哈希在一起，并保留有关下一级别的一些信息。最终，我们只剩下两个元素被哈希在一起形成了默克尔根。何时寻找交易会有用？每个新用户开始使用标准比特币钱包客户端都必须下载整个区块链。随着时间的推移，区块链的下载大小已经增加到了几个千兆字节。对于新用户来说，这可能令人生畏，因为他们在区块链下载完成之前无法使用他们的钱包，这可能会使他们却步。为了解决必须下载历史交易的庞大区块链的问题，中本聪提出了一种称为 SPV 的解决方案。SPV 中的基本原理是创建一个仅下载区块头而不是整个区块链的钱包客户端。这个新的轻量级客户端可以使用区块头中的默克尔根来验证特定交易是否位于给定的区块中。精确的机制要求钱包依赖于一个默克尔分支，并达到特定的交易，就像图 3-6 中显示的例子一样。目前，对于比特币来说，有一个名为 Electrum 的备选钱包客户端实现了 SPV，并允许新用户避免下载整个区块链。![A430562_1_En_3_Fig6_HTML.jpg](img/A430562_1_En_3_Fig6_HTML.jpg)图 3-6.使用默克尔根找到交易根允许我们在搜索过程中跳过树的一半，而下一级别进一步缩小了搜索范围。使用默克尔根，我们可以在只需三步的情况下达到交易，这在比特币当前网络中是非常高的操作效率所需。到达交易 6 的路径也被称为默克尔分支，连接根和一个叶子。

## 区块链分叉

这里有一个有趣的情景需要考虑：几个矿工正在竞争解决 PoW 并创建一个区块。碰巧，两个矿工在几秒钟内找到一个有效值，并将其广播到网络上。现在会发生什么？这种情况被称为分叉，在比特币网络中是完全正常的，特别是当网络开始扩展并包括数千名矿工时。为了解决分叉，在网络上制定了一些规则，称为共识规则。分叉创建了区块链的两个版本，当下一个区块被发现时，这个分叉将会被解决。一些节点将会在一个区块链版本上进行工作，而其他节点将在第二个版本上进行工作。当下一个区块被发现时，由于包含了这个新区块，其中一个链将变得更长。这个链现在变成了活跃链，节点将会收敛到这个新链上。这个过程在图 3-7 中以可视化方式展示。![A430562_1_En_3_Fig7_HTML.jpg](img/A430562_1_En_3_Fig7_HTML.jpg)图 3-7.链中的分叉在这个例子中，区块 4 同时被两个矿工发现，但当 Branch B 上发现了下一个区块时，这个分叉被解决。这个分支现在成为了活跃链，所有节点都收敛到使用 Branch B 作为新活跃链。区块链上的常规分叉并不是一个值得关注的事件，因为它们通常在几分钟内就能解决。然而，软分叉和硬分叉是一个全然不同的问题。这些可能发生在比特币核心代码升级时，导致未升级的节点和已经开始按照新共识规则创建区块的已升级节点之间发生永久分裂。网络上开始出现两种完全不同类型的区块，网络不能收敛到一个单一的活跃链，直到节点升级到新规则。在这种情况下，有两种可能的结果。第一种可能性是大多数网络转向新规则（软分叉），新规则允许部分有效的旧区块继续存在。第二种选择是旧区块对于新节点来说不再有效，并且新节点不接受网络上的旧区块。这是一个硬分叉，没有前向兼容性，旧区块将不再被新节点接受。所有的矿工和节点都必须升级到新软件，以便在新规则下其区块被认为是有效的。硬分叉可能会引起混乱，并对依赖旧规则进行交易的用户和商家造成问题。他们必须升级他们的后端软件，以便与新规则兼容，并确保比特币的收款顺利过渡。对于比特币网络来说，目前并没有硬分叉计划，但开发人员已经开始研究这个过程可能有多复杂。我们在这里结束了对区块链分叉的讨论，但我们会在后面回到这个话题。在接下来的章节中，我们将看一看在未来比特币协议的情况下，硬分叉可能会成为一个必要的情况。

## 摘要

在本章中，我们将挖矿的概念融入整个区块链网络中。我们描述了区块链在技术层面上是什么以及它是如何运作的。然后，我们描述了交易的工作流程和跟踪未花费的交易输出。我们谈论了交易是如何组合并在区块链上传播的，以及挖矿软件，如钱包和挖矿客户端。然后，我们将挖矿放入适当网络的背景中，并展示了交易是如何从被包含在区块中到被传播的。之后，我们谈论了 SPV 的概念以及比特币中 Merkle 哈希和根的重要性。我们在章节最后讨论了区块链分叉以及它们如何影响网络，我们在本书中稍后也会重新讨论这个问题。

## 参考文献

编写本章所使用的主要参考资料是比特币开发者指南，用于讨论 UTXOs 和区块头。Georg Becker 关于 Merkel 树签名的工作被用于准备简单支付验证和 Merkel 根部分。
